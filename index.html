<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FinPess ‚Äî Sistema Financeiro Pessoal</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <style>
    :root{
      --bg: #FAFBFC;
      --panel: #FFFFFF;
      --muted: #5F6B76;
      --primary: #0A2238;
      --primary-600: #133957;
      --accent: #25D39A;
      --radius: 14px;
      --card-shadow: 0 4px 14px rgba(10,34,56,0.05);
      --glass: rgba(10,34,56,0.02);
      --gap: 22px;
      font-family: 'Poppins', 'Inter', system-ui, -apple-system, "Segoe UI", Roboto;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--primary);}

    /* Layout */
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100vh;}

    /* SIDEBAR */
    .sidebar{background:linear-gradient(180deg,var(--primary),var(--primary-600));color:#fff;padding:24px;display:flex;flex-direction:column;gap:18px;border-right:1px solid rgba(255,255,255,0.04)}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:var(--panel);display:flex;align-items:center;justify-content:center;color:var(--primary);font-weight:700;box-shadow:var(--card-shadow)}
    .brand h1{font-size:18px;margin:0;font-weight:700}

    .nav{display:flex;flex-direction:column;gap:6px;margin-top:6px}
    .nav a{display:flex;gap:14px;align-items:center;padding:10px;border-radius:10px;color:rgba(255,255,255,0.92);text-decoration:none;font-weight:600}
    .nav a i{width:22px;text-align:center}
    .nav a:hover{background:rgba(255,255,255,0.06)}
    .nav a.active{background:rgba(255,255,255,0.12);box-shadow:inset 0 0 0 1px rgba(255,255,255,0.03)}

    .sidebar .spacer{flex:1}
    .user-mini{display:flex;gap:12px;align-items:center;background:rgba(255,255,255,0.03);padding:10px;border-radius:10px}
    .avatar{width:36px;height:36px;border-radius:8px;background:var(--panel);color:var(--primary);display:flex;align-items:center;justify-content:center;font-weight:700}

    /* CONTENT */
    .content{padding:28px}
    header.app-header{display:flex;align-items:center;justify-content:space-between;gap:20px;margin-bottom:var(--gap)}
    .search{flex:1;display:flex;align-items:center;gap:12px;background:var(--panel);padding:10px;border-radius:12px;border:1px solid #EEF2F4;box-shadow:var(--card-shadow)}
    .search input{border:0;outline:none;padding:6px 8px;font-size:15px;color:var(--primary);background:transparent}

    .top-actions{display:flex;gap:10px}
    .btn{border:0;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer;transition:all .18s ease}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{background:transparent;border:1px solid #E6EAEE;color:var(--primary-600)}
    .btn.small{padding:6px 12px;font-size:13px}

    /* Dashboard grid */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:18px}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .col-8{grid-column:span 8}
    .col-12{grid-column:span 12}

    .card{background:var(--panel);padding:22px;border-radius:var(--radius);box-shadow:var(--card-shadow);border:1px solid #EEF2F4}
    .card h3{margin:0;font-size:15px;color:var(--muted);font-weight:600}
    .card .value{font-size:24px;font-weight:800;margin-top:8px}

    /* Saldo list */
    .saldos{display:flex;flex-direction:column;gap:10px}
    .saldo-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:var(--glass)}

    .chart-wrap{height:340px}

    /* Table */
    table{width:100%;border-collapse:collapse;font-size:15px}
    thead th{font-weight:700;text-align:left;padding:12px 8px;color:var(--muted)}
    tbody td{padding:12px 8px;border-top:1px solid #F1F3F5}
    .tag{display:inline-block;padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px}
    .tag.receita{color:#0B6FD6}
    .tag.despesa{color:#D64545}
    .tag.ativo{background:#E8F5E8;color:#2ECC71}
    .tag.inativo{background:#FBEAEA;color:#E74C3C}
    .tag.fisica{background:#E3F2FD;color:#1976D2}
    .tag.juridica{background:#E8F5E8;color:#2E7D32}

    .form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #E9EEF2;background:transparent}

    /* Status badges */
    .status-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600}
    .status-ativo{background:#E8F5E8;color:#2ECC71}
    .status-inativo{background:#FBEAEA;color:#E74C3C}

    /* Address info */
    .address-info{background:#F8F9FA;padding:12px;border-radius:8px;border:1px solid #E9ECEF;margin-top:8px}
    .address-line{margin-bottom:4px;font-size:13px}

    @media (max-width:980px){
      .app{grid-template-columns:1fr}
      .sidebar{display:flex;flex-direction:row;align-items:center;gap:12px;padding:12px;overflow:auto}
      .content{padding:16px}
      .grid{grid-template-columns:repeat(6,1fr)}
      .col-4{grid-column:span 6}
      .col-6{grid-column:span 6}
      .col-8{grid-column:span 6}
    }

    /* Theme dark */
    :root[data-theme='dark']{--bg:#0E1117;--panel:#1A1F26;--muted:#A9B3C1;--primary:#E6EDF3;--primary-600:#A4B1C4;--accent:#2ECC9A;--card-shadow:0 4px 18px rgba(0,0,0,0.35);--glass:rgba(255,255,255,0.04)}

    /* Buttons & cards micro interactions */
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(12,34,56,0.06)}
    .card{transition:all .18s ease}
    .card:hover{transform:translateY(-4px);box-shadow:0 12px 36px rgba(12,34,56,0.08)}

    /* Table modern */
    table tbody tr:nth-child(odd){background:rgba(0,0,0,0.015)}
    table tbody tr:hover{background:rgba(0,0,0,0.04);transition:.2s}

    /* KPI */
    .kpi-head{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .kpi-head i{font-size:20px;color:var(--accent);background:var(--glass);padding:10px;border-radius:10px}
    .kpi.receita i{color:#2ECC71;background:rgba(46,204,113,0.12)}
    .kpi.despesa i{color:#E74C3C;background:rgba(231,76,60,0.12)}
    .value[data-animate]{opacity:0;transform:translateY(6px);transition:all .45s cubic-bezier(.2,.9,.3,1)}
    .value[data-animate].visible{opacity:1;transform:translateY(0)}
    .kpi{display:flex;flex-direction:column;justify-content:center;min-height:140px}

    @media(max-width:780px){.kpi{min-height:110px;padding:18px}}
    
    /* Modal styles */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(11,39,64,0.45);z-index:60}
    .modal-content{width:95%;max-width:720px;background:var(--panel);border-radius:12px;padding:22px;box-shadow:var(--card-shadow);max-height:90vh;overflow-y:auto}
    
    /* Login specific */
    .login-logo{width:60px;height:60px;border-radius:12px;background:var(--panel);display:flex;align-items:center;justify-content:center;color:var(--primary);font-weight:700;font-size:24px;margin:0 auto 20px;box-shadow:var(--card-shadow)}
    
    /* Loading */
    .loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Conditional field */
    .conditional-field{display:none;animation:fadeIn 0.3s ease-in}
    .conditional-field.visible{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

    /* Field validation */
    .field-error{border-color:#E74C3C !important}
    .error-message{color:#E74C3C;font-size:12px;margin-top:4px;display:none}
    .error-message.visible{display:block}

    /* CEP loading */
    .cep-loading{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite;margin-left:8px}

    /* NOVO ESTILO PARA FILTROS HORIZONTAIS */
    .filtros-container {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    
    .filtros-container .btn {
      flex-shrink: 0;
    }
    
    .filtros-container select,
    .filtros-container input {
      min-width: 140px;
      flex: 1;
    }
    
    .filtros-container input {
      min-width: 200px;
    }
    
    @media (max-width: 768px) {
      .filtros-container {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filtros-container select,
      .filtros-container input {
        min-width: auto;
      }
      
      #dashboard .grid .col-6 {
        grid-column: span 12;
      }
    }

    /* NOVO ESTILO PARA CAMPOS PREENCHIDOS */
    input.filled, select.filled, textarea.filled {
      font-weight: 600 !important;
      color: var(--primary) !important;
    }
  </style>
</head>
<body>
  <div id="login-modal" class="modal" style="display:flex;">
    <div class="modal-content" style="max-width:400px;text-align:center">
      <div class="login-logo">FP</div>
      <h2 style="margin:0 0 8px">FinPess</h2>
      <p style="color:var(--muted);margin-bottom:24px">Fa√ßa login para continuar</p>
      
      <div style="display:flex;flex-direction:column;gap:12px">
        <input id="login-email" type="email" placeholder="E-mail" style="padding:12px;border-radius:8px;border:1px solid #E9EEF2">
        <input id="login-password" type="password" placeholder="Senha" style="padding:12px;border-radius:8px;border:1px solid #E9EEF2">
        
        <button class="btn primary" onclick="fazerLogin()" style="width:100%;padding:12px" id="login-btn">
          <i class="fas fa-sign-in-alt"></i> Entrar
        </button>
        
        <div style="font-size:14px;color:var(--muted);margin:16px 0">ou</div>
        
        <button class="btn ghost" onclick="trocarParaCadastro()" style="width:100%">
          Criar nova conta
        </button>
      </div>
    </div>
  </div>

  <div id="cadastro-modal" class="modal">
    <div class="modal-content" style="max-width:400px;text-align:center">
      <h3 style="margin:0 0 20px">Criar Conta</h3>
      
      <div style="display:flex;flex-direction:column;gap:12px">
        <input id="cadastro-nome" placeholder="Seu nome" style="padding:12px;border-radius:8px;border:1px solid #E9EEF2">
        <input id="cadastro-email" type="email" placeholder="E-mail" style="padding:12px;border-radius:8px;border:1px solid #E9EEF2">
        <input id="cadastro-password" type="password" placeholder="Senha (m√≠n. 6 caracteres)" style="padding:12px;border-radius:8px;border:1px solid #E9EEF2">
        
        <button class="btn primary" onclick="fazerCadastro()" style="width:100%;padding:12px" id="cadastro-btn">
          <i class="fas fa-user-plus"></i> Criar Conta
        </button>
        
        <button class="btn ghost" onclick="trocarParaLogin()" style="width:100%">
          Voltar para login
        </button>
      </div>
    </div>
  </div>

  <div class="app" style="display:none">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">FP</div>
        <div>
          <h1>FinPess</h1>
          <div style="font-size:12px;opacity:.9">Gest√£o Financeira</div>
        </div>
      </div>

      <nav class="nav" aria-label="Main navigation">
        <a class="active" data-screen="dashboard" href="#"><i class="fas fa-home"></i> Dashboard</a>
        <a data-screen="lancamentos" href="#"><i class="fas fa-money-bill-wave"></i> Lan√ßamentos</a>
        <a data-screen="contas" href="#"><i class="fas fa-university"></i> Contas</a>
        <a data-screen="setores" href="#"><i class="fas fa-sitemap"></i> Setores</a>
        <a data-screen="categorias" href="#"><i class="fas fa-tags"></i> Categorias</a>
        <a data-screen="parceiros" href="#"><i class="fas fa-user-friends"></i> Parceiros</a>
        <a data-screen="formas-pagamento" href="#"><i class="fas fa-credit-card"></i> Formas de Pagamento</a>
      </nav>

      <div class="spacer"></div>

      <div class="user-mini">
        <div class="avatar">U</div>
        <div>
          <div style="font-weight:700" id="user-name">Usu√°rio</div>
          <div style="font-size:12px;color:rgba(255,255,255,0.8)" id="user-email">user@exemplo.com</div>
          <button onclick="fazerLogout()" style="background:none;border:none;color:rgba(255,255,255,0.7);font-size:11px;cursor:pointer;margin-top:4px">
            <i class="fas fa-sign-out-alt"></i> Sair
          </button>
        </div>
      </div>
    </aside>

    <main class="content">
      <header class="app-header">
        <div class="search"><i class="fas fa-search" style="color:var(--muted)"></i><input id="global-search" placeholder="Pesquisar lan√ßamentos, parceiros ou categorias..."></div>
        <div class="top-actions"><button class="btn" id="btn-theme">Tema</button><button class="btn primary" id="btn-novo">+ Novo</button></div>
      </header>

      <section id="dashboard" class="screen">
        <div class="grid" style="margin-bottom:var(--gap)">
          <div class="col-4">
            <div class="card kpi receita" style="padding:18px;">
              <div class="kpi-head"><i class="fas fa-wallet"></i><h3>Saldo Geral</h3></div>
              <div class="value" id="saldo-geral" data-animate>R$ 0,00</div>
              <div class="kpi-sub" id="saldo-data">Atualizado hoje</div>
            </div>
          </div>

          <div class="col-4">
            <div class="card kpi receita" style="padding:18px;">
              <div class="kpi-head"><i class="fas fa-arrow-trend-up"></i><h3>Receitas (M√™s)</h3></div>
              <div class="value" id="receitas-mes" data-animate>R$ 0,00</div>
              <div class="kpi-sub">Atualizado hoje</div>
            </div>
          </div>

          <div class="col-4">
            <div class="card kpi despesa" style="padding:18px;">
              <div class="kpi-head"><i class="fas fa-arrow-trend-down"></i><h3>Despesas (M√™s)</h3></div>
              <div class="value" id="despesas-mes" data-animate>R$ 0,00</div>
              <div class="kpi-sub">Atualizado hoje</div>
            </div>
          </div>
        </div>

        <div class="grid">
          <div class="col-8">
            <div class="card">
              <h3>Fluxo de Caixa (√öltimos 6 meses)</h3>
              <div class="chart-wrap"><canvas id="chartFluxo"></canvas></div>
            </div>

            <div class="card" style="margin-top:18px">
              <h3>√öltimos Lan√ßamentos</h3>
              <table>
                <thead>
                  <tr><th>Parceiro</th><th>Detalhes</th><th>Valor</th><th>Venc.</th><th>Tipo</th></tr>
                </thead>
                <tbody id="tbody-ultimos"></tbody>
              </table>
            </div>
          </div>

          <div class="col-4">
            <div class="card">
              <h3>Saldos por Conta</h3>
              <div class="saldos" id="lista-saldos"></div>
            </div>

            <div class="grid" style="margin-top:18px">
              <div class="col-6">
                <div class="card">
                  <div class="kpi-head">
                    <i class="fas fa-money-bill-wave" style="color:#E74C3C;background:rgba(231,76,60,0.12)"></i>
                    <h3>Contas a Pagar</h3>
                  </div>
                  <div class="value" id="contas-a-pagar-valor">R$ 0,00</div>
                  <div class="kpi-sub" id="contas-a-pagar-info">Nenhuma conta pendente</div>
                </div>
              </div>
              <div class="col-6">
                <div class="card">
                  <div class="kpi-head">
                    <i class="fas fa-hand-holding-usd" style="color:#2ECC71;background:rgba(46,204,113,0.12)"></i>
                    <h3>Contas a Receber</h3>
                  </div>
                  <div class="value" id="contas-a-receber-valor">R$ 0,00</div>
                  <div class="kpi-sub" id="contas-a-receber-info">Nenhuma conta pendente</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="lancamentos" class="screen" style="display:none">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
            <h3 style="margin:0">Lan√ßamentos</h3>
            <div style="display:flex;align-items:center;gap:12px">
              <div style="display:flex;align-items:center;gap:8px;background:var(--glass);padding:6px 12px;border-radius:8px">
                <button class="btn ghost small" onclick="mudarMes(-1)" style="padding:4px 8px">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <span id="mes-atual" style="font-weight:600;min-width:140px;text-align:center">Novembro 2024</span>
                <button class="btn ghost small" onclick="mudarMes(1)" style="padding:4px 8px">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
              
              <button class="btn primary" onclick="abrirFormLancamento()">
                <i class="fas fa-plus"></i> Novo Lan√ßamento
              </button>
            </div>
          </div>

          <div class="filtros-container" style="margin-top:16px">
		  
			<select id="filtro-conta-lancamento" onchange="filtrarLancamentos()">
              <option value="">Todas as contas</option>
              </select>
		  
            <select id="filtro-tipo-lancamento" onchange="filtrarLancamentos()">
              <option value="">Todos os tipos</option>
              <option value="receita">Receita</option>
              <option value="despesa">Despesa</option>
              <option value="transferencia">Transfer√™ncia</option>
            </select>
            
            <select id="filtro-status-lancamento" onchange="filtrarLancamentos()">
              <option value="">Todos os status</option>
              <option value="realizado">Realizado</option>
              <option value="nao-realizado">N√£o Realizado</option>
            </select>
            
            <select id="filtro-parceiro-lancamento" onchange="filtrarLancamentos()">
              <option value="">Todos os parceiros</option>
            </select>
            
            <input id="filtro-descricao-lancamento" placeholder="Buscar por descri√ß√£o..." oninput="filtrarLancamentos()">
          </div>
        </div>

        <div class="grid" style="margin-top:18px">
          <div class="col-4">
            <div class="card kpi receita">
              <div class="kpi-head"><i class="fas fa-arrow-trend-up"></i><h3>Receitas (M√™s)</h3></div>
              <div class="value" id="receitas-mes-lancamentos">R$ 0,00</div>
            </div>
          </div>
          <div class="col-4">
            <div class="card kpi despesa">
              <div class="kpi-head"><i class="fas fa-arrow-trend-down"></i><h3>Despesas (M√™s)</h3></div>
              <div class="value" id="despesas-mes-lancamentos">R$ 0,00</div>
            </div>
          </div>
          <div class="col-4">
            <div class="card kpi">
              <div class="kpi-head"><i class="fas fa-scale-balanced"></i><h3>Saldo (M√™s)</h3></div>
              <div class="value" id="saldo-mes-lancamentos">R$ 0,00</div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Descri√ß√£o</th>
                <th>Parceiro</th>
                <th>Categoria</th>
                <th>Valor</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tabela-lancamentos-body"></tbody>
          </table>
        </div>
      </section>

      <section id="contas" class="screen" style="display:none">
        <div class="card">
          <h3>Contas Financeiras</h3>
          <div class="filtros-container">
            <button class="btn primary" onclick="abrirFormConta()">+ Nova Conta</button>
            <select id="filtro-tipo-conta" onchange="renderTabelaContas()">
              <option value="">Todos os tipos</option>
              <option value="corrente">Conta Corrente</option>
              <option value="poupanca">Poupan√ßa</option>
              <option value="carteira">Carteira</option>
              <option value="investimento">Investimento</option>
              <option value="outro">Outro</option>
            </select>
            <select id="filtro-status-conta" onchange="renderTabelaContas()">
              <option value="">Todos os status</option>
              <option value="ativo">Ativo</option>
              <option value="inativo">Inativo</option>
            </select>
            <input id="filtro-text-conta" placeholder="Buscar por nome..." oninput="renderTabelaContas()">
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Tipo</th>
                <th>Saldo</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tabela-contas-body"></tbody>
          </table>
        </div>
      </section>

      <section id="setores" class="screen" style="display:none">
        <div class="card">
          <h3>Setores (Centro de Custo)</h3>
          <div class="filtros-container">
            <button class="btn primary" onclick="abrirFormSetor()">+ Novo Setor</button>
            <select id="filtro-status-setor" onchange="renderTabelaSetores()">
              <option value="">Todos os status</option>
              <option value="ativo">Ativo</option>
              <option value="inativo">Inativo</option>
            </select>
            <input id="filtro-text-setor" placeholder="Buscar por descri√ß√£o..." oninput="renderTabelaSetores()">
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <table>
            <thead>
              <tr>
                <th>Descri√ß√£o</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tabela-setores-body"></tbody>
          </table>
        </div>
      </section>

      <section id="categorias" class="screen" style="display:none">
        <div class="card">
          <h3>Categorias</h3>
          <div class="filtros-container">
            <button class="btn primary" onclick="abrirFormCategoria()">+ Nova Categoria</button>
            <select id="filtro-tipo-categoria" onchange="renderTabelaCategorias()">
              <option value="">Todos os tipos</option>
              <option value="receita">Receita</option>
              <option value="despesa">Despesa</option>
            </select>
            <select id="filtro-status-categoria" onchange="renderTabelaCategorias()">
              <option value="">Todos os status</option>
              <option value="ativo">Ativo</option>
              <option value="inativo">Inativo</option>
            </select>
            <input id="filtro-text-categoria" placeholder="Buscar por nome..." oninput="renderTabelaCategorias()">
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Tipo</th>
                <th>Cor</th>
                <th>Setor</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tabela-categorias-body"></tbody>
          </table>
        </div>
      </section>

      <section id="parceiros" class="screen" style="display:none">
        <div class="card">
          <h3>Parceiros</h3>
          <div class="filtros-container">
            <button class="btn primary" onclick="abrirFormParceiro()">+ Novo Parceiro</button>
            <select id="filtro-tipo-parceiro" onchange="renderTabelaParceiros()">
              <option value="">Todos os tipos</option>
              <option value="fisica">F√≠sica</option>
              <option value="juridica">Jur√≠dica</option>
            </select>
            <select id="filtro-status-parceiro" onchange="renderTabelaParceiros()">
              <option value="">Todos os status</option>
              <option value="ativo">Ativo</option>
              <option value="inativo">Inativo</option>
            </select>
            <input id="filtro-text-parceiro" placeholder="Buscar por nome..." oninput="renderTabelaParceiros()">
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Tipo</th>
                <th>CPF/CNPJ</th>
                <th>Telefone</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tabela-parceiros-body"></tbody>
          </table>
        </div>
      </section>

      <section id="formas-pagamento" class="screen" style="display:none">
        <div class="card">
          <h3>Formas de Pagamento</h3>
          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn primary" onclick="abrirFormFormaPagamento()">+ Nova Forma</button>
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <table>
            <thead>
              <tr>
                <th>Descri√ß√£o</th>
                <th>Status</th>
                <th>Parcelamento</th>
                <th>M√°x. Parcelas</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tabela-formas-pagamento-body"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <div id="modal-form" class="modal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="modal-title" style="margin:0">Formul√°rio</h3>
        <button onclick="fecharModal()" style="border:0;background:#F3F6F8;padding:8px;border-radius:8px"><i class="fas fa-times"></i></button>
      </div>
      <div id="modal-body" style="margin-top:12px"></div>
    </div>
  </div>

  <div id="modal-lancamento" class="modal">
    <div class="modal-content" style="max-width:600px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="modal-lancamento-title" style="margin:0">Novo Lan√ßamento</h3>
        <button onclick="fecharModalLancamento()" style="border:0;background:#F3F6F8;padding:8px;border-radius:8px">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div id="modal-lancamento-body" style="margin-top:16px">
        </div>
    </div>
  </div>

  <script>
    // ---------- Configura√ß√£o Firebase ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAhOwJZZ9OxsWsEW1BsGXy7I-5qTFyH-GI",
      authDomain: "finpess-efabe.firebaseapp.com",
      databaseURL: "https://finpess-efabe-default-rtdb.firebaseio.com",
      projectId: "finpess-efabe",
      storageBucket: "finpess-efabe.firebasestorage.app",
      messagingSenderId: "730433687910",
      appId: "1:730433687910:web:9a3a6130abc6d95fa338a7"
    };

    // Inicializa Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Vari√°veis globais
    let currentUser = null;
    let dataSaldos = [];
    let dataLancamentos = [];
    let dataCategorias = [];
    let dataParceiros = [];
    let dataFormasPagamento = [];
    let dataSetores = [];

    // ---------- VARI√ÅVEIS GLOBAIS PARA LAN√áAMENTOS ----------
    let mesAtual = new Date().getMonth();
    let anoAtual = new Date().getFullYear();
    let lancamentoEditando = null;

    // ---------- SISTEMA DE CACHE ----------
    let cacheTimestamp = null;
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutos

    // Fun√ß√µes de cache
    function saveToCache(userId) {
        const cacheData = {
            dataSaldos,
            dataLancamentos,
            dataCategorias,
            dataParceiros,
            dataFormasPagamento,
            dataSetores,
            timestamp: Date.now()
        };
        localStorage.setItem(`finpess_cache_${userId}`, JSON.stringify(cacheData));
    }

    function applyCachedData(cachedData) {
        dataSaldos = cachedData.dataSaldos || [];
        dataLancamentos = cachedData.dataLancamentos || [];
        dataCategorias = cachedData.dataCategorias || [];
        dataParceiros = cachedData.dataParceiros || [];
        dataFormasPagamento = cachedData.dataFormasPagamento || [];
        dataSetores = cachedData.dataSetores || [];
    }

    function invalidateCache() {
        cacheTimestamp = null;
        if (currentUser) {
            localStorage.removeItem(`finpess_cache_${currentUser.uid}`);
        }
    }

    // ---------- Sistema de Autentica√ß√£o (MOVIDO PARA O TOPO) ----------
    
    async function initializeAuth() {
        try {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await onUserSignedIn(user);
                } else {
                    onUserSignedOut();
                }
            });
        } catch (error) {
            console.error('Erro ao inicializar auth:', error);
            showError('Erro ao inicializar sistema de autentica√ß√£o');
        }
    }

    async function fazerLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const loginBtn = document.getElementById('login-btn');
        
        if (!email || !password) {
            showError('Preencha email e senha');
            return;
        }
        
        try {
            loginBtn.innerHTML = '<div class="loading"></div> Entrando...';
            loginBtn.disabled = true;
            
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            console.error('Erro no login:', error);
            showError('Erro ao fazer login: ' + error.message);
            loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar';
            loginBtn.disabled = false;
        }
    }

    async function fazerCadastro() {
        const nome = document.getElementById('cadastro-nome').value;
        const email = document.getElementById('cadastro-email').value;
        const password = document.getElementById('cadastro-password').value;
        const cadastroBtn = document.getElementById('cadastro-btn');
        
        if (!nome || !email || !password) {
            showError('Preencha todos os campos');
            return;
        }
        
        if (password.length < 6) {
            showError('A senha deve ter pelo menos 6 caracteres');
            return;
        }
        
        try {
            cadastroBtn.innerHTML = '<div class="loading"></div> Criando conta...';
            cadastroBtn.disabled = true;
            
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;
            
            // Salvar dados do usu√°rio no Firestore
            await db.collection('usuarios').doc(user.uid).set({
                nome: nome,
                email: email,
                dataCriacao: firebase.firestore.FieldValue.serverTimestamp(),
                ultimoAcesso: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Criar dados iniciais para o usu√°rio
            await criarDadosIniciaisUsuario(user.uid);
            
        } catch (error) {
            console.error('Erro no cadastro:', error);
            showError('Erro ao criar conta: ' + error.message);
            cadastroBtn.innerHTML = '<i class="fas fa-user-plus"></i> Criar Conta';
            cadastroBtn.disabled = false;
        }
    }

    function fazerLogout() {
        if (confirm('Deseja realmente sair?')) {
            auth.signOut();
        }
    }

    function trocarParaCadastro() {
        document.getElementById('login-modal').style.display = 'none';
        document.getElementById('cadastro-modal').style.display = 'flex';
    }

    function trocarParaLogin() {
        document.getElementById('cadastro-modal').style.display = 'none';
        document.getElementById('login-modal').style.display = 'flex';
    }

    async function onUserSignedIn(user) {
        console.log('üë§ Usu√°rio logado:', user.email);
        
        // Atualizar interface
        document.getElementById('login-modal').style.display = 'none';
        document.getElementById('cadastro-modal').style.display = 'none';
        document.querySelector('.app').style.display = 'grid';
        
        // Atualizar informa√ß√µes do usu√°rio
        const userNameElement = document.getElementById('user-name');
        const userEmailElement = document.getElementById('user-email');
        const userAvatarElement = document.querySelector('.user-mini .avatar');
        
        if (userNameElement) userNameElement.textContent = user.email.split('@')[0];
        if (userEmailElement) userEmailElement.textContent = user.email;
        if (userAvatarElement) userAvatarElement.textContent = user.email[0].toUpperCase();
        
        // CORRE√á√ÉO: Verificar se o documento do usu√°rio existe antes de atualizar
        try {
            const userDoc = await db.collection('usuarios').doc(user.uid).get();
            
            if (userDoc.exists) {
                // Documento existe, atualizar √∫ltimo acesso
                await db.collection('usuarios').doc(user.uid).update({
                    ultimoAcesso: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                // Documento n√£o existe, criar um novo
                await db.collection('usuarios').doc(user.uid).set({
                    nome: user.email.split('@')[0],
                    email: user.email,
                    dataCriacao: firebase.firestore.FieldValue.serverTimestamp(),
                    ultimoAcesso: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Criar dados iniciais
                await criarDadosIniciaisUsuario(user.uid);
            }
        } catch (error) {
            console.error('Erro ao verificar/atualizar usu√°rio:', error);
            // Continuar mesmo com erro para n√£o bloquear o login
        }
        
        // Carregar dados do usu√°rio
        await loadUserData(user.uid);
    }

    function onUserSignedOut() {
        console.log('üö™ Usu√°rio deslogado');
        currentUser = null;
        
        // Resetar dados
        dataSaldos = [];
        dataLancamentos = [];
        dataCategorias = [];
        dataParceiros = [];
        dataFormasPagamento = [];
        dataSetores = [];
        
		// Destruir gr√°fico
		destroyChart();
		
        // Limpar cache
        invalidateCache();
		
        
        // Mostrar tela de login
        document.getElementById('login-modal').style.display = 'flex';
        document.querySelector('.app').style.display = 'none';
        
        // Resetar formul√°rios de login
        document.getElementById('login-email').value = '';
        document.getElementById('login-password').value = '';
        document.getElementById('login-btn').innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar';
        document.getElementById('login-btn').disabled = false;
        
        // Resetar interface
        renderDashboard();
    }

    // ---------- SISTEMA DE NOTIFICA√á√ïES ----------
    function showNotification(message, type = 'info', duration = 5000) {
        // Remover notifica√ß√£o existente
        const existingNotification = document.getElementById('global-notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        // Criar nova notifica√ß√£o
        const notification = document.createElement('div');
        notification.id = 'global-notification';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
        `;

        // Cores baseadas no tipo
        const colors = {
            success: '#2ECC71',
            error: '#E74C3C',
            warning: '#F39C12',
            info: '#3498DB'
        };

        notification.style.backgroundColor = colors[type] || colors.info;
        notification.textContent = message;

        document.body.appendChild(notification);

        // Animar entrada
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
            notification.style.opacity = '1';
        }, 100);

        // Auto-remover ap√≥s dura√ß√£o
        if (duration > 0) {
            setTimeout(() => {
                hideNotification(notification);
            }, duration);
        }

        // Clique para fechar
        notification.addEventListener('click', () => {
            hideNotification(notification);
        });

        return notification;
    }

    function hideNotification(notification) {
        notification.style.transform = 'translateX(400px)';
        notification.style.opacity = '0';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }

    // Substituir os alerts por notifica√ß√µes
    function showError(message) {
        console.error('Erro:', message);
        showNotification(message, 'error', 7000);
    }

    function showSuccess(message) {
        showNotification(message, 'success', 4000);
    }

    function showInfo(message) {
        showNotification(message, 'info', 4000);
    }


    // ---------- FUN√á√ïES PARA CONTAS A PAGAR/RECEBER DIN√ÇMICAS ----------
    function calcularContasAPagar() {
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0); // Considera apenas a data, sem hora
        
        const contasAPagar = dataLancamentos.filter(l => {
            const dataVencimento = new Date(l.data);
            dataVencimento.setHours(0, 0, 0, 0);
            
            return l.tipo === 'despesa' && 
                   !l.pago && 
                   dataVencimento >= hoje;
        });
        
        // Ordenar por data de vencimento (mais pr√≥ximas primeiro)
        contasAPagar.sort((a, b) => new Date(a.data) - new Date(b.data));
        
        const totalAPagar = contasAPagar.reduce((total, lancamento) => {
            return total + (lancamento.valor || 0);
        }, 0);
        
        return {
            total: totalAPagar,
            quantidade: contasAPagar.length,
            lancamentos: contasAPagar,
            proximoVencimento: contasAPagar.length > 0 ? contasAPagar[0].data : null
        };
    }

    function calcularContasAReceber() {
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        
        const contasAReceber = dataLancamentos.filter(l => {
            const dataVencimento = new Date(l.data);
            dataVencimento.setHours(0, 0, 0, 0);
            
            return l.tipo === 'receita' && 
                   !l.pago && 
                   dataVencimento >= hoje;
        });
        
        // Ordenar por data de vencimento (mais pr√≥ximas primeiro)
        contasAReceber.sort((a, b) => new Date(a.data) - new Date(b.data));
        
        const totalAReceber = contasAReceber.reduce((total, lancamento) => {
            return total + (lancamento.valor || 0);
        }, 0);
        
        return {
            total: totalAReceber,
            quantidade: contasAReceber.length,
            lancamentos: contasAReceber,
            proximoVencimento: contasAReceber.length > 0 ? contasAReceber[0].data : null
        };
    }

    function atualizarCardsContasPendentes() {
        const contasAPagar = calcularContasAPagar();
        const contasAReceber = calcularContasAReceber();
        
        // Atualizar Contas a Pagar
        const valorPagarElement = document.getElementById('contas-a-pagar-valor');
        const infoPagarElement = document.getElementById('contas-a-pagar-info');
        
        if (valorPagarElement) {
            valorPagarElement.textContent = formatMoney(contasAPagar.total);
            valorPagarElement.style.color = contasAPagar.total > 0 ? '#E74C3C' : 'var(--primary)';
        }
        
        if (infoPagarElement) {
            if (contasAPagar.quantidade === 0) {
                infoPagarElement.textContent = 'Nenhuma conta pendente';
                infoPagarElement.style.color = 'var(--muted)';
            } else {
                const proximoVencimento = contasAPagar.proximoVencimento ? 
                    formatDate(contasAPagar.proximoVencimento) : '';
                infoPagarElement.innerHTML = `
                    ${contasAPagar.quantidade} conta(s) pendente(s)
                    ${proximoVencimento ? `<br><small>Pr√≥ximo: ${proximoVencimento}</small>` : ''}
                `;
                infoPagarElement.style.color = '#E74C3C';
            }
        }
        
        // Atualizar Contas a Receber
        const valorReceberElement = document.getElementById('contas-a-receber-valor');
        const infoReceberElement = document.getElementById('contas-a-receber-info');
        
        if (valorReceberElement) {
            valorReceberElement.textContent = formatMoney(contasAReceber.total);
            valorReceberElement.style.color = contasAReceber.total > 0 ? '#2ECC71' : 'var(--primary)';
        }
        
        if (infoReceberElement) {
            if (contasAReceber.quantidade === 0) {
                infoReceberElement.textContent = 'Nenhuma conta pendente';
                infoReceberElement.style.color = 'var(--muted)';
            } else {
                const proximoVencimento = contasAReceber.proximoVencimento ? 
                    formatDate(contasAReceber.proximoVencimento) : '';
                infoReceberElement.innerHTML = `
                    ${contasAReceber.quantidade} conta(s) pendente(s)
                    ${proximoVencimento ? `<br><small>Pr√≥ximo: ${proximoVencimento}</small>` : ''}
                `;
                infoReceberElement.style.color = '#2ECC71';
            }
        }
    }


    // ---------- Dados Iniciais para Novos Usu√°rios ----------
    
    async function criarDadosIniciaisUsuario(userId) {
        try {
            const batch = db.batch();
            
            // Contas iniciais
            const contasIniciais = [
                { 
                    nome: 'Conta Corrente', 
                    valor: 0, 
                    tipo: 'corrente',
                    dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp(),
                    ativo: true,
                    userId: userId
                },
                { 
                    nome: 'Carteira', 
                    valor: 0, 
                    tipo: 'carteira', 
                    dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp(),
                    ativo: true,
                    userId: userId
                }
            ];
            
            contasIniciais.forEach(conta => {
                const docRef = db.collection('contas').doc();
                batch.set(docRef, conta);
            });
            
            // Setores iniciais
            const setoresIniciais = [
                { 
                    descricao: 'Administrativo', 
                    ativo: true,
                    userId: userId
                },
                { 
                    descricao: 'Comercial', 
                    ativo: true,
                    userId: userId
                },
                { 
                    descricao: 'Produ√ß√£o', 
                    ativo: true,
                    userId: userId
                }
            ];
            
            setoresIniciais.forEach(setor => {
                const docRef = db.collection('setores').doc();
                batch.set(docRef, setor);
            });
            
            // Categorias iniciais ATUALIZADAS
            const categoriasIniciais = [
                { 
                    nome: 'Sal√°rio', 
                    tipo: 'receita', 
                    cor: '#2ECC71', 
                    descricao: 'Sal√°rio e proventos',
                    ativo: true,
                    padrao: true,
                    userId: userId 
                },
                { 
                    nome: 'Alimenta√ß√£o', 
                    tipo: 'despesa', 
                    cor: '#E74C3C', 
                    descricao: 'Gastos com alimenta√ß√£o',
                    ativo: true,
                    padrao: true,
                    userId: userId 
                },
                { 
                    nome: 'Transporte', 
                    tipo: 'despesa', 
                    cor: '#3498DB', 
                    descricao: 'Transporte e combust√≠vel',
                    ativo: true,
                    padrao: true,
                    userId: userId 
                },
                { 
                    nome: 'Moradia', 
                    tipo: 'despesa', 
                    cor: '#9B59B6', 
                    descricao: 'Aluguel, condom√≠nio, IPTU',
                    ativo: true,
                    padrao: true,
                    userId: userId 
                },
                { 
                    nome: 'Investimentos', 
                    tipo: 'receita', 
                    cor: '#F39C12', 
                    descricao: 'Rendimentos de investimentos',
                    ativo: true,
                    padrao: true,
                    userId: userId 
                }
            ];
            
            categoriasIniciais.forEach(categoria => {
                const docRef = db.collection('categorias').doc();
                batch.set(docRef, categoria);
            });
            
            // Parceiros iniciais
            const parceirosIniciais = [
                { 
                    nome: 'Cliente Jo√£o Silva', 
                    tipo: 'fisica', 
                    ativo: true, 
                    cpfCnpj: '123.456.789-00',
                    telefone: '(11) 99999-9999',
                    userId: userId 
                }
            ];
            
            parceirosIniciais.forEach(parceiro => {
                const docRef = db.collection('parceiros').doc();
                batch.set(docRef, parceiro);
            });

            // Formas de Pagamento iniciais
            const formasPagamentoIniciais = [
                { 
                    descricao: 'Cart√£o de Cr√©dito', 
                    ativo: true, 
                    permiteParcelamento: true, 
                    maxParcelas: 12,
                    userId: userId 
                }
            ];
            
            formasPagamentoIniciais.forEach(forma => {
                const docRef = db.collection('formasPagamento').doc();
                batch.set(docRef, forma);
            });
            
            await batch.commit();
            console.log('üìù Dados iniciais criados para usu√°rio:', userId);
            showSuccess('Dados iniciais configurados com sucesso!');
        } catch (error) {
            console.error('‚ùå Erro ao criar dados iniciais:', error);
            showError('Erro ao criar dados iniciais: ' + error.message);
        }
    }

    // ---------- Carregamento de Dados do Usu√°rio ----------
   

			// ---------- FUN√á√ÉO DE UTILIDADE PARA SALDO ----------
			/**
			 * Procura uma conta na mem√≥ria local e a retorna.
			 * @param {string} contaId O ID da conta a ser encontrada.
			 */
			function getContaById(contaId) {
				return dataSaldos.find(c => c.id === contaId);
			}
			// ----------------------------------------------------

			// ---------- FUN√á√ÉO PRINCIPAL DE MOVIMENTA√á√ÉO DE SALDO ----------
			/**
			 * Atualiza o valor de uma conta no Firebase e na mem√≥ria local.
			 * @param {string} contaId ID da conta a ser ajustada.
			 * @param {number} valorMovimento O valor do movimento (positivo ou negativo).
			 */
			async function ajustarSaldoConta(contaId, valorMovimento) {
				if (!contaId || valorMovimento === 0) return;

				const conta = getContaById(contaId);
				if (!conta) {
					showError(`Conta ID ${contaId} n√£o encontrada.`);
					return;
				}

				// 1. Calcular o novo saldo local (Saldo Antigo + Movimento)
				const novoValor = (conta.valor || 0) + valorMovimento;

				try {
					// 2. Atualizar no Firebase
					await db.collection('contas').doc(contaId).update({
						valor: novoValor,
						dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
					});

					// 3. Atualizar na mem√≥ria local (dataSaldos)
					conta.valor = novoValor;

					// 4. For√ßar a atualiza√ß√£o visual no Dashboard
					renderSaldos();
					renderDashboard();
					
				} catch (error) {
					console.error("‚ùå Erro ao ajustar saldo da conta:", error);
					showError("Erro ao ajustar saldo: " + error.message);
				}
			}
			// ----------------------------------------------------------------

   
    async function loadUserData(userId) {
        try {
            console.log(`üìä Carregando dados do usu√°rio: ${userId}`);
            
            // Verificar cache
            const now = Date.now();
            const cachedData = localStorage.getItem(`finpess_cache_${userId}`);
            
            if (cachedData && cacheTimestamp && (now - cacheTimestamp) < CACHE_DURATION) {
                const parsedData = JSON.parse(cachedData);
                console.log('‚úÖ Dados carregados do cache');
                applyCachedData(parsedData);
                renderAll();
                atualizarCardsContasPendentes(); 

				// Destruir gr√°fico anterior antes de criar novo
				destroyChart();
				setTimeout(() => initChart(), 100);

				popularFiltroParceiros();
				showSuccess('Dados carregados com sucesso!');	
                return;
            }

            // Carregar do Firebase
            const loadCollection = async (collectionName, orderByField = null) => {
                try {
                    let query = db.collection(collectionName).where('userId', '==', userId);
                    
                    if (orderByField) {
                        query = query.orderBy(orderByField, 'desc');
                    }
                    
                    const snapshot = await query.limit(1000).get();
                    const dados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    console.log(`‚úÖ ${collectionName}: ${dados.length} registros carregados`);
                    return dados;
                    
                } catch (error) {
                    console.error(`‚ùå Erro ao carregar ${collectionName}:`, error);
                    return [];
                }
            };

            const [
                contasData, 
                lancamentosData, 
                categoriasData, 
                parceirosData, 
                formasPagamentoData,
                setoresData
            ] = await Promise.all([
                loadCollection('contas'),
                loadCollection('lancamentos', 'data'),
                loadCollection('categorias'),
                loadCollection('parceiros'),
                loadCollection('formasPagamento'),
                loadCollection('setores')
            ]);

            // Atribuir dados - CORRE√á√ÉO: garantir que s√£o apenas do usu√°rio
            dataSaldos = contasData.filter(item => item.userId === userId);
            dataLancamentos = lancamentosData.filter(item => item.userId === userId);
            dataCategorias = categoriasData.filter(item => item.userId === userId);
            dataParceiros = parceirosData.filter(item => item.userId === userId);
            dataFormasPagamento = formasPagamentoData.filter(item => item.userId === userId);
            dataSetores = setoresData.filter(item => item.userId === userId);

            // Salvar no cache
            saveToCache(userId);
            cacheTimestamp = now;

            console.log('‚úÖ Dados do usu√°rio carregados:', {
                contas: dataSaldos.length,
                lancamentos: dataLancamentos.length,
                categorias: dataCategorias.length,
                parceiros: dataParceiros.length,
                formasPagamento: dataFormasPagamento.length,
                setores: dataSetores.length
            });

            renderAll();
            atualizarCardsContasPendentes();
            initChart();
            popularFiltroParceiros();
			popularFiltroContas();
            showSuccess('Dados carregados com sucesso!');
            
        } catch (error) {
            console.error('‚ùå Erro cr√≠tico ao carregar dados do usu√°rio:', error);
            showError('Erro ao carregar dados: ' + error.message);
        }
    }

    // ---------- Fun√ß√µes de Visualiza√ß√£o ----------
    
    function showScreen(id){
        document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
        const el = document.getElementById(id);
        if (el) el.style.display = 'block';
        
        // Renderizar dados espec√≠ficos da tela
        if (id === 'formas-pagamento') {
            renderTabelaFormasPagamento();
        } else if (id === 'parceiros') {
            renderTabelaParceiros();
        } else if (id === 'categorias') {
            renderTabelaCategorias();
        } else if (id === 'contas') {
            renderTabelaContas();
        } else if (id === 'setores') {
            renderTabelaSetores();
        } else if (id === 'lancamentos') {
            atualizarDisplayMes();
		} else if (id === 'dashboard') {
			// Recriar gr√°fico apenas se n√£o existir
			setTimeout(() => {
				if (!chartObj) {
					initChart();
				}
			}, 100);
		}
    }
    

    function renderAll() {
        renderDashboard();
        renderSaldos();
        montarUltimosLancamentos();
        atualizarCardsContasPendentes();
        
        // Anima√ß√µes
        document.querySelectorAll('.card').forEach(c => c.classList.add('visible'));
        animateKPIs();
    }

    function renderDashboard(){
        document.getElementById('saldo-geral').textContent = formatMoney(calcSaldo());
        document.getElementById('receitas-mes').textContent = formatMoney(sumByType('receita'));
        document.getElementById('despesas-mes').textContent = formatMoney(sumByType('despesa'));
        document.getElementById('saldo-data').textContent = 'Atualizado em ' + new Date().toLocaleDateString('pt-BR');
        
        // ATUALIZADO: Adicionar chamada para contas pendentes
        atualizarCardsContasPendentes();
    }

    function renderSaldos(){
        const root = document.getElementById('lista-saldos');
        if (!root) return;
        
        root.innerHTML = '';
        dataSaldos.forEach(s => {
            const item = document.createElement('div');
            item.className = 'saldo-item';
            item.innerHTML = `
                <div>
                    <div style="font-weight:700">${s.nome}</div>
                    <div class="meta">${s.tipo}</div>
                </div>
                <div style="font-weight:800;color:${s.valor >= 0 ? '#2ECC71' : '#E74C3C'}">
                    ${formatMoney(s.valor)}
                </div>
            `;
            root.appendChild(item);
        });
    }

    function montarUltimosLancamentos(){
        const tbody = document.getElementById('tbody-ultimos');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        const ultimos = dataLancamentos
            .sort((a, b) => new Date(b.data) - new Date(a.data))
            .slice(0, 8);
            
        ultimos.forEach(l => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${l.parceiro || '---'}</td>
                <td>${l.descricao || l.desc || ''}</td>
                <td>${formatMoney(l.valor)}</td>
                <td>${formatDate(l.data)}</td>
                <td><span class='tag ${l.tipo}'>${l.tipo}</span></td>
            `;
            tbody.appendChild(tr);
        });
    }

    // ========== NOVAS FUN√á√ïES PARA LAN√áAMENTOS ==========

    // ---------- FUN√á√ïES DE NAVEGA√á√ÉO POR M√äS ----------
    function atualizarDisplayMes() {
      const meses = [
        'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
      ];
      document.getElementById('mes-atual').textContent = `${meses[mesAtual]} ${anoAtual}`;
      carregarLancamentosMes();
    }

    function mudarMes(direcao) {
      mesAtual += direcao;
      if (mesAtual > 11) {
        mesAtual = 0;
        anoAtual++;
      } else if (mesAtual < 0) {
        mesAtual = 11;
        anoAtual--;
      }
      atualizarDisplayMes();
    }

    function popularFiltroParceiros() {
      const filtroParceiro = document.getElementById('filtro-parceiro-lancamento');
      if (filtroParceiro) {
        const parceirosAtivos = dataParceiros.filter(p => p.ativo);
        filtroParceiro.innerHTML = '<option value="">Todos os parceiros</option>' +
          parceirosAtivos.map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
      }
    }
	
	function popularFiltroContas() {
    const filtroConta = document.getElementById('filtro-conta-lancamento');
    if (filtroConta) {
        // Garantir que a lista de contas ativas do usu√°rio √© usada
        const contasAtivas = dataSaldos.filter(c => c.ativo && c.userId === currentUser.uid);
        
        filtroConta.innerHTML = '<option value="">Todas as contas</option>' +
          contasAtivas.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
    }
}

    // ---------- FUN√á√ïES DE CARREGAMENTO E FILTRAGEM ----------
    function carregarLancamentosMes() {
      const primeiroDia = new Date(anoAtual, mesAtual, 1);
      const ultimoDia = new Date(anoAtual, mesAtual + 1, 0);
      
      const lancamentosMes = dataLancamentos.filter(l => {
        const dataLancamento = new Date(l.data);
        return dataLancamento >= primeiroDia && dataLancamento <= ultimoDia;
      });
      
      renderizarTabelaLancamentos(lancamentosMes);
      atualizarResumoMes(lancamentosMes);
    }
	
	function filtrarLancamentos() {
		const tipo = document.getElementById('filtro-tipo-lancamento').value;
		const status = document.getElementById('filtro-status-lancamento').value;
		const parceiro = document.getElementById('filtro-parceiro-lancamento').value;
		const contaFiltro = document.getElementById('filtro-conta-lancamento').value;
		const descricao = document.getElementById('filtro-descricao-lancamento').value.toLowerCase();
		
		const primeiroDia = new Date(anoAtual, mesAtual, 1);
		const ultimoDia = new Date(anoAtual, mesAtual + 1, 0);
		
		const lancamentosFiltrados = dataLancamentos.filter(l => {
			const dataLancamento = new Date(l.data);
			const noMes = dataLancamento >= primeiroDia && dataLancamento <= ultimoDia;
			const matchTipo = !tipo || l.tipo === tipo;
			const matchStatus = !status || 
			  (status === 'realizado' && l.pago === true) || 
			  (status === 'nao-realizado' && l.pago === false);
			const matchParceiro = !parceiro || l.parceiroId === parceiro;
			const matchDescricao = !descricao || l.descricao.toLowerCase().includes(descricao);
			const matchConta = !contaFiltro || l.contaId === contaFiltro;
			
			return noMes && matchTipo && matchStatus && matchParceiro && matchDescricao && matchConta;
		});
		
		renderizarTabelaLancamentos(lancamentosFiltrados);
		atualizarResumoMes(lancamentosFiltrados);

		// ************************************************
		// NOVO: L√ìGICA DE FEEDBACK VISUAL NOS FILTROS
		// ************************************************
		
		const filtros = [
			{ element: document.getElementById('filtro-tipo-lancamento'), value: tipo },
			{ element: document.getElementById('filtro-status-lancamento'), value: status },
			{ element: document.getElementById('filtro-parceiro-lancamento'), value: parceiro },
			{ element: document.getElementById('filtro-conta-lancamento'), value: contaFiltro },
			{ element: document.getElementById('filtro-descricao-lancamento'), value: descricao }
		];

		filtros.forEach(filtro => {
			if (filtro.element) {
				// Verifica se o valor √© diferente de vazio ("") ou nulo, 
				// indicando que um filtro foi aplicado.
				if (filtro.value && filtro.value.trim() !== "") {
					filtro.element.classList.add('filled');
				} else {
					filtro.element.classList.remove('filled');
				}
			}
		});
		// ************************************************
	}
	
    function atualizarResumoMes(lancamentos) {
    
		// Filtrar Lan√ßamentos que N√ÉO S√ÉO PARTE de uma transfer√™ncia
		const lancamentosSemTransferencia = lancamentos.filter(l => !l.referenciaTransferenciaId);
		
		const receitas = lancamentosSemTransferencia
			.filter(l => l.tipo === 'receita' && l.pago)
			.reduce((sum, l) => sum + l.valor, 0);
		
		const despesas = lancamentosSemTransferencia
			.filter(l => l.tipo === 'despesa' && l.pago)
			.reduce((sum, l) => sum + l.valor, 0);
		
		const saldo = receitas - despesas;
		
		document.getElementById('receitas-mes-lancamentos').textContent = formatMoney(receitas);
		document.getElementById('despesas-mes-lancamentos').textContent = formatMoney(despesas);
		document.getElementById('saldo-mes-lancamentos').textContent = formatMoney(saldo);
		document.getElementById('saldo-mes-lancamentos').style.color = saldo >= 0 ? '#2ECC71' : '#E74C3C';
	}
	
    // ---------- FUN√á√ïES PARA CAMPOS PREENCHIDOS EM NEGRITO ----------
    function verificarCamposPreenchidos() {
        document.querySelectorAll('#modal-lancamento input, #modal-lancamento select, #modal-lancamento textarea').forEach(campo => {
            if (campo.value && campo.value.trim() !== '') {
                campo.classList.add('filled');
            } else {
                campo.classList.remove('filled');
            }
        });
    }

    function adicionarListenersCampos() {
        document.querySelectorAll('#modal-lancamento input, #modal-lancamento select, #modal-lancamento textarea').forEach(campo => {
            campo.addEventListener('input', verificarCamposPreenchidos);
            campo.addEventListener('change', verificarCamposPreenchidos);
        });
    }

		// ---------- FUN√á√ÉO PARA REALIZAR LAN√áAMENTO (CORRIGIDA SINTAXE) ----------
		async function realizarLancamento(lancamentoId) {
			const lancamento = dataLancamentos.find(l => l.id === lancamentoId);

			if (!lancamento) return;
			if (lancamento.pago) return; // J√° est√° pago

			if (!confirm('Deseja marcar este lan√ßamento como realizado?')) {
				return;
			}
			
			try {
				// 1. Marca como pago no Firebase
				await db.collection('lancamentos').doc(lancamentoId).update({
					pago: true,
					dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
				});
				
				// ************************************************
				// NOVO: MOVIMENTA√á√ÉO DO SALDO DA CONTA (SIMPLIFICADO E RE-INCORPORADO)
				// ************************************************

				// 1. Calcular o valor do movimento (Receita √© +, Despesa √© -).
				const valorMovimento = lancamento.valor * (lancamento.tipo === 'despesa' ? -1 : 1);

				// 2. Apenas ajustamos o saldo da conta vinculada a este registro.
				await ajustarSaldoConta(lancamento.contaId, valorMovimento);
				
				// 2. Atualizar localmente
				lancamento.pago = true;
				
				invalidateCache();
				carregarLancamentosMes();
				atualizarCardsContasPendentes();
				showSuccess('Lan√ßamento marcado como realizado!');
				
			} catch (error) { // <-- CHAVE DE FECHAMENTO DO TRY E IN√çCIO DO CATCH
				console.error("Erro ao realizar lan√ßamento:", error);
				showError("Erro ao realizar o lan√ßamento.");
			}
		}

    function renderizarTabelaLancamentos(lancamentos) {
      const body = document.getElementById('tabela-lancamentos-body');
      if (!body) return;
      
      body.innerHTML = '';
      
      // Ordenar por data (mais recente primeiro)
      lancamentos.sort((a, b) => new Date(b.data) - new Date(a.data));
      
      lancamentos.forEach(lancamento => {
        const tr = document.createElement('tr');
        
        // Buscar informa√ß√µes relacionadas
        const categoria = dataCategorias.find(c => c.id === lancamento.categoriaId);
        const parceiro = dataParceiros.find(p => p.id === lancamento.parceiroId);
        
        // BOT√ÉO REALIZAR - s√≥ aparece se n√£o realizado
        const botaoRealizar = !lancamento.pago ? `
            <button class="btn small" onclick="realizarLancamento('${lancamento.id}')" 
                style="background:#E8F5E8;color:#2ECC71;margin-left:4px" title="Marcar como realizado">
                <i class="fas fa-check"></i>
            </button>
        ` : '';
        
        tr.innerHTML = `
          <td>${formatDate(lancamento.data)}</td>
          <td>
            <div style="font-weight:700">${lancamento.descricao}</div>
            ${lancamento.observacoes ? `<div style="font-size:12px;color:var(--muted)">${lancamento.observacoes}</div>` : ''}
            ${lancamento.parcelaAtual ? `<div style="font-size:11px;color:var(--muted)">Parcela ${lancamento.parcelaAtual}/${lancamento.numeroParcelas}</div>` : ''}
          </td>
          <td>${parceiro ? parceiro.nome : '---'}</td>
          <td>${categoria ? categoria.nome : '---'}</td>
          <td>
            <div style="font-weight:800;color:${lancamento.tipo === 'despesa' ? '#E74C3C' : '#2ECC71'}">
              ${formatMoney(lancamento.valor)}
            </div>
          </td>
          <td>
            <span class="status-badge ${lancamento.pago ? 'status-ativo' : 'status-inativo'}">
              <i class="fas ${lancamento.pago ? 'fa-check' : 'fa-clock'}"></i>
              ${lancamento.pago ? 'Realizado' : 'N√£o Realizado'}
            </span>
          </td>
          <td style="white-space: nowrap;">
            <button class="btn small" onclick="editarLancamento('${lancamento.id}')" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            ${botaoRealizar}
            <button class="btn small" onclick="excluirLancamento('${lancamento.id}')" 
              style="background:#FBEAEA;color:#E74C3C;margin-left:4px" title="Excluir">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        body.appendChild(tr);
      });
    }

    // ---------- FORMUL√ÅRIO DE LAN√áAMENTOS (REFATORADO) ----------
    function abrirFormLancamento(lancamentoId = null) {
      if (!currentUser) {
        showError('Fa√ßa login para continuar');
        return;
      }
      
      lancamentoEditando = lancamentoId ? dataLancamentos.find(l => l.id === lancamentoId) : null;
      const body = document.getElementById('modal-lancamento-body');
      
      // Filtrar dados ativos para os dropdowns - CORRE√á√ÉO: garantir que pega apenas do usu√°rio logado
      const categoriasAtivas = dataCategorias.filter(c => c.ativo && c.userId === currentUser.uid);
      const parceirosAtivos = dataParceiros.filter(p => p.ativo && p.userId === currentUser.uid);
      const contasAtivas = dataSaldos.filter(c => c.ativo && c.userId === currentUser.uid);
      const formasPagamentoAtivas = dataFormasPagamento.filter(f => f.ativo && f.userId === currentUser.uid);
      
      body.innerHTML = `
        <div class="form-row">
          <div>
            <label>Tipo *</label>
            <select id="l_tipo" onchange="atualizarCamposPorTipo()">
              <option value="">Selecione o tipo...</option>
              <option value="receita" ${lancamentoEditando && lancamentoEditando.tipo === 'receita' ? 'selected' : ''}>Receita</option>
              <option value="despesa" ${lancamentoEditando && lancamentoEditando.tipo === 'despesa' ? 'selected' : ''}>Despesa</option>
              <option value="transferencia" ${lancamentoEditando && lancamentoEditando.tipo === 'transferencia' ? 'selected' : ''}>Transfer√™ncia</option>
            </select>
          </div>
          <div id="container-descricao"> <label>Descri√ß√£o *</label>
            <input id="l_descricao" value="${lancamentoEditando ? lancamentoEditando.descricao : ''}" 
                   placeholder="Descri√ß√£o do lan√ßamento">
            <div class="error-message" id="error-descricao"></div>
          </div>
        </div>
        
        <div class="form-row">
          <div>
            <label>Valor (R$) *</label>
            <input id="l_valor" type="number" step="0.01" 
                   value="${lancamentoEditando ? lancamentoEditando.valor : ''}" 
                   placeholder="0,00" oninput="atualizarCorValor()">
            <div class="error-message" id="error-valor"></div>
          </div>
          <div>
            <label>Data de Vencimento *</label>
            <input id="l_data" type="date" 
                   value="${lancamentoEditando ? lancamentoEditando.data : getTodayString()}">
          </div>
        </div>
        
        <div class="form-row">
          <div id="container-categoria"> <label>Categoria <span id="categoria-obrigatoria">*</span></label>
            <select id="l_categoria">
              <option value="">Selecione...</option>
              ${categoriasAtivas.map(cat => `
                <option value="${cat.id}" ${lancamentoEditando && lancamentoEditando.categoriaId === cat.id ? 'selected' : ''}>
                  ${cat.nome} (${cat.tipo === 'receita' ? 'Receita' : 'Despesa'})
                </option>
              `).join('')}
            </select>
            <div class="error-message" id="error-categoria"></div>
          </div>
          <div id="container-status"> <label>Status</label>
            <select id="l_pago">
              <option value="">Selecione o status...</option>
              <option value="true" ${lancamentoEditando && lancamentoEditando.pago ? 'selected' : ''}>Realizado</option>
              <option value="false" ${lancamentoEditando && !lancamentoEditando.pago ? 'selected' : ''}>N√£o Realizado</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div id="conta-origem-container">
            <label id="label-conta-origem">Conta Financeira *</label> 
            <select id="l_conta">
              <option value="">Selecione...</option>
              ${contasAtivas.map(conta => `
                <option value="${conta.id}" ${lancamentoEditando && lancamentoEditando.contaId === conta.id ? 'selected' : ''}>
                  ${conta.nome} (${formatMoney(conta.valor)})
                </option>
              `).join('')}
            </select>
            <div class="error-message" id="error-conta"></div>
          </div>
          <div id="conta-destino-container" class="conditional-field">
            <label id="label-conta-destino">Conta de Destino *</label>
            <select id="l_conta_destino">
              <option value="">Selecione...</option>
              ${contasAtivas.map(conta => `
                <option value="${conta.id}" ${lancamentoEditando && lancamentoEditando.contaDestinoId === conta.id ? 'selected' : ''}>
                  ${conta.nome} (${formatMoney(conta.valor)})
                </option>
              `).join('')}
            </select>
            <div class="error-message" id="error-conta-destino"></div>
          </div>
        </div>
        
        <div class="form-row">
          <div id="container-forma-pagamento"> <label>Forma de Pagamento</label>
            <select id="l_forma_pagamento" onchange="atualizarCampoParcelas()">
              <option value="">Selecione...</option>
              ${formasPagamentoAtivas.map(forma => `
                <option value="${forma.id}" ${lancamentoEditando && lancamentoEditando.formaPagamentoId === forma.id ? 'selected' : ''}>
                  ${forma.descricao}
                </option>
              `).join('')}
            </select>
          </div>
          <div id="parcelas-container" class="conditional-field">
            <label>N√∫mero de Parcelas</label>
            <select id="l_parcelas">
              <option value="1">1x</option>
              <option value="2">2x</option>
              <option value="3">3x</option>
              <option value="4">4x</option>
              <option value="5">5x</option>
              <option value="6">6x</option>
              <option value="7">7x</option>
              <option value="8">8x</option>
              <option value="9">9x</option>
              <option value="10">10x</option>
              <option value="11">11x</option>
              <option value="12">12x</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div id="container-parceiro"> <label>Parceiro</label>
            <select id="l_parceiro">
              <option value="">Selecione...</option>
              ${parceirosAtivos.map(parceiro => `
                <option value="${parceiro.id}" ${lancamentoEditando && lancamentoEditando.parceiroId === parceiro.id ? 'selected' : ''}>
                  ${parceiro.nome}
                </option>
              `).join('')}
            </select>
          </div>
        </div>
        
        <div style="margin-top:12px">
          <label id="label-observacoes">Observa√ß√µes</label> <textarea id="l_observacoes" rows="3" placeholder="Observa√ß√µes adicionais...">${lancamentoEditando ? (lancamentoEditando.observacoes || '') : ''}</textarea>
        </div>
        
        <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px">
          <button class="btn" onclick="fecharModalLancamento()">Cancelar</button>
          <button class="btn primary" onclick="salvarLancamento()">
            ${lancamentoEditando ? 'Atualizar' : 'Salvar'} Lan√ßamento
          </button>
        </div>
      `;
      
      // Inicializar campos baseados no tipo
      atualizarCamposPorTipo();
      atualizarCorValor();
      atualizarCampoParcelas();
      
      // MUDAN√áA 2: Adicionar verifica√ß√£o de campos preenchidos
      setTimeout(() => {
        verificarCamposPreenchidos();
        adicionarListenersCampos();
      }, 100);
      
      document.getElementById('modal-lancamento-title').textContent = 
        lancamentoEditando ? 'Editar Lan√ßamento' : 'Novo Lan√ßamento';
      document.getElementById('modal-lancamento').style.display = 'flex';
    }

    // ---------- FUN√á√ÉO ATUALIZADA (UX DE TRANSFER√äNCIA) ----------
    function atualizarCamposPorTipo() {
      const tipo = document.getElementById('l_tipo').value;
      const contaDestinoContainer = document.getElementById('conta-destino-container');
      
      // Elementos a serem controlados
      const containerDescricao = document.getElementById('container-descricao');
      const containerCategoria = document.getElementById('container-categoria');
      const containerFormaPagamento = document.getElementById('container-forma-pagamento');
      const containerParceiro = document.getElementById('container-parceiro');
      const categoriaObrigatoriaSpan = document.getElementById('categoria-obrigatoria');
      const categoriaSelect = document.getElementById('l_categoria');
      const observacoesTextarea = document.getElementById('l_observacoes');
      const descricaoInput = document.getElementById('l_descricao');
      const statusSelect = document.getElementById('l_pago');

      const labelContaOrigem = document.getElementById('label-conta-origem');
      const labelContaDestino = document.getElementById('label-conta-destino');
      
      // Cont√™ineres a serem ocultados na Transfer√™ncia
      const camposOcultos = [containerCategoria, containerFormaPagamento, containerParceiro];
      
      if (tipo === 'transferencia') {
        // VISIBILIDADE: Transfer√™ncia
        contaDestinoContainer.classList.add('visible');
        
        // OCULTAR CAMPOS IRRELEVANTES (INCLUINDO DESCRI√á√ÉO)
        if (containerDescricao) containerDescricao.style.display = 'none'; // NOVO: OCULTA DESCRI√á√ÉO
        camposOcultos.forEach(el => el ? el.style.display = 'none' : null);
        
        // √çCONES INTUITIVOS (NOVO)
        if (labelContaOrigem) {
            labelContaOrigem.innerHTML = 'Conta de Origem <i class="fas fa-arrow-up" style="color: #E74C3C; margin-left: 5px;"></i> *'; 
        }
        if (labelContaDestino) {
            labelContaDestino.innerHTML = 'Conta de Destino <i class="fas fa-arrow-down" style="color: #3498DB; margin-left: 5px;"></i> *';
        }
        
        // AUTO-PREENCHER STATUS (Visualmente "N√£o Realizado")
        if (statusSelect) {
            statusSelect.value = 'false'; // Valor visual padr√£o
            statusSelect.disabled = true; // Impedir altera√ß√£o pelo usu√°rio
        }
        
        // Descri√ß√£o e Categoria
        if (categoriaObrigatoriaSpan) {
            categoriaObrigatoriaSpan.textContent = '';
            categoriaObrigatoriaSpan.title = 'Opcional para transfer√™ncias';
        }
        if (categoriaSelect) {
            categoriaSelect.removeAttribute('required');
        }
        if (descricaoInput) {
            descricaoInput.placeholder = 'Descri√ß√£o (Opcional)';
        }

        // Limpar observa√ß√£o se for a padr√£o de transfer√™ncia para evitar redund√¢ncia (ser√° preenchido na grava√ß√£o)
        if (!lancamentoEditando && observacoesTextarea) {
            observacoesTextarea.value = '';
        }
        
      } else {
        // VISIBILIDADE: Receita/Despesa
        contaDestinoContainer.classList.remove('visible');
        
        // MOSTRAR CAMPOS RELEVANTES
        if (containerDescricao) containerDescricao.style.display = 'block'; // MOSTRAR
        camposOcultos.forEach(el => el ? el.style.display = 'block' : null);

        // Restaurar Labels
        if (labelContaOrigem) labelContaOrigem.innerHTML = 'Conta Financeira *';
        if (labelContaDestino) labelContaDestino.innerHTML = 'Conta de Destino *';
        
        // Restaurar Status
        if (statusSelect) statusSelect.disabled = false;
        
        // Categoria obrigat√≥ria
        if (categoriaObrigatoriaSpan) categoriaObrigatoriaSpan.textContent = '*';
        if (categoriaSelect) categoriaSelect.setAttribute('required', 'required');

        // Limpar placeholder de Descri√ß√£o
        if (descricaoInput) descricaoInput.placeholder = 'Descri√ß√£o do lan√ßamento';
      }
      
      atualizarCorValor();
      atualizarCampoParcelas();
      verificarCamposPreenchidos(); 
    }

    function atualizarCorValor() {
      const tipo = document.getElementById('l_tipo').value;
      const valorInput = document.getElementById('l_valor');
      
      if (tipo === 'despesa') {
        valorInput.style.color = '#E74C3C';
      } else {
        valorInput.style.color = '#2ECC71';
      }
    }

    function atualizarCampoParcelas() {
      const formaPagamentoId = document.getElementById('l_forma_pagamento').value;
      const parcelasContainer = document.getElementById('parcelas-container');
      const parcelasSelect = document.getElementById('l_parcelas');
      
      if (!formaPagamentoId) {
        parcelasContainer.classList.remove('visible');
        return;
      }
      
      const formaPagamento = dataFormasPagamento.find(f => f.id === formaPagamentoId);
      
      if (formaPagamento && formaPagamento.permiteParcelamento) {
        parcelasContainer.classList.add('visible');
        
        // Atualizar op√ß√µes de parcelas baseado no m√°ximo permitido
        const maxParcelas = formaPagamento.maxParcelas || 12;
        parcelasSelect.innerHTML = '';
        
        for (let i = 1; i <= maxParcelas; i++) {
          parcelasSelect.innerHTML += `<option value="${i}">${i}x</option>`;
        }
        
        if (lancamentoEditando && lancamentoEditando.numeroParcelas) {
          parcelasSelect.value = lancamentoEditando.numeroParcelas;
        }
      } else {
        parcelasContainer.classList.remove('visible');
        parcelasSelect.value = '1';
      }
    }

    // ---------- VALIDA√á√ïES DE FORMUL√ÅRIO APRIMORADAS (COM EXCE√á√ÉO DE DESCRI√á√ÉO) ----------
    function validarFormularioLancamento() {
        let isValid = true;
        const tipo = document.getElementById('l_tipo').value;

        // Limpar erros anteriores
        document.querySelectorAll('.error-message').forEach(el => {
            el.classList.remove('visible');
        });
        
        // Validar campos obrigat√≥rios
        const campos = [
            { id: 'l_tipo', mensagem: 'Tipo √© obrigat√≥rio' },
            { id: 'l_descricao', mensagem: 'Descri√ß√£o √© obrigat√≥ria', ignoraTransferencia: true }, // NOVO: Ignora para Transfer√™ncia
            { id: 'l_valor', mensagem: 'Valor deve ser maior que zero' },
            { id: 'l_data', mensagem: 'Data √© obrigat√≥ria' },
            { id: 'l_pago', mensagem: 'Status √© obrigat√≥rio' },
            { id: 'l_conta', mensagem: 'Conta financeira √© obrigat√≥ria' }
        ];
        
        campos.forEach(campo => {
            // Se for Transfer√™ncia, ignora a valida√ß√£o de Descri√ß√£o.
            if (campo.ignoraTransferencia && tipo === 'transferencia') return; 

            const element = document.getElementById(campo.id);
            const errorElement = document.getElementById(`error-${campo.id.replace('l_', '')}`);
            
            if (!element || !element.value) {
                if (errorElement) {
                    errorElement.textContent = campo.mensagem;
                    errorElement.classList.add('visible');
                }
                isValid = false;
            }
        });
        
        // Valida√ß√£o espec√≠fica para valor
        const valor = parseFloat(document.getElementById('l_valor').value);
        if (!valor || valor <= 0) {
            const errorElement = document.getElementById('error-valor');
            if (errorElement) {
                errorElement.textContent = 'Valor deve ser maior que zero';
                errorElement.classList.add('visible');
            }
            isValid = false;
        }
        
        // Valida√ß√£o condicional da categoria
        const categoriaId = document.getElementById('l_categoria').value;
        if (tipo !== 'transferencia' && !categoriaId) {
            const errorElement = document.getElementById('error-categoria');
            if (errorElement) {
                errorElement.textContent = 'Categoria √© obrigat√≥ria para receitas e despesas';
                errorElement.classList.add('visible');
            }
            isValid = false;
        }
        
        // Valida√ß√£o para transfer√™ncia
        if (tipo === 'transferencia') {
            const contaDestinoId = document.getElementById('l_conta_destino').value;
            const contaOrigemId = document.getElementById('l_conta').value;
            
            if (!contaDestinoId) {
                const errorElement = document.getElementById('error-conta-destino');
                if (errorElement) {
                    errorElement.textContent = 'Conta de destino √© obrigat√≥ria para transfer√™ncias';
                    errorElement.classList.add('visible');
                }
                isValid = false;
            }
            
            if (contaOrigemId === contaDestinoId) {
                const errorElement = document.getElementById('error-conta-destino');
                if (errorElement) {
                    errorElement.textContent = 'Conta de origem e destino n√£o podem ser iguais';
                    errorElement.classList.add('visible');
                }
                isValid = false;
            }
        }
        
        return isValid;
    }

    function coletarDadosFormularioLancamento() {
        const tipo = document.getElementById('l_tipo').value;
        
        // NOVO: Coleta o status. Se for transfer√™ncia, o valor l√≥gico 'pago' ser√° for√ßado a true 
        // na fun√ß√£o criarLancamentoTransferencia, mas o valor que sai do formul√°rio √© 'false' (N√£o Realizado).
        let statusPago = document.getElementById('l_pago').value === 'true';

        return {
            descricao: document.getElementById('l_descricao').value.trim(),
            tipo: tipo,
            valor: parseFloat(document.getElementById('l_valor').value),
            data: document.getElementById('l_data').value,
            pago: statusPago, 
            categoriaId: tipo !== 'transferencia' ? document.getElementById('l_categoria').value : null,
            contaId: document.getElementById('l_conta').value,
            formaPagamentoId: document.getElementById('l_forma_pagamento').value || null,
            numeroParcelas: parseInt(document.getElementById('l_parcelas')?.value || '1'),
            parceiroId: document.getElementById('l_parceiro').value || null,
            observacoes: document.getElementById('l_observacoes').value.trim(),
            contaDestinoId: tipo === 'transferencia' ? document.getElementById('l_conta_destino').value : null
        };
    }

    async function atualizarLancamentoExistente(dados) {
        await db.collection('lancamentos').doc(lancamentoEditando.id).update({
            ...dados,
            dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Atualizar localmente
        const index = dataLancamentos.findIndex(l => l.id === lancamentoEditando.id);
        if (index !== -1) {
            dataLancamentos[index] = { ...dataLancamentos[index], ...dados };
        }
    }

	async function criarNovoLancamento(dados) {
		
		const lancamentoBaseComMeta = {
			...dados,
			userId: currentUser.uid, 
			dataCriacao: firebase.firestore.FieldValue.serverTimestamp(),
			dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
		};
		
		if (lancamentoBaseComMeta.tipo === 'transferencia') {
			// FLUXO PRINCIPAL DE TRANSFER√äNCIA: Cria dois registros em lote e move o saldo.
			await criarLancamentoTransferencia(lancamentoBaseComMeta);
			
		} else if (lancamentoBaseComMeta.numeroParcelas > 1) {
			// L√≥gica de parcelamento (para Receita/Despesa parcelada)
			await criarLancamentosParcelados(lancamentoBaseComMeta); 
			
		} else {
			// Lan√ßamento √önico (Receita/Despesa simples)
			const docRef = await db.collection('lancamentos').add(lancamentoBaseComMeta);
			lancamentoBaseComMeta.id = docRef.id;
			dataLancamentos.unshift(lancamentoBaseComMeta); 
			
			if (document.getElementById('lancamentos').style.display === 'block') {
				carregarLancamentosMes();
			}
		}
	}
	
//-------------‚ö†Ô∏è aten√ß√£o Corre√ß√£o ‚ö†Ô∏è -------------------------------------------------------------//
	
// ---------- FUN√á√ÉO REFATORADA: CRIA DUPLO REGISTRO DE TRANSFER√äNCIA COM AJUSTE DE SALDO ----------
	async function criarLancamentoTransferencia(lancamentoBase) {
		const batch = db.batch();
		const novosLancamentos = [];
		
		// NOVO: For√ßar o status pago como verdadeiro no momento de salvar (opera√ß√£o at√¥mica)
		lancamentoBase.pago = true;
		
		const contaOrigem = getContaById(lancamentoBase.contaId)?.nome || 'Conta Origem';
		const contaDestino = getContaById(lancamentoBase.contaDestinoId)?.nome || 'Conta Destino';
		
		// Gerar um ID √∫nico para vincular os dois lan√ßamentos
		const transferenciaGrupoId = db.collection('lancamentos').doc().id; 
		
		// --- 1. Lan√ßamento de SA√çDA (Despesa na Conta de Origem) ---
		const saidaDocRef = db.collection('lancamentos').doc();
		const lancamentoSaida = {
			...lancamentoBase,
			id: saidaDocRef.id,
			tipo: 'despesa', // Tipo de movimenta√ß√£o √© Despesa
			contaId: lancamentoBase.contaId, // Conta de Origem
			
			// GARANTINDO A DATA CORRETA
			data: lancamentoBase.data, 
			
			// Campos nulos/limpos
			contaDestinoId: null, 
			categoriaId: null,
			parceiroId: null,
			formaPagamentoId: null,
			
			// DESCRI√á√ÉO SIMPLIFICADA (Sem valor)
			descricao: `Transfer√™ncia para ${contaDestino}`,
			
			// OBSERVA√á√ÉO LIMPA (Sem ID de refer√™ncia no texto)
			observacoes: `SA√çDA por Transfer√™ncia.`, 
			referenciaTransferenciaId: transferenciaGrupoId, // Mant√©m a refer√™ncia apenas internamente
		};
		batch.set(saidaDocRef, lancamentoSaida);
		novosLancamentos.push(lancamentoSaida);
		
		// --- 2. Lan√ßamento de ENTRADA (Receita na Conta de Destino) ---
		const entradaDocRef = db.collection('lancamentos').doc();
		const lancamentoEntrada = {
			...lancamentoBase,
			id: entradaDocRef.id,
			tipo: 'receita', // Tipo de movimenta√ß√£o √© Receita
			contaId: lancamentoBase.contaDestinoId, // Conta de Destino
			
			// GARANTINDO A DATA CORRETA
			data: lancamentoBase.data,
			
			// Campos nulos/limpos
			contaDestinoId: null,
			categoriaId: null,
			parceiroId: null,
			formaPagamentoId: null,

			// DESCRI√á√ÉO SIMPLIFICADA (Sem valor)
			descricao: `Transfer√™ncia de ${contaOrigem}`,
			
			// OBSERVA√á√ÉO LIMPA (Sem ID de refer√™ncia no texto)
			observacoes: `ENTRADA por Transfer√™ncia.`,
			referenciaTransferenciaId: transferenciaGrupoId,
		};
		batch.set(entradaDocRef, lancamentoEntrada);
		novosLancamentos.push(lancamentoEntrada);

		// Salvar os dois lan√ßamentos no Firebase em lote (atomicamente)
		await batch.commit();
		showSuccess('Transfer√™ncia realizada com sucesso!');

		// AJUSTE DE SALDO IMEDIATO
		const valorMovimento = lancamentoBase.valor;
		await ajustarSaldoConta(lancamentoBase.contaId, valorMovimento * -1); // Sa√≠da (D√©bito da Origem)
		await ajustarSaldoConta(lancamentoBase.contaDestinoId, valorMovimento); // Entrada (Cr√©dito no Destino)
		
		// Atualizar localmente
		dataLancamentos.unshift(...novosLancamentos);
		
		// Se o modal estiver aberto na tela de lan√ßamentos, recarrega
		if (document.getElementById('lancamentos').style.display === 'block') {
			carregarLancamentosMes();
		}
	}

//-------------‚ö†Ô∏è aten√ß√£o Corre√ß√£o ‚ö†Ô∏è -------------------------------------------------------------//

		async function salvarLancamento() {
			if (!currentUser) {
				showError('Fa√ßa login para continuar');
				return;
			}
			
			// NOVO: Diagn√≥stico visual se a valida√ß√£o falhar
			if (!validarFormularioLancamento()) {
                showError('Por favor, corrija os campos obrigat√≥rios.');
				return;
			}
			
			const novosDados = coletarDadosFormularioLancamento();
			
			try {
				if (lancamentoEditando) {
					// ************************************************
					// L√ìGICA DE REVERS√ÉO E AJUSTE DE SALDO AO EDITAR
					// ************************************************
					const antigoStatusPago = lancamentoEditando.pago;
					const novoStatusPago = novosDados.pago;
					
					// 1. Detectar revers√£o de Status (de PAGO para N√ÉO PAGO)
					if (antigoStatusPago && !novoStatusPago) {
						// Se estava pago e agora n√£o est√°, precisamos reverter o movimento!
						const valorReverso = lancamentoEditando.valor * (lancamentoEditando.tipo === 'despesa' ? 1 : -1); // Inverter o sinal
						
						// Se for Transfer√™ncia ou Despesa/Receita, a l√≥gica √© a mesma no novo modelo:
						// Simplesmente reverte o valor na conta.
						await ajustarSaldoConta(lancamentoEditando.contaId, valorReverso);
						
						// ATEN√á√ÉO: Se for um registro de Transfer√™ncia (Sa√≠da ou Entrada), a revers√£o no 
						// registro do Firestore √© suficiente, pois a outra ponta deve ser tratada pelo 
						// usu√°rio se ele quiser reverter a transfer√™ncia inteira.
						
					} 
					
					// 2. Detectar novo pagamento (de N√ÉO PAGO para PAGO)
					else if (!antigoStatusPago && novoStatusPago) {
						// Se n√£o estava pago e agora est√°, aplicar o movimento
						const valorAplicar = lancamentoEditando.valor * (lancamentoEditando.tipo === 'despesa' ? -1 : 1);
						
						// Simplesmente aplica o valor na conta.
						await ajustarSaldoConta(lancamentoEditando.contaId, valorAplicar);
					}
					
					// Salvar a atualiza√ß√£o do documento (Status, Descri√ß√£o, etc.)
					await atualizarLancamentoExistente(novosDados);
					showSuccess('Lan√ßamento atualizado com sucesso!');

					// ************************************************
					// FIM DA L√ìGICA DE REVERS√ÉO E AJUSTE AO EDITAR
					// ************************************************

				} else {
					// CRIA√á√ÉO DE NOVO LAN√áAMENTO (Transfer√™ncia √© tratada dentro de criarNovoLancamento)
					await criarNovoLancamento(novosDados);
					showSuccess('Lan√ßamento criado com sucesso!');
				}
				
				fecharModalLancamento();
				invalidateCache(); 
				
			// TRATAMENTO DE SALDO AP√ìS CRIA√á√ÉO (Se for novo e pago, E N√ÉO FOR TRANSFER√äNCIA)
			if (!lancamentoEditando && novosDados.pago && novosDados.tipo !== 'transferencia') {
					
				// Aqui, ajustamos Receita/Despesa simples (Transfer√™ncia j√° ajustou o saldo no Passo 2)
				const valorFinal = novosDados.valor * (novosDados.tipo === 'despesa' ? -1 : 1);
				await ajustarSaldoConta(novosDados.contaId, valorFinal);
			}
				
				if (document.getElementById('lancamentos').style.display === 'block') {
					carregarLancamentosMes();
				} 
				
				atualizarCardsContasPendentes();
				
			} catch (error) {
				console.error("‚ùå Erro ao salvar lan√ßamento:", error);
				showError("Erro ao salvar o lan√ßamento: " + error.message);
			}
		}
	
	async function criarLancamentosParcelados(lancamentoBase) {
		  const numeroParcelas = lancamentoBase.numeroParcelas;
		  const valorParcela = lancamentoBase.valor / numeroParcelas;
		  const dataBase = new Date(lancamentoBase.data);
		  
		  const batch = db.batch();
		  const novosLancamentos = [];
		  
		  for (let i = 0; i < numeroParcelas; i++) {
			const dataParcela = new Date(dataBase);
			dataParcela.setMonth(dataParcela.getMonth() + i);
			
			// Usamos o lancamentoBase (que agora tem o userId) e sobrescrevemos apenas o necess√°rio
			const lancamentoParcela = {
			  ...lancamentoBase,
			  valor: valorParcela,
			  data: dataParcela.toISOString().slice(0, 10),
			  parcelaAtual: i + 1,
			  // Novo formato de observa√ß√£o para incluir a parcela
			  observacoes: `${lancamentoBase.observacoes || ''} (Parcela ${i + 1}/${numeroParcelas})`.trim(), 
			  dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
			};
			
			const docRef = db.collection('lancamentos').doc();
			batch.set(docRef, lancamentoParcela);
			
			novosLancamentos.push({ id: docRef.id, ...lancamentoParcela });
			}
		  
		 await batch.commit(); // ‚úÖ O commit do lote agora deve passar na regra de seguran√ßa
		  
		 // Adicionar localmente
		 dataLancamentos.unshift(...novosLancamentos);
		  
		 // ‚úÖ CORRE√á√ÉO: For√ßar atualiza√ß√£o imediata da tela se estiver vis√≠vel
		 if (document.getElementById('lancamentos').style.display === 'block') {
			  carregarLancamentosMes();
		 }
	}	

    function editarLancamento(lancamentoId) {
      abrirFormLancamento(lancamentoId);
    }


		async function excluirLancamento(lancamentoId) {
		if (!confirm('Tem certeza que deseja excluir este lan√ßamento?')) {
			return;
		}

		const lancamento = dataLancamentos.find(l => l.id === lancamentoId);
		if (!lancamento) return;
		
		try {
			// ************************************************
			// NOVO: L√ìGICA DE REVERS√ÉO ANTES DE EXCLUIR (SIMPLIFICADO)
			// ************************************************
			if (lancamento.pago) {
				// Se o lan√ßamento estava pago, aplicamos a revers√£o.
				// O valor reverso de uma Despesa (tipo: 'despesa') √© positivo.
				// O valor reverso de uma Receita (tipo: 'receita') √© negativo.
				
				// 1. Calcular o valor reverso
				const valorReverso = lancamento.valor * (lancamento.tipo === 'despesa' ? 1 : -1); 
				
				// 2. Ajustamos o saldo da conta vinculada a este registro.
				await ajustarSaldoConta(lancamento.contaId, valorReverso);
			}
			// ************************************************
			
			await db.collection('lancamentos').doc(lancamentoId).delete();
			
			// Remover localmente
			dataLancamentos = dataLancamentos.filter(l => l.id !== lancamentoId);
			invalidateCache();
			carregarLancamentosMes();
			renderDashboard();
			renderSaldos();
			atualizarCardsContasPendentes();
			showSuccess('Lan√ßamento exclu√≠do com sucesso!');
			
		} catch (error) {
			console.error("Erro ao excluir lan√ßamento:", error);
			showError("Erro ao excluir o lan√ßamento.");
		}
	}


    function fecharModalLancamento() {
      document.getElementById('modal-lancamento').style.display = 'none';
      lancamentoEditando = null;
    }
	

    // ========== CONTAS FINANCEIRAS ==========

    function renderTabelaContas() {
        const body = document.getElementById('tabela-contas-body');
        if (!body) return;
        
        const filtroTipo = document.getElementById('filtro-tipo-conta')?.value || '';
        const filtroStatus = document.getElementById('filtro-status-conta')?.value || '';
        const filtroTexto = (document.getElementById('filtro-text-conta')?.value || '').toLowerCase();
        
        body.innerHTML = '';
        
        const contasFiltradas = dataSaldos.filter(c => {
            const matchTipo = filtroTipo ? c.tipo === filtroTipo : true;
            const matchStatus = filtroStatus ? 
                (filtroStatus === 'ativo' ? c.ativo === true : c.ativo === false) : true;
            const matchTexto = filtroTexto ? c.nome.toLowerCase().includes(filtroTexto) : true;
            
            return matchTipo && matchStatus && matchTexto;
        });
        
        contasFiltradas.forEach(conta => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div style="font-weight:700">${conta.nome}</div>
                    ${conta.descricao ? `<div style="font-size:12px;color:var(--muted)">${conta.descricao}</div>` : ''}
                </td>
                <td>
                    <span class="tag ${conta.tipo}">
                        ${getTipoContaLabel(conta.tipo)}
                    </span>
                </td>
                <td>
                    <div style="font-weight:800;color:${conta.valor >= 0 ? '#2ECC71' : '#E74C3C'}">
                        ${formatMoney(conta.valor)}
                    </div>
                </td>
                <td>
                    <span class="status-badge ${conta.ativo ? 'status-ativo' : 'status-inativo'}">
                        <i class="fas ${conta.ativo ? 'fa-check' : 'fa-times'}"></i>
                        ${conta.ativo ? 'Ativo' : 'Inativo'}
                    </span>
                </td>
                <td>
                    <button class="btn small" onclick="editarConta('${conta.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn small" onclick="excluirConta('${conta.id}')" 
                        style="background:#FBEAEA;color:#E74C3C;margin-left:4px">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            body.appendChild(tr);
        });
    }

    function getTipoContaLabel(tipo) {
        const tipos = {
            'corrente': 'Conta Corrente',
            'poupanca': 'Poupan√ßa',
            'carteira': 'Carteira',
            'investimento': 'Investimento',
            'outro': 'Outro'
        };
        return tipos[tipo] || tipo;
    }

    function abrirFormConta(contaId = null) {
        if (!currentUser) {
            showError('Fa√ßa login para continuar');
            return;
        }
        
        const conta = contaId ? dataSaldos.find(c => c.id === contaId) : null;
        const body = document.getElementById('modal-body');
        
        body.innerHTML = `
            <div class="form-row">
                <div>
                    <label>Nome da Conta *</label>
                    <input id="ct_nome" value="${conta ? conta.nome : ''}" 
                           placeholder="Ex: Banco X, Carteira, Poupan√ßa...">
                    <div class="error-message" id="error-nome-conta"></div>
                </div>
                <div>
                    <label>Tipo *</label>
                    <select id="ct_tipo">
                        <option value="corrente" ${conta && conta.tipo === 'corrente' ? 'selected' : ''}>Conta Corrente</option>
                        <option value="poupanca" ${conta && conta.tipo === 'poupanca' ? 'selected' : ''}>Poupan√ßa</option>
                        <option value="carteira" ${conta && conta.tipo === 'carteira' ? 'selected' : ''}>Carteira</option>
                        <option value="investimento" ${conta && conta.tipo === 'investimento' ? 'selected' : ''}>Investimento</option>
                        <option value="outro" ${conta && conta.tipo === 'outro' ? 'selected' : ''}>Outro</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label>Saldo Inicial (R$)</label>
                    <input id="ct_valor" type="number" step="0.01" value="${conta ? conta.valor : '0'}" placeholder="0,00">
                </div>
                <div>
                    <label>Status</label>
                    <select id="ct_ativo">
                        <option value="true" ${conta && conta.ativo !== false ? 'selected' : ''}>Ativo</option>
                        <option value="false" ${conta && !conta.ativo ? 'selected' : ''}>Inativo</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top:12px">
                <label>Descri√ß√£o</label>
                <textarea id="ct_descricao" rows="3" placeholder="Descri√ß√£o opcional da conta...">${conta ? (conta.descricao || '') : ''}</textarea>
            </div>
            
            <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
                <button class="btn" onclick="fecharModal()">Cancelar</button>
                <button class="btn primary" onclick="salvarConta('${contaId || ''}')">
                    ${contaId ? 'Atualizar' : 'Salvar'} Conta
                </button>
            </div>
        `;
        
        abrirModal(contaId ? 'Editar Conta' : 'Nova Conta');
    }

    async function salvarConta(contaId = null) {
        if (!currentUser) {
            showError('Fa√ßa login para continuar');
            return;
        }
        
        // Valida√ß√µes
        const nome = document.getElementById('ct_nome').value.trim();
        const tipo = document.getElementById('ct_tipo').value;
        const valor = parseFloat(document.getElementById('ct_valor').value || 0);
        const descricao = document.getElementById('ct_descricao').value.trim();
        const ativo = document.getElementById('ct_ativo').value === 'true';
        
        // Validar campos obrigat√≥rios
        if (!nome) {
            document.getElementById('error-nome-conta').textContent = 'Nome √© obrigat√≥rio';
            document.getElementById('error-nome-conta').classList.add('visible');
            return;
        } else {
            document.getElementById('error-nome-conta').classList.remove('visible');
        }
        
        const contaData = {
            nome: nome,
            tipo: tipo,
            valor: valor,
            descricao: descricao,
            ativo: ativo,
            userId: currentUser.uid,
            dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        try {
            if (contaId) {
                // Editar conta existente
                await db.collection('contas').doc(contaId).update(contaData);
                
                // Atualizar localmente
                const index = dataSaldos.findIndex(c => c.id === contaId);
                if (index !== -1) {
                    dataSaldos[index] = { ...dataSaldos[index], ...contaData };
                }
                showSuccess('Conta atualizada com sucesso!');
            } else {
                // Nova conta
                contaData.dataCriacao = firebase.firestore.FieldValue.serverTimestamp();
                const docRef = await db.collection('contas').add(contaData);
                contaData.id = docRef.id;
                dataSaldos.unshift(contaData);
                showSuccess('Conta criada com sucesso!');
            }
            
            fecharModal();
            invalidateCache();
            renderTabelaContas();
            renderDashboard();
            renderSaldos();
            // ATUALIZADO: Atualizar contas pendentes
            atualizarCardsContasPendentes();
            
        } catch (error) {
            console.error("‚ùå Erro ao salvar conta:", error);
            showError("Erro ao salvar a conta: " + error.message);
        }
    }

    function editarConta(contaId) {
        abrirFormConta(contaId);
    }

    async function excluirConta(contaId) {
        const conta = dataSaldos.find(c => c.id === contaId);
        
        if (!conta) return;
        
        // Verificar se existem lan√ßamentos vinculados a esta conta
        const lancamentosComConta = dataLancamentos.filter(l => l.contaId === contaId);
        if (lancamentosComConta.length > 0) {
            const confirmar = confirm(`Esta conta est√° sendo usada em ${lancamentosComConta.length} lan√ßamento(s). Deseja realmente excluir?`);
            if (!confirmar) return;
        }
        
        if (!confirm('Tem certeza que deseja excluir esta conta?')) {
            return;
        }
        
        try {
            await db.collection('contas').doc(contaId).delete();
            
            // Remover localmente
            dataSaldos = dataSaldos.filter(c => c.id !== contaId);
            invalidateCache();
            renderTabelaContas();
            renderDashboard();
            renderSaldos();
            // ATUALIZADO: Atualizar contas pendentes
            atualizarCardsContasPendentes();
            showSuccess('Conta exclu√≠da com sucesso!');
            
        } catch (error) {
            console.error("Erro ao excluir conta:", error);
            showError("Erro ao excluir a conta.");
        }
    }

    // ========== SETORES (CENTRO DE CUSTO) ==========

    function renderTabelaSetores() {
        const body = document.getElementById('tabela-setores-body');
        if (!body) return;
        
        const filtroStatus = document.getElementById('filtro-status-setor')?.value || '';
        const filtroTexto = (document.getElementById('filtro-text-setor')?.value || '').toLowerCase();
        
        body.innerHTML = '';
        
        const setoresFiltrados = dataSetores.filter(s => {
            const matchStatus = filtroStatus ? 
                (filtroStatus === 'ativo' ? s.ativo === true : s.ativo === false) : true;
            const matchTexto = filtroTexto ? s.descricao.toLowerCase().includes(filtroTexto) : true;
            
            return matchStatus && matchTexto;
        });
        
        setoresFiltrados.forEach(setor => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div style="font-weight:700">${setor.descricao}</div>
                </td>
                <td>
                    <span class="status-badge ${setor.ativo ? 'status-ativo' : 'status-inativo'}">
                        <i class="fas ${setor.ativo ? 'fa-check' : 'fa-times'}"></i>
                        ${setor.ativo ? 'Ativo' : 'Inativo'}
                    </span>
                </td>
                <td>
                    <button class="btn small" onclick="editarSetor('${setor.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn small" onclick="excluirSetor('${setor.id}')" 
                        style="background:#FBEAEA;color:#E74C3C;margin-left:4px">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            body.appendChild(tr);
        });
    }

    function abrirFormSetor(setorId = null) {
        if (!currentUser) {
            showError('Fa√ßa login para continuar');
            return;
        }
        
        const setor = setorId ? dataSetores.find(s => s.id === setorId) : null;
        const body = document.getElementById('modal-body');
        
        body.innerHTML = `
            <div class="form-row">
                <div>
                    <label>Descri√ß√£o do Setor *</label>
                    <input id="s_descricao" value="${setor ? setor.descricao : ''}" 
                           placeholder="Ex: Administrativo, Comercial, Produ√ß√£o...">
                    <div class="error-message" id="error-descricao-setor"></div>
                </div>
                <div>
                    <label>Status</label>
                    <select id="s_ativo">
                        <option value="true" ${setor && setor.ativo !== false ? 'selected' : ''}>Ativo</option>
                        <option value="false" ${setor && !setor.ativo ? 'selected' : ''}>Inativo</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
                <button class="btn" onclick="fecharModal()">Cancelar</button>
                <button class="btn primary" onclick="salvarSetor('${setorId || ''}')">
                    ${setorId ? 'Atualizar' : 'Salvar'} Setor
                </button>
            </div>
        `;
        
        abrirModal(setorId ? 'Editar Setor' : 'Novo Setor');
    }

    async function salvarSetor(setorId = null) {
        if (!currentUser) {
            showError('Fa√ßa login para continuar');
            return;
        }
        
        // Valida√ß√µes
        const descricao = document.getElementById('s_descricao').value.trim();
        const ativo = document.getElementById('s_ativo').value === 'true';
        
        // Validar campos obrigat√≥rios
        if (!descricao) {
            document.getElementById('error-descricao-setor').textContent = 'Descri√ß√£o √© obrigat√≥ria';
            document.getElementById('error-descricao-setor').classList.add('visible');
            return;
        } else {
            document.getElementById('error-descricao-setor').classList.remove('visible');
        }
        
        // Verificar se j√° existe setor com mesma descri√ß√£o
        const setorExistente = dataSetores.find(s => 
            s.descricao.toLowerCase() === descricao.toLowerCase() && 
            s.id !== setorId
        );
        
        if (setorExistente) {
            document.getElementById('error-descricao-setor').textContent = 'J√° existe um setor com esta descri√ß√£o';
            document.getElementById('error-descricao-setor').classList.add('visible');
            return;
        }
        
        const setorData = {
            descricao: descricao,
            ativo: ativo,
            userId: currentUser.uid,
            dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        try {
            if (setorId) {
                // Editar setor existente
                await db.collection('setores').doc(setorId).update(setorData);
                
                // Atualizar localmente
                const index = dataSetores.findIndex(s => s.id === setorId);
                if (index !== -1) {
                    dataSetores[index] = { ...dataSetores[index], ...setorData };
                }
                showSuccess('Setor atualizado com sucesso!');
            } else {
                // Novo setor
                setorData.dataCriacao = firebase.firestore.FieldValue.serverTimestamp();
                const docRef = await db.collection('setores').add(setorData);
                setorData.id = docRef.id;
                dataSetores.unshift(setorData);
                showSuccess('Setor criado com sucesso!');
            }
            
            fecharModal();
            invalidateCache();
            renderTabelaSetores();
            
        } catch (error) {
            console.error("‚ùå Erro ao salvar setor:", error);
            showError("Erro ao salvar o setor: " + error.message);
        }
    }

    function editarSetor(setorId) {
        abrirFormSetor(setorId);
    }

    async function excluirSetor(setorId) {
        const setor = dataSetores.find(s => s.id === setorId);
        
        if (!setor) return;
        
        // Verificar se existem lan√ßamentos vinculados a este setor
        const lancamentosComSetor = dataLancamentos.filter(l => l.setorId === setorId);
        if (lancamentosComSetor.length > 0) {
            const confirmar = confirm(`Este setor est√° sendo usado em ${lancamentosComSetor.length} lan√ßamento(s). Deseja realmente excluir?`);
            if (!confirmar) return;
        }
        
        if (!confirm('Tem certeza que deseja excluir este setor?')) {
            return;
        }
        
        try {
            await db.collection('setores').doc(setorId).delete();
            
            // Remover localmente
            dataSetores = dataSetores.filter(s => s.id !== setorId);
            invalidateCache();
            renderTabelaSetores();
            showSuccess('Setor exclu√≠do com sucesso!');
            
        } catch (error) {
            console.error("Erro ao excluir setor:", error);
            showError("Erro ao excluir o setor.");
        }
    }

    // ========== CATEGORIAS ==========

    function renderTabelaCategorias() {
        const body = document.getElementById('tabela-categorias-body');
        if (!body) return;
        
        const filtroTipo = document.getElementById('filtro-tipo-categoria')?.value || '';
        const filtroStatus = document.getElementById('filtro-status-categoria')?.value || '';
        const filtroTexto = (document.getElementById('filtro-text-categoria')?.value || '').toLowerCase();
        
        body.innerHTML = '';
        
        const categoriasFiltradas = dataCategorias.filter(c => {
            const matchTipo = filtroTipo ? c.tipo === filtroTipo : true;
            const matchStatus = filtroStatus ? 
                (filtroStatus === 'ativo' ? c.ativo === true : c.ativo === false) : true;
            const matchTexto = filtroTexto ? c.nome.toLowerCase().includes(filtroTexto) : true;
            
            return matchTipo && matchStatus && matchTexto;
        });
        
        categoriasFiltradas.forEach(categoria => {
            const tr = document.createElement('tr');
            
            // Buscar nome do setor baseado no setorId
            const setorNome = categoria.setorId ? 
                (dataSetores.find(s => s.id === categoria.setorId)?.descricao || 'Setor n√£o encontrado') : 
                '---';
                
            tr.innerHTML = `
                <td>
                    <div style="font-weight:700">${categoria.nome}</div>
                    ${categoria.descricao ? `<div style="font-size:12px;color:var(--muted)">${categoria.descricao}</div>` : ''}
                </td>
                <td>
                    <span class="tag ${categoria.tipo}">
                        ${categoria.tipo === 'receita' ? 'Receita' : 'Despesa'}
                    </span>
                </td>
                <td>
                    ${categoria.cor ? `
                        <div style="display:flex;align-items:center;gap:8px">
                            <div style="width:16px;height:16px;border-radius:50%;background:${categoria.cor};border:1px solid rgba(0,0,0,0.1)"></div>
                            <span style="font-size:12px">${categoria.cor}</span>
                        </div>
                    ` : '---'}
                </td>
                <td>
                    <div style="font-size:13px;color:var(--muted)">${setorNome}</div>
                </td>
                <td>
                    <span class="status-badge ${categoria.ativo ? 'status-ativo' : 'status-inativo'}">
                        <i class="fas ${categoria.ativo ? 'fa-check' : 'fa-times'}"></i>
                        ${categoria.ativo ? 'Ativo' : 'Inativo'}
                    </span>
                </td>
                <td>
                    <button class="btn small" onclick="editarCategoria('${categoria.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn small" onclick="excluirCategoria('${categoria.id}')" 
                        style="background:#FBEAEA;color:#E74C3C;margin-left:4px"
                        ${categoria.padrao ? 'disabled title="Categoria padr√£o n√£o pode ser exclu√≠da"' : ''}>
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            body.appendChild(tr);
        });
    }

    function abrirFormCategoria(categoriaId = null) {
        if (!currentUser) {
            showError('Fa√ßa login para continuar');
            return;
        }
        
        const categoria = categoriaId ? dataCategorias.find(c => c.id === categoriaId) : null;
        const body = document.getElementById('modal-body');
        
        // Filtrar setores ativos para o dropdown
        const setoresAtivos = dataSetores.filter(s => s.ativo);
        
        body.innerHTML = `
            <div class="form-row">
                <div>
                    <label>Nome da Categoria *</label>
                    <input id="c_nome" value="${categoria ? categoria.nome : ''}" 
                           placeholder="Ex: Alimenta√ß√£o, Sal√°rio, Transporte...">
                    <div class="error-message" id="error-nome-categoria"></div>
                </div>
                <div>
                    <label>Tipo *</label>
                    <select id="c_tipo">
                        <option value="receita" ${categoria && categoria.tipo === 'receita' ? 'selected' : ''}>Receita</option>
                        <option value="despesa" ${categoria && categoria.tipo === 'despesa' ? 'selected' : ''}>Despesa</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label>Cor de Identifica√ß√£o</label>
                    <div style="display:flex;gap:8px;align-items:center">
                        <input type="color" id="c_cor" value="${categoria ? (categoria.cor || '#2ECC71') : '#2ECC71'}" 
                               style="width:60px;height:40px;padding:2px">
                        <input type="text" id="c_cor_text" value="${categoria ? (categoria.cor || '#2ECC71') : '#2ECC71'}" 
                               placeholder="#2ECC71" style="flex:1" oninput="document.getElementById('c_cor').value = this.value">
                    </div>
                </div>
                <div>
                    <label>Setor (Centro de Custo)</label>
                    <select id="c_setor">
                        <option value="">Nenhum setor</option>
                        ${setoresAtivos.map(setor => `
                            <option value="${setor.id}" ${categoria && categoria.setorId === setor.id ? 'selected' : ''}>
                                ${setor.descricao}
                            </option>
                        `).join('')}
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label>Status</label>
                    <select id="c_ativo">
                        <option value="true" ${categoria && categoria.ativo !== false ? 'selected' : ''}>Ativo</option>
                        <option value="false" ${categoria && !categoria.ativo ? 'selected' : ''}>Inativo</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top:12px">
                <label>Descri√ß√£o</label>
                <textarea id="c_descricao" rows="3" placeholder="Descri√ß√£o opcional da categoria...">${categoria ? (categoria.descricao || '') : ''}</textarea>
            </div>
            
            ${categoria && categoria.padrao ? `
                <div style="margin-top:12px;padding:10px;background:#FFF3CD;border-radius:8px;border:1px solid #FFEAA7">
                    <i class="fas fa-info-circle" style="color:#856404"></i>
                    <span style="color:#856404;font-size:13px"> Esta √© uma categoria padr√£o do sistema.</span>
                </div>
            ` : ''}
            
            <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
                <button class="btn" onclick="fecharModal()">Cancelar</button>
                <button class="btn primary" onclick="salvarCategoria('${categoriaId || ''}')">
                    ${categoriaId ? 'Atualizar' : 'Salvar'} Categoria
                </button>
            </div>
        `;
        
        // Sincronizar campos de cor
        document.getElementById('c_cor').addEventListener('input', function(e) {
            document.getElementById('c_cor_text').value = e.target.value;
        });
        
        document.getElementById('c_cor_text').addEventListener('input', function(e) {
            document.getElementById('c_cor').value = e.target.value;
        });
        
        abrirModal(categoriaId ? 'Editar Categoria' : 'Nova Categoria');
    }

    async function salvarCategoria(categoriaId = null) {
        if (!currentUser) {
            showError('Fa√ßa login para continuar');
            return;
        }
        
        // Valida√ß√µes
        const nome = document.getElementById('c_nome').value.trim();
        const tipo = document.getElementById('c_tipo').value;
        const cor = document.getElementById('c_cor').value;
        const setorId = document.getElementById('c_setor').value || null;
        const descricao = document.getElementById('c_descricao').value.trim();
        const ativo = document.getElementById('c_ativo').value === 'true';
        
        // Validar campos obrigat√≥rios
        if (!nome) {
            document.getElementById('error-nome-categoria').textContent = 'Nome √© obrigat√≥rio';
            document.getElementById('error-nome-categoria').classList.add('visible');
            return;
        } else {
            document.getElementById('error-nome-categoria').classList.remove('visible');
        }
        
        // Verificar se j√° existe categoria com mesmo nome e tipo
        const categoriaExistente = dataCategorias.find(c => 
            c.nome.toLowerCase() === nome.toLowerCase() && 
            c.tipo === tipo && 
            c.id !== categoriaId
        );
        
        if (categoriaExistente) {
            document.getElementById('error-nome-categoria').textContent = 'J√° existe uma categoria com este nome e tipo';
            document.getElementById('error-nome-categoria').classList.add('visible');
            return;
        }
        
        const categoriaData = {
            nome: nome,
            tipo: tipo,
            cor: cor,
            setorId: setorId,
            descricao: descricao,
            ativo: ativo,
            userId: currentUser.uid,
            dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        try {
            if (categoriaId) {
                // Editar categoria existente - preservar campo 'padrao' se existir
                const categoriaOriginal = dataCategorias.find(c => c.id === categoriaId);
                if (categoriaOriginal && categoriaOriginal.padrao) {
                    categoriaData.padrao = true;
                }
                
                await db.collection('categorias').doc(categoriaId).update(categoriaData);
                
                // Atualizar localmente
                const index = dataCategorias.findIndex(c => c.id === categoriaId);
                if (index !== -1) {
                    dataCategorias[index] = { ...dataCategorias[index], ...categoriaData };
                }
                showSuccess('Categoria atualizada com sucesso!');
            } else {
                // Nova categoria
                categoriaData.dataCriacao = firebase.firestore.FieldValue.serverTimestamp();
                const docRef = await db.collection('categorias').add(categoriaData);
                categoriaData.id = docRef.id;
                dataCategorias.unshift(categoriaData);
                showSuccess('Categoria criada com sucesso!');
            }
            
            fecharModal();
            invalidateCache();
            renderTabelaCategorias();
            
        } catch (error) {
            console.error("‚ùå Erro ao salvar categoria:", error);
            showError("Erro ao salvar a categoria: " + error.message);
        }
    }

    function editarCategoria(categoriaId) {
        abrirFormCategoria(categoriaId);
    }

    async function excluirCategoria(categoriaId) {
        const categoria = dataCategorias.find(c => c.id === categoriaId);
        
        if (!categoria) return;
        
        // Impedir exclus√£o de categorias padr√£o
        if (categoria.padrao) {
            showError('Categorias padr√£o do sistema n√£o podem ser exclu√≠das.');
            return;
        }
        
        // Verificar se existem lan√ßamentos usando esta categoria
        const lancamentosComCategoria = dataLancamentos.filter(l => l.categoriaId === categoriaId);
        if (lancamentosComCategoria.length > 0) {
            const confirmar = confirm(`Esta categoria est√° sendo usada em ${lancamentosComCategoria.length} lan√ßamento(s). Deseja realmente excluir?`);
            if (!confirmar) return;
        }
        
        if (!confirm('Tem certeza que deseja excluir esta categoria?')) {
            return;
        }
        
        try {
            await db.collection('categorias').doc(categoriaId).delete();
            
            // Remover localmente
            dataCategorias = dataCategorias.filter(c => c.id !== categoriaId);
            invalidateCache();
            renderTabelaCategorias();
            showSuccess('Categoria exclu√≠da com sucesso!');
            
        } catch (error) {
            console.error("Erro ao excluir categoria:", error);
            showError("Erro ao excluir a categoria.");
        }
    }

    // ---------- PARCEIROS ----------
    
    function renderTabelaParceiros() {
        const body = document.getElementById('tabela-parceiros-body');
        if (!body) return;
        
        const filtroTipo = document.getElementById('filtro-tipo-parceiro')?.value || '';
        const filtroStatus = document.getElementById('filtro-status-parceiro')?.value || '';
        const filtroTexto = (document.getElementById('filtro-text-parceiro')?.value || '').toLowerCase();
        
        body.innerHTML = '';
        
        const parceirosFiltrados = dataParceiros.filter(p => {
            const matchTipo = filtroTipo ? p.tipo === filtroTipo : true;
            const matchStatus = filtroStatus ? 
                (filtroStatus === 'ativo' ? p.ativo === true : p.ativo === false) : true;
            const matchTexto = filtroTexto ? p.nome.toLowerCase().includes(filtroTexto) : true;
            
            return matchTipo && matchStatus && matchTexto;
        });
        
        parceirosFiltrados.forEach(parceiro => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div style="font-weight:700">${parceiro.nome}</div>
                    ${parceiro.observacoes ? `<div style="font-size:12px;color:var(--muted)">${parceiro.observacoes.substring(0, 50)}${parceiro.observacoes.length > 50 ? '...' : ''}</div>` : ''}
                </td>
                <td><span class="tag ${parceiro.tipo}">${parceiro.tipo === 'fisica' ? 'F√≠sica' : 'Jur√≠dica'}</span></td>
                <td>${parceiro.cpfCnpj || '---'}</td>
                <td>${parceiro.telefone || '---'}</td>
                <td>
                    <span class="status-badge ${parceiro.ativo ? 'status-ativo' : 'status-inativo'}">
                        <i class="fas ${parceiro.ativo ? 'fa-check' : 'fa-times'}"></i>
                        ${parceiro.ativo ? 'Ativo' : 'Inativo'}
                    </span>
                </td>
                <td>
                    <button class="btn small" onclick="editarParceiro('${parceiro.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn small" onclick="excluirParceiro('${parceiro.id}')" style="background:#FBEAEA;color:#E74C3C;margin-left:4px">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            body.appendChild(tr);
        });
    }

    function abrirFormParceiro(parceiroId = null) {
        if (!currentUser) {
            showError('Fa√ßa login para continuar');
            return;
        }
        
        const parceiro = parceiroId ? dataParceiros.find(p => p.id === parceiroId) : null;
        const body = document.getElementById('modal-body');
        
        body.innerHTML = `
            <div class="form-row">
                <div>
                    <label>Nome/Raz√£o Social *</label>
                    <input id="p_nome" value="${parceiro ? parceiro.nome : ''}" placeholder="Nome completo ou raz√£o social">
                    <div class="error-message" id="error-nome"></div>
                </div>
                <div>
                    <label>Tipo *</label>
                    <select id="p_tipo" onchange="toggleTipoDocumento()">
                        <option value="fisica" ${parceiro && parceiro.tipo === 'fisica' ? 'selected' : ''}>Pessoa F√≠sica</option>
                        <option value="juridica" ${parceiro && parceiro.tipo === 'juridica' ? 'selected' : ''}>Pessoa Jur√≠dica</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div id="cpf_container" class="${parceiro && parceiro.tipo === 'fisica' ? '' : 'conditional-field'}">
                    <label>CPF *</label>
                    <input id="p_cpf" value="${parceiro && parceiro.tipo === 'fisica' ? (parceiro.cpfCnpj || '') : ''}" placeholder="000.000.000-00" oninput="formatarCPF(this)">
                    <div class="error-message" id="error-cpf"></div>
                </div>
                <div id="cnpj_container" class="conditional-field ${parceiro && parceiro.tipo === 'juridica' ? 'visible' : ''}">
                    <label>CNPJ *</label>
                    <input id="p_cnpj" value="${parceiro && parceiro.tipo === 'juridica' ? (parceiro.cpfCnpj || '') : ''}" placeholder="00.000.000/0000-00" oninput="formatarCNPJ(this)">
                    <div class="error-message" id="error-cnpj"></div>
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label>CEP</label>
                    <div style="display:flex;gap:8px">
                        <input id="p_cep" value="${parceiro ? (parceiro.cep || '') : ''}" placeholder="00000-000" style="flex:1" oninput="formatarCEP(this)" onblur="buscarCEP(this.value)">
                        <button type="button" class="btn ghost" onclick="buscarCEP(document.getElementById('p_cep').value)" style="white-space:nowrap">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div class="error-message" id="error-cep"></div>
                    <div id="cep-loading" style="display:none;font-size:12px;color:var(--muted);margin-top:4px">
                        <div class="cep-loading"></div> Buscando endere√ßo...
                    </div>
                </div>
                <div>
                    <label>Telefone/WhatsApp</label>
                    <input id="p_telefone" value="${parceiro ? (parceiro.telefone || '') : ''}" placeholder="(11) 99999-9999" oninput="formatarTelefone(this)">
                    <div class="error-message" id="error-telefone"></div>
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label>Rua/Logradouro</label>
                    <input id="p_logradouro" value="${parceiro ? (parceiro.logradouro || '') : ''}" placeholder="Nome da rua, avenida, etc.">
                </div>
                <div>
                    <label>N√∫mero</label>
                    <input id="p_numero" value="${parceiro ? (parceiro.numero || '') : ''}" placeholder="N√∫mero">
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label>Bairro</label>
                    <input id="p_bairro" value="${parceiro ? (parceiro.bairro || '') : ''}" placeholder="Bairro">
                </div>
                <div>
                    <label>Cidade</label>
                    <input id="p_cidade" value="${parceiro ? (parceiro.cidade || '') : ''}" placeholder="Cidade">
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label>Estado</label>
                    <select id="p_estado">
                        <option value="">Selecione...</option>
                        <option value="AC" ${parceiro && parceiro.estado === 'AC' ? 'selected' : ''}>Acre</option>
                        <option value="AL" ${parceiro && parceiro.estado === 'AL' ? 'selected' : ''}>Alagoas</option>
                        <option value="AP" ${parceiro && parceiro.estado === 'AP' ? 'selected' : ''}>Amap√°</option>
                        <option value="AM" ${parceiro && parceiro.estado === 'AM' ? 'selected' : ''}>Amazonas</option>
                        <option value="BA" ${parceiro && parceiro.estado === 'BA' ? 'selected' : ''}>Bahia</option>
                        <option value="CE" ${parceiro && parceiro.estado === 'CE' ? 'selected' : ''}>Cear√°</option>
                        <option value="DF" ${parceiro && parceiro.estado === 'DF' ? 'selected' : ''}>Distrito Federal</option>
                        <option value="ES" ${parceiro && parceiro.estado === 'ES' ? 'selected' : ''}>Esp√≠rito Santo</option>
                        <option value="GO" ${parceiro && parceiro.estado === 'GO' ? 'selected' : ''}>Goi√°s</option>
                        <option value="MA" ${parceiro && parceiro.estado === 'MA' ? 'selected' : ''}>Maranh√£o</option>
                        <option value="MT" ${parceiro && parceiro.estado === 'MT' ? 'selected' : ''}>Mato Grosso</option>
                        <option value="MS" ${parceiro && parceiro.estado === 'MS' ? 'selected' : ''}>Mato Grosso do Sul</option>
                        <option value="MG" ${parceiro && parceiro.estado === 'MG' ? 'selected' : ''}>Minas Gerais</option>
                        <option value="PA" ${parceiro && parceiro.estado === 'PA' ? 'selected' : ''}>Par√°</option>
                        <option value="PB" ${parceiro && parceiro.estado === 'PB' ? 'selected' : ''}>Para√≠ba</option>
                        <option value="PR" ${parceiro && parceiro.estado === 'PR' ? 'selected' : ''}>Paran√°</option>
                        <option value="PE" ${parceiro && parceiro.estado === 'PE' ? 'selected' : ''}>Pernambuco</option>
                        <option value="PI" ${parceiro && parceiro.estado === 'PI' ? 'selected' : ''}>Piau√≠</option>
                        <option value="RJ" ${parceiro && parceiro.estado === 'RJ' ? 'selected' : ''}>Rio de Janeiro</option>
                        <option value="RN" ${parceiro && parceiro.estado === 'RN' ? 'selected' : ''}>Rio Grande do Norte</option>
                        <option value="RS" ${parceiro && parceiro.estado === 'RS' ? 'selected' : ''}>Rio Grande do Sul</option>
                        <option value="RO" ${parceiro && parceiro.estado === 'RO' ? 'selected' : ''}>Rond√¥nia</option>
                        <option value="RR" ${parceiro && parceiro.estado === 'RR' ? 'selected' : ''}>Roraima</option>
                        <option value="SC" ${parceiro && parceiro.estado === 'SC' ? 'selected' : ''}>Santa Catarina</option>
                        <option value="SP" ${parceiro && parceiro.estado === 'SP' ? 'selected' : ''}>S√£o Paulo</option>
                        <option value="SE" ${parceiro && parceiro.estado === 'SE' ? 'selected' : ''}>Sergipe</option>
                        <option value="TO" ${parceiro && parceiro.estado === 'TO' ? 'selected' : ''}>Tocantins</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top:12px">
                <label>Observa√ß√µes</label>
                <textarea id="p_observacoes" rows="3" placeholder="Observa√ß√µes adicionais...">${parceiro ? (parceiro.observacoes || '') : ''}</textarea>
            </div>
            
            <div class="form-row">
                <div>
                    <label>Status</label>
                    <select id="p_ativo">
                        <option value="true" ${parceiro && parceiro.ativo ? 'selected' : ''}>Ativo</option>
                        <option value="false" ${parceiro && !parceiro.ativo ? 'selected' : ''}>Inativo</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
                <button class="btn" onclick="fecharModal()">Cancelar</button>
                <button class="btn primary" onclick="salvarParceiro('${parceiroId || ''}')">
                    ${parceiroId ? 'Atualizar' : 'Salvar'} Parceiro
                </button>
            </div>
        `;
        
        // Inicializar campos baseados no tipo
        toggleTipoDocumento();
        
        abrirModal(parceiroId ? 'Editar Parceiro' : 'Novo Parceiro');
    }

    function toggleTipoDocumento() {
        const tipo = document.getElementById('p_tipo').value;
        const cpfContainer = document.getElementById('cpf_container');
        const cnpjContainer = document.getElementById('cnpj_container');
        
        if (tipo === 'fisica') {
            cpfContainer.classList.remove('conditional-field');
            cnpjContainer.classList.remove('visible');
        } else {
            cpfContainer.classList.add('conditional-field');
            cnpjContainer.classList.add('visible');
        }
    }

    // ---------- VALIDA√á√ïES E FORMATA√á√ïES ----------
    
    function formatarCPF(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 11) value = value.substring(0, 11);
        
        if (value.length <= 11) {
            value = value.replace(/(\d{3})(\d)/, '$1.$2')
                        .replace(/(\d{3})(\d)/, '$1.$2')
                        .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        }
        
        input.value = value;
        validarCPF(value);
    }

    function validarCPF(cpf) {
        const errorElement = document.getElementById('error-cpf');
        cpf = cpf.replace(/\D/g, '');
        
        if (cpf.length === 0) {
            errorElement.textContent = '';
            errorElement.classList.remove('visible');
            return true;
        }
        
        if (cpf.length !== 11) {
            errorElement.textContent = 'CPF deve ter 11 d√≠gitos';
            errorElement.classList.add('visible');
            return false;
        }
        
        // Valida√ß√£o simples de CPF
        if (/^(\d)\1{10}$/.test(cpf)) {
            errorElement.textContent = 'CPF inv√°lido';
            errorElement.classList.add('visible');
            return false;
        }
        
        errorElement.textContent = '';
        errorElement.classList.remove('visible');
        return true;
    }

    function formatarCNPJ(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 14) value = value.substring(0, 14);
        
        if (value.length <= 14) {
            value = value.replace(/^(\d{2})(\d)/, '$1.$2')
                        .replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3')
                        .replace(/\.(\d{3})(\d)/, '.$1/$2')
                        .replace(/(\d{4})(\d)/, '$1-$2');
        }
        
        input.value = value;
        validarCNPJ(value);
    }

    function validarCNPJ(cnpj) {
        const errorElement = document.getElementById('error-cnpj');
        cnpj = cnpj.replace(/\D/g, '');
        
        if (cnpj.length === 0) {
            errorElement.textContent = '';
            errorElement.classList.remove('visible');
            return true;
        }
        
        if (cnpj.length !== 14) {
            errorElement.textContent = 'CNPJ deve ter 14 d√≠gitos';
            errorElement.classList.add('visible');
            return false;
        }
        
        errorElement.textContent = '';
        errorElement.classList.remove('visible');
        return true;
    }

    function formatarTelefone(input) {
        let value = input.value.replace(/\D/g, '');
        
        if (value.length > 11) value = value.substring(0, 11);
        
        if (value.length <= 11) {
            if (value.length === 11) {
                value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (value.length === 10) {
                value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            } else if (value.length > 6) {
                value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
            } else if (value.length > 0) {
                value = value.replace(/(\d{0,2})/, '($1');
            }
        }
        
        input.value = value;
        validarTelefone(value);
    }

    function validarTelefone(telefone) {
        const errorElement = document.getElementById('error-telefone');
        const digits = telefone.replace(/\D/g, '').length;
        
        if (telefone.length === 0) {
            errorElement.textContent = '';
            errorElement.classList.remove('visible');
            return true;
        }
        
        if (digits < 10 || digits > 11) {
            errorElement.textContent = 'Telefone deve ter 10 ou 11 d√≠gitos';
            errorElement.classList.add('visible');
            return false;
        }
        
        errorElement.textContent = '';
        errorElement.classList.remove('visible');
        return true;
    }

    function formatarCEP(input) {
        let value = input.value.replace(/\D/g, '');
        
        if (value.length > 8) value = value.substring(0, 8);
        
        if (value.length === 8) {
            value = value.replace(/(\d{5})(\d{3})/, '$1-$2');
        }
        
        input.value = value;
    }

    async function buscarCEP(cep) {
        const cepDigits = cep.replace(/\D/g, '');
        const loadingElement = document.getElementById('cep-loading');
        
        if (cepDigits.length !== 8) {
            return;
        }
        
        loadingElement.style.display = 'block';
        
        try {
            const response = await fetch(`https://viacep.com.br/ws/${cepDigits}/json/`);
            const data = await response.json();
            
            if (!data.erro) {
                // Preencher automaticamente os campos de endere√ßo
                document.getElementById('p_logradouro').value = data.logradouro || '';
                document.getElementById('p_bairro').value = data.bairro || '';
                document.getElementById('p_cidade').value = data.localidade || '';
                document.getElementById('p_estado').value = data.uf || '';
                showInfo('Endere√ßo preenchido automaticamente!');
            } else {
                showInfo('CEP n√£o encontrado');
            }
        } catch (error) {
            console.error('Erro ao buscar CEP:', error);
            showError('Erro ao buscar CEP');
        } finally {
            loadingElement.style.display = 'none';
        }
    }

    async function salvarParceiro(parceiroId = null) {
        if (!currentUser) {
            showError('Fa√ßa login para continuar');
            return;
        }
        
        // Valida√ß√µes
        const nome = document.getElementById('p_nome').value.trim();
        const tipo = document.getElementById('p_tipo').value;
        const cpf = tipo === 'fisica' ? document.getElementById('p_cpf').value : '';
        const cnpj = tipo === 'juridica' ? document.getElementById('p_cnpj').value : '';
        const telefone = document.getElementById('p_telefone').value;
        const cep = document.getElementById('p_cep').value;
        const logradouro = document.getElementById('p_logradouro').value;
        const numero = document.getElementById('p_numero').value;
        const bairro = document.getElementById('p_bairro').value;
        const cidade = document.getElementById('p_cidade').value;
        const estado = document.getElementById('p_estado').value;
        const observacoes = document.getElementById('p_observacoes').value;
        const ativo = document.getElementById('p_ativo').value === 'true';
        
        // Validar campos obrigat√≥rios
        if (!nome) {
            document.getElementById('error-nome').textContent = 'Nome √© obrigat√≥rio';
            document.getElementById('error-nome').classList.add('visible');
            return;
        } else {
            document.getElementById('error-nome').classList.remove('visible');
        }
        
        if (tipo === 'fisica' && !validarCPF(cpf)) return;
        if (tipo === 'juridica' && !validarCNPJ(cnpj)) return;
        if (telefone && !validarTelefone(telefone)) return;
        
        const parceiroData = {
            nome: nome,
            tipo: tipo,
            cpfCnpj: tipo === 'fisica' ? cpf : cnpj,
            telefone: telefone,
            cep: cep,
            logradouro: logradouro,
            numero: numero,
            bairro: bairro,
            cidade: cidade,
            estado: estado,
            observacoes: observacoes,
            ativo: ativo,
            userId: currentUser.uid,
            dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        try {
            if (parceiroId) {
                // Editar parceiro existente
                await db.collection('parceiros').doc(parceiroId).update(parceiroData);
                
                // Atualizar localmente
                const index = dataParceiros.findIndex(p => p.id === parceiroId);
                if (index !== -1) {
                    dataParceiros[index] = { ...dataParceiros[index], ...parceiroData };
                }
                showSuccess('Parceiro atualizado com sucesso!');
            } else {
                // Novo parceiro
                parceiroData.dataCriacao = firebase.firestore.FieldValue.serverTimestamp();
                const docRef = await db.collection('parceiros').add(parceiroData);
                parceiroData.id = docRef.id;
                dataParceiros.unshift(parceiroData);
                showSuccess('Parceiro criado com sucesso!');
            }
            
            fecharModal();
            invalidateCache();
            renderTabelaParceiros();
            
        } catch (error) {
            console.error("‚ùå Erro ao salvar parceiro:", error);
            showError("Erro ao salvar o parceiro: " + error.message);
        }
    }

    function editarParceiro(parceiroId) {
        abrirFormParceiro(parceiroId);
    }

    async function excluirParceiro(parceiroId) {
        if (!confirm('Tem certeza que deseja excluir este parceiro?')) {
            return;
        }
        
        try {
            await db.collection('parceiros').doc(parceiroId).delete();
            
            // Remover localmente
            dataParceiros = dataParceiros.filter(p => p.id !== parceiroId);
            invalidateCache();
            renderTabelaParceiros();
            showSuccess('Parceiro exclu√≠do com sucesso!');
            
        } catch (error) {
            console.error("Erro ao excluir parceiro:", error);
            showError("Erro ao excluir o parceiro.");
        }
    }

    // ---------- FORMAS DE PAGAMENTO ----------
    
    function renderTabelaFormasPagamento() {
        const body = document.getElementById('tabela-formas-pagamento-body');
        if (!body) return;
        
        body.innerHTML = '';
        
        dataFormasPagamento.forEach(forma => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${forma.descricao}</td>
                <td>
                    <span class="status-badge ${forma.ativo ? 'status-ativo' : 'status-inativo'}">
                        <i class="fas ${forma.ativo ? 'fa-check' : 'fa-times'}"></i>
                        ${forma.ativo ? 'Ativo' : 'Inativo'}
                    </span>
                </td>
                <td>${forma.permiteParcelamento ? 'Sim' : 'N√£o'}</td>
                <td>${forma.permiteParcelamento ? (forma.maxParcelas || 1) : '---'}</td>
                <td>
                    <button class="btn small" onclick="editarFormaPagamento('${forma.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn small" onclick="excluirFormaPagamento('${forma.id}')" style="background:#FBEAEA;color:#E74C3C;margin-left:4px">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            body.appendChild(tr);
        });
    }

    function abrirFormFormaPagamento(formaId = null) {
        if (!currentUser) {
            showError('Fa√ßa login para continuar');
            return;
        }
        
        const forma = formaId ? dataFormasPagamento.find(f => f.id === formaId) : null;
        const body = document.getElementById('modal-body');
        
        body.innerHTML = `
            <div class="form-row">
                <div>
                    <label>Descri√ß√£o *</label>
                    <input id="f_descricao" value="${forma ? forma.descricao : ''}" placeholder="Ex: Cart√£o de Cr√©dito, PIX, etc.">
                </div>
                <div>
                    <label>Status</label>
                    <select id="f_ativo">
                        <option value="true" ${forma && forma.ativo ? 'selected' : ''}>Ativo</option>
                        <option value="false" ${forma && !forma.ativo ? 'selected' : ''}>Inativo</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label>Permite Parcelamento</label>
                    <select id="f_permite_parcelamento" onchange="toggleCampoParcelas()">
                        <option value="false" ${forma && !forma.permiteParcelamento ? 'selected' : ''}>N√£o</option>
                        <option value="true" ${forma && forma.permiteParcelamento ? 'selected' : ''}>Sim</option>
                    </select>
                </div>
                <div id="max_parcelas_container" class="conditional-field ${forma && forma.permiteParcelamento ? 'visible' : ''}">
                    <label>M√°ximo de Parcelas</label>
                    <input id="f_max_parcelas" type="number" min="1" max="36" value="${forma && forma.permiteParcelamento ? forma.maxParcelas : 1}">
                </div>
            </div>
            
            <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
                <button class="btn" onclick="fecharModal()">Cancelar</button>
                <button class="btn primary" onclick="salvarFormaPagamento('${formaId || ''}')">
                    ${formaId ? 'Atualizar' : 'Salvar'} Forma de Pagamento
                </button>
            </div>
        `;
        
        abrirModal(formaId ? 'Editar Forma de Pagamento' : 'Nova Forma de Pagamento');
    }

    function toggleCampoParcelas() {
        const permiteParcelamento = document.getElementById('f_permite_parcelamento').value === 'true';
        const container = document.getElementById('max_parcelas_container');
        
        if (permiteParcelamento) {
            container.classList.add('visible');
        } else {
            container.classList.remove('visible');
        }
    }

    async function salvarFormaPagamento(formaId = null) {
        if (!currentUser) {
            showError('Fa√ßa login para continuar');
            return;
        }
        
        const descricao = document.getElementById('f_descricao').value.trim();
        const ativo = document.getElementById('f_ativo').value === 'true';
        const permiteParcelamento = document.getElementById('f_permite_parcelamento').value === 'true';
        const maxParcelas = permiteParcelamento ? parseInt(document.getElementById('f_max_parcelas').value) || 1 : 1;
        
        if (!descricao) {
            showError('Preencha a descri√ß√£o da forma de pagamento.');
            return;
        }
        
        if (permiteParcelamento && (maxParcelas < 1 || maxParcelas > 36)) {
            showError('O n√∫mero m√°ximo de parcelas deve estar entre 1 e 36.');
            return;
        }
        
        const formaData = {
            descricao: descricao,
            ativo: ativo,
            permiteParcelamento: permiteParcelamento,
            maxParcelas: maxParcelas,
            userId: currentUser.uid,
            dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        try {
            if (formaId) {
                // Editar forma existente
                await db.collection('formasPagamento').doc(formaId).update(formaData);
                
                // Atualizar localmente
                const index = dataFormasPagamento.findIndex(f => f.id === formaId);
                if (index !== -1) {
                    dataFormasPagamento[index] = { ...dataFormasPagamento[index], ...formaData };
                }
                showSuccess('Forma de pagamento atualizada com sucesso!');
            } else {
                // Nova forma
                formaData.dataCriacao = firebase.firestore.FieldValue.serverTimestamp();
                const docRef = await db.collection('formasPagamento').add(formaData);
                formaData.id = docRef.id;
                dataFormasPagamento.unshift(formaData);
                showSuccess('Forma de pagamento criada com sucesso!');
            }
            
            fecharModal();
            invalidateCache();
            renderTabelaFormasPagamento();
            
        } catch (error) {
            console.error("Erro ao salvar forma de pagamento:", error);
            showError("Erro ao salvar a forma de pagamento.");
        }
    }

    function editarFormaPagamento(formaId) {
        abrirFormFormaPagamento(formaId);
    }

    async function excluirFormaPagamento(formaId) {
        if (!confirm('Tem certeza que deseja excluir esta forma de pagamento?')) {
            return;
        }
        
        try {
            await db.collection('formasPagamento').doc(formaId).delete();
            
            // Remover localmente
            dataFormasPagamento = dataFormasPagamento.filter(f => f.id !== formaId);
            invalidateCache();
            renderTabelaFormasPagamento();
            showSuccess('Forma de pagamento exclu√≠da com sucesso!');
            
        } catch (error) {
            console.error("Erro ao excluir forma de pagamento:", error);
            showError("Erro ao excluir a forma de pagamento.");
        }
    }

    // ---------- UTILIT√ÅRIOS ----------
    
    function formatMoney(v){ 
        return isNaN(v) ? 'R$ 0,00' : 
            (v < 0 ? `- R$ ${Math.abs(v).toFixed(2).replace('.',',')}` : `R$ ${v.toFixed(2).replace('.',',')}`);
    }
    
	function formatDate(d){ 
		if (!d) return '---'; 
		
		// Adicionar um pequeno offset para garantir que a data n√£o retroceda no fuso hor√°rio local.
		// O ideal √© criar a data sem a convers√£o autom√°tica de fuso hor√°rio.
		const parts = d.split('-'); // d √© 'YYYY-MM-DD'
		
		// Cria a data localmente: (Ano, M√™s - 1, Dia)
		const dt = new Date(parts[0], parts[1] - 1, parts[2]); 
		
		// Fallback de seguran√ßa para quem est√° lendo a data
		if (isNaN(dt)) {
			// Se a constru√ß√£o acima falhar (o que √© raro), tenta a convers√£o padr√£o
			const fallbackDt = new Date(d); 
			return fallbackDt.toLocaleDateString('pt-BR'); 
		}
		
		return dt.toLocaleDateString('pt-BR'); 
	}
	
	function getTodayString() {
		const today = new Date();
		
		// Obter o ano, m√™s e dia da data LOCAL
		const year = today.getFullYear();
		// O m√™s come√ßa em 0 (Janeiro), ent√£o somamos 1 e garantimos 2 d√≠gitos
		const month = String(today.getMonth() + 1).padStart(2, '0'); 
		// Garantir 2 d√≠gitos para o dia
		const day = String(today.getDate()).padStart(2, '0');

		// Retorna a data no formato YYYY-MM-DD (padr√£o do campo de data HTML)
		return `${year}-${month}-${day}`;
	}
    
    function sumByType(tipo){ 
    return dataLancamentos
        // NOVO FILTRO: Ignora qualquer lan√ßamento que seja parte de uma transfer√™ncia
        .filter(l => l.tipo === tipo && !l.referenciaTransferenciaId)
        .reduce((s, x) => s + (x.valor || 0), 0); 
	}
    
    function calcSaldo(){ 
        return dataSaldos.reduce((s, x) => s + (x?.valor || 0), 0); 
    }

    // ---------- MODAL ----------
    
    function abrirModal(titulo){
        document.getElementById('modal-title').textContent = titulo;
        document.getElementById('modal-form').style.display = 'flex';
    }

    function fecharModal(){
        document.getElementById('modal-form').style.display = 'none';
    }

    // ---------- GR√ÅFICO ----------
    
	let chartObj = null;
	function initChart(){
		const canvas = document.getElementById('chartFluxo');
		if (!canvas) return;
		
		// Destruir gr√°fico anterior se existir
		if (chartObj) {
			chartObj.destroy();
			chartObj = null;
		}
		
		const ctx = canvas.getContext('2d');
		
		// Dados de exemplo - voc√™ pode substituir por dados real
		// Dados de exemplo - voc√™ pode substituir por dados reais posteriormente
		const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'];
		const receitas = [3200, 2800, 3500, 4200, 3800, 4500];
		const despesas = [1800, 2200, 1900, 2100, 2400, 2000];
		
		try {
			chartObj = new Chart(ctx, {
				type: 'line',
				data: {
					labels: meses,
					datasets: [
						{
							label: 'Receitas',
							data: receitas,
							fill: true,
							tension: 0.35,
							borderWidth: 2,
							borderColor: '#2ECC71',
							backgroundColor: 'rgba(46, 204, 113, 0.1)'
						},
						{
							label: 'Despesas',
							data: despesas,
							fill: false,
							tension: 0.35,
							borderWidth: 2,
							borderColor: '#E74C3C'
						}
					]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						legend: {
							display: true
						}
					},
					scales: {
						y: {
							beginAtZero: true,
							ticks: {
								callback: function(v) {
									return 'R$ ' + v.toLocaleString('pt-BR');
								}
							}
						}
					}
				}
			});
		} catch (error) {
        console.error('‚ùå Erro ao criar gr√°fico:', error);
    }
}

function destroyChart() {
    if (chartObj) {
        chartObj.destroy();
        chartObj = null;
    }
}

    // ---------- ANIMA√á√ïES ----------
    
    function animateValue(el, value){
        if (!el) return;
        const duration = 900;
        const start = 0;
        const end = value;
        const startTime = performance.now();
        
        function update(ts) {
            const progress = Math.min((ts - startTime) / duration, 1);
            const current = start + (end - start) * progress;
            el.textContent = formatMoney(current);
            if (progress < 1) requestAnimationFrame(update);
        }
        
        requestAnimationFrame(update);
        el.dataset.animate = '';
        setTimeout(() => el.classList.add('visible'), 10);
    }
    
    function animateKPIs(){
        const saldoGeral = document.getElementById('saldo-geral');
        const receitasMes = document.getElementById('receitas-mes');
        const despesasMes = document.getElementById('despesas-mes');
        
        if (saldoGeral) animateValue(saldoGeral, calcSaldo());
        if (receitasMes) animateValue(receitasMes, sumByType('receita'));
        if (despesasMes) animateValue(despesasMes, sumByType('despesa'));
    }

    // ---------- INICIALIZA√á√ÉO ----------
    
    document.addEventListener('DOMContentLoaded', async () => {
        // Tema
        const btnTheme = document.getElementById('btn-theme');
        btnTheme?.addEventListener('click', () => {
            const root = document.documentElement;
            const atual = root.getAttribute('data-theme');
            const novo = atual === 'dark' ? '' : 'dark';
            root.setAttribute('data-theme', novo);
            showInfo(`Tema ${novo === 'dark' ? 'escuro' : 'claro'} ativado`);
        });

        // Navega√ß√£o
        document.querySelectorAll('.nav a').forEach(a => {
            a.addEventListener('click', e => {
                e.preventDefault();
                document.querySelectorAll('.nav a').forEach(x => x.classList.remove('active'));
                a.classList.add('active');
                showScreen(a.dataset.screen);
            });
        });

        // Bot√£o Novo ATUALIZADO
        document.getElementById('btn-novo')?.addEventListener('click', () => {
            const screenAtiva = document.querySelector('.screen[style="display: block"]')?.id || 
                              document.querySelector('.screen:not([style])')?.id;
            
            if (screenAtiva === 'lancamentos') {
                abrirFormLancamento();
            } else if (screenAtiva === 'formas-pagamento') {
                abrirFormFormaPagamento();
            } else if (screenAtiva === 'parceiros') {
                abrirFormParceiro();
            } else if (screenAtiva === 'categorias') {
                abrirFormCategoria();
            } else if (screenAtiva === 'contas') {
                abrirFormConta();
            } else if (screenAtiva === 'setores') {
                abrirFormSetor();
            } else {
                abrirFormLancamento();
            }
        });

        // Inicializar Authentication
        await initializeAuth();
    });
  </script>
</body>
</html>
