<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinPess - Sistema de Controle Financeiro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

    <style>
        /* =================================== */
        /* VARIÁVEIS DA IDENTIDADE FINPESS */
        /* =================================== */
        :root {
            --primary-color: #0B2740;
            --primary-light: #1a3d5a;
            --secondary-color: #2ECC9A; /* VERDE */
            --secondary-dark: #27b589;
            --bg-light: #F5F6F7;
            --bg-lighter: #ffffff;
            --text-dark: #0B2740;
            --text-light: #6C757D;
            --success-color: #2ECC9A;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
            /* Cor específica para Receita (AZUL #1E90FF) */
            --receita-color: #1E90FF; 
            
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --card-shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
            --border-radius: 12px;
            --sidebar-width: 280px;
            
            --font-primary: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* RESET E ESTILOS GLOBAIS */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body { 
            font-family: var(--font-primary); 
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* TELA DE LOGIN */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            padding: 20px;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }

        .login-title {
            color: var(--primary-color);
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .login-form {
            text-align: left;
        }

        .login-form label {
            display: block;
            margin-top: 18px;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .login-form input {
            width: 100%;
            padding: 14px 16px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius);
            transition: var(--transition);
            font-family: inherit;
            font-size: 1rem;
            background: #f8fafc;
        }

        .login-form input:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(46, 204, 154, 0.15);
            background: white;
        }

        .login-btn {
            width: 100%;
            padding: 14px 24px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            margin-top: 20px;
            font-size: 1rem;
        }

        .login-btn:hover {
            background: var(--secondary-dark);
            transform: translateY(-2px);
        }

        .test-credentials {
            margin-top: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            border-left: 4px solid var(--secondary-color);
        }

        /* ======================================= */
        /* LAYOUT PRINCIPAL E MENU DINÂMICO */
        /* ======================================= */
        .layout-container { 
            display: none;
            flex: 1;
            min-height: 100vh;
        }

        /* Define a largura padrão (Desktop) */
        .sidebar { 
            width: var(--sidebar-width); 
            min-width: var(--sidebar-width);
            background: linear-gradient(165deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white; 
            height: 100vh; 
            position: fixed; 
            padding-top: 30px; 
            box-shadow: 5px 0 25px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            z-index: 100;
            transition: width 0.3s ease;
        }

        .content { 
            margin-left: var(--sidebar-width); 
            padding: 40px; 
            width: calc(100% - var(--sidebar-width));
            position: relative; 
            transition: margin-left 0.3s ease, width 0.3s ease;
        }
        
        /* Estado Recolhido (Usado para telas pequenas) */
        .sidebar-recolhido .sidebar {
            width: 80px;
            min-width: 80px;
        }
        .sidebar-recolhido .sidebar h2 {
             /* Esconde o texto 'FinPess' */
            font-size: 0; 
            padding: 0;
            margin-bottom: 15px;
            border-bottom: none;
        }
        .sidebar-recolhido .sidebar h2 i {
             font-size: 1.4rem;
             padding: 15px 0;
        }
        
        .sidebar-recolhido .sidebar a {
            padding: 16px 0;
            text-align: center;
            justify-content: center;
        }
        .sidebar-recolhido .sidebar a span {
            display: none; /* Esconde o texto do link */
        }

        .sidebar-recolhido .content {
            margin-left: 80px;
            width: calc(100% - 80px);
        }


        .sidebar h2 { 
            text-align: center; 
            padding: 15px 0; 
            margin-bottom: 30px; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            font-size: 1.4rem;
            font-weight: 700;
        }

        .sidebar a { 
            display: flex; 
            align-items: center; 
            padding: 16px 25px; 
            text-decoration: none; 
            color: rgba(255, 255, 255, 0.85); 
            transition: var(--transition);
            border-left: 4px solid transparent;
            margin: 5px 15px;
            border-radius: var(--border-radius);
            font-weight: 500;
        }
        .sidebar a i {
            width: 30px; /* Garante que o ícone tenha espaço reservado */
            text-align: center;
            margin-right: 10px;
        }
        .sidebar-recolhido .sidebar a i {
             margin-right: 0;
        }


        .sidebar a:hover { 
            background: rgba(255, 255, 255, 0.1); 
            color: white;
        }

        .sidebar a.active { 
            background: rgba(255, 255, 255, 0.15); 
            border-left-color: var(--secondary-color); 
            color: white;
        }

        /* NOVO: Estilos para o Menu de Perfil */
        #user-profile-menu {
            position: absolute;
            top: 25px;
            right: 25px;
            z-index: 500;
            font-size: 0.95rem;
        }
        
        #user-profile-toggle {
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 8px 15px;
            background: var(--bg-lighter);
            border: 1px solid #ddd;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            transition: all 0.2s;
        }
        #user-profile-toggle:hover {
            background: #f1f1f1;
        }
        #user-profile-toggle i {
            color: var(--primary-color);
            margin-right: 8px;
        }

        #user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 200px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow-hover);
            margin-top: 10px;
            overflow: hidden;
            z-index: 600;
        }
        #user-dropdown a {
            display: block;
            padding: 10px 15px;
            text-decoration: none;
            color: var(--text-dark);
        }
        #user-dropdown a:hover {
            background: var(--bg-light);
        }
        .dropdown-hidden {
            display: none;
        }


        /* TELAS */
        .screen { 
            display: none; 
        }

        .screen.active { 
            display: block; 
        }

        /* COMPONENTES */
        .card { 
            background: var(--bg-lighter); 
            padding: 30px; 
            margin-bottom: 30px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--card-shadow);
        }

        .btn { 
            padding: 12px 20px; 
            border: none; 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            font-weight: 600; 
            transition: var(--transition); 
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
        }
        
        /* Ajuste do botão de Ação para telas menores */
        .btn-action-icon {
            padding: 8px 10px; /* Reduz o padding para ser mais compacto */
            font-size: 0.9em;
        }

        .btn-primary { 
            background: var(--primary-color);
            color: white; 
        }

        .btn-success { 
            background: var(--secondary-color);
            color: white; 
        }

        .btn-danger { 
            background: var(--danger-color);
            color: white; 
        }
        
        .btn-info {
            background: var(--info-color);
            color: white;
        }

        .btn-sm { 
            padding: 8px 12px; 
            font-size: 0.85em; 
        }

        table { 
            width: 100%; 
            border-collapse: collapse;
            margin-top: 20px; 
        }

        table th, table td { 
            padding: 12px; 
            text-align: left; 
            border-bottom: 1px solid #f1f5f9; 
        }

        table th { 
            background: #f8fafc;
            font-weight: 700; 
        }

        .form-container {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .form-container.hidden {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
            padding: 0;
        }

        label { 
            display: block; 
            margin-top: 15px; 
            margin-bottom: 5px; 
            font-weight: 600; 
        }

        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 15px; 
            border: 1px solid #e2e8f0; 
            border-radius: var(--border-radius); 
            font-family: inherit;
        }

        .toolbar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        /* Estilos base do badge (usado para status) */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        /* NOVO: Classes de cor de texto para o campo TIPO */
        .tipo-receita-text {
            color: var(--receita-color); /* Azul */
            font-weight: 600;
        }
        .tipo-despesa-text {
            color: var(--danger-color); /* Vermelho */
            font-weight: 600;
        }

        /* Estilos do Tipo (Removendo o background circular antigo) */
        .badge-receita, .badge-despesa {
            background: none !important;
            color: inherit !important; /* Deve ser sobrescrito pelo tipo-xxx-text */
            padding: 0;
            border-radius: 0;
        }

        
        /* Pago (Despesa Concluída) usa o VERDE de Sucesso */
        .badge-pago {
            background: var(--success-color); /* MUDANÇA APLICADA: Cor Verde */
            color: white;
        }
        /* RECEBIDO (Azul Concluída) AGORA USA O VERDE de Sucesso */
        .badge-recebido-status {
            background: var(--success-color); /* MUDANÇA APLICADA: Cor Verde */
            color: white;
        }
        /* Cor para pendente de receita e AGORA PENDENTE DE DESPESA */
        .badge-warning { 
            background: var(--warning-color);
            color: white;
        }
        
        /* Badge Ativo/Inativo */
        .badge-ativo {
            background: var(--success-color);
            color: white;
        }

        .badge-inativo {
            background: var(--text-light); /* Cor cinza para inativo */
            color: white;
        }

        /* Ajuste na grade principal do Dashboard */
        .dashboard-saldos-contas-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
            gap: 25px; 
            margin-bottom: 30px;
        }

        .indicator-card {
            background: var(--bg-lighter);
            padding: 25px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--card-shadow);
            position: relative;
        }

        .value {
            font-size: 2em; 
            font-weight: 800; 
            margin-top: 10px; 
        }
        
        /* Dashboard - Lista de Saldos */
        .dashboard-saldos-contas-grid > .card {
            /* Para garantir que o card de saldos individuais se encaixe na grade */
            padding: 20px; 
        }
        
        .saldo-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
            font-size: 0.95rem;
        }
        .saldo-item strong {
            font-weight: 600;
        }
        
        /* Estilos para os novos cards de resumo mensal */
        #dashboard-receitas-mes .value {
            color: var(--secondary-color); /* Verde Sucesso */
        }
        
        #dashboard-despesas-mes .value {
            color: var(--danger-color); /* Vermelho Danger */
        }
        
        /* Estilos para os detalhes de pendentes */
        .detail-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            padding: 5px 0;
        }
        .detail-item .value {
            font-size: 1em; /* Reduz o tamanho do valor para caber no detalhe */
            font-weight: 600;
        }
        .detail-item.vencidos .value {
            color: var(--danger-color);
        }
        .detail-item.vence-hoje .value {
            color: var(--warning-color);
        }
        .detail-item.futuro .value {
            color: var(--primary-color);
        }
        
        /* Layout para o Card de Gráfico */
        .dashboard-chart-card {
            grid-column: 1 / -1; /* Ocupa toda a largura da linha */
            min-height: 400px;
        }


        .alert {
            padding: 12px 16px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid var(--secondary-color);
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid var(--danger-color);
        }

        /* Estilos para coloração de Saldo */
        .saldo-positivo {
            color: var(--receita-color); /* AZUL: #1E90FF */
            font-weight: 600;
        }

        .saldo-negativo {
            color: var(--danger-color); /* VERMELHO: #e74c3c */
            font-weight: 600;
        }
        
        /* Estilo para esconder/mostrar campos opcionais no formulário */
        .campo-parcelamento.hidden {
            display: none;
        }
        
        /* Estilo para Resumo de Parcelamento */
        #resumo-parcelamento {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background: #f8fafc;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9em;
        }
        #resumo-parcelamento.hidden {
            display: none;
        }
        
        /* Estilo para o filtro de mês/ano */
        .date-filter-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-lighter);
            padding: 10px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
        }

        .current-month-display {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        /* NOVO: Estilos para o toolbar de filtros de dados */
        .filter-data-toolbar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .filter-data-toolbar select, .filter-data-toolbar input {
            padding: 10px;
            margin-bottom: 0; 
        }
        
        /* Ajuste do container de botões de Ação para o formulário */
        .form-action-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
    </style>
</head>
<body class="sidebar-recolhido"> <div id="login-screen">
        <div class="login-container">
            <h2 class="login-title">
                <i class="fas fa-lock"></i> Acesso ao FinPess
            </h2>
            <div id="login-alert-message"></div>
            <form id="form-login-inicial" class="login-form">
                <label for="login-email">E-mail:</label>
                <input type="email" id="login-email" placeholder="Seu e-mail de acesso" required>
                
                <label for="login-senha">Senha:</label>
                <input type="password" id="login-senha" placeholder="Sua senha" required>
                
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
                </button>
            </form>
            
            <div class="test-credentials">
                <strong>Credenciais para teste:</strong>
                E-mail: admin@sistema.com | Senha: 123<br>
                E-mail: user@sistema.com | Senha: 456
            </div>
        </div>
    </div>

    <div class="layout-container">
        <div class="sidebar" id="sidebar">
            <h2><i class="fas fa-chart-line"></i> FinPess</h2>
            <a href="#" class="nav-link active" data-screen="dashboard"><i class="fas fa-home"></i> <span>Dashboard</span></a>
            <a href="#" class="nav-link" data-screen="lancamentos"><i class="fas fa-hand-holding-usd"></i> <span>Lançamentos</span></a>
            <hr style="border-color: rgba(255, 255, 255, 0.1); margin: 20px 15px;">
            <a href="#" class="nav-link" data-screen="cadastro-contas"><i class="fas fa-file-invoice-dollar"></i> <span>Plano de Contas</span></a>
            <a href="#" class="nav-link" data-screen="cadastro-categorias"><i class="fas fa-tags"></i> <span>Cad. Categorias</span></a>
            <a href="#" class="nav-link" data-screen="cadastro-bancos"><i class="fas fa-university"></i> <span>Contas Financeiras</span></a>
            <a href="#" class="nav-link" data-screen="cadastro-tipos-pagamento"><i class="fas fa-credit-card"></i> <span>Tipos de Pagamento</span></a>
            <a href="#" class="nav-link" data-screen="cadastro-parceiros"><i class="fas fa-user-friends"></i> <span>Cad. Clientes/Forn.</span></a>
            <a href="#" class="nav-link" data-screen="cadastro-usuarios"><i class="fas fa-user-lock"></i> <span>Cad. Usuários</span></a>
            <hr style="border-color: rgba(255, 255, 255, 0.1); margin: 20px 15px;">
            <a href="#" class="nav-link" data-screen="relatorios"><i class="fas fa-file-alt"></i> <span>Relatórios</span></a>
        </div>

        <div class="content">
            <div id="user-profile-menu">
                <div id="user-profile-toggle" onclick="document.getElementById('user-dropdown').classList.toggle('dropdown-hidden')">
                    <i class="fas fa-user-circle"></i>
                    <span id="logged-user-name">Carregando...</span>
                </div>
                <div id="user-dropdown" class="dropdown-hidden">
                    <a href="#" onclick="abrirModalTrocaUsuario(); return false;">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </a>
                </div>
            </div>
            
            <div id="dashboard" class="screen active">
                <h1><i class="fas fa-tachometer-alt"></i> Dashboard Financeiro</h1>
                <div class="dashboard-saldos-contas-grid">
                    
                    <div class="indicator-card">
                        <h3><i class="fas fa-wallet"></i> Saldo Geral Atual (Efetivado)</h3>
                        <p class="value" id="dashboard-saldo">R$ 0,00</p>
                    </div>
                    
                    <div class="card" style="margin-bottom: 0;">
                        <h3><i class="fas fa-university"></i> Saldos por Conta</h3>
                        <div id="dashboard-saldos-bancarios">
                            </div>
                    </div>
                    
                    <div class="indicator-card" id="dashboard-receitas-mes">
                        <h3><i class="fas fa-arrow-up"></i> Receitas Mês (Efet.)</h3>
                        <p class="value" id="dashboard-total-receitas-mes">R$ 0,00</p>
                    </div>
                    
                    <div class="indicator-card" id="dashboard-despesas-mes">
                        <h3><i class="fas fa-arrow-down"></i> Despesas Mês (Efet.)</h3>
                        <p class="value" id="dashboard-total-despesas-mes">R$ 0,00</p>
                    </div>
                    
                    <div class="indicator-card">
                        <h3><i class="fas fa-arrow-circle-down"></i> Contas a Pagar</h3>
                        <p class="value" id="dashboard-a-pagar">R$ 0,00</p>
                        <hr style="margin: 10px 0; border-color: rgba(0,0,0,0.1);">
                        <div id="detalhes-a-pagar">
                            </div>
                    </div>
                    
                    <div class="indicator-card">
                        <h3><i class="fas fa-arrow-circle-up"></i> Contas a Receber</h3>
                        <p class="value" id="dashboard-a-receber">R$ 0,00</p>
                        <hr style="margin: 10px 0; border-color: rgba(0,0,0,0.1);">
                        <div id="detalhes-a-receber">
                            </div>
                    </div>
                    
                    <div class="card dashboard-chart-card">
                        <h2><i class="fas fa-chart-line"></i> Fluxo de Caixa Mensal (Últimos 6 Meses)</h2>
                        <div style="height: 300px; margin-top: 20px;">
                            <canvas id="fluxoCaixaChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="lancamentos" class="screen">
                <h1><i class="fas fa-hand-holding-usd"></i> Lançamentos Financeiros</h1>
                <div id="lancamentos-alerts"></div>
                
                <div class="toolbar">
                    <button class="btn btn-success" onclick="novoLancamentoRapido('receita')">
                        <i class="fas fa-plus-circle"></i> Nova Receita
                    </button>
                    <button class="btn btn-danger" onclick="novoLancamentoRapido('despesa')">
                        <i class="fas fa-minus-circle"></i> Nova Despesa
                    </button>
                </div>
                
                <div class="date-filter-toolbar">
                    <button class="btn btn-primary btn-sm" onclick="mudarMes(-1)">
                        <i class="fas fa-chevron-left"></i> Mês Anterior
                    </button>
                    <span class="current-month-display" id="filtro-mes-ano">Novembro / 2025</span>
                    <button class="btn btn-primary btn-sm" onclick="mudarMes(1)">
                        Próximo Mês <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                
                <div class="filter-data-toolbar">
                    <select id="filtro-status" onchange="renderizarTabelaLancamentos()">
                        <option value="">Status (Todos)</option>
                        <option value="pendente">Pendente</option>
                        <option value="pago">Pago</option>
                        <option value="recebido">Recebido</option>
                    </select>
                    
                    <select id="filtro-tipo" onchange="renderizarTabelaLancamentos()">
                        <option value="">Tipo (Todos)</option>
                        <option value="receita">Receita</option>
                        <option value="despesa">Despesa</option>
                    </select>
                    
                    <select id="filtro-parceiro-id" onchange="renderizarTabelaLancamentos()">
                        <option value="">Parceiro (Todos)</option>
                        </select>
                    
                    <input type="text" id="filtro-descricao" placeholder="Buscar por Descrição/Detalhes" oninput="renderizarTabelaLancamentos()">
                </div>

                <div class="card">
                    <h2>Novo/Editar Lançamento</h2>
                    <div class="form-container hidden" id="form-lancamento-container"> 
                        <form id="form-lancamento">
                            <input type="hidden" id="lancamento-id">
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                                
                                <div>
                                    <label>Tipo:</label>
                                    <select id="lancamento-tipo" required onchange="toggleStatusField()">
                                        <option value="receita">Receita</option>
                                        <option value="despesa">Despesa</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label>Valor Total (R$):</label>
                                    <input type="number" id="lancamento-valor" step="0.01" required>
                                </div>
                                
                                <div id="status-field-container">
                                    <label id="status-label">Pago?</label>
                                    <select id="lancamento-pago-recebido" required>
                                        <option value="false">Não</option>
                                        <option value="true">Sim</option>
                                    </select>
                                </div>
                                
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label>Categoria:</label>
                                    <select id="lancamento-categoria-id" required>
                                        </select>
                                </div>
                                <div>
                                    <label>Conta Bancária:</label>
                                    <select id="lancamento-banco-id" required>
                                        </select>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label>Parceiro (Cli./Forn.):</label>
                                    <select id="lancamento-parceiro-id" required>
                                        </select>
                                </div>
                                <div>
                                    <label>Forma de Pagamento:</label>
                                    <select id="lancamento-tipo-pagamento-id" required>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                                <div>
                                    <label>Data Vencimento (1ª Parcela):</label>
                                    <input type="date" id="lancamento-data-vencimento" required>
                                </div>
                                <div>
                                    <label>Data Efetivação:</label>
                                    <input type="date" id="lancamento-data" required>
                                </div>
                                <div>
                                    <label>Parcelas:</label>
                                    <select id="lancamento-parcelas" required disabled onchange="prepararResumoParcelas()">
                                        <option value="1">1x</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="resumo-parcelamento" class="hidden">
                                <strong>Resumo do Parcelamento:</strong>
                                <ul id="lista-parcelas" style="list-style: none; padding-left: 0;"></ul>
                            </div>

                            <label>Descrição Opcional:</label>
                            <input type="text" id="lancamento-descricao">

                            <div class="form-action-buttons">
                                <button type="button" class="btn btn-danger" onclick="cancelarLancamento()">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-success">
                                    Salvar Lançamento(s)
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <h2>Lançamentos por Vencimento</h2>
                    <table id="tabela-lancamentos">
                        <thead>
                            <tr>
                                <th>Parceiro</th>
                                <th>Detalhes</th>
                                <th>Valor</th>
                                <th>Vencimento</th>
                                <th>Tipo</th> 
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-lancamentos">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="cadastro-contas" class="screen">
                <h1><i class="fas fa-file-invoice-dollar"></i> Cadastro de Plano de Contas</h1>
                
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="novoPlanoContasRapido()">
                        <i class="fas fa-plus-circle"></i> Novo Plano de Contas
                    </button>
                </div>

                <div class="card">
                    <h2>Novo/Editar Conta Contábil</h2>
                    <div class="form-container hidden" id="form-contas-container">
                        <form id="form-contas">
                            <input type="hidden" id="conta-id">
                            <label>Nome da Conta:</label>
                            <input type="text" id="conta-nome" required>
                            <label>Tipo:</label>
                            <select id="conta-tipo" required>
                                <option value="receita">Receita</option>
                                <option value="despesa">Despesa</option>
                            </select>
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" class="btn btn-danger" onclick="cancelarPlanoContas()">Cancelar</button>
                                <button type="submit" class="btn btn-success">Salvar Conta</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <h2>Contas Cadastradas</h2>
                    <table id="tabela-contas">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Tipo</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-contas">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="cadastro-categorias" class="screen">
                <h1><i class="fas fa-tags"></i> Cadastro de Categorias</h1>
                
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="novaCategoriaRapido()">
                        <i class="fas fa-plus-circle"></i> Nova Categoria
                    </button>
                </div>

                <div class="card">
                    <h2>Nova/Editar Categoria</h2>
                    <div class="form-container hidden" id="form-categorias-container">
                        <form id="form-categorias">
                            <input type="hidden" id="categoria-id"> 
                            <label>Nome da Categoria:</label>
                            <input type="text" id="categoria-nome" required>
                            
                            <label>Plano de Contas Associado:</label>
                            <select id="categoria-plano-contas-id" required>
                                </select>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" class="btn btn-danger" onclick="cancelarCategoria()">Cancelar</button>
                                <button type="submit" class="btn btn-success">Salvar Categoria</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <h2>Categorias Cadastradas</h2>
                    <table id="tabela-categorias">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Plano de Contas</th>
                                <th>Tipo</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-categorias">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="cadastro-bancos" class="screen">
                <h1><i class="fas fa-university"></i> Cadastro de Contas Financeiras</h1>
                
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="novaContaRapido()">
                        <i class="fas fa-plus-circle"></i> Nova Conta Financeira
                    </button>
                </div>

                <div class="card">
                    <h2>Nova/Editar Conta Financeira</h2>
                    <div class="form-container hidden" id="form-bancos-container">
                        <form id="form-bancos">
                            <input type="hidden" id="banco-id">
                            <label>Nome da Conta:</label>
                            <input type="text" id="banco-nome" required>
                            <label>Saldo Inicial (R$):</label>
                            <input type="number" id="banco-saldo-inicial" step="0.01" value="0.00" required>
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" class="btn btn-danger" onclick="cancelarConta()">Cancelar</button>
                                <button type="submit" class="btn btn-success">Salvar Conta</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <h2>Contas Cadastradas</h2>
                    <table id="tabela-bancos">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Saldo</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-bancos">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div id="cadastro-tipos-pagamento" class="screen">
                <h1><i class="fas fa-credit-card"></i> Cadastro de Tipos de Pagamento</h1>
                
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="novoTipoPagamentoRapido()">
                        <i class="fas fa-plus-circle"></i> Novo Tipo de Pagamento
                    </button>
                </div>

                <div class="card">
                    <h2>Novo/Editar Tipo de Pagamento</h2>
                    <div class="form-container hidden" id="form-tipos-pagamento-container">
                        <form id="form-tipos-pagamento">
                            <input type="hidden" id="tipo-pagamento-id">
                            <label>Descrição:</label>
                            <input type="text" id="tipo-pagamento-descricao" required>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label>Status:</label>
                                    <select id="tipo-pagamento-ativo" required>
                                        <option value="true">Ativo</option>
                                        <option value="false">Inativo</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Aceita Parcelamento?</label>
                                    <select id="tipo-pagamento-parcela-sim" onchange="toggleMaxParcelas()">
                                        <option value="false">Não</option>
                                        <option value="true">Sim</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="campo-parcelamento hidden">
                                <label>Máximo de Parcelas Permitidas:</label>
                                <input type="number" id="tipo-pagamento-max-parcelas" min="1" value="1" required>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                <button type="button" class="btn btn-danger" onclick="cancelarTipoPagamento()">Cancelar</button>
                                <button type="submit" class="btn btn-success">Salvar Tipo</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <h2>Tipos de Pagamento Cadastrados</h2>
                    <table id="tabela-tipos-pagamento">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Descrição</th>
                                <th>Status</th>
                                <th>Parcelamento</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-tipos-pagamento">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="cadastro-parceiros" class="screen">
                <h1><i class="fas fa-user-friends"></i> Cadastro de Clientes e Fornecedores</h1>
                
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="novoParceiroRapido()">
                        <i class="fas fa-plus-circle"></i> Novo Parceiro
                    </button>
                </div>

                <div class="card">
                    <h2>Novo/Editar Parceiro</h2>
                    <div class="form-container hidden" id="form-parceiros-container">
                        <form id="form-parceiros">
                            <input type="hidden" id="parceiro-id">
                            <label>Nome/Razão Social:</label>
                            <input type="text" id="parceiro-nome" required>
                            <label>Tipo:</label>
                            <select id="parceiro-tipo" required>
                                <option value="cliente">Cliente</option>
                                <option value="fornecedor">Fornecedor</option>
                            </select>
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" class="btn btn-danger" onclick="cancelarParceiro()">Cancelar</button>
                                <button type="submit" class="btn btn-success">Salvar Parceiro</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <h2>Parceiros Cadastrados</h2>
                    <table id="tabela-parceiros">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Tipo</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-parceiros">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="cadastro-usuarios" class="screen">
                <h1><i class="fas fa-user-lock"></i> Cadastro de Usuários</h1>
                
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="novoUsuarioRapido()">
                        <i class="fas fa-user-plus"></i> Novo Usuário
                    </button>
                </div>

                <div class="card">
                    <h2>Novo/Editar Usuário</h2>
                    <div class="form-container hidden" id="form-usuarios-container">
                        <form id="form-usuarios">
                            <input type="hidden" id="usuario-id">
                            <label>Nome Completo:</label>
                            <input type="text" id="usuario-nome" required>
                            <label>E-mail:</label>
                            <input type="email" id="usuario-email" required>
                            <label>Senha (deixe em branco para manter a senha):</label>
                            <input type="password" id="usuario-senha" placeholder="Preencha apenas para alterar"> 
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" class="btn btn-danger" onclick="cancelarUsuario()">Cancelar</button>
                                <button type="submit" class="btn btn-success">Salvar Usuário</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <h2>Usuários Cadastrados</h2>
                    <table id="tabela-usuarios">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>E-mail</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-usuarios">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="relatorios" class="screen">
                <h1><i class="fas fa-file-alt"></i> Relatórios Financeiros</h1>
                
                <div class="card">
                    <h2>Filtros para Geração de Relatório</h2>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div>
                            <label>Tipo:</label>
                            <select id="rel-tipo">
                                <option value="">Todos</option>
                                <option value="receita">Receita</option>
                                <option value="despesa">Despesa</option>
                            </select>
                        </div>
                        <div>
                            <label>Status:</label>
                            <select id="rel-status">
                                <option value="">Todos</option>
                                <option value="pendente">Pendente</option>
                                <option value="pago">Pago</option>
                                <option value="recebido">Recebido</option>
                            </select>
                        </div>
                        <div>
                            <label>Parceiro:</label>
                            <select id="rel-parceiro-id">
                                </select>
                        </div>
                        <div>
                            <label>Categoria:</label>
                            <select id="rel-categoria-id">
                                </select>
                        </div>
                        <div>
                            <label>Plano de Contas:</label>
                            <select id="rel-plano-contas-id">
                                </select>
                        </div>
                        <div>
                            <label>Busca por Descrição:</label>
                            <input type="text" id="rel-descricao" placeholder="Ex: Aluguel, Comissão">
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <button class="btn btn-success" onclick="baixarRelatorio('xls')">
                            <i class="fas fa-download"></i> Baixar XLS
                        </button>
                        <button class="btn btn-danger" onclick="baixarRelatorio('pdf')">
                            <i class="fas fa-file-pdf"></i> Baixar PDF
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ===================================
        // DADOS E CONFIGURAÇÃO
        // ===================================
        const MOCK_USUARIOS = [
            { id: 1, nome: 'Administrador Principal', email: 'admin@sistema.com', senha: '123' },
            { id: 2, nome: 'Usuário Padrão', email: 'user@sistema.com', senha: '456' }
        ];

        const MOCK_PLANO_CONTAS = [
            { id: 1, nome: 'Receita de Vendas', tipo: 'receita' },
            { id: 2, nome: 'Despesas Operacionais', tipo: 'despesa' }
        ];

        const MOCK_CATEGORIAS = [
            // ATUALIZADO: Adicionando planoContasId
            { id: 1, nome: 'Venda de Produtos', planoContasId: 1 },
            { id: 2, nome: 'Serviços Prestados', planoContasId: 1 },
            { id: 3, nome: 'Material de Escritório', planoContasId: 2 },
            { id: 4, nome: 'Salários e Encargos', planoContasId: 2 }
        ];

        const MOCK_BANCOS = [
            { id: 1, nome: 'Conta Corrente Principal', saldo: 15000.00 },
            { id: 2, nome: 'Caixa', saldo: -500.00 }, 
            { id: 3, nome: 'Conta Poupança', saldo: 0.00 }
        ];

        const MOCK_PARCEIROS = [
            { id: 1, nome: 'Cliente ABC Ltda', tipo: 'cliente' },
            { id: 2, nome: 'Fornecedor XYZ S/A', tipo: 'fornecedor' }
        ];

        // Tipos de Pagamento
        const MOCK_TIPOS_PAGAMENTO = [
            { id: 1, descricao: 'Dinheiro/Pix', ativo: true, parcela: false, maxParcelas: 1 },
            { id: 2, descricao: 'Cartão de Crédito', ativo: true, parcela: true, maxParcelas: 12 },
            { id: 3, descricao: 'Boleto', ativo: true, parcela: false, maxParcelas: 1 }
        ];

        const MOCK_LANCAMENTOS = [
            // Simulação de dados nos últimos 6 meses para o gráfico
            // Mês 10 (Novembro):
            { id: 1, descricao: 'Venda de Produtos Jan', valor: 2500.00, data: '2025-11-20', dataVencimento: '2025-12-15', tipo: 'receita', categoriaId: 1, bancoId: 1, parceiroId: 1, tipoPagamentoId: 1, parcelas: 1, parcelaAtual: 1, status: 'pendente' },
            { id: 2, descricao: 'Material Escritório', valor: 166.67, data: '2025-11-10', dataVencimento: '2025-11-18', tipo: 'despesa', categoriaId: 3, bancoId: 1, parceiroId: 2, tipoPagamentoId: 2, parcelas: 3, parcelaAtual: 1, status: 'pendente' },
            { id: 4, descricao: 'Serviço de Limpeza', valor: 300.00, data: '2025-11-10', dataVencimento: '2025-11-19', tipo: 'despesa', categoriaId: 3, bancoId: 1, parceiroId: 2, tipoPagamentoId: 3, parcelas: 1, parcelaAtual: 1, status: 'pendente' },
            { id: 5, descricao: 'Salário Funcionário', valor: 3000.00, data: '2025-11-15', dataVencimento: '2025-11-15', tipo: 'despesa', categoriaId: 4, bancoId: 1, parceiroId: 2, tipoPagamentoId: 1, parcelas: 1, parcelaAtual: 1, status: 'pago' }, // PAGO NOV
            { id: 6, descricao: 'Comissão de Vendas', valor: 1500.00, data: '2025-11-05', dataVencimento: '2025-11-05', tipo: 'receita', categoriaId: 1, bancoId: 1, parceiroId: 1, tipoPagamentoId: 1, parcelas: 1, parcelaAtual: 1, status: 'recebido' }, // RECEBIDO NOV
            { id: 3, descricao: 'Serviços Prestados Jan', valor: 3200.00, data: '2025-11-20', dataVencimento: '2025-11-30', tipo: 'receita', categoriaId: 2, bancoId: 2, parceiroId: 1, tipoPagamentoId: 1, parcelas: 1, parcelaAtual: 1, status: 'pendente' },
            
            // Mês 9 (Outubro):
            { id: 7, descricao: 'Venda Outubro', valor: 10000.00, data: '2025-10-10', dataVencimento: '2025-10-10', tipo: 'receita', categoriaId: 1, bancoId: 1, parceiroId: 1, tipoPagamentoId: 1, parcelas: 1, parcelaAtual: 1, status: 'recebido' },
            { id: 8, descricao: 'Aluguel Outubro', valor: 4500.00, data: '2025-10-01', dataVencimento: '2025-10-01', tipo: 'despesa', categoriaId: 4, bancoId: 1, parceiroId: 2, tipoPagamentoId: 1, parcelas: 1, parcelaAtual: 1, status: 'pago' },
            
            // Mês 8 (Setembro):
            { id: 9, descricao: 'Serviço Setembro', valor: 3000.00, data: '2025-09-15', dataVencimento: '2025-09-15', tipo: 'receita', categoriaId: 2, bancoId: 2, parceiroId: 1, tipoPagamentoId: 1, parcelas: 1, parcelaAtual: 1, status: 'recebido' },
            { id: 10, descricao: 'Marketing Setembro', valor: 5000.00, data: '2025-09-20', dataVencimento: '2025-09-20', tipo: 'despesa', categoriaId: 3, bancoId: 1, parceiroId: 2, tipoPagamentoId: 1, parcelas: 1, parcelaAtual: 1, status: 'pago' },
        ];
        
        // Variável de estado para o filtro de mês/ano
        const hoje = new Date(2025, 10, 19); // Define a data de hoje como 2025-11-19 para fins de teste
        let filtroMesAno = new Date(hoje.getFullYear(), hoje.getMonth(), 1); 
        
        // Mapeamento de meses para exibição
        const MESES = [
            "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
            "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
        ];


        // Carregar dados do localStorage ou usar mocks
        let usuarios = JSON.parse(localStorage.getItem('usuarios')) || MOCK_USUARIOS;
        let loggedUserId = localStorage.getItem('loggedUserId') || null;
        let planoContas = JSON.parse(localStorage.getItem('planoContas')) || MOCK_PLANO_CONTAS;
        let categorias = JSON.parse(localStorage.getItem('categorias')) || MOCK_CATEGORIAS;
        let bancos = JSON.parse(localStorage.getItem('bancos')) || MOCK_BANCOS; 
        let parceiros = JSON.parse(localStorage.getItem('parceiros')) || MOCK_PARCEIROS;
        let tiposPagamento = JSON.parse(localStorage.getItem('tiposPagamento')) || MOCK_TIPOS_PAGAMENTO;
        let lancamentos = JSON.parse(localStorage.getItem('lancamentos')) || MOCK_LANCAMENTOS;

        // IDs sequenciais
        let nextId = {
            planoContas: Math.max(...planoContas.map(p => p.id), 0) + 1,
            categorias: Math.max(...categorias.map(c => c.id), 0) + 1,
            bancos: Math.max(...bancos.map(b => b.id), 0) + 1,
            parceiros: Math.max(...parceiros.map(p => p.id), 0) + 1,
            lancamentos: Math.max(...lancamentos.map(l => l.id), 0) + 1,
            usuarios: Math.max(...usuarios.map(u => u.id), 0) + 1,
            tiposPagamento: Math.max(...tiposPagamento.map(tp => tp.id), 0) + 1
        };
        
        // UTILS
        
        function formatarDataParaInput(date) {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();

            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;

            return [year, month, day].join('-');
        }

        // Função para formatar data para exibição (DD/MM/AAAA)
        function formatarDataParaExibicao(dateStr) {
            if (!dateStr || dateStr.length !== 10) return '---';
            // Assume que dateStr está no formato AAAA-MM-DD
            const [ano, mes, dia] = dateStr.split('-');
            return `${dia}/${mes}/${ano}`;
        }
        
        // Função para formatar a exibição do mês/ano
        function formatarExibicaoMesAno(date) {
            const mes = MESES[date.getMonth()];
            const ano = date.getFullYear();
            return `${mes} / ${ano}`;
        }
        
        // Função para atualizar o display do filtro
        function atualizarDisplayFiltro() {
            const display = document.getElementById('filtro-mes-ano');
            if(display) {
                display.textContent = formatarExibicaoMesAno(filtroMesAno);
            }
        }
        
        // Função para mudar o mês do filtro
        function mudarMes(delta) {
            // Cria uma nova data no primeiro dia do mês atual do filtro
            const novoMes = filtroMesAno.getMonth() + delta;
            const novoAno = filtroMesAno.getFullYear();
            
            filtroMesAno = new Date(novoAno, novoMes, 1);
            
            atualizarDisplayFiltro();
            renderizarTabelaLancamentos();
        }

        // ===================================
        // FUNÇÃO DE LIMPEZA DE DADOS (EMERGÊNCIA)
        // ===================================

        // Função para Resetar Dados para Mocks (Solução para o problema)
        function limparDadosELocalStorage() {
             if (confirm("ATENÇÃO: Isso apagará TODOS os seus dados salvos localmente e irá restaurar os dados de demonstração (mocks). Deseja continuar?")) {
                 localStorage.clear();
                 // Força o reload para recarregar os mocks
                 window.location.reload(); 
             }
        }


        // ===================================
        // FUNÇÕES DE LOGIN, NAVEGAÇÃO E UTILITÁRIAS
        // ===================================
        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'flex';
            document.querySelector('.layout-container').style.display = 'none';
        }

        function hideLoginScreen() {
            document.getElementById('login-screen').style.display = 'none';
            document.querySelector('.layout-container').style.display = 'flex';
        }

        function processarLoginInicial(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const senha = document.getElementById('login-senha').value;
            const alertBox = document.getElementById('login-alert-message');
            
            alertBox.innerHTML = '';

            const user = usuarios.find(u => u.email === email && u.senha === senha);

            if (user) {
                loggedUserId = user.id;
                localStorage.setItem('loggedUserId', loggedUserId);
                localStorage.setItem('usuarios', JSON.stringify(usuarios));
                
                hideLoginScreen();
                updateLoggedUserStatus();
                showScreen('dashboard');
                mostrarNotificacao(`Login efetuado com sucesso! Bem-vindo(a), ${user.nome}.`, 'success');
                calcularSaldos();
                renderizarTabelas();
                
            } else {
                alertBox.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> E-mail ou Senha incorretos.</div>';
            }
        }

        function checkLoginStatus() {
            if (!loggedUserId) {
                showLoginScreen();
                return false;
            }
            
            const user = usuarios.find(u => u.id == loggedUserId);
            if (!user) {
                showLoginScreen();
                return false;
            }
            
            hideLoginScreen();
            updateLoggedUserStatus();
            return true;
        }

        function updateLoggedUserStatus() {
            const user = usuarios.find(u => u.id == loggedUserId);
            const userNameElement = document.getElementById('logged-user-name');
            
            if (userNameElement && user) {
                userNameElement.textContent = user.nome;
            }
        }

        function abrirModalTrocaUsuario() {
            localStorage.removeItem('loggedUserId');
            showLoginScreen();
        }
        
        function showScreen(screenId, element = null) {
            if (!checkLoginStatus()) return;
            
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
            
            document.querySelectorAll('.sidebar a').forEach(link => {
                link.classList.remove('active');
            });
            
            if (element) {
                element.classList.add('active');
            }
            
            if (screenId === 'lancamentos') {
                 // Garante que o filtro e a tabela sejam carregados corretamente
                 atualizarDisplayFiltro();
                 renderizarTabelaLancamentos();
                 preencherSelectsLancamentos({});
                 toggleStatusField(); // Garante que o campo de status inicial esteja correto
            } else if (screenId === 'cadastro-categorias') {
                 // Chama a função para preencher os selects de Plano de Contas
                 preencherSelectsCategorias({}); 
                 renderizarTabelaCategorias(); 
            } else if (screenId === 'dashboard') {
                calcularSaldos();
                // Renderiza saldos individuais e resumo mensal
                renderizarSaldosBancariosDashboard(); 
                calcularResumoMensal();
                // Detalhes de Pendentes
                calcularDetalhesPendentes();
                // NOVO: Renderiza o gráfico
                renderizarGraficoFluxoCaixa(); 
            } else if (screenId === 'relatorios') {
                 // NOVO: Preenche os filtros da tela de Relatórios
                 preencherFiltrosRelatorios();
            }
        }

        function mostrarNotificacao(mensagem, tipo, elementoId = null) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                ${mensagem}
            `;
            
            let container = document.body;
            if (elementoId) {
                const customContainer = document.getElementById(elementoId);
                if (customContainer) {
                    container = customContainer;
                }
            }
            // Garante que a notificação seja anexada antes de qualquer coisa, e não ao body (se container for definido)
            if (elementoId && document.getElementById(elementoId)) {
                document.getElementById(elementoId).prepend(alertDiv);
            } else {
                 document.body.prepend(alertDiv);
            }
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function toggleForm(containerId, toggleButtonId, isHidden) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (isHidden !== undefined ? isHidden : !container.classList.contains('hidden')) {
                container.classList.add('hidden');
            } else {
                container.classList.remove('hidden');
            }
        }

        function salvarDados() {
            localStorage.setItem('planoContas', JSON.stringify(planoContas));
            localStorage.setItem('categorias', JSON.stringify(categorias));
            localStorage.setItem('bancos', JSON.stringify(bancos));
            localStorage.setItem('parceiros', JSON.stringify(parceiros));
            localStorage.setItem('lancamentos', JSON.stringify(lancamentos));
            localStorage.setItem('usuarios', JSON.stringify(usuarios));
            // Salvar Tipos de Pagamento
            localStorage.setItem('tiposPagamento', JSON.stringify(tiposPagamento));
        }
        
        // NOVO: Função para calcular o Resumo Mensal (Receitas/Despesas Efetivadas)
        function calcularResumoMensal() {
            // Mês e Ano atual são baseados em 'hoje'
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();
            
            const lancamentosMesAtual = lancamentos.filter(l => {
                // Filtra apenas status efetivados (pago ou recebido)
                if (l.status !== 'pago' && l.status !== 'recebido') return false; 
                
                // Filtra pelo Mês de EFETIVAÇÃO (data)
                const dataEfetivacao = new Date(l.data + 'T12:00:00');
                return dataEfetivacao.getMonth() === mesAtual && dataEfetivacao.getFullYear() === anoAtual;
            });
            
            const totalReceitasMes = lancamentosMesAtual
                .filter(l => l.tipo === 'receita')
                .reduce((sum, l) => sum + l.valor, 0);
                
            const totalDespesasMes = lancamentosMesAtual
                .filter(l => l.tipo === 'despesa')
                .reduce((sum, l) => sum + l.valor, 0);
            
            document.getElementById('dashboard-total-receitas-mes').textContent = `R$ ${totalReceitasMes.toFixed(2)}`;
            document.getElementById('dashboard-total-despesas-mes').textContent = `R$ ${totalDespesasMes.toFixed(2)}`;
            
            // Atualiza o Saldo Geral (a função original calcularSaldos() já faz isso, mas garantimos a chamada)
            calcularSaldos();
        }
        
        // NOVO: Função para calcular detalhes de Contas Pendentes por Vencimento
        function calcularDetalhesPendentes() {
            const dataHoje = new Date(hoje.toISOString().split('T')[0] + 'T12:00:00'); // Data de hoje (2025-11-19)
            
            const totais = {
                aPagar: { vencidos: 0, hoje: 0, futuros: 0 },
                aReceber: { vencidos: 0, hoje: 0, futuros: 0 }
            };

            lancamentos.forEach(l => {
                if (l.status === 'pendente') {
                    const tipo = l.tipo === 'despesa' ? 'aPagar' : 'aReceber';
                    const dataVencimento = new Date(l.dataVencimento + 'T12:00:00');
                    
                    // Compara datas (convertendo para milissegundos para comparação numérica)
                    if (dataVencimento.getTime() < dataHoje.getTime()) {
                        totais[tipo].vencidos += l.valor;
                    } else if (dataVencimento.toDateString() === dataHoje.toDateString()) {
                        totais[tipo].hoje += l.valor;
                    } else {
                        totais[tipo].futuros += l.valor;
                    }
                }
            });

            // RENDERIZAÇÃO A PAGAR
            const htmlPagar = `
                <div class="detail-item vencidos">
                    <span><i class="fas fa-exclamation-triangle"></i> Vencidos:</span>
                    <span class="value">R$ ${totais.aPagar.vencidos.toFixed(2)}</span>
                </div>
                <div class="detail-item vence-hoje">
                    <span><i class="fas fa-calendar-day"></i> Vencem Hoje:</span>
                    <span class="value">R$ ${totais.aPagar.hoje.toFixed(2)}</span>
                </div>
                <div class="detail-item futuro">
                    <span><i class="fas fa-arrow-right"></i> Futuros:</span>
                    <span class="value">R$ ${totais.aPagar.futuros.toFixed(2)}</span>
                </div>
            `;
            document.getElementById('detalhes-a-pagar').innerHTML = htmlPagar;

            // RENDERIZAÇÃO A RECEBER
            const htmlReceber = `
                <div class="detail-item vencidos">
                    <span><i class="fas fa-exclamation-triangle"></i> Vencidos:</span>
                    <span class="value">R$ ${totais.aReceber.vencidos.toFixed(2)}</span>
                </div>
                <div class="detail-item vence-hoje">
                    <span><i class="fas fa-calendar-day"></i> Vencem Hoje:</span>
                    <span class="value">R$ ${totais.aReceber.hoje.toFixed(2)}</span>
                </div>
                <div class="detail-item futuro">
                    <span><i class="fas fa-arrow-right"></i> Futuros:</span>
                    <span class="value">R$ ${totais.aReceber.futuros.toFixed(2)}</span>
                </div>
            `;
            document.getElementById('detalhes-a-receber').innerHTML = htmlReceber;
            
            // Re-calcula o total geral (que é a soma de todos os pendentes)
            const totalAPagar = totais.aPagar.vencidos + totais.aPagar.hoje + totais.aPagar.futuros;
            const totalAReceber = totais.aReceber.vencidos + totais.aReceber.hoje + totais.aReceber.futuros;
            document.getElementById('dashboard-a-pagar').textContent = `R$ ${totalAPagar.toFixed(2)}`;
            document.getElementById('dashboard-a-receber').textContent = `R$ ${totalAReceber.toFixed(2)}`;
        }


        function calcularSaldos() {
            // Conta apenas lançamentos EFETIVADOS para o Saldo Geral do DASHBOARD
            const lancamentosEfetivados = lancamentos.filter(l => l.status === 'pago' || l.status === 'recebido');

            const totalReceitas = lancamentosEfetivados
                .filter(l => l.tipo === 'receita')
                .reduce((sum, l) => sum + l.valor, 0);
                
            const totalDespesas = lancamentosEfetivados
                .filter(l => l.tipo === 'despesa')
                .reduce((sum, l) => sum + l.valor, 0);
                
            const saldoTotal = totalReceitas - totalDespesas;
            
            document.getElementById('dashboard-saldo').textContent = `R$ ${saldoTotal.toFixed(2)}`;
        }
        
        // Função para agregar dados dos últimos X meses para o gráfico
        function getDataUltimosMeses(mesesRetroativos = 6) {
            const dadosAgregados = [];
            const labels = [];
            
            // Inicializa a partir do mês atual
            let dataCursor = new Date(hoje.getFullYear(), hoje.getMonth(), 1); 
            
            // Popula os dados agregados para X meses (incluindo o atual)
            for (let i = 0; i < mesesRetroativos; i++) {
                
                const mes = dataCursor.getMonth();
                const ano = dataCursor.getFullYear();
                
                // Mês/Ano para o Label
                labels.unshift(`${MESES[mes].substring(0, 3)}/${ano}`); 
                
                // Filtra lançamentos efetuados naquele mês e ano
                const lancamentosDoMes = lancamentos.filter(l => {
                    if (l.status !== 'pago' && l.status !== 'recebido') return false;
                    const dataEfetivacao = new Date(l.data + 'T12:00:00');
                    return dataEfetivacao.getMonth() === mes && dataEfetivacao.getFullYear() === ano;
                });
                
                const receitas = lancamentosDoMes.filter(l => l.tipo === 'receita').reduce((sum, l) => sum + l.valor, 0);
                const despesas = lancamentosDoMes.filter(l => l.tipo === 'despesa').reduce((sum, l) => sum + l.valor, 0);
                
                dadosAgregados.unshift({
                    receitas: receitas.toFixed(2),
                    despesas: despesas.toFixed(2),
                    fluxo: (receitas - despesas).toFixed(2)
                });
                
                // Volta um mês no cursor
                dataCursor.setMonth(dataCursor.getMonth() - 1);
            }
            
            const receitas = dadosAgregados.map(d => d.receitas);
            const despesas = dadosAgregados.map(d => d.despesas);
            
            return { labels, receitas, despesas };
        }
        
        // Variável global para armazenar a instância do gráfico
        let fluxoCaixaChartInstance = null;

        // Função para renderizar o gráfico usando Chart.js
        function renderizarGraficoFluxoCaixa() {
            const ctx = document.getElementById('fluxoCaixaChart');
            if (!ctx) return;
            
            const { labels, receitas, despesas } = getDataUltimosMeses(6);
            
            // Destrói a instância anterior do gráfico, se existir
            if (fluxoCaixaChartInstance) {
                fluxoCaixaChartInstance.destroy();
            }

            fluxoCaixaChartInstance = new Chart(ctx, {
                type: 'line', 
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Receitas Efetivadas',
                            data: receitas,
                            borderColor: 'rgba(46, 204, 154, 1)', // Verde (secondary-color)
                            backgroundColor: 'rgba(46, 204, 154, 0.1)',
                            borderWidth: 3, // Linha mais grossa para destaque
                            tension: 0.4, // Curva suave (onda)
                            fill: false, 
                            pointRadius: 5,
                            pointBackgroundColor: 'rgba(46, 204, 154, 1)'
                        },
                        {
                            label: 'Despesas Efetivadas',
                            data: despesas,
                            borderColor: 'rgba(231, 76, 60, 1)', // Vermelho (danger-color)
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 3, // Linha mais grossa para destaque
                            tension: 0.4, // Curva suave (onda)
                            fill: false, 
                            pointRadius: 5,
                            pointBackgroundColor: 'rgba(231, 76, 60, 1)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += 'R$ ' + context.parsed.y.toFixed(2).replace('.', ',');
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                        }
                    }
                }
            });
        }
        
        // Funções auxiliares para buscar nomes por ID
        function getNomeById(id, array) {
            const item = array.find(i => i.id == id);
            return item ? item.nome : 'Não Encontrado';
        }
        
        // Função auxiliar para buscar Descrição da Forma de Pagamento
        function getNomeTipoPagamento(id) {
            const tipo = tiposPagamento.find(tp => tp.id == id);
            return tipo ? tipo.descricao : 'Não Informada';
        }

        function getOptionsHtml(data, defaultValue = null, hasParcela = false) {
            let options = '<option value="">Selecione...</option>';
            data.forEach(item => {
                const selected = defaultValue == item.id ? 'selected' : ''; 
                // A chave pode ser 'nome' (Plano de Contas, Categorias, Bancos, Parceiros) ou 'descricao' (Tipos de Pagamento)
                const text = item.nome || item.descricao; 
                // Adicionando atributo data-parcela se for o caso
                const dataAttr = item.parcela ? `data-max-parcelas="${item.maxParcelas}"` : 'data-max-parcelas="1"';
                options += `<option value="${item.id}" ${selected} ${dataAttr}>${text}</option>`;
            });
            return options;
        }

        function preencherSelectsLancamentos(lancamento = {}) {
            const catId = lancamento.categoriaId || null;
            const bcoId = lancamento.bancoId || null;
            const pcoId = lancamento.parceiroId || null;
            const tpId = lancamento.tipoPagamentoId || null;

            // 1. Categorias
            const selectCategoria = document.getElementById('lancamento-categoria-id');
            if (selectCategoria) {
                selectCategoria.innerHTML = getOptionsHtml(categorias, catId);
            }

            // 2. Contas Bancárias
            const selectBanco = document.getElementById('lancamento-banco-id');
            if (selectBanco) {
                selectBanco.innerHTML = getOptionsHtml(bancos, bcoId);
            }
            
            // 3. Parceiros (Clientes/Forn.)
            const selectParceiro = document.getElementById('lancamento-parceiro-id');
            // Preenche o select de Parceiros para o formulário de Lançamentos
            if (selectParceiro) {
                selectParceiro.innerHTML = getOptionsHtml(parceiros, pcoId);
            }
            
            // 4. Tipos de Pagamento
            const selectTipoPagamento = document.getElementById('lancamento-tipo-pagamento-id');
            if (selectTipoPagamento) {
                // Filtra apenas ativos para seleção, mas carrega todos os dados
                const tiposAtivos = tiposPagamento.filter(tp => tp.ativo);
                selectTipoPagamento.innerHTML = getOptionsHtml(tiposAtivos, tpId);
                
                // Dispara a lógica de parcelamento para carregar o campo de parcelas
                atualizarCampoParcelas(tpId, lancamento.parcelas);
            }
            
            // 5. NOVO: Preenche o filtro de Parceiros
            const filtroParceiro = document.getElementById('filtro-parceiro-id');
            if (filtroParceiro) {
                filtroParceiro.innerHTML = getOptionsHtml(parceiros, '');
                // Adiciona a opção "Todos"
                filtroParceiro.prepend(new Option('Parceiro (Todos)', ''));
            }
            
            // 6. Configura o campo de status (Pago/Recebido)
            toggleStatusField(lancamento.status);
        }
        
        // Função para preencher selects de Plano de Contas na tela de Categoria
        function preencherSelectsCategorias(categoria = {}) {
            const pcId = categoria.planoContasId || null;
            
            // 1. Plano de Contas
            const selectPlanoContas = document.getElementById('categoria-plano-contas-id');
            if (selectPlanoContas) {
                selectPlanoContas.innerHTML = getOptionsHtml(planoContas, pcId);
            }
        }
        
        // Função para atualizar o campo de parcelas baseado na Forma de Pagamento
        function atualizarCampoParcelas(tipoPagamentoId, parcelaSelecionada = 1) {
            const selectPagamento = document.getElementById('lancamento-tipo-pagamento-id');
            const selectParcelas = document.getElementById('lancamento-parcelas');
            
            // Limpa e desativa o campo por padrão
            selectParcelas.innerHTML = '<option value="1">1x</option>';
            selectParcelas.disabled = true;

            const selectedOption = selectPagamento.querySelector(`option[value="${tipoPagamentoId}"]`);
            
            if (selectedOption) {
                const maxParcelas = parseInt(selectedOption.getAttribute('data-max-parcelas') || '1');
                
                if (maxParcelas > 1) {
                    selectParcelas.disabled = false;
                    let optionsHtml = '';
                    for (let i = 1; i <= maxParcelas; i++) {
                        const selected = i == parcelaSelecionada ? 'selected' : '';
                        optionsHtml += `<option value="${i}" ${selected}>${i}x</option>`;
                    }
                    selectParcelas.innerHTML = optionsHtml;
                }
            }
            
            // Recarrega o resumo de parcelas (será útil na edição)
            prepararResumoParcelas();
        }
        
        // Função para gerar o resumo visual das parcelas
        function prepararResumoParcelas() {
            const valorTotal = parseFloat(document.getElementById('lancamento-valor').value);
            const numParcelas = parseInt(document.getElementById('lancamento-parcelas').value);
            const dataVencimentoStr = document.getElementById('lancamento-data-vencimento').value;
            const resumoDiv = document.getElementById('resumo-parcelamento');
            const listaUl = document.getElementById('lista-parcelas');

            resumoDiv.classList.add('hidden');
            listaUl.innerHTML = ''; 

            if (numParcelas > 1 && valorTotal > 0 && dataVencimentoStr) {
                const valorParcela = Math.round((valorTotal / numParcelas) * 100) / 100; // Arredonda para 2 casas
                let dataVencimento = new Date(dataVencimentoStr + 'T12:00:00'); // Garante que a data não sofra fuso horário
                
                let totalAcumulado = 0;
                
                for (let i = 1; i <= numParcelas; i++) {
                    const dataVencimentoParcela = new Date(dataVencimento);
                    
                    // Adiciona i-1 meses à data da primeira parcela
                    if (i > 1) {
                         dataVencimentoParcela.setMonth(dataVencimentoParcela.getMonth() + (i - 1));
                    }
                    
                    let valorCorrigido = valorParcela;
                    totalAcumulado += valorParcela;

                    // Ajuste da última parcela para cobrir a diferença de arredondamento
                    if (i === numParcelas) {
                         const diferenca = valorTotal - totalAcumulado;
                         valorCorrigido = Math.round((valorParcela + diferenca) * 100) / 100;
                    }
                    
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <strong>${i}/${numParcelas}:</strong> R$ ${valorCorrigido.toFixed(2)} 
                        (Vencimento: ${formatarDataParaExibicao(formatarDataParaInput(dataVencimentoParcela))})
                    `;
                    listaUl.appendChild(li);
                }
                
                resumoDiv.classList.remove('hidden');
            } else if (numParcelas === 1) {
                 resumoDiv.classList.add('hidden');
            }
        }

        // Função para gerar múltiplos lançamentos (parcelamento)
        function gerarParcelas(lancamentoBase, numParcelas, isEfetivado) {
            const novosLancamentos = [];
            const valorTotal = lancamentoBase.valor;
            const valorParcela = Math.round((valorTotal / numParcelas) * 100) / 100;
            const dataVencimentoStr = lancamentoBase.dataVencimento;
            let dataVencimento = new Date(dataVencimentoStr + 'T12:00:00'); 
            
            let totalAcumulado = 0;
            
            const statusParaParcelas = isEfetivado 
                                       ? (lancamentoBase.tipo === 'receita' ? 'recebido' : 'pago') 
                                       : 'pendente';


            for (let i = 1; i <= numParcelas; i++) {
                const dataVencimentoParcela = new Date(dataVencimento);
                
                // Adiciona i-1 meses (para o primeiro mês, i-1=0, mantendo a data original)
                if (i > 1) {
                     dataVencimentoParcela.setMonth(dataVencimentoParcela.getMonth() + (i - 1));
                }
                
                let valorCorrigido = valorParcela;
                totalAcumulado += valorParcela;

                // Ajuste da última parcela para cobrir a diferença de arredondamento
                if (i === numParcelas) {
                     const diferenca = valorTotal - totalAcumulado;
                     valorCorrigido = Math.round((valorParcela + diferenca) * 100) / 100;
                }
                
                const novoLancamento = {
                    ...lancamentoBase,
                    id: nextId.lancamentos++, // Novo ID sequencial para cada parcela
                    valor: valorCorrigido,
                    dataVencimento: formatarDataParaInput(dataVencimentoParcela),
                    // Mantém a descrição original + informação da parcela
                    descricao: `${lancamentoBase.descricao} (${i}/${numParcelas})`, 
                    parcelas: numParcelas, 
                    parcelaAtual: i, 
                    status: statusParaParcelas // APLICA O STATUS ESCOLHIDO
                };
                
                // Se o status for efetivado, ajusta o saldo bancário (Apenas a primeira parcela para evitar duplicação no mock)
                // A lógica completa de efetivação para múltiplas parcelas é complexa e deve ser feita no clique do botão na tabela.
                if (statusParaParcelas !== 'pendente' && i === 1) {
                    ajustarSaldoBancario(novoLancamento, 'efetivar');
                }
                
                novosLancamentos.push(novoLancamento);
            }
            
            return novosLancamentos;
        }


        // ===================================
        // FUNÇÕES DE LANÇAMENTOS
        // ===================================
        
        function novoLancamentoRapido(tipo) {
            toggleForm('form-lancamento-container', null, false);
            document.getElementById('form-lancamento').reset();
            document.getElementById('lancamento-tipo').value = tipo;
            document.getElementById('lancamento-id').value = ''; 
            
            // Re-habilita campos
            document.getElementById('lancamento-valor').disabled = false;
            document.getElementById('lancamento-parcelas').disabled = false;
            
            // Garante que a data de efetivação seja preenchida com a data de hoje para novos lançamentos
            const hojeStr = formatarDataParaInput(new Date(hoje));
            document.getElementById('lancamento-data').value = hojeStr;
            document.getElementById('lancamento-data-vencimento').value = hojeStr;
            
            preencherSelectsLancamentos(); 
            
            // Zera o campo de parcelas e esconde o resumo
            const selectParcelas = document.getElementById('lancamento-parcelas');
            selectParcelas.innerHTML = '<option value="1">1x</option>';
            selectParcelas.disabled = true;
            document.getElementById('resumo-parcelamento').classList.add('hidden');
            
            // NOVO: Ajusta o campo de status para o padrão (Não/false)
            toggleStatusField();
            
            // Ajusta o container de ações: mostra apenas o Salvar Edição/Cancelar para Edição
            const actionContainer = document.querySelector('.form-action-buttons');
             if(actionContainer) {
                 actionContainer.innerHTML = `<button type="button" class="btn btn-danger" onclick="cancelarLancamento()">Cancelar</button>
                                              <button type="submit" class="btn btn-success">Salvar Lançamento(s)</button>`;
             }
        }

        function editarLancamento(id) {
            const lancamento = lancamentos.find(l => l.id === id);
            if (!lancamento) {
                mostrarNotificacao('Erro: Lançamento não encontrado para edição.', 'danger', 'lancamentos-alerts');
                return;
            }

            toggleForm('form-lancamento-container', null, false);
            
            // Preenche os campos do formulário
            document.getElementById('lancamento-id').value = lancamento.id;
            document.getElementById('lancamento-descricao').value = lancamento.descricao;
            document.getElementById('lancamento-valor').value = lancamento.valor.toFixed(2);
            document.getElementById('lancamento-data').value = lancamento.data;
            document.getElementById('lancamento-data-vencimento').value = lancamento.dataVencimento;
            document.getElementById('lancamento-tipo').value = lancamento.tipo;

            preencherSelectsLancamentos(lancamento); 
            
            document.getElementById('lancamento-tipo-pagamento-id').value = lancamento.tipoPagamentoId;
            atualizarCampoParcelas(lancamento.tipoPagamentoId, lancamento.parcelas);

            // CORREÇÃO ESSENCIAL: Permite a edição apenas de lançamentos não parcelados (1x) ou de parcelas individuais
            const isParcelado = lancamento.parcelas > 1;
            const valorInput = document.getElementById('lancamento-valor');
            const parcelasSelect = document.getElementById('lancamento-parcelas');
            
            // Se for um lançamento que faz parte de uma sequência (parcelas > 1), bloqueia valor e número de parcelas
            valorInput.disabled = isParcelado;
            parcelasSelect.disabled = isParcelado;

            if (isParcelado) {
                 mostrarNotificacao(`Você está editando a Parcela ${lancamento.parcelaAtual}/${lancamento.parcelas}. Valor e número de parcelas bloqueados.`, 'warning', 'lancamentos-alerts');
                 // Força o valor correto da parcela individual no campo de valor
                 valorInput.value = lancamento.valor.toFixed(2);
                 
            } else {
                 // Lançamento simples (1x)
                 valorInput.disabled = false; 
            }
            
            // Garante que o campo de parcelas exiba o valor correto para a edição (1x ou N/X)
            document.getElementById('lancamento-parcelas').value = lancamento.parcelas || 1;
            
            prepararResumoParcelas();
            
            // NOVO: Define o status Sim/Não do campo de edição
            toggleStatusField(lancamento.status);


            // Renderiza o botão de reversão se o lançamento estiver efetivado
            const isEfetivado = (lancamento.status === 'pago' || lancamento.status === 'recebido');
            const reverterButton = isEfetivado ? 
                `<button type="button" class="btn btn-danger" style="margin-right: 10px;" onclick="efetivarLancamento(${lancamento.id})">
                    <i class="fas fa-undo"></i> Reverter para Pendente
                </button>` : '';

            // MUDANÇA: Exibe apenas o botão de Salvar Edição e o Reverter
            const actionContainer = document.querySelector('.form-action-buttons');
             if(actionContainer) {
                 actionContainer.innerHTML = `${reverterButton}
                                             <button type="button" class="btn btn-danger" onclick="cancelarLancamento()">Cancelar</button>
                                             <button type="submit" class="btn btn-success" id="btn-salvar-edicao">Salvar Lançamento</button>`;
             }
            
            document.getElementById('form-lancamento-container').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelarLancamento() {
            document.getElementById('lancamento-id').value = ''; 
            toggleForm('form-lancamento-container', null, true);
            document.getElementById('form-lancamento').reset();
            
            // Reseta e re-habilita os campos de valor/parcelas
            document.getElementById('lancamento-valor').disabled = false;
            document.getElementById('lancamento-parcelas').disabled = false;
            
            // Reseta o campo de parcelas e resumo
            const selectParcelas = document.getElementById('lancamento-parcelas');
            selectParcelas.innerHTML = '<option value="1">1x</option>';
            selectParcelas.disabled = true;
            document.getElementById('resumo-parcelamento').classList.add('hidden');
        }
        
        // Função para AJUSTAR O SALDO DA CONTA BANCÁRIA
        function ajustarSaldoBancario(lancamento, operacao) {
            const bancoIndex = bancos.findIndex(b => b.id === lancamento.bancoId);

            if (bancoIndex !== -1) {
                let saldoAtual = bancos[bancoIndex].saldo;
                const valor = lancamento.valor;
                const tipo = lancamento.tipo; 

                let novoSaldo = saldoAtual;

                if (operacao === 'efetivar') {
                    if (tipo === 'receita') {
                        novoSaldo += valor; 
                    } else {
                        novoSaldo -= valor; 
                    }
                } else if (operacao === 'reverter') {
                    if (tipo === 'receita') {
                        novoSaldo -= valor; 
                    } else {
                        novoSaldo += valor; 
                    }
                }

                bancos[bancoIndex].saldo = novoSaldo;
                return true;
            }
            return false;
        }

        // Função para efetivar/reverter o lançamento E O SALDO BANCÁRIO
        function efetivarLancamento(id) {
            const lancamentoIndex = lancamentos.findIndex(l => l.id === id);

            if (lancamentoIndex !== -1) {
                const lancamento = lancamentos[lancamentoIndex];
                
                const novoStatus = lancamento.tipo === 'receita' ? 'recebido' : 'pago';
                const mensagem = lancamento.tipo === 'receita' ? 'recebida' : 'paga';
                
                if (lancamento.status !== 'pendente') {
                     // AÇÃO: REVERTER
                     if (!confirm(`Este lançamento já está ${mensagem}. Deseja marcá-lo como PENDENTE novamente? Isso pode afetar o saldo do Dashboard e da Conta Bancária.`)) {
                         return;
                     }
                     
                     ajustarSaldoBancario(lancamento, 'reverter');
                     lancamento.status = 'pendente';
                     mostrarNotificacao('Lançamento revertido para PENDENTE! Saldo bancário ajustado.', 'danger', 'lancamentos-alerts');
                     
                     // Se a reversão foi feita no formulário de edição, fecha o formulário
                     cancelarLancamento();
                } else {
                     // AÇÃO: EFETIVAR
                     
                     ajustarSaldoBancario(lancamento, 'efetivar');
                     lancamento.status = novoStatus;
                     mostrarNotificacao(`Lançamento ${mensagem} com sucesso! Saldo bancário ajustado.`, 'success', 'lancamentos-alerts');
                }

                salvarDados();
                renderizarTabelaLancamentos();
                renderizarTabelaBancos(); 
                calcularSaldos();
                calcularResumoMensal(); // Atualiza o resumo do mês
                calcularDetalhesPendentes(); // Atualiza os detalhes
                renderizarGraficoFluxoCaixa(); // Atualiza o gráfico
            }
        }

        // Tornar o status 'pendente' Laranja (badge-warning) tanto para receita quanto para despesa.
        function renderizarTabelaLancamentos() {
            const tbody = document.getElementById('tbody-lancamentos');
            if (!tbody) return;
            
            // 1. OBTENÇÃO DE FILTROS
            const mesFiltro = filtroMesAno.getMonth();
            const anoFiltro = filtroMesAno.getFullYear();
            
            const filtroStatus = document.getElementById('filtro-status').value.toLowerCase();
            const filtroTipo = document.getElementById('filtro-tipo').value.toLowerCase();
            const filtroParceiroId = document.getElementById('filtro-parceiro-id').value;
            const filtroDescricao = document.getElementById('filtro-descricao').value.toLowerCase().trim();


            // 2. FILTRAGEM: Filtra lançamentos pela data de vencimento e filtros adicionais
            const lancamentosFiltrados = lancamentos.filter(lancamento => {
                // Filtro 1: Mês/Ano (Vencimento)
                if (!lancamento.dataVencimento) return false; 
                const dataVencimento = new Date(lancamento.dataVencimento + 'T12:00:00');
                if (dataVencimento.getMonth() !== mesFiltro || dataVencimento.getFullYear() !== anoFiltro) {
                    return false;
                }
                
                // Filtro 2: Status
                if (filtroStatus && lancamento.status !== filtroStatus) {
                    return false;
                }
                
                // Filtro 3: Tipo
                if (filtroTipo && lancamento.tipo !== filtroTipo) {
                    return false;
                }
                
                // Filtro 4: Parceiro
                if (filtroParceiroId && lancamento.parceiroId != filtroParceiroId) {
                    return false;
                }
                
                // Filtro 5: Descrição (Busca em descrição ou categoria)
                if (filtroDescricao) {
                    const descricaoLowerCase = (lancamento.descricao || '').toLowerCase();
                    const categoriaNome = getNomeById(lancamento.categoriaId, categorias).toLowerCase();
                    
                    if (!descricaoLowerCase.includes(filtroDescricao) && !categoriaNome.includes(filtroDescricao)) {
                        return false;
                    }
                }

                return true;
            });
            
            // 3. RENDERIZAÇÃO
            tbody.innerHTML = lancamentosFiltrados.map(lancamento => {
                // 1. Status Badge
                let statusBadgeClass = ''; 
                let statusText = 'Pendente';

                if (lancamento.status === 'pago') {
                    statusBadgeClass = 'badge-pago';
                    statusText = 'PAGO';
                } else if (lancamento.status === 'recebido') {
                    statusBadgeClass = 'badge-recebido-status'; 
                    statusText = 'RECEBIDO';
                } else if (lancamento.status === 'pendente') { 
                    statusBadgeClass = 'badge-warning'; 
                    statusText = 'Pendente'; 
                }
                
                // 2. Tipo Badge (Apenas cor de fonte)
                const tipoTextColorClass = lancamento.tipo === 'receita' ? 'tipo-receita-text' : 'tipo-despesa-text';
                
                // 3. Detalhe da Forma de Pagamento e Parcelas (incluindo parcelaAtual/parcelas)
                const formaPagamentoNome = getNomeTipoPagamento(lancamento.tipoPagamentoId);
                const categoriaNome = getNomeById(lancamento.categoriaId, categorias); // Categoria
                const parcelaInfo = (lancamento.parcelas > 1 && lancamento.parcelaAtual) ? 
                                     ` (${lancamento.parcelaAtual}/${lancamento.parcelas})` : 
                                     (lancamento.parcelas > 1 ? ` (Total: ${lancamento.parcelas}x)` : ''); 

                // 4. Botão Efetivar (na Tabela)
                const efetivarButtonText = lancamento.tipo === 'receita' ? 'Receber' : 'Pagar';
                const efetivarButtonIcon = 'fa-check'; // Padrão sempre checkmark
                
                // MUDANÇA: Usando classes compactas de ícones
                const efetivarButton = lancamento.status === 'pendente' ? 
                    `<button class="btn btn-success btn-sm btn-action-icon" title="${efetivarButtonText}" onclick="efetivarLancamento(${lancamento.id})">
                        <i class="fas ${efetivarButtonIcon}"></i>
                    </button>` : ''; 
                    
                // 5. Parceiro
                const parceiroNome = getNomeById(lancamento.parceiroId, parceiros);


                return `
                    <tr>
                        <td>${parceiroNome}</td>
                        
                        <td>
                            <strong title="Descrição">${lancamento.descricao || categoriaNome}</strong>
                            <br>
                            <small style="color: var(--text-light);">
                                Categoria: ${categoriaNome}
                                <br>
                                Conta: ${getNomeById(lancamento.bancoId, bancos)} | Pgto: ${formaPagamentoNome}${parcelaInfo}
                            </small>
                        </td>
                        
                        <td>R$ ${lancamento.valor.toFixed(2)}</td>
                        <td>${formatarDataParaExibicao(lancamento.dataVencimento)}</td>
                        <td><span class="${tipoTextColorClass}">${lancamento.tipo}</span></td>
                        <td><span class="badge ${statusBadgeClass}">${statusText}</span></td>
                        <td>
                            ${efetivarButton}
                            <button class="btn btn-info btn-sm btn-action-icon" title="Editar" onclick="editarLancamento(${lancamento.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm btn-action-icon" title="Excluir" onclick="excluirLancamento(${lancamento.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function excluirLancamento(id) {
            if (confirm('Tem certeza que deseja excluir este lançamento? Se for uma parcela, apenas ela será excluída.')) {
                // Se estiver efetivado (pago/recebido), é necessário reverter o impacto no saldo bancário
                const lancamento = lancamentos.find(l => l.id == id);
                if (lancamento && (lancamento.status === 'pago' || lancamento.status === 'recebido')) {
                     ajustarSaldoBancario(lancamento, 'reverter');
                }

                lancamentos = lancamentos.filter(l => l.id !== id);
                salvarDados();
                renderizarTabelaLancamentos();
                renderizarTabelaBancos();
                calcularSaldos();
                mostrarNotificacao('Lançamento excluído com sucesso!', 'success', 'lancamentos-alerts');
            }
        }

        // ===================================
        // FUNÇÕES DO DASHBOARD
        // ===================================
        function renderizarSaldosBancariosDashboard() {
            const container = document.getElementById('dashboard-saldos-bancarios');
            if (!container) return;
            
            container.innerHTML = bancos.map(banco => {
                const saldoClass = banco.saldo >= 0 ? 'saldo-positivo' : 'saldo-negativo';
                
                return `
                    <div class="saldo-item">
                        <span><i class="fas fa-money-check-alt"></i> ${banco.nome}:</span>
                        <span class="${saldoClass}">R$ ${banco.saldo.toFixed(2)}</span>
                    </div>
                `;
            }).join('');
        }
        
        // ===================================
        // FUNÇÕES DE CADASTROS 
        // ===================================

        // PLANO DE CONTAS
        function novoPlanoContasRapido() {
            toggleForm('form-contas-container', null, false);
            document.getElementById('form-contas').reset();
            document.getElementById('conta-id').value = ''; 
        }

        function editarPlanoContas(id) {
            const conta = planoContas.find(p => p.id === id);
            if (!conta) { mostrarNotificacao('Erro: Conta não encontrada para edição.', 'danger'); return; }
            toggleForm('form-contas-container', null, false);
            document.getElementById('conta-id').value = conta.id;
            document.getElementById('conta-nome').value = conta.nome;
            document.getElementById('conta-tipo').value = conta.tipo;
            document.getElementById('form-contas-container').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelarPlanoContas() {
            document.getElementById('conta-id').value = ''; 
            toggleForm('form-contas-container', null, true);
            document.getElementById('form-contas').reset();
        }

        function renderizarTabelaPlanoContas() {
            const tbody = document.getElementById('tbody-contas');
            if (!tbody) return;
            
            tbody.innerHTML = planoContas.map(conta => `
                <tr>
                    <td>${conta.id}</td>
                    <td>${conta.nome}</td>
                    <td><span class="badge ${conta.tipo === 'receita' ? 'badge-receita' : 'badge-despesa'}">${conta.tipo}</span></td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="editarPlanoContas(${conta.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="excluirPlanoContas(${conta.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Se houver mudanças no Plano de Contas, o select de Categorias precisa ser atualizado
            preencherSelectsCategorias({}); 
            renderizarTabelaCategorias();
        }

        function excluirPlanoContas(id) {
            if (confirm('Tem certeza que deseja excluir esta conta?')) {
                planoContas = planoContas.filter(p => p.id !== id);
                salvarDados();
                renderizarTabelaPlanoContas();
                mostrarNotificacao('Conta excluída com sucesso!', 'success');
            }
        }
        
        // CATEGORIAS
        function novaCategoriaRapido() {
            toggleForm('form-categorias-container', null, false);
            document.getElementById('form-categorias').reset();
            document.getElementById('categoria-id').value = ''; 
            // Garante que o select esteja preenchido
            preencherSelectsCategorias({}); 
        }

        function editarCategoria(id) {
            const categoria = categorias.find(c => c.id === id);
            if (!categoria) { mostrarNotificacao('Erro: Categoria não encontrada para edição.', 'danger'); return; }
            toggleForm('form-categorias-container', null, false);
            
            document.getElementById('categoria-id').value = categoria.id;
            document.getElementById('categoria-nome').value = categoria.nome;
            // Preenche o select de Plano de Contas
            preencherSelectsCategorias(categoria);
            
            document.getElementById('form-categorias-container').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelarCategoria() {
            document.getElementById('categoria-id').value = ''; 
            toggleForm('form-categorias-container', null, true);
            document.getElementById('form-categorias').reset();
        }

        function renderizarTabelaCategorias() {
            const tbody = document.getElementById('tbody-categorias');
            if (!tbody) return;
            
            tbody.innerHTML = categorias.map(categoria => {
                const planoContasNome = getNomeById(categoria.planoContasId, planoContas);
                
                // Determina o tipo da Categoria através do Plano de Contas associado
                const plano = planoContas.find(p => p.id === categoria.planoContasId);
                const tipo = plano ? plano.tipo : 'N/A';
                const tipoBadgeClass = tipo === 'receita' ? 'badge-receita' : (tipo === 'despesa' ? 'badge-despesa' : '');

                return `
                    <tr>
                        <td>${categoria.id}</td>
                        <td>${categoria.nome}</td>
                        <td>${planoContasNome}</td>
                        <td><span class="badge ${tipoBadgeClass}">${tipo}</span></td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="editarCategoria(${categoria.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="excluirCategoria(${categoria.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function excluirCategoria(id) {
            if (confirm('Tem certeza que deseja excluir esta categoria?')) {
                categorias = categorias.filter(c => c.id !== id);
                salvarDados();
                renderizarTabelaCategorias();
                mostrarNotificacao('Categoria excluída com sucesso!', 'success');
            }
        }
        
        // CONTAS BANCÁRIAS (CONTAS FINANCEIRAS)
        function novaContaRapido() {
            toggleForm('form-bancos-container', null, false);
            document.getElementById('form-bancos').reset();
            document.getElementById('banco-id').value = ''; 
        }

        function editarBanco(id) {
            const banco = bancos.find(b => b.id === id);
            if (!banco) { mostrarNotificacao('Erro: Conta bancária não encontrada para edição.', 'danger'); return; }
            toggleForm('form-bancos-container', null, false);
            document.getElementById('banco-id').value = banco.id;
            document.getElementById('banco-nome').value = banco.nome;
            document.getElementById('banco-saldo-inicial').value = banco.saldo.toFixed(2);
            document.getElementById('form-bancos-container').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelarConta() {
            document.getElementById('banco-id').value = ''; 
            toggleForm('form-bancos-container', null, true);
            document.getElementById('form-bancos').reset();
        }

        // Função de renderização com coloração do Saldo
        function renderizarTabelaBancos() {
            const tbody = document.getElementById('tbody-bancos');
            if (!tbody) return;
            
            tbody.innerHTML = bancos.map(banco => {
                const saldoClass = banco.saldo >= 0 ? 'saldo-positivo' : 'saldo-negativo';
                
                return `
                    <tr>
                        <td>${banco.id}</td>
                        <td>${banco.nome}</td>
                        <td><span class="${saldoClass}">R$ ${banco.saldo.toFixed(2)}</span></td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="editarBanco(${banco.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="excluirBanco(${banco.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // NOVO: Atualiza também a lista de saldos no Dashboard
            renderizarSaldosBancariosDashboard();
        }

        function excluirBanco(id) {
            if (confirm('Tem certeza que deseja excluir esta conta bancária?')) {
                bancos = bancos.filter(b => b.id !== id);
                salvarDados();
                renderizarTabelaBancos();
                mostrarNotificacao('Conta bancária excluída com sucesso!', 'success');
            }
        }
        
        // TIPOS DE PAGAMENTO
        function toggleMaxParcelas() {
            const isParcelamento = document.getElementById('tipo-pagamento-parcela-sim').value === 'true';
            const container = document.querySelector('.campo-parcelamento');
            
            if (isParcelamento) {
                container.classList.remove('hidden');
                document.getElementById('tipo-pagamento-max-parcelas').required = true;
            } else {
                container.classList.add('hidden');
                document.getElementById('tipo-pagamento-max-parcelas').required = false;
                document.getElementById('tipo-pagamento-max-parcelas').value = 1; 
            }
        }
        
        function novoTipoPagamentoRapido() {
            toggleForm('form-tipos-pagamento-container', null, false);
            document.getElementById('form-tipos-pagamento').reset();
            document.getElementById('tipo-pagamento-id').value = ''; 
            // Garante que o campo de parcela esteja escondido no modo "novo"
            document.querySelector('.campo-parcelamento').classList.add('hidden'); 
        }

        function editarTipoPagamento(id) {
            const tipoPagamento = tiposPagamento.find(tp => tp.id === id);
            if (!tipoPagamento) { mostrarNotificacao('Erro: Tipo de Pagamento não encontrado para edição.', 'danger'); return; }
            
            toggleForm('form-tipos-pagamento-container', null, false);
            
            document.getElementById('tipo-pagamento-id').value = tipoPagamento.id;
            document.getElementById('tipo-pagamento-descricao').value = tipoPagamento.descricao;
            document.getElementById('tipo-pagamento-ativo').value = tipoPagamento.ativo.toString();
            document.getElementById('tipo-pagamento-parcela-sim').value = tipoPagamento.parcela.toString();
            
            // Exibe ou esconde o campo de parcela e preenche o valor
            if (tipoPagamento.parcela) {
                document.querySelector('.campo-parcelamento').classList.remove('hidden');
                document.getElementById('tipo-pagamento-max-parcelas').value = tipoPagamento.maxParcelas;
            } else {
                document.querySelector('.campo-parcelamento').classList.add('hidden');
                document.getElementById('tipo-pagamento-max-parcelas').value = 1;
            }
            
            document.getElementById('form-tipos-pagamento-container').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelarTipoPagamento() {
            document.getElementById('tipo-pagamento-id').value = ''; 
            toggleForm('form-tipos-pagamento-container', null, true);
            document.getElementById('form-tipos-pagamento').reset();
            document.querySelector('.campo-parcelamento').classList.add('hidden');
        }

        function renderizarTabelaTiposPagamento() {
            const tbody = document.getElementById('tbody-tipos-pagamento');
            if (!tbody) return;
            
            tbody.innerHTML = tiposPagamento.map(tipo => {
                const ativoText = tipo.ativo ? 'Ativo' : 'Inativo';
                const ativoClass = tipo.ativo ? 'badge-ativo' : 'badge-inativo';
                const parcelaText = tipo.parcela ? `Sim (Máx: ${tipo.maxParcelas})` : 'Não';

                return `
                    <tr>
                        <td>${tipo.id}</td>
                        <td>${tipo.descricao}</td>
                        <td><span class="badge ${ativoClass}">${ativoText}</span></td>
                        <td>${parcelaText}</td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="editarTipoPagamento(${tipo.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="excluirTipoPagamento(${tipo.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function excluirTipoPagamento(id) {
            if (confirm('Tem certeza que deseja excluir este Tipo de Pagamento?')) {
                tiposPagamento = tiposPagamento.filter(tp => tp.id !== id);
                salvarDados();
                renderizarTabelaTiposPagamento();
                mostrarNotificacao('Tipo de Pagamento excluído com sucesso!', 'success');
            }
        }
        
        // PARCEIROS
        function novoParceiroRapido() {
            toggleForm('form-parceiros-container', null, false);
            document.getElementById('form-parceiros').reset();
            document.getElementById('parceiro-id').value = ''; 
        }

        function editarParceiro(id) {
            const parceiro = parceiros.find(p => p.id === id);
            if (!parceiro) { mostrarNotificacao('Erro: Parceiro não encontrado para edição.', 'danger'); return; }
            toggleForm('form-parceiros-container', null, false);
            document.getElementById('parceiro-id').value = parceiro.id;
            document.getElementById('parceiro-nome').value = parceiro.nome;
            document.getElementById('parceiro-tipo').value = parceiro.tipo;
            document.getElementById('form-parceiros-container').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelarParceiro() {
            document.getElementById('parceiro-id').value = ''; 
            toggleForm('form-parceiros-container', null, true);
            document.getElementById('form-parceiros').reset();
        }

        function renderizarTabelaParceiros() {
            const tbody = document.getElementById('tbody-parceiros');
            if (!tbody) return;
            
            tbody.innerHTML = parceiros.map(parceiro => `
                <tr>
                    <td>${parceiro.id}</td>
                    <td>${parceiro.nome}</td>
                    <td>${parceiro.tipo}</td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="editarParceiro(${parceiro.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="excluirParceiro(${parceiro.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function excluirParceiro(id) {
            if (confirm('Tem certeza que deseja excluir este parceiro?')) {
                parceiros = parceiros.filter(p => p.id !== id);
                salvarDados();
                renderizarTabelaParceiros();
                mostrarNotificacao('Parceiro excluído com sucesso!', 'success');
            }
        }
        
        // USUÁRIOS
        function novoUsuarioRapido() {
            toggleForm('form-usuarios-container', null, false);
            document.getElementById('form-usuarios').reset();
            document.getElementById('usuario-id').value = ''; 
            document.getElementById('usuario-senha').required = true; 
            document.getElementById('usuario-senha').placeholder = 'Sua senha';
        }

        function editarUsuario(id) {
            const usuario = usuarios.find(u => u.id === id);
            if (!usuario) { mostrarNotificacao('Erro: Usuário não encontrado para edição.', 'danger'); return; }
            toggleForm('form-usuarios-container', null, false);
            document.getElementById('usuario-id').value = usuario.id;
            document.getElementById('usuario-nome').value = usuario.nome;
            document.getElementById('usuario-email').value = usuario.email;
            document.getElementById('usuario-senha').value = ''; 
            document.getElementById('usuario-senha').required = false; 
            document.getElementById('usuario-senha').placeholder = 'Preencha apenas para alterar';
            document.getElementById('form-usuarios-container').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelarUsuario() {
            document.getElementById('usuario-id').value = ''; 
            document.getElementById('usuario-senha').required = true; 
            document.getElementById('usuario-senha').placeholder = 'Sua senha';
            toggleForm('form-usuarios-container', null, true);
            document.getElementById('form-usuarios').reset();
        }

        function renderizarTabelaUsuarios() {
            const tbody = document.getElementById('tbody-usuarios');
            if (!tbody) return;
            
            tbody.innerHTML = usuarios.map(usuario => `
                <tr>
                    <td>${usuario.id}</td>
                    <td>${usuario.nome}</td>
                    <td>${usuario.email}</td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="editarUsuario(${usuario.id})" ${usuario.id == loggedUserId ? 'disabled' : ''}>
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="excluirUsuario(${usuario.id})" ${usuario.id == loggedUserId ? 'disabled' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function excluirUsuario(id) {
            if (id == loggedUserId) {
                mostrarNotificacao('Não é possível excluir o usuário logado!', 'danger');
                return;
            }
            
            if (confirm('Tem certeza que deseja excluir este usuário?')) {
                usuarios = usuarios.filter(u => u.id !== id);
                salvarDados();
                renderizarTabelaUsuarios();
                mostrarNotificacao('Usuário excluído com sucesso!', 'success');
            }
        }

        // ===================================
        // RENDERIZAR TODAS AS TABELAS
        // ===================================
        function renderizarTabelas() {
            renderizarTabelaLancamentos();
            renderizarTabelaPlanoContas();
            renderizarTabelaCategorias();
            renderizarTabelaBancos();
            renderizarTabelaParceiros();
            renderizarTabelaUsuarios();
            renderizarTabelaTiposPagamento();
            atualizarDisplayFiltro();
            // Garante que o Dashboard seja atualizado no carregamento
            calcularResumoMensal();
        }

        // ===================================
        // FORMULÁRIOS - EVENT LISTENERS
        // ===================================
        document.addEventListener('DOMContentLoaded', function() {
            // Implementação da Lógica Dinâmica do Menu Lateral
            const body = document.body;
            const toggleSidebar = () => {
                const width = window.innerWidth;
                // Para telas menores que 992px, recolhe automaticamente
                if (width < 992) {
                    body.classList.add('sidebar-recolhido');
                } else {
                    body.classList.remove('sidebar-recolhido');
                }
            };

            // Aplica a lógica ao carregar e redimensionar
            toggleSidebar();
            window.addEventListener('resize', toggleSidebar);
            
            // Login
            document.getElementById('form-login-inicial').addEventListener('submit', processarLoginInicial);

            // Navegação
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const screenId = this.getAttribute('data-screen');
                    showScreen(screenId, this);
                });
            });
            
            // Listener para Forma de Pagamento (Atualiza Parcelas)
            document.getElementById('lancamento-tipo-pagamento-id').addEventListener('change', function() {
                 atualizarCampoParcelas(this.value);
            });
            
            // Listener para Tipo de Lançamento (Atualiza Label de Status)
            document.getElementById('lancamento-tipo').addEventListener('change', toggleStatusField);
            
            // Listener para Valor Total e Data de Vencimento (Atualiza Resumo)
            document.getElementById('lancamento-valor').addEventListener('input', prepararResumoParcelas);
            document.getElementById('lancamento-data-vencimento').addEventListener('change', prepararResumoParcelas);


            // *******************************************************************
            // Lógica de Submissão de Lançamentos
            // *******************************************************************
            document.getElementById('form-lancamento').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const id = document.getElementById('lancamento-id').value; 
                const numParcelas = parseInt(document.getElementById('lancamento-parcelas').value);
                const valorAtual = parseFloat(document.getElementById('lancamento-valor').value);
                
                // LÊ O VALOR DO CAMPO DE STATUS SIM/NÃO
                const isStatusSim = document.getElementById('lancamento-pago-recebido').value === 'true'; 

                
                // Determina o status final para o salvamento
                const statusFinal = isStatusSim
                                    ? (document.getElementById('lancamento-tipo').value === 'receita' ? 'recebido' : 'pago') 
                                    : 'pendente';
                
                if (isNaN(valorAtual) || valorAtual <= 0) {
                     mostrarNotificacao('O Valor Total deve ser um número positivo.', 'danger', 'lancamentos-alerts');
                     return;
                }
                
                const lancamentoBase = {
                    descricao: document.getElementById('lancamento-descricao').value,
                    valor: valorAtual,
                    data: document.getElementById('lancamento-data').value,
                    dataVencimento: document.getElementById('lancamento-data-vencimento').value,
                    tipo: document.getElementById('lancamento-tipo').value,
                    categoriaId: parseInt(document.getElementById('lancamento-categoria-id').value),
                    bancoId: parseInt(document.getElementById('lancamento-banco-id').value),
                    parceiroId: parseInt(document.getElementById('lancamento-parceiro-id').value),
                    tipoPagamentoId: parseInt(document.getElementById('lancamento-tipo-pagamento-id').value),
                };

                // 1. LÓGICA DE EDIÇÃO (Apenas 1x ou Parcela Individual)
                if (id) {
                    const lancamentoOriginal = lancamentos.find(l => l.id == id);
                    
                    // Lógica de Status: Se mudou de Efetivado/Pendente ou vice-versa, ajusta o saldo.
                    const isOriginalEfetivado = (lancamentoOriginal.status === 'pago' || lancamentoOriginal.status === 'recebido');
                    const isNovoEfetivado = isStatusSim;
                    
                    if (isOriginalEfetivado !== isNovoEfetivado) {
                        if (isNovoEfetivado) {
                            // De Pendente para Efetivado
                            ajustarSaldoBancario(lancamentoOriginal, 'efetivar');
                        } else {
                            // De Efetivado para Pendente
                            ajustarSaldoBancario(lancamentoOriginal, 'reverter');
                        }
                    }

                    const lancamentoData = {
                        ...lancamentoBase,
                        id: parseInt(id),
                        parcelas: lancamentoOriginal.parcelas || 1, 
                        parcelaAtual: lancamentoOriginal.parcelaAtual || 1,
                        status: statusFinal // Aplica o novo status
                    };
                    
                    const index = lancamentos.findIndex(l => l.id == id);
                    if (index !== -1) {
                        lancamentos[index] = lancamentoData;
                        mostrarNotificacao('Lançamento editado com sucesso!', 'success', 'lancamentos-alerts');
                    }
                
                // 2. LÓGICA DE CRIAÇÃO (1x ou Nx)
                } else {
                    let lancamentosParaSalvar;
                    let mensagemNotificacao;
                    
                    if (numParcelas > 1) {
                        // GERA MÚLTIPLAS PARCELAS E APLICA O STATUS ESCOLHIDO
                        lancamentosParaSalvar = gerarParcelas(lancamentoBase, numParcelas, isStatusSim);
                        mensagemNotificacao = `${numParcelas} lançamentos gerados e salvos com sucesso!`;
                        
                    } else {
                        // LANÇAMENTO SIMPLES (1x)
                        const lancamentoSimples = {
                            ...lancamentoBase,
                            id: nextId.lancamentos++, 
                            parcelas: 1,
                            parcelaAtual: 1,
                            status: statusFinal // Aplica o status final
                        };
                        
                        lancamentosParaSalvar = [lancamentoSimples];
                        mensagemNotificacao = `Lançamento salvo como ${statusFinal.toUpperCase()} com sucesso!`;
                        
                        // Efetua o ajuste imediato no saldo se for efetivado
                        if (statusFinal !== 'pendente') {
                             ajustarSaldoBancario(lancamentoSimples, 'efetivar');
                        }
                    }
                    
                    // Salva os novos lançamentos
                    lancamentos.push(...lancamentosParaSalvar);
                    mostrarNotificacao(mensagemNotificacao, 'success', 'lancamentos-alerts');
                }
                
                salvarDados();
                renderizarTabelaLancamentos();
                calcularSaldos();
                cancelarLancamento();
            });

            // Plano de Contas (Listener)
            document.getElementById('form-contas').addEventListener('submit', function(e) {
                e.preventDefault();
                const id = document.getElementById('conta-id').value;
                const novaConta = {
                    id: id ? parseInt(id) : nextId.planoContas++,
                    nome: document.getElementById('conta-nome').value,
                    tipo: document.getElementById('conta-tipo').value
                };
                
                if (id) {
                    const index = planoContas.findIndex(p => p.id == id);
                    if (index !== -1) {
                        planoContas[index] = novaConta;
                        mostrarNotificacao('Conta atualizada com sucesso!', 'success');
                    }
                } else {
                    planoContas.push(novaConta);
                    mostrarNotificacao('Conta salva com sucesso!', 'success');
                }
                
                salvarDados();
                renderizarTabelaPlanoContas();
                cancelarPlanoContas();
            });

            // CATEGORIAS (Listener)
            document.getElementById('form-categorias').addEventListener('submit', function(e) {
                e.preventDefault();
                const id = document.getElementById('categoria-id').value;
                
                // Validação do Plano de Contas
                const planoContasId = parseInt(document.getElementById('categoria-plano-contas-id').value);
                if (!planoContasId) {
                    mostrarNotificacao('Selecione um Plano de Contas válido.', 'danger');
                    return;
                }
                
                const novaCategoria = {
                    id: id ? parseInt(id) : nextId.categorias++,
                    nome: document.getElementById('categoria-nome').value,
                    planoContasId: planoContasId // NOVO CAMPO SALVO
                };
                
                if (id) {
                    const index = categorias.findIndex(c => c.id == id);
                    if (index !== -1) {
                        categorias[index] = novaCategoria;
                        mostrarNotificacao('Categoria atualizada com sucesso!', 'success');
                    }
                } else {
                    categorias.push(novaCategoria);
                    mostrarNotificacao('Categoria salva com sucesso!', 'success');
                }
                
                salvarDados();
                renderizarTabelaCategorias();
                cancelarCategoria();
            });

            // Bancos (Listener)
            document.getElementById('form-bancos').addEventListener('submit', function(e) {
                e.preventDefault();
                const id = document.getElementById('banco-id').value;
                const novaConta = {
                    id: id ? parseInt(id) : nextId.bancos++,
                    nome: document.getElementById('banco-nome').value,
                    saldo: parseFloat(document.getElementById('banco-saldo-inicial').value)
                };
                
                if (id) {
                    const index = bancos.findIndex(b => b.id == id);
                    if (index !== -1) {
                        bancos[index] = novaConta;
                        mostrarNotificacao('Conta bancária atualizada com sucesso!', 'success');
                    }
                } else {
                    bancos.push(novaConta);
                    mostrarNotificacao('Conta bancária salva com sucesso!', 'success');
                }
                
                salvarDados();
                renderizarTabelaBancos();
                cancelarConta();
            });
            
            // Tipos de Pagamento (Listener)
            document.getElementById('form-tipos-pagamento').addEventListener('submit', function(e) {
                e.preventDefault();
                const id = document.getElementById('tipo-pagamento-id').value;
                const isParcela = document.getElementById('tipo-pagamento-parcela-sim').value === 'true';
                
                const novoTipoPagamento = {
                    id: id ? parseInt(id) : nextId.tiposPagamento++,
                    descricao: document.getElementById('tipo-pagamento-descricao').value,
                    ativo: document.getElementById('tipo-pagamento-ativo').value === 'true',
                    parcela: isParcela,
                    maxParcelas: isParcela ? parseInt(document.getElementById('tipo-pagamento-max-parcelas').value) : 1
                };
                
                if (id) {
                    const index = tiposPagamento.findIndex(tp => tp.id == id);
                    if (index !== -1) {
                        tiposPagamento[index] = novoTipoPagamento;
                        mostrarNotificacao('Tipo de Pagamento atualizado com sucesso!', 'success');
                    }
                } else {
                    tiposPagamento.push(novoTipoPagamento);
                    mostrarNotificacao('Tipo de Pagamento salvo com sucesso!', 'success');
                }
                
                salvarDados();
                renderizarTabelaTiposPagamento();
                cancelarTipoPagamento();
            });


            // Parceiros (Listener)
            document.getElementById('form-parceiros').addEventListener('submit', function(e) {
                e.preventDefault();
                const id = document.getElementById('parceiro-id').value;
                const novoParceiro = {
                    id: id ? parseInt(id) : nextId.parceiros++,
                    nome: document.getElementById('parceiro-nome').value,
                    tipo: document.getElementById('parceiro-tipo').value
                };
                
                if (id) {
                    const index = parceiros.findIndex(p => p.id == id);
                    if (index !== -1) {
                        parceiros[index] = novoParceiro;
                        mostrarNotificacao('Parceiro atualizado com sucesso!', 'success');
                    }
                } else {
                    parceiros.push(novoParceiro);
                    mostrarNotificacao('Parceiro salvo com sucesso!', 'success');
                }
                
                salvarDados();
                renderizarTabelaParceiros();
                cancelarParceiro();
            });

            // Usuários (Listener)
            document.getElementById('form-usuarios').addEventListener('submit', function(e) {
                e.preventDefault();
                const id = document.getElementById('usuario-id').value;
                const senhaDigitada = document.getElementById('usuario-senha').value;
                const isNewUser = !id; 
                
                let usuarioData = {
                    id: id ? parseInt(id) : nextId.usuarios++,
                    nome: document.getElementById('usuario-nome').value,
                    email: document.getElementById('usuario-email').value,
                };

                if (isNewUser) {
                    usuarioData.senha = senhaDigitada;
                    usuarios.push(usuarioData);
                    mostrarNotificacao('Usuário salvo com sucesso!', 'success');
                } else {
                    const index = usuarios.findIndex(u => u.id == id);
                    if (index !== -1) {
                        usuarioData.senha = senhaDigitada || usuarios[index].senha; 
                        usuarios[index] = usuarioData;
                        mostrarNotificacao('Usuário atualizado com sucesso!', 'success');
                    }
                }
                
                salvarDados();
                renderizarTabelaUsuarios();
                updateLoggedUserStatus();
                cancelarUsuario();
            });

            // Verificar login ao carregar
            setTimeout(() => {
                checkLoginStatus();
                renderizarTabelas();
                calcularSaldos();
            }, 100);
        });
    </script>
</body>
</html>

