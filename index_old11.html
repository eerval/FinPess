<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FinPess — Sistema Financeiro Pessoal</title>
  <link rel="icon" type="image/png" href="favicon-finpess.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Chart.js 4.x -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Chart.js Plugin para Datalabels -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>


  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <style>
    :root {
      /* --- PALETA DE CORES BASE (LIGHT) --- */
      --bg: #F0F2F5;
      --panel: #FFFFFF;
      --muted: #64748B;
      --primary: #1E293B; /* Texto principal escuro */
      --primary-600: #334155;
      
      --accent: #10B981; /* Verde Esmeralda Moderno */
      --success: #10B981;
      --danger: #EF4444;
      --info: #3B82F6;
      --warning: #F59E0B;
      
      /* --- VARIÁVEIS DE ESTRUTURA (Dinâmicas) --- */
      --border: #E2E8F0;      /* Cor da borda suave */
      --input-bg: #F8FAFC;    /* Fundo dos inputs */
      --input-border: #CBD5E1;
      --hover-bg: #F1F5F9;
      
      --radius: 12px;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --glass: rgba(255, 255, 255, 0.5);
      --gap: 24px;
      
      /* Fontes e Tamanhos */
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --font-display: 'Poppins', 'Inter', sans-serif;
      --font-body: 'Inter', -apple-system, sans-serif;
      --text-xs: 0.75rem;
      --text-sm: 0.875rem;
      --text-base: 1rem;
      --text-lg: 1.125rem;
      --text-xl: 1.25rem;
      --text-2xl: 1.5rem;
      --text-3xl: 1.875rem;
    }

    /* --- TEMA ESCURO (DARK MODE) --- */
    :root[data-theme='dark'] {
      --bg: #0F172A;        /* Fundo muito escuro (Slate 900) */
      --panel: #1E293B;     /* Painéis (Slate 800) */
      --muted: #94A3B8;     /* Texto secundário claro */
      --primary: #F1F5F9;   /* Texto principal quase branco */
      --primary-600: #E2E8F0;
      
      --border: #334155;    /* Bordas escuras */
      --input-bg: #0F172A;  /* Input fundo escuro */
      --input-border: #334155;
      --hover-bg: #334155;
      
      --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
      --glass: rgba(30, 41, 59, 0.7);
    }
	
	/* --- CORREÇÃO DO ÍCONE DE CALENDÁRIO NO TEMA ESCURO --- */
	:root[data-theme='dark'] input[type="date"]::-webkit-calendar-picker-indicator {
		filter: invert(100%) brightness(100%) contrast(100%);
		cursor: pointer;
	}

	/* Garante que o ícone também fique visível em campos desabilitados */
	:root[data-theme='dark'] input[type="date"]:disabled::-webkit-calendar-picker-indicator {
		opacity: 0.5;
	}

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--primary); transition: background 0.3s ease, color 0.3s ease; }

    /* Layout */
    .app { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }

    /* SIDEBAR */
    .sidebar {
      background: #0F172A; /* Sidebar sempre escura no Light Mode para contraste */
      color: #F8FAFC;
      padding: 1.5rem;
      display: flex; flex-direction: column; gap: 1rem;
      border-right: 1px solid rgba(255,255,255,0.05);
      position: relative;
    }
    :root[data-theme='dark'] .sidebar { background: var(--panel); border-right: 1px solid var(--border); }

    .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 1rem; }
    .logo { 
	  width: 40px; 
	  height: 40px; 
	  border-radius: 10px; 
	  background: url('favicon-finpess.png') no-repeat center center; /* Usa o ícone como miniatura */
	  background-size: cover;
	  display: flex; 
	  align-items: center; 
	  justify-content: center; 
	}
    .brand h1 { font-size: 18px; margin: 0; font-weight: 700; color: #fff; }
    :root[data-theme='dark'] .brand h1 { color: var(--primary); }

    .nav { display: flex; flex-direction: column; gap: 4px; margin-top: 6px; }
    .nav a {
      display: flex; gap: 12px; align-items: center; padding: 12px;
      border-radius: 8px; color: #94A3B8; text-decoration: none;
      font-weight: 500; transition: all 0.2s;
    }
    .nav a:hover { background: rgba(255,255,255,0.05); color: #F1F5F9; }
    .nav a.active { background: var(--accent); color: #FFF; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }

    .sidebar .spacer { flex: 1; }
    .user-mini { display: flex; gap: 12px; align-items: center; padding: 10px; border-radius: 10px; background: rgba(255,255,255,0.05); margin-top: auto; }
    .avatar { width: 36px; height: 36px; border-radius: 8px; background: #334155; color: #FFF; display: flex; align-items: center; justify-content: center; font-weight: 700; }

    /* CONTENT */
    .content { padding: 28px; overflow-y: auto; }
    
    header.app-header { display: flex; align-items: center; justify-content: space-between; gap: 20px; margin-bottom: var(--gap); padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); }

    /* INPUTS & SEARCH */
    .search {
      flex: 1; display: flex; align-items: center; gap: 10px;
      background: var(--panel); padding: 0 16px; border-radius: 12px;
      border: 1px solid var(--border); /* Variável */
      box-shadow: var(--card-shadow); height: 48px;
    }
    .search input { border: none; background: transparent; padding: 0; color: var(--primary); }
    .search input:focus { outline: none; }
    .search input::placeholder { color: var(--muted); }

    /* Estilos globais de Inputs */
    /* --- NOVA APARÊNCIA DOS CAMPOS --- */
	input, select, textarea {
	  width: 100%; 
	  padding: 12px; 
	  border-radius: 8px;
	  border: 1px solid var(--input-border); 
	  background-color: var(--input-bg); 
	  color: var(--primary);
	  font-family: inherit; 
	  font-size: 0.95rem;
	  transition: all 0.2s ease-in-out;
	  /* Sombra interna para dar a sensação de que o campo é preenchível */
	  box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05); 
	}

	/* Quando o usuário clica ou digita no campo */
	input:focus, select:focus, textarea:focus {
	  outline: none; 
	  border-color: var(--accent); /* Cor verde esmeralda que você já usa */
	  background-color: var(--panel); /* O campo fica branco/claro ao destacar */
	  box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15), inset 0 1px 2px rgba(0, 0, 0, 0.05);
	  transform: translateY(-1px); /* Pequeno efeito de elevação */
	}

	/* --- PADRONIZAÇÃO DE PLACEHOLDERS E CAMPOS --- */
    
    /* 1. Suaviza o texto em campos de digitação (Descrição, Valor, etc) */
    input::placeholder, 
    textarea::placeholder {
      color: var(--muted) !important;
      opacity: 0.4 !important; /* Bem discreto para não parecer preenchido */
      font-weight: 400;
    }

    /* 2. Suaviza o texto inicial de seletores (O "Selecione...") */
    select {
      color: var(--primary);
    }

    /* Regra específica para o texto de ajuda do Select */
    select:invalid, 
    select option[value=""],
    select option:first-child {
      color: var(--muted) !important;
      opacity: 0.5 !important;
    }

    /* Garante que as opções da lista fiquem legíveis ao abrir */
    select option { 
      background: var(--panel); 
      color: var(--primary); 
      opacity: 1 !important;
    }

    /* 3. Estilo para Campos Travados (Lançamentos Consolidados) */
    input:disabled, select:disabled, textarea:disabled {
      background-color: var(--bg) !important;
      color: var(--muted);
      cursor: not-allowed;
      opacity: 0.6;
      border-style: dashed;
    }
    
    .top-actions { display: flex; gap: 10px; }
	
    /* BUTTONS */
    .btn {
      border: 0; padding: 0.75rem 1.5rem; border-radius: 12px;
      font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
      transition: all 0.2s; font-size: 0.875rem; position: relative; overflow: hidden;
    }
    .btn.primary { background: linear-gradient(135deg, var(--accent), #1dc389); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25); }
    .btn.primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(37, 211, 154, 0.4); }
    .btn.ghost { background: transparent; border: 1px solid var(--border); color: var(--muted); }
    .btn.ghost:hover { background: var(--hover-bg); color: var(--primary); }
    .btn.small { padding: 6px 12px; font-size: 13px; }

    /* CARDS */
    .card {
      background: var(--panel); padding: 1.5rem; border-radius: 16px;
      box-shadow: var(--card-shadow); border: 1px solid transparent;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative; overflow: hidden;
      color: var(--primary);
    }
    .card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.08); border-color: rgba(37, 211, 154, 0.2); }
    .card h3 { margin: 0 0 16px 0; font-size: 15px; color: var(--muted); font-weight: 600; }

    /* GRID SYSTEM */
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 18px; }
    .col-3 { grid-column: span 3; }
    .col-4 { grid-column: span 4; }
    .col-5 { grid-column: span 5; }
    .col-6 { grid-column: span 6; }
    .col-7 { grid-column: span 7; }
    .col-8 { grid-column: span 8; }
    .col-12 { grid-column: span 12; }

    /* KPI CARDS */
    .kpi-card { 
      background: linear-gradient(135deg, var(--panel) 0%, rgba(255, 255, 255, 0.05) 100%);
      border: 1px solid rgba(37, 211, 154, 0.1); position: relative;
      display: flex; flex-direction: column; justify-content: center; min-height: 140px; padding: 1.5rem;
    }
    .status-indicator { position: absolute; top: 12px; right: 12px; width: 8px; height: 8px; border-radius: 50%; background: var(--success); box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2); }
    
    .kpi-label { display: flex; align-items: center; gap: 0.5rem; color: var(--muted); font-size: var(--text-sm); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
    .kpi-value { font-size: var(--text-3xl); font-weight: 800; margin: 0.5rem 0; color: var(--primary); }
    .kpi-meta { font-size: var(--text-xs); color: var(--muted); margin-top: 0.25rem; }
    
    /* Cores específicas de KPI */
    .kpi-card.saldo .kpi-value { color: var(--info); }
    .kpi-card.receita .kpi-value { color: var(--success); }
    .kpi-card.despesa .kpi-value { color: var(--danger); }
    
    /* Outros KPIs menores */
    .kpi { display: flex; flex-direction: column; justify-content: center; min-height: 120px; padding: 1.5rem; }
    .kpi-head { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .kpi-head i { font-size: 20px; padding: 10px; border-radius: 10px; }
    .kpi.receita i { color: var(--success); background: rgba(46,204,113,0.12); }
    .kpi.despesa i { color: var(--danger); background: rgba(231,76,60,0.12); }
    .kpi.pagar i { color: var(--warning); background: rgba(243, 156, 18, 0.12); }
    .kpi.receber i { color: var(--accent); background: rgba(37, 211, 154, 0.12); }
    .kpi .value { font-size: 24px; font-weight: 800; }

    /* TABLES */
    table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: var(--text-sm); }
    thead th {
      text-align: left; padding: 1rem;
      color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
      border-bottom: 2px solid var(--border); background: rgba(10, 34, 56, 0.02);
    }
    :root[data-theme='dark'] thead th { background: rgba(255, 255, 255, 0.02); }
    
    tbody td { padding: 1rem; border-top: 1px solid var(--border); color: var(--primary); vertical-align: middle; transition: background-color 0.2s ease; }
    tbody tr:hover { background: var(--hover-bg); }

    /* LISTA SALDOS */
    .saldos { display: flex; flex-direction: column; gap: 10px; }
    .saldo-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-radius: 8px; background: var(--glass); border: 1px solid transparent; }
    :root[data-theme='dark'] .saldo-item { border-color: var(--border); }

    /* TAGS & BADGES */
    .tag { display: inline-block; padding: 6px 8px; border-radius: 999px; font-weight: 700; font-size: 12px; }
    .tag.receita { color: var(--success); }
    .tag.despesa { color: var(--danger); }
    .tag.corrente { background: rgba(52, 152, 219, 0.1); color: var(--info); }
    .status-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; }
    .status-ativo { background: rgba(16, 185, 129, 0.12); color: var(--success); }
    .status-inativo { background: rgba(239, 68, 68, 0.12); color: var(--danger); }

    /* FORMS & MODALS */
    .modal {
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      background: rgba(11, 39, 64, 0.6); z-index: 100; backdrop-filter: blur(2px);
    }
    .modal-content {
      width: 95%; max-width: 600px; background: var(--panel);
      border-radius: 12px; padding: 22px; box-shadow: var(--card-shadow);
      max-height: 90vh; overflow-y: auto; border: 1px solid var(--border);
      color: var(--primary);
    }
    .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px; }
    label { 
	  display: block; 
	  margin-bottom: 8px; 
	  font-size: 13px; 
	  color: var(--primary); /* Mudamos de muted para primary para dar mais leitura */
	  font-weight: 600; /* Deixamos um pouco mais "negrito" */
	  letter-spacing: 0.3px;
	}
    
    .error-message { color: var(--danger); font-size: 12px; margin-top: 4px; display: none; }
    .error-message.visible { display: block; }
    
    /* Login styles */
    .login-logo { width: 60px; height: 60px; border-radius: 12px; background: var(--panel); display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: 700; font-size: 24px; margin: 0 auto 20px; box-shadow: var(--card-shadow); border: 1px solid var(--border); }

    /* UTILITÁRIOS VISUAIS */
    .filtros-container { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-top: 12px; }
    .filtros-container select, .filtros-container input { min-width: 140px; flex: 1; }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--muted); border-radius: 4px; opacity: 0.3; }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary-600); opacity: 0.8; }
    
    /* Charts */
    .chart-wrap { height: 340px; position: relative; }
    
    /* Loading */
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .conditional-field { display: none; animation: fadeIn 0.3s ease-in; }
    .conditional-field.visible { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .field-error { border-color: var(--danger) !important; }
    input.filled, select.filled, textarea.filled { border-color: var(--primary-600); font-weight: 500; }
    .cep-loading { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-left: 8px; }

    /* --- RESPONSIVIDADE AVANÇADA (MOBILE) --- */
    
    /* Botão Hambúrguer (Só aparece no mobile) */
    .mobile-menu-btn { display: none; font-size: 1.2rem; padding: 8px 12px; margin-right: 10px; }

    /* Overlay (Fundo escuro quando menu abre) */
    .sidebar-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 998;
      opacity: 0; visibility: hidden; transition: all 0.3s; backdrop-filter: blur(2px);
    }
    .sidebar-overlay.active { opacity: 1; visibility: visible; }

    @media (max-width: 980px) {
      /* 1. Layout Principal vira Coluna Única */
      .app { grid-template-columns: 1fr; }
      
      /* 2. Sidebar vira Menu Gaveta (Off-canvas) */
      .sidebar {
        position: fixed; top: 0; left: -280px; /* Escondido na esquerda */
        height: 100vh; width: 260px; z-index: 999;
        flex-direction: column; align-items: stretch; /* Volta ao layout vertical */
        transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 4px 0 24px rgba(0,0,0,0.2);
        background: var(--primary); /* Garante fundo escuro no mobile */
        border-right: 1px solid rgba(255,255,255,0.1);
      }
      
      /* Classe que o JS vai adicionar para abrir o menu */
      .sidebar.open { left: 0; }
      
      /* Ajuste interno da Sidebar Mobile */
      .sidebar .brand { margin-bottom: 20px; justify-content: flex-start; }
      .sidebar .brand h1, .sidebar .brand div { display: block; } /* Mostra o logo */
      .nav { flex-direction: column; } /* Links um embaixo do outro */
      
      /* 3. Header e Botão Menu */
      .mobile-menu-btn { display: inline-flex; }
      .app-header { gap: 10px; flex-wrap: wrap; }
      .search { order: 2; width: 100%; min-width: 100%; margin-top: 10px; }
      .top-actions { margin-left: auto; }
      
      /* 4. Grid do Dashboard (Tudo empilhado) */
      .grid { display: flex; flex-direction: column; gap: 16px; }
      .col-3, .col-4, .col-5, .col-6, .col-7, .col-8, .col-12 { width: 100%; grid-column: auto; }
      
      /* 5. Ajustes de Espaçamento */
      .content { padding: 16px; padding-bottom: 80px; } /* Espaço extra no fim */
      
      /* 6. Formulários (Colunas viram linhas) */
      .form-row { grid-template-columns: 1fr; gap: 16px; }
      
      /* 7. Tabelas com Scroll Horizontal */
      .card { padding: 16px; overflow-x: auto; } /* Permite tabela deslizar */
      table { min-width: 600px; } /* Força largura mínima para não espremer */
      
      /* 8. Modal Fullscreen no Mobile */
      .modal-content { 
        width: 100%; height: 100%; max-height: 100%; border-radius: 0; 
        display: flex; flex-direction: column; 
      }
    }
	
	/* Esta regra diz: se a tela for menor que 768px, tudo que tiver 
	   a classe 'esconder-no-celular' deve sumir */
	@media (max-width: 768px) {
	  .esconder-no-celular {
		display: none !important;
	  }
	}
	
	/* --- NOVO ESTILO: LISTA DE LANÇAMENTOS (Estilo Nubank/Guiabolso) --- */
    .lancamento-list { display: flex; flex-direction: column; gap: 20px; }
    
    .date-group { display: flex; flex-direction: column; gap: 10px; }
    
    /* Cabeçalho da Data (ex: "Hoje, 09 de Fevereiro") */
    .date-header { 
      font-size: 0.85rem; font-weight: 700; color: var(--muted); 
      text-transform: uppercase; letter-spacing: 0.5px; margin-left: 4px;
      display: flex; align-items: center; justify-content: space-between;
      border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 5px;
    }

    /* O Cartão do Lançamento */
    .lancamento-card {
      background: var(--panel); padding: 16px; border-radius: 12px;
      display: flex; align-items: center; gap: 16px;
      border: 1px solid transparent; transition: all 0.2s;
      position: relative; overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .lancamento-card:hover { transform: translateY(-2px); box-shadow: var(--card-shadow); border-color: rgba(37, 211, 154, 0.2); }
    
    /* Ícone Quadrado Colorido */
    .cat-icon {
      width: 42px; height: 42px; border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; color: #FFF; flex-shrink: 0;
      font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    /* Textos (Descrição e Categoria) */
    .lancamento-info { flex: 1; min-width: 0; }
    .lancamento-desc { font-weight: 600; font-size: 0.95rem; color: var(--primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .lancamento-meta { font-size: 0.8rem; color: var(--muted); display: flex; align-items: center; gap: 6px; margin-top: 2px; }
    
    /* Valores (Direita) */
    .lancamento-values { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
    .lancamento-amount { font-weight: 700; font-size: 1rem; }
    
    /* Botões de Ação (Aparecem ao passar o mouse ou fixos no mobile) */
    .lancamento-actions { 
      display: flex; align-items: center; gap: 8px; margin-left: 10px;
    }

    /* Faixa lateral amarela para contas pendentes */
    .pending-stripe {
      position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--warning);
    }

    /* Ajuste para telas pequenas */
    @media (max-width: 600px) {
      .lancamento-card { padding: 12px; gap: 12px; }
      .cat-icon { width: 36px; height: 36px; font-size: 14px; }
      .lancamento-amount { font-size: 0.9rem; }
      .lancamento-actions .btn { padding: 4px 8px; }
    }
	
	/* --- ESTILO CARTEIRA (CONTAS) --- */
    .contas-grid {
      display: grid;
      /* Cria colunas automáticas: Mínimo 280px, Máximo o que der */
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .conta-card {
      background: var(--panel);
      padding: 20px;
      border-radius: 16px;
      border: 1px solid transparent;
      box-shadow: var(--card-shadow);
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 160px;
    }
    
    :root[data-theme='dark'] .conta-card { border-color: var(--border); }
    
    .conta-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    }

    /* Cabeçalho do Card (Ícone + Nome) */
    .conta-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 15px; }
    
    .conta-icon-box {
      width: 48px; height: 48px; border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .conta-actions { display: flex; gap: 8px; }

    /* Corpo do Card (Saldo) */
    .conta-body { margin-top: auto; }
    .conta-label { font-size: 0.8rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
    .conta-saldo { font-size: 1.6rem; font-weight: 800; color: var(--primary); margin-top: 4px; }
    
    /* Status Badge pequena no canto */
    .conta-status {
      font-size: 11px; padding: 4px 8px; border-radius: 20px;
      font-weight: 600; display: inline-block; margin-top: 8px;
    }
    .status-active { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .status-inactive { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
	
	/* --- ESTILO CATEGORIAS (Grid Visual) --- */
    .categorias-grid {
      display: grid;
      /* Cria colunas automáticas: Mínimo 220px */
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
    }

    .cat-card {
      background: var(--panel);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid transparent;
      box-shadow: var(--card-shadow);
      position: relative;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    :root[data-theme='dark'] .cat-card { border-color: var(--border); }
    
    .cat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
    }

    /* Cabeçalho do Card: Ícone e Ações */
    .cat-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
    
    /* O Ícone da Categoria (Usaremos a função inteligente aqui também!) */
    .cat-card-icon {
      width: 40px; height: 40px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; color: #fff;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* Corpo do Card: Nome e Detalhes */
    .cat-card-body { display: flex; flex-direction: column; gap: 4px; }
    .cat-card-name { font-weight: 700; color: var(--primary); font-size: 0.95rem; }
    .cat-card-setor { font-size: 0.75rem; color: var(--muted); display: flex; align-items: center; gap: 4px; }

    /* Etiquetas (Receita/Despesa) */
    .cat-badge {
      font-size: 10px; padding: 3px 8px; border-radius: 6px;
      text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;
      align-self: flex-start;
    }
    .badge-receita { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .badge-despesa { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
		
	/* --- ESTILO PARCEIROS (Cartões de Contato) --- */
    .parceiros-grid {
      display: grid;
      /* Colunas automáticas: Mínimo 280px */
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .parceiro-card {
      background: var(--panel);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid transparent;
      box-shadow: var(--card-shadow);
      display: flex;
      flex-direction: column;
      gap: 15px;
      transition: all 0.2s;
      position: relative;
    }
    
    :root[data-theme='dark'] .parceiro-card { border-color: var(--border); }

    .parceiro-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.08);
      border-color: rgba(37, 211, 154, 0.2);
    }

    /* Cabeçalho: Avatar + Nome */
    .parceiro-header { display: flex; align-items: center; gap: 12px; }
    
    .parceiro-avatar {
      width: 44px; height: 44px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; color: #fff; flex-shrink: 0;
    }

    .parceiro-info { flex: 1; min-width: 0; }
    .parceiro-name { font-weight: 700; font-size: 1rem; color: var(--primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .parceiro-type { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }

    /* Corpo: Dados de Contato */
    .parceiro-body { 
      display: flex; flex-direction: column; gap: 8px; 
      padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.05);
    }
    
    .contact-row { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; color: var(--primary-600); }
    .contact-icon { width: 20px; text-align: center; color: var(--muted); font-size: 14px; }

    /* Ações (Editar/Excluir) - Flutuando no topo */
    .parceiro-actions { position: absolute; top: 15px; right: 15px; display: flex; gap: 5px; }	
	
	/* --- ESTILO FORMAS DE PAGAMENTO (Cartões Compactos) --- */
    .formas-grid {
      display: grid;
      /* Colunas automáticas: Mínimo 240px */
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
    }

    .forma-card {
      background: var(--panel);
      padding: 18px;
      border-radius: 12px;
      border: 1px solid transparent;
      box-shadow: var(--card-shadow);
      display: flex;
      align-items: center;
      gap: 15px;
      position: relative;
      transition: all 0.2s;
    }
    
    :root[data-theme='dark'] .forma-card { border-color: var(--border); }

    .forma-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
      border-color: rgba(37, 211, 154, 0.2);
    }

    /* Ícone do Meio de Pagamento */
    .forma-icon {
      width: 46px; height: 46px; border-radius: 12px;
      background: var(--bg); /* Fundo suave */
      color: var(--primary);
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; flex-shrink: 0;
    }

    .forma-info { flex: 1; min-width: 0; }
    .forma-name { font-weight: 700; color: var(--primary); font-size: 0.95rem; margin-bottom: 4px; }

    /* Badge de Parcelamento */
    .forma-badge {
      font-size: 10px; padding: 3px 8px; border-radius: 6px;
      text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;
      display: inline-block;
    }
    .badge-parcelado { background: rgba(59, 130, 246, 0.1); color: #3B82F6; } /* Azul */
    .badge-avista { background: rgba(16, 185, 129, 0.1); color: var(--success); } /* Verde */

    /* Ações (Editar/Excluir) */
    .forma-actions { display: flex; flex-direction: column; gap: 4px; }
	
	/* --- ESTILO SETORES (Cartões de Departamento) --- */
    .setores-grid {
      display: grid;
      /* Colunas automáticas: Mínimo 200px */
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }

    .setor-card {
      background: var(--panel);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid transparent;
      box-shadow: var(--card-shadow);
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      transition: all 0.2s;
      text-align: center;
      align-items: center;
    }
    
    :root[data-theme='dark'] .setor-card { border-color: var(--border); }

    .setor-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
      border-color: rgba(37, 211, 154, 0.2);
    }

    /* Ícone do Setor */
    .setor-icon {
      width: 50px; height: 50px; border-radius: 50%;
      background: rgba(59, 130, 246, 0.1); /* Azul suave */
      color: #3B82F6;
      display: flex; align-items: center; justify-content: center;
      font-size: 22px; margin-bottom: 5px;
    }

    .setor-name { font-weight: 700; color: var(--primary); font-size: 1rem; }
    
    /* Status Badge */
    .setor-status {
      font-size: 10px; padding: 2px 8px; border-radius: 10px;
      text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;
      background: var(--bg); color: var(--muted);
    }
    .status-inactive-text { color: var(--danger); }

    /* Ações (Editar/Excluir) - Posicionamento absoluto no canto */
    .setor-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 4px; }
	
	/* --- AJUSTE DE CONTRASTE E CAMPOS BLOQUEADOS --- */

	/* Estilo padrão para campos bloqueados */
	input:disabled, select:disabled, textarea:disabled {
	  cursor: not-allowed;
	  opacity: 0.6; /* Deixa levemente apagado */
	  background-color: var(--bg) !important; /* Usa o fundo do app para parecer 'vazio' */
	  border-style: dashed; /* Opcional: borda pontilhada para indicar bloqueio */
	}

	/* Ajuste fino das bordas para o Tema Claro */
	:root {
	  --input-border: #D1D5DB; /* Um cinza mais suave que o atual */
	}

	/* Ajuste fino das bordas para o Tema Escuro */
	:root[data-theme='dark'] {
	  --input-border: #334155;
	  --input-bg: #1E293B;
	}

	/* Garante que os inputs preenchidos não fiquem com bordas pesadas */
	input.filled, select.filled, textarea.filled {
	  border-color: var(--accent); /* Usa a cor de destaque (verde) em vez de preto */
	  border-width: 1px;
	}
	
	/* --- CONFIGURAÇÕES DE VISIBILIDADE (MELHORIA) --- */
	@media (max-width: 768px) {
	  /* Se o 'corpo' do site tiver essa classe, o elemento some no celular */
	  body.ocultar-novo-mobile #btn-novo-lancamento-tela { display: none !important; }
	  body.ocultar-busca-mobile #filtro-descricao-lancamento { display: none !important; }
	  body.ocultar-kpis-mobile #container-kpis-lancamentos { display: none !important; }
	}

	.btn-config-gear {
	  background: transparent;
	  border: none;
	  color: var(--muted);
	  cursor: pointer;
	  padding: 5px;
	  font-size: 16px;
	  transition: 0.2s;
	  display: flex;
	  align-items: center;
	  justify-content: center;
	}
	.btn-config-gear:hover { color: var(--accent); }
	
	/* --- NOVA GRADE DE FILTROS COMPACTA --- */
	.filtros-grid-compacta {
	  display: grid;
	  /* Cria colunas automáticas que se ajustam ao espaço disponível */
	  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
	  gap: 10px;
	  background: var(--panel);
	  padding: 16px;
	  border-radius: 12px;
	  border: 1px solid var(--border);
	  margin-top: 16px;
	}

	/* Redução de altura para economizar espaço vertical */
	.filtros-grid-compacta input, 
	.filtros-grid-compacta select {
	  height: 38px !important; 
	  padding: 0 12px !important;
	  font-size: 0.85rem !important;
	  border-radius: 8px !important;
	  margin: 0 !important;
	}

	/* Campo de busca ganha destaque ocupando 2 colunas */
	.col-busca-larga {
	  grid-column: span 2;
	}

	/* Ajuste para celulares: 2 colunas e busca normal */
	@media (max-width: 600px) {
	  .col-busca-larga { grid-column: span 1; }
	  .filtros-grid-compacta { grid-template-columns: 1fr 1fr; }
	}
	
	/* --- NOVA GRADE DE FILTROS COMPACTA --- */
	.filtros-grid-compacta {
	  display: grid;
	  /* Cria colunas automáticas: mínimo 140px, máximo preenche o espaço */
	  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
	  gap: 10px;
	  background: var(--panel);
	  padding: 16px;
	  border-radius: 12px;
	  border: 1px solid var(--border);
	  margin-top: 16px;
	  align-items: end; /* Alinha os campos pela base */
	}

	/* Redução de altura para economizar espaço vertical */
	.filtros-grid-compacta input, 
	.filtros-grid-compacta select {
	  height: 38px !important; 
	  padding: 0 12px !important;
	  font-size: 0.85rem !important;
	  border-radius: 8px !important;
	  margin: 0 !important;
	}

	/* Campo de busca ganha destaque ocupando 2 colunas */
	.col-busca-larga {
	  grid-column: span 2;
	}

	/* Botão de Limpar Filtros */
	.btn-limpar {
	  background: var(--bg);
	  color: var(--muted);
	  border: 1px solid var(--border);
	  height: 38px;
	  border-radius: 8px;
	  cursor: pointer;
	  font-weight: 600;
	  font-size: 13px;
	  transition: all 0.2s;
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  gap: 6px;
	}

	.btn-limpar:hover {
	  background: var(--hover-bg);
	  color: var(--danger);
	  border-color: var(--danger);
	}

	@media (max-width: 600px) {
	  .col-busca-larga { grid-column: span 1; }
	  .filtros-grid-compacta { grid-template-columns: 1fr 1fr; }
	}
	
	/* --- BARRA DE NAVEGAÇÃO MOBILE COM SCROLL HORIZONTAL --- */
	.mobile-nav-bar {
	  display: none; 
	  position: fixed;
	  bottom: 0;
	  left: 0;
	  right: 0;
	  height: 70px;
	  background: var(--panel);
	  border-top: 1px solid var(--border);
	  z-index: 1000;
	  box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
	  padding: 0 10px;
	  padding-bottom: env(safe-area-inset-bottom);
	  
	  /* Ativa o scroll horizontal */
	  display: flex;
	  overflow-x: auto;
	  scroll-snap-type: x mandatory;
	  -webkit-overflow-scrolling: touch;
	}

	/* Esconde a barra de rolagem visualmente */
	.mobile-nav-bar::-webkit-scrollbar {
	  display: none;
	}

	.mobile-nav-item {
	  display: flex;
	  flex-direction: column;
	  align-items: center;
	  justify-content: center;
	  color: var(--muted);
	  text-decoration: none;
	  font-size: 10px;
	  font-weight: 600;
	  gap: 4px;
	  min-width: 85px; /* Define um tamanho fixo para permitir o scroll */
	  flex-shrink: 0;
	  transition: 0.2s;
	  scroll-snap-align: start;
	}

	.mobile-nav-item i {
	  font-size: 20px;
	}

	.mobile-nav-item.active {
	  color: var(--accent);
	}
	
	@media (max-width: 980px) {
	  .mobile-nav-bar { display: flex; }
	  .content { padding-bottom: 90px !important; }
	}

	/* Regra para exibir apenas no Mobile */
	@media (min-width: 981px) {
	  .mobile-nav-bar {
		display: none !important;
	  }
	}

	@media (max-width: 980px) {
	  .mobile-nav-bar {
		display: flex;
	  }
	  /* Adiciona um recuo no conteúdo para a barra não cobrir os últimos itens da lista */
	  .content {
		padding-bottom: 80px !important;
	  }
	}
		
   </style>
</head>
<body>
  <div id="login-modal" class="modal" style="display:flex;">
    <div class="modal-content" style="max-width:400px;text-align:center">
      <img src="logo-finpess.png" alt="FinPess" style="width: 200px; height: auto; margin-bottom: 20px; display: block; margin-left: auto; margin-right: auto;">
      <h2 style="margin:0 0 8px"></h2>
      <p style="color:var(--muted);margin-bottom:24px">Faça login para continuar</p>
      
      <div style="display:flex;flex-direction:column;gap:12px">
        <input id="login-email" type="email" placeholder="E-mail" style="padding:12px;border-radius:8px;border:1px solid #E9EEF2">
        <input id="login-password" type="password" placeholder="Senha" style="padding:12px;border-radius:8px;border:1px solid #E9EEF2">
		<div style="text-align: right; margin-top: 5px; margin-bottom: 15px;">
			<button type="button" onclick="redefinirSenha()" style="background:none; border:none; color:#3b82f6; font-size:12px; cursor:pointer; font-weight:500; text-decoration: underline;">
				Esqueci minha senha
			</button>
		</div>
        
        <button class="btn primary" onclick="fazerLogin()" style="width:100%;padding:12px" id="login-btn">
          <i class="fas fa-sign-in-alt"></i> Entrar
        </button>
        
        <div style="font-size:14px;color:var(--muted);margin:16px 0">ou</div>
        
        <button class="btn ghost" onclick="trocarParaCadastro()" style="width:100%">
          Criar uma conta
        </button>
      </div>
    </div>
  </div>

  <div id="cadastro-modal" class="modal">
    <div class="modal-content" style="max-width:400px;text-align:center">
      <h3 style="margin:0 0 20px">Criar Conta</h3>
	  <img src="logo-finpess.png" alt="FinPess" style="width: 120px; margin-bottom: 15px;">
      
      <div style="display:flex;flex-direction:column;gap:12px">
        <input id="cadastro-nome" placeholder="Seu nome" style="padding:12px;border-radius:8px;border:1px solid #E9EEF2">
        <input id="cadastro-email" type="email" placeholder="E-mail" style="padding:12px;border-radius:8px;border:1px solid #E9EEF2">
        <input id="cadastro-password" type="password" placeholder="Senha (mín. 6 caracteres)" style="padding:12px;border-radius:8px;border:1px solid #E9EEF2">
        
        <button class="btn primary" onclick="fazerCadastro()" style="width:100%;padding:12px" id="cadastro-btn">
          <i class="fas fa-user-plus"></i> Criar Conta
        </button>
        
        <button class="btn ghost" onclick="trocarParaLogin()" style="width:100%">
          Voltar para login
        </button>
      </div>
    </div>
  </div>

  <div class="app" style="display:none">
  <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <aside class="sidebar">
	  <div class="brand">
		<div class="logo"></div> <div>
		  <h1>FinPess</h1>
		  <div style="font-size:12px;opacity:.9">Gestão Financeira Pessoal</div>
		</div>
	  </div>

      <nav class="nav" aria-label="Main navigation">
        <a class="active" data-screen="dashboard" href="#"><i class="fas fa-home"></i> Dashboard</a>
        <a data-screen="lancamentos" href="#"><i class="fas fa-money-bill-wave"></i> Lançamentos</a>
        <a data-screen="contas" href="#"><i class="fas fa-university"></i> Contas</a>
        <a data-screen="setores" href="#"><i class="fas fa-sitemap"></i> Setores</a>
        <a data-screen="categorias" href="#"><i class="fas fa-tags"></i> Categorias</a>
        <a data-screen="parceiros" href="#"><i class="fas fa-user-friends"></i> Parceiros</a>
        <a data-screen="formas-pagamento" href="#"><i class="fas fa-credit-card"></i> Formas de Pagamento</a>
      </nav>

      <div class="spacer"></div>

      <div class="user-mini">
        <div class="avatar">U</div>
        <div>
          <div style="font-weight:700" id="user-name">Usuário</div>
          <div style="font-size:12px;color:rgba(255,255,255,0.8)" id="user-email">user@exemplo.com</div>
          <button onclick="fazerLogout()" style="background:none;border:none;color:rgba(255,255,255,0.7);font-size:11px;cursor:pointer;margin-top:4px">
            <i class="fas fa-sign-out-alt"></i> Sair
          </button>
        </div>
      </div>
    </aside>

    <main class="content">
		
      <header class="app-header">
		<button class="btn ghost mobile-menu-btn" onclick="toggleSidebar()">
			<i class="fas fa-bars"></i>
		</button>
		
        <div class="search">
			<i class="fas fa-search" style="color:var(--muted)"></i>
			<input id="global-search" placeholder="Buscar em lançamentos (pressione Enter)...">
		</div>
        <div class="top-actions">
           <!-- NOVO: Adiciona um botão de "Novo Lançamento" mais proeminente e universal -->
          <button class="btn primary" id="btn-novo-lancamento" onclick="abrirFormLancamento()">
            <i class="fas fa-plus"></i> Novo Lançamento
          </button>
          <button class="btn" id="btn-theme">Tema</button>
        </div>
      </header>

      
      <section id="dashboard" class="screen">
        <!-- 1. KPIs PRINCIPAIS (4 COLUNAS - Reestruturado para ser mais visual e conciso) -->
        <div class="grid" style="margin-bottom:var(--gap)">
		   
		  <!-- Saldo Geral (KPI central) -->
			<div class="col-3">
			  <div class="card kpi-card saldo" style="border-left: 4px solid var(--info);">
				<div class="status-indicator"></div>
				<div class="kpi-label">
				  <i class="fas fa-university"></i>
				  <span>Saldo Geral</span>
				</div>
				<div class="kpi-value" data-animate id="saldo-geral">R$ 0,00</div>
				<div class="kpi-meta" id="saldo-data">Atualizado em ---</div>
			  </div>
			</div>

          <!-- Receitas (Mês) -->
          <div class="col-3">
			  <div class="card kpi-card receita" style="border-left: 4px solid var(--success);">
				<div class="status-indicator"></div>
				<div class="kpi-label">
				  <i class="fas fa-arrow-up"></i>
				  <span>Receitas (Mês)</span>
				</div>
				<div class="kpi-value" data-animate id="receitas-mes">R$ 0,00</div>
				<div class="kpi-meta" id="delta-receita">Mês atual</div>
			  </div>
			</div>

          <!-- Despesas (Mês) -->
          <div class="col-3">
			  <div class="card kpi-card despesa" style="border-left: 4px solid var(--danger);">
				<div class="status-indicator"></div>
				<div class="kpi-label">
				  <i class="fas fa-arrow-down"></i>
				  <span>Despesas (Mês)</span>
				</div>
				<div class="kpi-value" data-animate id="despesas-mes">R$ 0,00</div>
				<div class="kpi-meta" id="delta-despesa">Mês atual</div>
			  </div>
			</div>

          <!-- Saldo Mês (Net Flow) -->
          <div class="col-3">
			  <div class="card kpi-card" id="kpi-saldo-mes" style="border-left: 4px solid var(--info);">
				<div class="status-indicator"></div>
				<div class="kpi-label">
				  <i class="fas fa-scale-balanced"></i>
				  <span>Fluxo Líquido (Mês)</span>
				</div>
				<div class="kpi-value" data-animate id="saldo-mes-dashboard">R$ 0,00</div>
				<div class="kpi-meta" id="delta-fluxo">Resultado do mês</div>
			  </div>
			</div>

        </div>
		   
        <!-- 2. GRÁFICOS E Saldos por Conta (COLUNA 7 / COLUNA 5) -->
        <div class="grid" style="margin-bottom:var(--gap)">
          
          <!-- Fluxo de Caixa (Gráfico Principal) -->
          <div class="col-7">
            <div class="card">
              <h3>Fluxo de Caixa (Últimos 6 Meses)</h3>
              <div class="chart-wrap" style="height:360px;margin-top:12px"><canvas id="chartFluxo"></canvas></div>
              <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <!-- Botões removidos, o fluxo de 6 meses é o padrão para simplicidade -->
                <div style="margin-left:auto;color:var(--muted);font-size:13px"><i class="fas fa-chart-line"></i> Receita e Despesa Realizadas</div>
              </div>
            </div>
          </div>

          <!-- Saldos por Conta -->
          <div class="col-5">
            <div class="card" style="height:448px"> <!-- Altura fixa para alinhar com o gráfico -->
              <h3>Saldos Detalhados por Conta</h3>
              <div id="lista-saldos" style="margin-top:12px;display:flex;flex-direction:column;gap:10px;overflow-y:auto;max-height: calc(100% - 40px);">
                <!-- contas preenchidas por JS -->
              </div>
            </div>
          </div>

        </div>

        <!-- 3. Contas Pendentes e Últimos Lançamentos (COLUNA 12) -->
        <div class="grid">

          <!-- Contas Pendentes (2 Cartões em uma Coluna 12) -->
          <div class="col-12" style="margin-bottom:var(--gap)">
             <div class="grid">
              <div class="col-6">
                 <div class="card kpi pagar" style="min-height:auto;border-left: 4px solid var(--warning);">
                    <div class="kpi-head"><i class="fas fa-clock"></i><h3>Contas a Pagar (Pendentes)</h3></div>
                    <div class="value" data-animate id="contas-a-pagar-valor">R$ 0,00</div>
                    <div style="font-size:13px;color:var(--muted);margin-top:4px" id="contas-a-pagar-info">Nenhuma conta pendente</div>
                 </div>
              </div>
              <div class="col-6">
                 <div class="card kpi receber" style="min-height:auto;border-left: 4px solid var(--accent);">
                    <div class="kpi-head"><i class="fas fa-hand-holding-dollar"></i><h3>Contas a Receber (Pendentes)</h3></div>
                    <div class="value" data-animate id="contas-a-receber-valor">R$ 0,00</div>
                    <div style="font-size:13px;color:var(--muted);margin-top:4px" id="contas-a-receber-info">Nenhuma conta a receber</div>
                 </div>
              </div>
             </div>
          </div>

          <!-- Distribuição de Despesas (Col 4) -->
          <div class="col-4">
            <div class="card" style="height:440px;">
              <h3>Distribuição de Despesas (Mês)</h3>
              <div class="chart-wrap" style="height:360px;margin-top:12px"><canvas id="chartDespesas"></canvas></div>
            </div>
          </div>
          
          <!-- Últimos Lançamentos (Col 8) -->
          <div class="col-8">
            <div class="card" style="height:440px;overflow:auto">
              <h3>Últimos Lançamentos Realizados</h3>
              <div id="dashboard-ultimos-container" class="lancamento-list" style="margin-top:10px;">
                  </div>
            </div>
          </div>
        </div>
		
		<div class="grid" style="margin-top: var(--gap)">
          <div class="col-12">
            <div class="card">
              <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px; margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid var(--border)">
                <div style="display:flex; align-items:center; gap:10px">
                  <i class="fas fa-bullseye" style="color:var(--accent)"></i>
                  <h3 style="margin:0">Planejamento Orçamentário (Mês Atual)</h3>
                </div>
                
                <div id="indicador-economia" style="text-align:right">
                    <div style="display: flex; align-items: center; justify-content: flex-end; gap: 6px;">
                        <span style="font-size:12px; color:var(--muted); font-weight:600; text-transform:uppercase">Economia Prevista</span>
                        <i class="fas fa-info-circle" 
                           style="color: var(--muted); cursor: help; font-size: 14px;" 
                           title="Este valor é uma projeção: Receitas Totais do Mês - Soma das Metas de Gastos. Ele indica quanto sobrará se você seguir o seu planejamento à risca.">
                        </i>
                    </div>
                    <div id="valor-economia-prevista" style="font-size:1.2rem; font-weight:800; color:var(--success)">R$ 0,00</div>
                </div>
              </div>
              
              <div id="container-metas" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
                </div>
            </div>
          </div>
        </div>
      </section>


      <section id="lancamentos" class="screen" style="display:none">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
            <div style="display:flex; align-items:center; gap:8px">
			  <h3 style="margin:0">Lançamentos</h3>
			  <button class="btn-config-gear" onclick="abrirConfigVisibilidade()" title="Configurar Visibilidade">
				<i class="fas fa-cog"></i>
			  </button>
			</div>
            <div style="display:flex;align-items:center;gap:12px">
              <div style="display:flex;align-items:center;gap:8px;background:var(--glass);padding:6px 12px;border-radius:8px">
                <button class="btn ghost small" onclick="mudarMes(-1)" style="padding:4px 8px">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <span id="mes-atual" style="font-weight:600;min-width:140px;text-align:center">Novembro 2024</span>
                <button class="btn ghost small" onclick="mudarMes(1)" style="padding:4px 8px">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
              
              <button class="btn primary" id="btn-novo-lancamento-tela" onclick="abrirFormLancamento()">
                <i class="fas fa-plus"></i> Novo Lançamento
              </button>
            </div>
          </div>

          <div class="filtros-grid-compacta">
			  <div class="col-busca-larga">
				<label style="font-size: 11px; color: var(--muted); margin-bottom: 4px; display: block;">Descrição</label>
				<input id="filtro-descricao-lancamento" placeholder="🔍 Buscar..." oninput="filtrarLancamentos()">
			  </div>

			  <div>
				<label style="font-size: 11px; color: var(--muted); margin-bottom: 4px; display: block;">Conta</label>
				<select id="filtro-conta-lancamento" onchange="filtrarLancamentos()">
				  <option value="">Todas</option>
				</select>
			  </div>

			  <div>
				<label style="font-size: 11px; color: var(--muted); margin-bottom: 4px; display: block;">Tipo</label>
				<select id="filtro-tipo-lancamento" onchange="filtrarLancamentos()">
				  <option value="">Todos</option>
				  <option value="receita">Receita</option>
				  <option value="despesa">Despesa</option>
				  <option value="transferencia">Transferência</option>
				</select>
			  </div>

			  <div>
				<label style="font-size: 11px; color: var(--muted); margin-bottom: 4px; display: block;">Status</label>
				<select id="filtro-status-lancamento" onchange="filtrarLancamentos()">
				  <option value="">Todos</option>
				  <option value="realizado">Realizado</option>
				  <option value="nao-realizado">Pendente</option>
				</select>
			  </div>

			  <div>
				<label style="font-size: 11px; color: var(--muted); margin-bottom: 4px; display: block;">Parceiro</label>
				<select id="filtro-parceiro-lancamento" onchange="filtrarLancamentos()">
				  <option value="">Todos</option>
				</select>
			  </div>

			  <button class="btn-limpar" onclick="resetFiltrosLancamentosCompleto()" title="Limpar todos os filtros">
				<i class="fas fa-eraser"></i> Limpar
			  </button>
			</div>
        </div>

        <div class="grid" id="container-kpis-lancamentos" style="margin-top:18px">
          <div class="col-4">
            <div class="card kpi receita">
              <div class="kpi-head"><i class="fas fa-arrow-trend-up"></i><h3>Receitas (Mês)</h3></div>
              <div class="value" id="receitas-mes-lancamentos">R$ 0,00</div>
            </div>
          </div>
          <div class="col-4">
            <div class="card kpi despesa">
              <div class="kpi-head"><i class="fas fa-arrow-trend-down"></i><h3>Despesas (Mês)</h3></div>
              <div class="value" id="despesas-mes-lancamentos">R$ 0,00</div>
            </div>
          </div>
          <div class="col-4">
            <div class="card kpi saldo">
              <div class="kpi-head"><i class="fas fa-scale-balanced"></i><h3>Saldo Líquido (Mês)</h3></div>
              <div class="value" id="saldo-mes-lancamentos">R$ 0,00</div>
            </div>
          </div>
        </div>

        <div id="lista-lancamentos-container" style="margin-top:18px; padding-bottom: 60px;">
            </div>
			
	</section>

      <section id="contas" class="screen" style="display:none">
        <div class="card">
          <div style="display:flex; align-items:center; gap:10px">
			  <h3 style="margin:0">Contas Financeiras</h3>
			  <button class="btn-config-gear" onclick="abrirConfigVisibilidadeContas()" title="Configurar Visibilidade no Dashboard">
				<i class="fas fa-cog"></i>
			  </button>
			</div>		
        <div class="filtros-container" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
          <div style="display: flex; gap: 10px;">
            <button class="btn primary" onclick="abrirFormConta()" style="padding: 10px 20px;">
              <i class="fas fa-plus"></i> Nova Conta
            </button>
            
            <button class="btn" onclick="recalcularSaldosGerais()" 
                    style="background-color: var(--info); color: white; border: none; padding: 10px 20px; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <i class="fas fa-sync-alt"></i> Recalcular Saldos
            </button>
          </div>

          <div style="display: flex; gap: 10px; flex-grow: 1; justify-content: flex-end; min-width: 300px;">
            <select id="filtro-tipo-conta" onchange="renderTabelaContas()" style="width: auto; min-width: 160px;">
              <option value="">Todos os tipos</option>
              <option value="corrente">Conta Corrente</option>
              <option value="poupanca">Poupança</option>
              <option value="carteira">Carteira</option>
              <option value="investimento">Investimento</option>
              <option value="outro">Outro</option>
            </select>
            
            <select id="filtro-status-conta" onchange="renderTabelaContas()" style="width: auto; min-width: 140px;">
              <option value="">Todos os status</option>
              <option value="ativo">Ativo</option>
              <option value="inativo">Inativo</option>
            </select>
            
            <input id="filtro-text-conta" placeholder="Buscar conta..." oninput="renderTabelaContas()" style="max-width: 200px;">
          </div>
        </div>	

        <div class="card" style="margin-top:18px">
          <div id="lista-contas-container" class="contas-grid" style="margin-top:20px; padding-bottom: 60px;">
            </div>
        </div>
      </section>

      <section id="setores" class="screen" style="display:none">
        <div class="card">
          <h3>Setores (Centro de Custo)</h3>
          <div class="filtros-container">
            <button class="btn primary" onclick="abrirFormSetor()">+ Novo Setor</button>
            <select id="filtro-status-setor" onchange="renderTabelaSetores()">
              <option value="">Todos os status</option>
              <option value="ativo">Ativo</option>
              <option value="inativo">Inativo</option>
            </select>
            <input id="filtro-text-setor" placeholder="Buscar por descrição..." oninput="renderTabelaSetores()">
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <div id="lista-setores-container" class="setores-grid" style="margin-top:20px; padding-bottom: 60px;">
            </div>
        </div>
      </section>

      <section id="categorias" class="screen" style="display:none">
        <div class="card">
          <h3>Categorias</h3>
          <div class="filtros-container">
            <button class="btn primary" onclick="abrirFormCategoria()">+ Nova Categoria</button>
            <select id="filtro-tipo-categoria" onchange="renderTabelaCategorias()">
              <option value="">Todos os tipos</option>
              <option value="receita">Receita</option>
              <option value="despesa">Despesa</option>
            </select>
            <select id="filtro-status-categoria" onchange="renderTabelaCategorias()">
              <option value="">Todos os status</option>
              <option value="ativo">Ativo</option>
              <option value="inativo">Inativo</option>
            </select>
            <input id="filtro-text-categoria" placeholder="Buscar por nome..." oninput="renderTabelaCategorias()">
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <div id="lista-categorias-container" class="categorias-grid" style="margin-top:20px; padding-bottom: 60px;">
            </div>
        </div>
      </section>

      <section id="parceiros" class="screen" style="display:none">
        <div class="card">
          <h3>Parceiros</h3>
          <div class="filtros-container">
            <button class="btn primary" onclick="abrirFormParceiro()">+ Novo Parceiro</button>
            <select id="filtro-tipo-parceiro" onchange="renderTabelaParceiros()">
              <option value="">Todos os tipos</option>
              <option value="fisica">Física</option>
              <option value="juridica">Jurídica</option>
            </select>
            <select id="filtro-status-parceiro" onchange="renderTabelaParceiros()">
              <option value="">Todos os status</option>
              <option value="ativo">Ativo</option>
              <option value="inativo">Inativo</option>
            </select>
            <input id="filtro-text-parceiro" placeholder="Buscar por nome..." oninput="renderTabelaParceiros()">
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <div id="lista-parceiros-container" class="parceiros-grid" style="margin-top:20px; padding-bottom: 60px;">
            </div>
        </div>
      </section>

      <section id="formas-pagamento" class="screen" style="display:none">
        <div class="card">
          <h3>Formas de Pagamento</h3>
          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn primary" onclick="abrirFormFormaPagamento()">+ Nova Forma</button>
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <div id="lista-formas-pagamento-container" class="formas-grid" style="margin-top:20px; padding-bottom: 60px;">
            </div>
        </div>
      </section>
    </main>
  </div>

  <div id="modal-form" class="modal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="modal-title" style="margin:0">Formulário</h3>
        <button onclick="fecharModal()" style="border:0;background:#F3F6F8;padding:8px;border-radius:8px"><i class="fas fa-times"></i></button>
      </div>
      <div id="modal-body" style="margin-top:12px"></div>
    </div>
  </div>

  <div id="modal-lancamento" class="modal">
    <div class="modal-content" style="max-width:600px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="modal-lancamento-title" style="margin:0">Novo Lançamento</h3>
        <button onclick="fecharModalLancamento()" style="border:0;background:#F3F6F8;padding:8px;border-radius:8px">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div id="modal-lancamento-body" style="margin-top:16px">
        </div>
    </div>
  </div>

  <script>
    // ---------- Configuração Firebase ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAhOwJZZ9OxsWsEW1BsGXy7I-5qTFyH-GI",
      authDomain: "finpess-efabe.firebaseapp.com",
      databaseURL: "https://finpess-efabe-default-rtdb.firebaseio.com",
      projectId: "finpess-efabe",
      storageBucket: "finpess-efabe.firebasestorage.app",
      messagingSenderId: "730433687910",
      appId: "1:730433687910:web:9a3a6130abc6d95fa338a7"
    };

    // Inicializa Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Variáveis globais
    let currentUser = null;
    let dataSaldos = [];
    let dataLancamentos = [];
    let dataCategorias = [];
    let dataParceiros = [];
    let dataFormasPagamento = [];
    let dataSetores = [];

    // ---------- VARIÁVEIS GLOBAIS PARA LANÇAMENTOS E GRÁFICOS ----------
    let mesAtual = new Date().getMonth();
    let anoAtual = new Date().getFullYear();
    let lancamentoEditando = null;
    let chartObj = null; // Para o Fluxo de Caixa
    let chartDespesasObj = null; // Para a Distribuição de Despesas

    // ---------- SISTEMA DE CACHE ----------
    let cacheTimestamp = null;
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutos

    // Funções de cache
    function saveToCache(userId) {
        const cacheData = {
            dataSaldos,
            dataLancamentos,
            dataCategorias,
            dataParceiros,
            dataFormasPagamento,
            dataSetores,
            timestamp: Date.now()
        };
        localStorage.setItem(`finpess_cache_${userId}`, JSON.stringify(cacheData));
    }

    function applyCachedData(cachedData) {
        dataSaldos = cachedData.dataSaldos || [];
        dataLancamentos = cachedData.dataLancamentos || [];
        dataCategorias = cachedData.dataCategorias || [];
        dataParceiros = cachedData.dataParceiros || [];
        dataFormasPagamento = cachedData.dataFormasPagamento || [];
        dataSetores = cachedData.dataSetores || [];
    }

    function invalidateCache() {
        cacheTimestamp = null;
        if (currentUser) {
            localStorage.removeItem(`finpess_cache_${currentUser.uid}`);
        }
    }

    // ---------- Sistema de Autenticação (MOVIDO PARA O TOPO) ----------
    
    async function initializeAuth() {
        try {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await onUserSignedIn(user);
                } else {
                    onUserSignedOut();
                }
            });
        } catch (error) {
            console.error('Erro ao inicializar auth:', error);
            showError('Erro ao inicializar sistema de autenticação');
        }
    }

    async function fazerLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const loginBtn = document.getElementById('login-btn');
        
        if (!email || !password) {
            showError('Preencha email e senha');
            return;
        }
        
        try {
            loginBtn.innerHTML = '<div class="loading"></div> Entrando...';
            loginBtn.disabled = true;
            
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            console.error('Erro no login:', error);
            showError('Erro ao fazer login: ' + error.message);
            loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar';
            loginBtn.disabled = false;
        }
    }
	
	// FUNÇÃO PARA RECUPERAR SENHA
	async function redefinirSenha() {
		const email = document.getElementById('login-email').value.trim();

		if (!email) {
			alert('Por favor, digite seu e-mail no campo acima para receber o link de recuperação.');
			document.getElementById('login-email').focus();
			return;
		}

		try {
			await auth.sendPasswordResetEmail(email);
			alert('E-mail enviado! Verifique sua caixa de entrada (e a pasta de spam) para criar uma nova senha.');
		} catch (error) {
			if (error.code === 'auth/user-not-found') {
				alert('Este e-mail não foi encontrado no sistema.');
			} else {
				alert('Erro ao enviar e-mail: ' + error.message);
			}
		}
	}

    async function fazerCadastro() {
        const nome = document.getElementById('cadastro-nome').value;
        const email = document.getElementById('cadastro-email').value;
        const password = document.getElementById('cadastro-password').value;
        const cadastroBtn = document.getElementById('cadastro-btn');
        
        if (!nome || !email || !password) {
            showError('Preencha todos os campos');
            return;
        }
        
        if (password.length < 6) {
            showError('A senha deve ter pelo menos 6 caracteres');
            return;
        }
        
        try {
            cadastroBtn.innerHTML = '<div class="loading"></div> Criando conta...';
            cadastroBtn.disabled = true;
            
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;
            
            // Salvar dados do usuário no Firestore
            await db.collection('usuarios').doc(user.uid).set({
                nome: nome,
                email: email,
                dataCriacao: firebase.firestore.FieldValue.serverTimestamp(),
                ultimoAcesso: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Criar dados iniciais para o usuário
            await criarDadosIniciaisUsuario(user.uid);
            
        } catch (error) {
            console.error('Erro no cadastro:', error);
            showError('Erro ao criar conta: ' + error.message);
            cadastroBtn.innerHTML = '<i class="fas fa-user-plus"></i> Criar Conta';
            cadastroBtn.disabled = false;
        }
    }

    function fazerLogout() {
        if (confirm('Deseja realmente sair?')) {
            auth.signOut();
        }
    }

    function trocarParaCadastro() {
        document.getElementById('login-modal').style.display = 'none';
        document.getElementById('cadastro-modal').style.display = 'flex';
    }

    function trocarParaLogin() {
        document.getElementById('cadastro-modal').style.display = 'none';
        document.getElementById('login-modal').style.display = 'flex';
    }

    async function onUserSignedIn(user) {
        console.log('👤 Usuário logado:', user.email);
        
        // Atualizar interface
        document.getElementById('login-modal').style.display = 'none';
        document.getElementById('cadastro-modal').style.display = 'none';
        document.querySelector('.app').style.display = 'grid';
        
        // Atualizar informações do usuário
        const userNameElement = document.getElementById('user-name');
        const userEmailElement = document.getElementById('user-email');
        const userAvatarElement = document.querySelector('.user-mini .avatar');
        
        if (userNameElement) userNameElement.textContent = user.email.split('@')[0];
        if (userEmailElement) userEmailElement.textContent = user.email;
        if (userAvatarElement) userAvatarElement.textContent = user.email[0].toUpperCase();
        
        // CORREÇÃO: Verificar se o documento do usuário existe antes de atualizar
        try {
            const userDoc = await db.collection('usuarios').doc(user.uid).get();
            
            if (userDoc.exists) {
                // Documento existe, atualizar último acesso
                await db.collection('usuarios').doc(user.uid).update({
                    ultimoAcesso: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                // Documento não existe, criar um novo
                await db.collection('usuarios').doc(user.uid).set({
                    nome: user.email.split('@')[0],
                    email: user.email,
                    dataCriacao: firebase.firestore.FieldValue.serverTimestamp(),
                    ultimoAcesso: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Criar dados iniciais
                await criarDadosIniciaisUsuario(user.uid);
            }
        } catch (error) {
            console.error('Erro ao verificar/atualizar usuário:', error);
            // Continuar mesmo com erro para não bloquear o login
        }
        
        // Carregar dados do usuário
        await loadUserData(user.uid);
    }

    function onUserSignedOut() {
        console.log('🚪 Usuário deslogado');
        currentUser = null;
        
        // Resetar dados
        dataSaldos = [];
        dataLancamentos = [];
        dataCategorias = [];
        dataParceiros = [];
        dataFormasPagamento = [];
        dataSetores = [];
        
		// Destruir gráfico
		destroyChart();
		destroyChartDespesas();
		
        // Limpar cache
        invalidateCache();
		
        
        // Mostrar tela de login
        document.getElementById('login-modal').style.display = 'flex';
        document.querySelector('.app').style.display = 'none';
        
        // Resetar formulários de login
        document.getElementById('login-email').value = '';
        document.getElementById('login-password').value = '';
        document.getElementById('login-btn').innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar';
        document.getElementById('login-btn').disabled = false;
        
        // Resetar interface
        renderDashboard();
    }

    // ---------- SISTEMA DE NOTIFICAÇÕES ----------
    function showNotification(message, type = 'info', duration = 5000) {
        // Remover notificação existente
        const existingNotification = document.getElementById('global-notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        // Criar nova notificação
        const notification = document.createElement('div');
        notification.id = 'global-notification';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
        `;

        // Cores baseadas no tipo
        const colors = {
            success: 'var(--success)',
            error: 'var(--danger)',
            warning: 'var(--warning)',
            info: 'var(--info)'
        };

        notification.style.backgroundColor = colors[type] || colors.info;
        notification.textContent = message;

        document.body.appendChild(notification);

        // Animar entrada
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
            notification.style.opacity = '1';
        }, 100);

        // Auto-remover após duração
        if (duration > 0) {
            setTimeout(() => {
                hideNotification(notification);
            }, duration);
        }

        // Clique para fechar
        notification.addEventListener('click', () => {
            hideNotification(notification);
        });

        return notification;
    }

    function hideNotification(notification) {
        notification.style.transform = 'translateX(400px)';
        notification.style.opacity = '0';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }

    // Substituir os alerts por notificações
    function showError(message) {
        console.error('Erro:', message);
        showNotification(message, 'error', 7000);
    }

    function showSuccess(message) {
        showNotification(message, 'success', 4000);
    }

    function showInfo(message) {
        showNotification(message, 'info', 4000);
    }


	function calcularContasAPagar() {
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    
		const contasAPagar = dataLancamentos.filter(l => {
			// Verificar se é uma despesa pendente e não é transferência
			const isDespesaPendente = l.tipo === 'despesa' && 
									  !l.pago && 
									  !l.referenciaTransferenciaId;
			
			if (!isDespesaPendente) return false;
			
			// Verificar se a data existe e é válida
			if (!l.data) return false;
			
			// Converter a data string para objeto Date
			const dataVencimento = new Date(l.data);
			
			// Verificar se a data é válida
			if (isNaN(dataVencimento.getTime())) return false;
			
			// Normalizar a data (remover horas, minutos, segundos)
			dataVencimento.setHours(0, 0, 0, 0);
			
			// CORREÇÃO: Só mostrar contas com data <= hoje + 365 dias (próximo ano)
			// Isso evita datas muito futuras que podem ser erros
			const umAnoAFrente = new Date();
			umAnoAFrente.setFullYear(umAnoAFrente.getFullYear() + 1);
			umAnoAFrente.setHours(0, 0, 0, 0);
			
			return dataVencimento <= umAnoAFrente;
		});
		
		// Ordenar por data de vencimento (vencidos primeiro, depois mais próximos)
		contasAPagar.sort((a, b) => {
			const dataA = new Date(a.data);
			const dataB = new Date(b.data);
			return dataA - dataB;
		});
		
		const totalAPagar = contasAPagar.reduce((total, lancamento) => {
			return total + (lancamento.valor || 0);
		}, 0);
		
		// Contar vencidos (datas anteriores a hoje)
		const vencidos = contasAPagar.filter(l => {
			const dataVencimento = new Date(l.data);
			dataVencimento.setHours(0, 0, 0, 0);
			return dataVencimento < hoje;
		}).length;
		
		// Encontrar próximo vencimento válido (não vencido)
		const proximoNaoVencido = contasAPagar.find(l => {
			const dataVencimento = new Date(l.data);
			dataVencimento.setHours(0, 0, 0, 0);
			return dataVencimento >= hoje;
		});
		
		return {
			total: totalAPagar,
			quantidade: contasAPagar.length,
			vencidos: vencidos,
			lancamentos: contasAPagar,
			proximoVencimento: proximoNaoVencido ? proximoNaoVencido.data : null
		};
	}


	function calcularContasAReceber() {
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    
		const contasAReceber = dataLancamentos.filter(l => {
			// Verificar se é uma receita pendente e não é transferência
			const isReceitaPendente = l.tipo === 'receita' && 
									  !l.pago && 
									  !l.referenciaTransferenciaId;
			
			if (!isReceitaPendente) return false;
			
			// Verificar se a data existe e é válida
			if (!l.data) return false;
			
			// Converter a data string para objeto Date
			const dataVencimento = new Date(l.data);
			
			// Verificar se a data é válida
			if (isNaN(dataVencimento.getTime())) return false;
			
			// Normalizar a data (remover horas, minutos, segundos)
			dataVencimento.setHours(0, 0, 0, 0);
			
			// CORREÇÃO: Só mostrar contas com data <= hoje + 365 dias (próximo ano)
			// Isso evita datas muito futuras que podem ser erros
			const umAnoAFrente = new Date();
			umAnoAFrente.setFullYear(umAnoAFrente.getFullYear() + 1);
			umAnoAFrente.setHours(0, 0, 0, 0);
			
			return dataVencimento <= umAnoAFrente;
		});
		
		// Ordenar por data de vencimento (vencidos primeiro, depois mais próximos)
		contasAReceber.sort((a, b) => {
			const dataA = new Date(a.data);
			const dataB = new Date(b.data);
			return dataA - dataB;
		});
		
		const totalAReceber = contasAReceber.reduce((total, lancamento) => {
			return total + (lancamento.valor || 0);
		}, 0);
		
		// Contar vencidos (datas anteriores a hoje)
		const vencidos = contasAReceber.filter(l => {
			const dataVencimento = new Date(l.data);
			dataVencimento.setHours(0, 0, 0, 0);
			return dataVencimento < hoje;
		}).length;
		
		// Encontrar próximo vencimento válido (não vencido)
		const proximoNaoVencido = contasAReceber.find(l => {
			const dataVencimento = new Date(l.data);
			dataVencimento.setHours(0, 0, 0, 0);
			return dataVencimento >= hoje;
		});
		
		return {
			total: totalAReceber,
			quantidade: contasAReceber.length,
			vencidos: vencidos,
			lancamentos: contasAReceber,
			proximoVencimento: proximoNaoVencido ? proximoNaoVencido.data : null
		};
	}
	

    function atualizarCardsContasPendentes() {
    const contasAPagar = calcularContasAPagar();
    const contasAReceber = calcularContasAReceber();
    
    // Atualizar Contas a Pagar
    const valorPagarElement = document.getElementById('contas-a-pagar-valor');
    const infoPagarElement = document.getElementById('contas-a-pagar-info');
    
    if (valorPagarElement) {
        valorPagarElement.textContent = formatMoney(contasAPagar.total);
        valorPagarElement.style.color = contasAPagar.total > 0 ? 'var(--warning)' : 'var(--primary)';
    }
    
    if (infoPagarElement) {
        if (contasAPagar.quantidade === 0) {
            infoPagarElement.innerHTML = 'Nenhuma conta pendente';
            infoPagarElement.style.color = 'var(--muted)';
        } else {
            const proximoVencimento = contasAPagar.proximoVencimento ? 
                formatDate(contasAPagar.proximoVencimento) : '';
            
            let infoHTML = `<span style="font-weight:600">${contasAPagar.quantidade} conta(s) pendente(s)</span>`;
            
            if (contasAPagar.vencidos > 0) {
                infoHTML += `<br><small style="color:var(--danger)">⚠️ ${contasAPagar.vencidos} vencida(s)</small>`;
            }
            
            if (proximoVencimento) {
                infoHTML += `<br><small>Próximo: ${proximoVencimento}</small>`;
            }
            
            infoPagarElement.innerHTML = infoHTML;
            infoPagarElement.style.color = contasAPagar.vencidos > 0 ? 'var(--danger)' : 'var(--warning)';
        }
    }
    
		// Atualizar Contas a Receber
		const valorReceberElement = document.getElementById('contas-a-receber-valor');
		const infoReceberElement = document.getElementById('contas-a-receber-info');
		
		if (valorReceberElement) {
			valorReceberElement.textContent = formatMoney(contasAReceber.total);
			valorReceberElement.style.color = contasAReceber.total > 0 ? 'var(--accent)' : 'var(--primary)';
		}
		
		if (infoReceberElement) {
			if (contasAReceber.quantidade === 0) {
				infoReceberElement.innerHTML = 'Nenhuma conta a receber';
				infoReceberElement.style.color = 'var(--muted)';
			} else {
				const proximoVencimento = contasAReceber.proximoVencimento ? 
					formatDate(contasAReceber.proximoVencimento) : '';
				
				let infoHTML = `<span style="font-weight:600">${contasAReceber.quantidade} conta(s) a receber</span>`;
				
				if (contasAReceber.vencidos > 0) {
					infoHTML += `<br><small style="color:var(--danger)">⚠️ ${contasAReceber.vencidos} vencida(s)</small>`;
				}
				
				if (proximoVencimento) {
					infoHTML += `<br><small>Próximo: ${proximoVencimento}</small>`;
				}
				
				infoReceberElement.innerHTML = infoHTML;
				infoReceberElement.style.color = contasAReceber.vencidos > 0 ? 'var(--danger)' : 'var(--accent)';
			}
		}
	}


    // ---------- Dados Iniciais para Novos Usuários ----------
    
    async function criarDadosIniciaisUsuario(userId) {
        try {
            const batch = db.batch();
            
            // Contas iniciais
            const contasIniciais = [
                { 
                    nome: 'Conta Corrente', 
                    valor: 0, 
                    tipo: 'corrente',
                    dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp(),
                    ativo: true,
                    userId: userId
                },
                { 
                    nome: 'Carteira', 
                    valor: 0, 
                    tipo: 'carteira', 
                    dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp(),
                    ativo: true,
                    userId: userId
                }
            ];
            
            contasIniciais.forEach(conta => {
                const docRef = db.collection('contas').doc();
                batch.set(docRef, conta);
            });
            
            // Setores iniciais
            const setoresIniciais = [
                { 
                    descricao: 'Administrativo', 
                    ativo: true,
                    userId: userId
                },
                { 
                    descricao: 'Comercial', 
                    ativo: true,
                    userId: userId
                },
                { 
                    descricao: 'Produção', 
                    ativo: true,
                    userId: userId
                }
            ];
            
            setoresIniciais.forEach(setor => {
                const docRef = db.collection('setores').doc();
                batch.set(docRef, setor);
            });
            
            // Categorias iniciais ATUALIZADAS
            const categoriasIniciais = [
                { 
                    nome: 'Salário', 
                    tipo: 'receita', 
                    cor: '#2ECC71', 
                    descricao: 'Salário e proventos',
                    ativo: true,
                    padrao: true,
                    userId: userId 
                },
                { 
                    nome: 'Alimentação', 
                    tipo: 'despesa', 
                    cor: '#E74C3C', 
                    descricao: 'Gastos com alimentação',
                    ativo: true,
                    padrao: true,
                    userId: userId 
                },
                { 
                    nome: 'Transporte', 
                    tipo: 'despesa', 
                    cor: '#3498DB', 
                    descricao: 'Transporte e combustível',
                    ativo: true,
                    padrao: true,
                    userId: userId 
                },
                { 
                    nome: 'Moradia', 
                    tipo: 'despesa', 
                    cor: '#9B59B6', 
                    descricao: 'Aluguel, condomínio, IPTU',
                    ativo: true,
                    padrao: true,
                    userId: userId 
                },
                { 
                    nome: 'Investimentos', 
                    tipo: 'receita', 
                    cor: '#F39C12', 
                    descricao: 'Rendimentos de investimentos',
                    ativo: true,
                    padrao: true,
                    userId: userId 
                }
            ];
            
            categoriasIniciais.forEach(categoria => {
                const docRef = db.collection('categorias').doc();
                batch.set(docRef, categoria);
            });
            
            // Parceiros iniciais
            const parceirosIniciais = [
                { 
                    nome: 'Cliente João Silva', 
                    tipo: 'fisica', 
                    ativo: true, 
                    cpfCnpj: '123.456.789-00',
                    telefone: '(11) 99999-9999',
                    userId: userId 
                }
            ];
            
            parceirosIniciais.forEach(parceiro => {
                const docRef = db.collection('parceiros').doc();
                batch.set(docRef, parceiro);
            });

            // Formas de Pagamento iniciais
            const formasPagamentoIniciais = [
                { 
                    descricao: 'Cartão de Crédito', 
                    ativo: true, 
                    permiteParcelamento: true, 
                    maxParcelas: 12,
                    userId: userId 
                }
            ];
            
            formasPagamentoIniciais.forEach(forma => {
                const docRef = db.collection('formasPagamento').doc();
                batch.set(docRef, forma);
            });
            
            await batch.commit();
            console.log('📝 Dados iniciais criados para usuário:', userId);
            showSuccess('Dados iniciais configurados com sucesso!');
        } catch (error) {
            console.error('❌ Erro ao criar dados iniciais:', error);
            showError('Erro ao criar dados iniciais: ' + error.message);
        }
    }

    // ---------- Carregamento de Dados do Usuário ----------
   

			// ---------- FUNÇÃO DE UTILIDADE PARA SALDO ----------
			/**
			 * Procura uma conta na memória local e a retorna.
			 * @param {string} contaId O ID da conta a ser encontrada.
			 */
			function getContaById(contaId) {
				return dataSaldos.find(c => c.id === contaId);
			}
			// ----------------------------------------------------

			// ---------- FUNÇÃO PRINCIPAL DE MOVIMENTAÇÃO DE SALDO ----------
			/**
			 * Atualiza o valor de uma conta no Firebase e na memória local.
			 * @param {string} contaId ID da conta a ser ajustada.
			 * @param {number} valorMovimento O valor do movimento (positivo ou negativo).
			 */
			async function ajustarSaldoConta(contaId, valorMovimento) {
				if (!contaId || valorMovimento === 0) return;

				const conta = getContaById(contaId);
				if (!conta) {
					showError(`Conta ID ${contaId} não encontrada.`);
					return;
				}

				// 1. Calcular o novo saldo local (Saldo Antigo + Movimento)
				const novoValor = (conta.valor || 0) + valorMovimento;

				try {
					// 2. Atualizar no Firebase
					await db.collection('contas').doc(contaId).update({
						valor: novoValor,
						dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
					});

					// 3. Atualizar na memória local (dataSaldos)
					conta.valor = novoValor;

					// 4. Forçar a atualização visual no Dashboard
					renderSaldos();
					renderDashboard();
					atualizarCardsContasPendentes();
					
					// Atualizar gráficos
					if (document.getElementById('dashboard').style.display === 'block') {
						if (chartObj) updateChart();
						if (chartDespesasObj) updateChartDespesas();
					}
					
				} catch (error) {
					console.error("❌ Erro ao ajustar saldo da conta:", error);
					showError("Erro ao ajustar saldo: " + error.message);
				}
			}
			// ----------------------------------------------------------------

   
    async function loadUserData(userId) {
        try {
            console.log(`📊 Carregando dados do usuário: ${userId}`);
            
            // Verificar cache
            const now = Date.now();
            const cachedData = localStorage.getItem(`finpess_cache_${userId}`);
            
            if (cachedData && cacheTimestamp && (now - cacheTimestamp) < CACHE_DURATION) {
                const parsedData = JSON.parse(cachedData);
                console.log('✅ Dados carregados do cache');
                applyCachedData(parsedData);
                renderAll();
                atualizarCardsContasPendentes(); 

				// Destruir gráfico anterior antes de criar novo
				destroyChart();
				destroyChartDespesas();
				// Recriar gráficos com timeout para garantir que o canvas esteja pronto
				setTimeout(() => {
					initChart();
					initChartDespesas();
				}, 100);

				popularFiltroParceiros();
				showSuccess('Dados carregados do cache com sucesso!');	
                return;
            }

            // Carregar do Firebase
            const loadCollection = async (collectionName, orderByField = null) => {
                try {
                    let query = db.collection(collectionName).where('userId', '==', userId);
                    
                    if (orderByField) {
                        query = query.orderBy(orderByField, 'desc');
                    }
                    
                    const snapshot = await query.limit(1000).get();
                    const dados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    console.log(`✅ ${collectionName}: ${dados.length} registros carregados`);
                    return dados;
                    
                } catch (error) {
                    console.error(`❌ Erro ao carregar ${collectionName}:`, error);
                    return [];
                }
            };

            const [
                contasData, 
                lancamentosData, 
                categoriasData, 
                parceirosData, 
                formasPagamentoData,
                setoresData
            ] = await Promise.all([
                loadCollection('contas'),
                loadCollection('lancamentos', 'data'),
                loadCollection('categorias'),
                loadCollection('parceiros'),
                loadCollection('formasPagamento'),
                loadCollection('setores')
            ]);

            // Atribuir dados - CORREÇÃO: garantir que são apenas do usuário
            dataSaldos = contasData.filter(item => item.userId === userId);
            dataLancamentos = lancamentosData.filter(item => item.userId === userId);
            dataCategorias = categoriasData.filter(item => item.userId === userId);
            dataParceiros = parceirosData.filter(item => item.userId === userId);
            dataFormasPagamento = formasPagamentoData.filter(item => item.userId === userId);
            dataSetores = setoresData.filter(item => item.userId === userId);

            // Salvar no cache
            saveToCache(userId);
            cacheTimestamp = now;

            console.log('✅ Dados do usuário carregados:', {
                contas: dataSaldos.length,
                lancamentos: dataLancamentos.length,
                categorias: dataCategorias.length,
                parceiros: dataParceiros.length,
                formasPagamento: dataFormasPagamento.length,
                setores: dataSetores.length
            });

            renderAll();
            atualizarCardsContasPendentes();
            initChart(); // Inicializa o Fluxo de Caixa
            initChartDespesas(); // Inicializa a Distribuição de Despesas
            popularFiltroParceiros();
			popularFiltroContas();
            showSuccess('Dados carregados com sucesso!');
            
        } catch (error) {
            console.error('❌ Erro crítico ao carregar dados do usuário:', error);
            showError('Erro ao carregar dados: ' + error.message);
        }
    }

    // ---------- Funções de Visualização ----------

	function showScreen(id){
		// 1. Identificar qual tela está ativa no momento antes de mudar
		const activeLink = document.querySelector('.nav a.active');
		const telaSaindo = activeLink ? activeLink.dataset.screen : null;

		// 2. Se o usuário estiver SAINDO da tela de lançamentos, limpamos tudo
		if (telaSaindo === 'lancamentos') {
			resetFiltrosLancamentosCompleto();
		}
		
		// CONTROLE DA TOP BAR (app-header)
		const header = document.querySelector('.app-header');
		if (header) {
			// Se for lançamentos, esconde. Caso contrário, mostra.
			header.style.display = (id === 'lancamentos') ? 'none' : 'flex';
		}

		// 3. Mudar a visibilidade das telas
		document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
		const el = document.getElementById(id);
		if (el) el.style.display = 'block';
		
		// 4. Renderizar dados específicos da nova tela
		if (id === 'formas-pagamento') {
			renderTabelaFormasPagamento();
		} else if (id === 'parceiros') {
			renderTabelaParceiros();
		} else if (id === 'categorias') {
			renderTabelaCategorias();
		} else if (id === 'contas') {
			renderTabelaContas();
		} else if (id === 'setores') {
			renderTabelaSetores();
		} else if (id === 'lancamentos') {
			atualizarDisplayMes();
		} else if (id === 'dashboard') {
			setTimeout(() => {
				destroyChart();
				destroyChartDespesas();
				initChart();
				initChartDespesas();
			}, 100);
		}
	}
    
    function renderAll() {
        renderDashboard();
        renderSaldos();
        montarUltimosLancamentos();
        atualizarCardsContasPendentes();
        renderMetasDashboard();
        // Animações
        animateKPIs();
    }

    function renderDashboard(){
		try {
			const saldoGeral = calcularSaldoGeral();
			const receitasMes = calcularReceitasMes();
			const despesasMes = calcularDespesasMes();
			const saldoMes = calcularSaldoMes();
			
			// Atualiza os textos básicos
			if(document.getElementById('saldo-geral')) document.getElementById('saldo-geral').textContent = formatMoney(saldoGeral);
			if(document.getElementById('receitas-mes')) document.getElementById('receitas-mes').textContent = formatMoney(receitasMes);
			if(document.getElementById('despesas-mes')) document.getElementById('despesas-mes').textContent = formatMoney(despesasMes);
			if(document.getElementById('saldo-mes-dashboard')) document.getElementById('saldo-mes-dashboard').textContent = formatMoney(saldoMes);
			
			// --- TRECHO SEGURO PARA AS CORES ---
			const kpiSaldoMes = document.getElementById('kpi-saldo-mes');
			if (kpiSaldoMes) {
				// Só muda a borda se o elemento existir
				kpiSaldoMes.style.borderLeftColor = saldoMes >= 0 ? 'var(--success)' : 'var(--danger)';
				
				// Verifica se o ícone existe antes de mudar a cor dele
				const icone = kpiSaldoMes.querySelector('i');
				if (icone) {
					icone.style.color = saldoMes >= 0 ? 'var(--success)' : 'var(--danger)';
					icone.style.background = saldoMes >= 0 ? 'rgba(46, 204, 113, 0.12)' : 'rgba(231, 76, 60, 0.12)';
				}
				
				const valorTexto = document.getElementById('saldo-mes-dashboard');
				if (valorTexto) {
					valorTexto.style.color = saldoMes >= 0 ? 'var(--success)' : 'var(--danger)';
				}
			}
			
			if(document.getElementById('saldo-data')) {
				document.getElementById('saldo-data').textContent = 
					'Atualizado em ' + new Date().toLocaleTimeString('pt-BR');
			}
				
		} catch (error) {
			console.error('❌ Erro ao atualizar dashboard:', error);
		}
	}
	
	function animateKPIs() {
		document.querySelectorAll('.kpi .value[data-animate]').forEach(kpi => {
			// Resetar a animação antes de adicionar a classe 'visible'
			kpi.classList.remove('visible');
			// Usar timeout para garantir que a animação ocorra
			setTimeout(() => {
				kpi.classList.add('visible');
			}, 50);
		});
	}

    function renderSaldos(){
		const root = document.getElementById('lista-saldos');
		if (!root) return;
		
		root.innerHTML = '';
		
		// NOVO: Filtra para mostrar apenas as contas que o usuário permitiu
		const contasVisiveis = dataSaldos.filter(s => s.exibirNoDashboard !== false);

		contasVisiveis.forEach(s => {
			const item = document.createElement('div');
			item.className = 'saldo-item';
			item.innerHTML = `
				<div>
					<div style="font-weight:700">${s.nome}</div>
					<div style="font-size:12px;color:var(--muted)">${getTipoContaLabel(s.tipo)}</div>
				</div>
				<div style="font-weight:800;color:${s.valor >= 0 ? 'var(--success)' : 'var(--danger)'}">
					${formatMoney(s.valor)}
				</div>
			`;
			root.appendChild(item);
		});
	}
	
//------------------------------ M A N T E N Ç Ã O ----------------------------------------//
	
   function montarUltimosLancamentos() {
		const container = document.getElementById('dashboard-ultimos-container');
		if (!container) return;
		
		container.innerHTML = '';
		
		// 1. ORDENAÇÃO: Aqui garantimos que o último lançado suba ao topo.
		// Comparamos a data do gasto e, se forem do mesmo dia, usamos o horário de criação como desempate.
		const ultimos = dataLancamentos
			.filter(l => l.pago === true)
			.sort((a, b) => {
				const dataA = new Date(a.data);
				const dataB = new Date(b.data);
				if (dataB - dataA !== 0) return dataB - dataA;
				// Desempate por ordem de inserção (o mais recente primeiro)
				return (b.id > a.id) ? 1 : -1; 
			})
			.slice(0, 10); // Pegamos os 10 mais recentes
			
		if (ultimos.length === 0) {
			container.innerHTML = '<div style="text-align:center; padding: 30px; color: var(--muted); opacity: 0.7;"><p>Nenhum lançamento recente.</p></div>';
			return;
		}
			
		ultimos.forEach(lancamento => {
			const categoria = dataCategorias.find(c => c.id === lancamento.categoriaId);
			const nomeLower = lancamento.descricao.toLowerCase();
			const isTransfer = lancamento.tipo === 'transferencia' || nomeLower.includes('transferência');

			let iconDisplay = isTransfer ? '<i class="fas fa-exchange-alt"></i>' : getIconeCategoria(categoria?.nome);
			let bgColor = isTransfer ? 'var(--info)' : (categoria ? categoria.cor : '#94A3B8');

			const itemCard = document.createElement('div');
			itemCard.className = 'lancamento-card';
			
			// --- MELHORIA DE INTERATIVIDADE ---
			itemCard.style.cursor = 'pointer'; // Muda o mouse para a "mãozinha" ao passar por cima
			itemCard.title = "Clique para filtrar este lançamento";
			
			// Quando clicar, ele chama a função que vamos criar no Passo 3
			itemCard.onclick = () => irParaLancamentoEFiltrar(lancamento.descricao);

			itemCard.innerHTML = `
				<div class="cat-icon" style="background: ${bgColor}; width: 38px; height: 38px; font-size: 16px;">
					${iconDisplay}
				</div>
				<div class="lancamento-info">
					<div class="lancamento-desc" style="font-size: 0.9rem;">${lancamento.descricao}</div>
					<div class="lancamento-meta" style="font-size: 0.75rem;">
						<span>${formatDate(lancamento.data)}</span>
					</div>
				</div>
				<div class="lancamento-values">
					<div class="lancamento-amount" style="color: ${lancamento.tipo === 'receita' ? 'var(--success)' : 'var(--danger)'}; font-size: 0.95rem;">
						${lancamento.tipo === 'receita' ? '+' : '-'} ${formatMoney(lancamento.valor).replace('R$', '').trim()}
					</div>
				</div>
			`;
			container.appendChild(itemCard);
		});
	}
	
	function irParaLancamentoEFiltrar(textoParaBuscar) {
		// 1. Comando para mudar de tela no sistema
		showScreen('lancamentos');

		// 2. Ajuste visual: deixar o botão "Lançamentos" no menu lateral marcado como ativo
		document.querySelectorAll('.nav a').forEach(link => link.classList.remove('active'));
		const linkAlvo = document.querySelector('a[data-screen="lancamentos"]');
		if (linkAlvo) linkAlvo.classList.add('active');

		// 3. O "Pulo do Gato": preencher o campo de busca e filtrar
		const campoBusca = document.getElementById('filtro-descricao-lancamento');
		if (campoBusca) {
			campoBusca.value = textoParaBuscar;
			campoBusca.classList.add('filled'); // Deixa o campo em destaque (negrito)
			filtrarLancamentos(); // Executa a busca automaticamente
		}
	}
	
//------------------------------ M A N T E N Ç Ã O ----------------------------------------//
	
    // ========== NOVAS FUNÇÕES PARA LANÇAMENTOS ==========

    // ---------- FUNÇÕES DE NAVEGAÇÃO POR MÊS ----------
    function atualizarDisplayMes() {
      const meses = [
        'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
      ];
      document.getElementById('mes-atual').textContent = `${meses[mesAtual]} ${anoAtual}`;
      carregarLancamentosMes();
    }

    function mudarMes(direcao) {
      mesAtual += direcao;
      if (mesAtual > 11) {
        mesAtual = 0;
        anoAtual++;
      } else if (mesAtual < 0) {
        mesAtual = 11;
        anoAtual--;
      }
      atualizarDisplayMes();
    }

    function popularFiltroParceiros() {
      const filtroParceiro = document.getElementById('filtro-parceiro-lancamento');
      if (filtroParceiro) {
        const parceirosAtivos = dataParceiros.filter(p => p.ativo);
        filtroParceiro.innerHTML = '<option value="">Todos os parceiros</option>' +
          parceirosAtivos.map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
      }
    }
	
	function popularFiltroContas() {
    const filtroConta = document.getElementById('filtro-conta-lancamento');
    if (filtroConta) {
        // Garantir que a lista de contas ativas do usuário é usada
        const contasAtivas = dataSaldos.filter(c => c.ativo && c.userId === currentUser.uid);
        
        filtroConta.innerHTML = '<option value="">Todas as contas</option>' +
          contasAtivas.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
    }
}

    // ---------- FUNÇÕES DE CARREGAMENTO E FILTRAGEM ----------
    function carregarLancamentosMes() {
      const primeiroDia = new Date(anoAtual, mesAtual, 1);
      const ultimoDia = new Date(anoAtual, mesAtual + 1, 0);
      
      const lancamentosMes = dataLancamentos.filter(l => {
        const dataLancamento = new Date(l.data);
        return dataLancamento >= primeiroDia && dataLancamento <= ultimoDia;
      });
      
      renderizarTabelaLancamentos(lancamentosMes);
      atualizarResumoMes(lancamentosMes);
    }
	
	function filtrarLancamentos() {
    // O uso de ?.value evita o erro 'reading properties of null'
		const tipo = document.getElementById('filtro-tipo-lancamento')?.value || "";
		const status = document.getElementById('filtro-status-lancamento')?.value || "";
		const parceiro = document.getElementById('filtro-parceiro-lancamento')?.value || "";
		const contaFiltro = document.getElementById('filtro-conta-lancamento')?.value || "";
		const descricao = document.getElementById('filtro-descricao-lancamento')?.value.toLowerCase() || "";
		
		const primeiroDia = new Date(anoAtual, mesAtual, 1);
		const ultimoDia = new Date(anoAtual, mesAtual + 1, 0);
		
		const lancamentosFiltrados = dataLancamentos.filter(l => {
			const dataLancamento = new Date(l.data);
			const noMes = dataLancamento >= primeiroDia && dataLancamento <= ultimoDia;
			const matchTipo = !tipo || l.tipo === tipo;
			const matchStatus = !status || 
			  (status === 'realizado' && l.pago === true) || 
			  (status === 'nao-realizado' && l.pago === false);
			const matchParceiro = !parceiro || l.parceiroId === parceiro;
			const matchDescricao = !descricao || l.descricao.toLowerCase().includes(descricao);
			const matchConta = !contaFiltro || l.contaId === contaFiltro;
			
			return noMes && matchTipo && matchStatus && matchParceiro && matchDescricao && matchConta;
		});
		
		renderizarTabelaLancamentos(lancamentosFiltrados);
		atualizarResumoMes(lancamentosFiltrados);

		// Feedback visual nos campos preenchidos
		const inputs = ['filtro-tipo-lancamento', 'filtro-status-lancamento', 'filtro-parceiro-lancamento', 'filtro-conta-lancamento', 'filtro-descricao-lancamento'];
		inputs.forEach(id => {
			const el = document.getElementById(id);
			if (el && el.value) {
				el.classList.add('filled');
			} else if (el) {
				el.classList.remove('filled');
			}
		});
	}
	
// ---------- NOVO: FUNÇÃO PARA RESETAR FILTROS DE LANÇAMENTOS AO SAIR DA TELA ----------
	function resetFiltrosLancamentos() {
		// 1. Resetar os valores para o padrão ("")
		const filtroConta = document.getElementById('filtro-conta-lancamento');
		const filtroTipo = document.getElementById('filtro-tipo-lancamento');
		const filtroStatus = document.getElementById('filtro-status-lancamento');
		const filtroParceiro = document.getElementById('filtro-parceiro-lancamento');
		const filtroDescricao = document.getElementById('filtro-descricao-lancamento'); // Campo de texto

		if (filtroConta) filtroConta.value = "";
		if (filtroTipo) filtroTipo.value = "";
		if (filtroStatus) filtroStatus.value = "";
		if (filtroParceiro) filtroParceiro.value = "";
		if (filtroDescricao) filtroDescricao.value = ""; // LIMPA O INPUT DE TEXTO!
		
		// 2. Limpar o estilo visual (a classe .filled)
		const filtros = [
			filtroConta,
			filtroTipo,
			filtroStatus,
			filtroParceiro,
			filtroDescricao
		];

		filtros.forEach(el => {
			if (el) el.classList.remove('filled');
		});

		// 3. Reaplicar a filtragem (que agora será sem filtros)
		filtrarLancamentos();
		
		console.log('✅ Filtros de lançamentos resetados.');
	}
	
	
    function atualizarResumoMes(lancamentos) {
        const primeiroDia = new Date(anoAtual, mesAtual, 1);
        const ultimoDia = new Date(anoAtual, mesAtual + 1, 0);
        
        // Filtrar lançamentos do mês atual
        const lancamentosMes = lancamentos.filter(l => {
            const dataLancamento = new Date(l.data);
            return dataLancamento >= primeiroDia && dataLancamento <= ultimoDia;
        });
    
        // Calcular receitas (pagas, não transferências)
        const receitas = lancamentosMes
            .filter(l => 
                l.tipo === 'receita' && 
                l.pago === true && 
                !l.referenciaTransferenciaId
            )
            .reduce((sum, l) => sum + l.valor, 0);
        
        // Calcular despesas (pagas, não transferências)
        const despesas = lancamentosMes
            .filter(l => 
                l.tipo === 'despesa' && 
                l.pago === true && 
                !l.referenciaTransferenciaId
            )
            .reduce((sum, l) => sum + l.valor, 0);
        
        const saldo = receitas - despesas;
        
        // Atualizar elementos
        document.getElementById('receitas-mes-lancamentos').textContent = formatMoney(receitas);
        document.getElementById('despesas-mes-lancamentos').textContent = formatMoney(despesas);
        document.getElementById('saldo-mes-lancamentos').textContent = formatMoney(saldo);
        document.getElementById('saldo-mes-lancamentos').style.color = saldo >= 0 ? 'var(--success)' : 'var(--danger)';
    }
	
	
    // ---------- FUNÇÕES PARA CAMPOS PREENCHIDOS EM NEGRITO ----------
    function verificarCamposPreenchidos() {
        document.querySelectorAll('#modal-lancamento input, #modal-lancamento select, #modal-lancamento textarea').forEach(campo => {
            if (campo.value && campo.value.trim() !== '') {
                campo.classList.add('filled');
            } else {
                campo.classList.remove('filled');
            }
        });
    }

    function adicionarListenersCampos() {
        document.querySelectorAll('#modal-lancamento input, #modal-lancamento select, #modal-lancamento textarea').forEach(campo => {
            campo.addEventListener('input', verificarCamposPreenchidos);
            campo.addEventListener('change', verificarCamposPreenchidos);
        });
    }
	
	// --- FUNÇÃO INTELIGENTE DE ÍCONES ---
    function getIconeCategoria(nome) {
        if (!nome) return '?';
        
        // Converte para minúsculo para facilitar a busca (ex: "Uber" vira "uber")
        const n = nome.toLowerCase();

        // 🍔 Alimentação
        if (n.includes('aliment') || n.includes('restaurante') || n.includes('lanche') || 
            n.includes('ifood') || n.includes('mercado') || n.includes('padaria')) return '🍔';
            
        // 🚗 Transporte
        if (n.includes('transporte') || n.includes('uber') || n.includes('99') || 
            n.includes('gasolina') || n.includes('posto') || n.includes('carro') || n.includes('ipva')) return '🚗';
            
        // 🏠 Moradia/Contas
        if (n.includes('casa') || n.includes('aluguel') || n.includes('condom') || 
            n.includes('luz') || n.includes('agua') || n.includes('internet') || n.includes('claro') || n.includes('vivo')) return '🏠';
            
        // 💰 Receitas/Financeiro
        if (n.includes('salario') || n.includes('salário') || n.includes('renda') || 
            n.includes('invest') || n.includes('dividend') || n.includes('pix')) return '💰';
            
        // 💊 Saúde
        if (n.includes('saude') || n.includes('saúde') || n.includes('farmacia') || 
            n.includes('medico') || n.includes('exame') || n.includes('gym') || n.includes('academia')) return '💊';
            
        // 🎓 Educação
        if (n.includes('educa') || n.includes('escola') || n.includes('curso') || 
            n.includes('livro') || n.includes('faculdade')) return '🎓';
            
        // 🍿 Lazer
        if (n.includes('lazer') || n.includes('cinema') || n.includes('netflix') || 
            n.includes('spotify') || n.includes('viagem') || n.includes('ferias')) return '🍿';
            
        // 🛍️ Compras
        if (n.includes('compra') || n.includes('shopping') || n.includes('roupa') || 
            n.includes('presente') || n.includes('eletronic')) return '🛍️';
			
		// 🔁 Transferência
        if (n.includes('Transferência') || n.includes('shopping') || n.includes('Transferências') || 
            n.includes('Transferência') || n.includes('Transferência')) return '🔁';	

        // Se não achar nada, retorna a primeira letra maiúscula
        return nome.charAt(0).toUpperCase();
    }

	function renderizarTabelaLancamentos(lancamentos) {
      const container = document.getElementById('lista-lancamentos-container');
      if (!container) return;
      
      container.innerHTML = '';
      
      if (lancamentos.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; padding: 40px; color: var(--muted); opacity: 0.6;">
                <i class="fas fa-receipt" style="font-size: 40px; margin-bottom: 15px;"></i>
                <p>Nenhum lançamento neste período.</p>
            </div>
        `;
        return;
      }
      
      // 1. Ordenar por data
      lancamentos.sort((a, b) => new Date(b.data) - new Date(a.data));
      
      // 2. Agrupar por Dia
      const grupos = {};
      
      lancamentos.forEach(l => {
         const partesData = l.data.split('-'); 
         const dateObj = new Date(partesData[0], partesData[1] - 1, partesData[2]);
         const dataKey = l.data; 
         
         if (!grupos[dataKey]) {
             grupos[dataKey] = {
                 itens: [],
                 textoData: dateObj.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' })
             };
         }
         grupos[dataKey].itens.push(l);
      });
      
      const listaWrapper = document.createElement('div');
      listaWrapper.className = 'lancamento-list';
      
      const datasOrdenadas = Object.keys(grupos).sort((a, b) => new Date(b) - new Date(a));
      
      datasOrdenadas.forEach(dataKey => {
          const grupo = grupos[dataKey];
          
          const totalDia = grupo.itens.reduce((acc, item) => {
              const val = item.tipo === 'despesa' ? -item.valor : item.valor;
              return acc + val;
          }, 0);
          
          const grupoDiv = document.createElement('div');
          grupoDiv.className = 'date-group';
          
          grupoDiv.innerHTML = `
            <div class="date-header">
                <span>${grupo.textoData}</span>
                <span style="font-size: 11px; opacity: 0.7; font-weight: 600;">
                    ${totalDia > 0 ? '+' : ''}${formatMoney(totalDia)}
                </span>
            </div>
          `;
          
          grupo.itens.forEach(lancamento => {
              const categoria = dataCategorias.find(c => c.id === lancamento.categoriaId);
              const parceiro = dataParceiros.find(p => p.id === lancamento.parceiroId);
              
              // --- CORREÇÃO AQUI: Detecta se é transferência pelo NOME também ---
              const nomeLower = lancamento.descricao.toLowerCase();
              const isTransfer = lancamento.tipo === 'transferencia' || nomeLower.includes('transferência') || nomeLower.includes('transferencia');

              let iconDisplay, bgColor;

              if (isTransfer) {
                  // Ícone de troca e cor Azul
                  iconDisplay = '<i class="fas fa-exchange-alt"></i>';
                  bgColor = '#3B82F6'; // Azul
              } else {
                  const nomeCat = categoria ? categoria.nome : '';
                  iconDisplay = (typeof getIconeCategoria === 'function') 
                                ? getIconeCategoria(nomeCat) 
                                : (nomeCat.charAt(0) || '?');
                                
                  bgColor = categoria ? categoria.cor : '#94A3B8';
              }
              
              // Cores do valor
              let valueColor = 'var(--primary)';
              let valueSignal = '';
              
              if (lancamento.tipo === 'receita') { 
                  valueColor = 'var(--success)'; 
                  valueSignal = '+'; 
              } else if (lancamento.tipo === 'despesa') { 
                  valueColor = 'var(--danger)'; 
                  valueSignal = '-'; 
              } 
              
              // Se for transferência, forçamos a cor azul no valor também (opcional, ou mantém vermelho/verde)
              if (isTransfer) {
                   valueColor = '#3B82F6'; 
                   // Mantém o sinal para saber se saiu ou entrou da conta atual
                   valueSignal = (lancamento.tipo === 'despesa') ? '-' : '+';
              }

              const itemCard = document.createElement('div');
              itemCard.className = 'lancamento-card';
              
              itemCard.innerHTML = `
                ${!lancamento.pago ? '<div class="pending-stripe"></div>' : ''}
                
                <div class="cat-icon" style="background: ${bgColor}">
                    ${iconDisplay}
                </div>
                
                <div class="lancamento-info">
                    <div class="lancamento-desc" title="${lancamento.descricao}">${lancamento.descricao}</div>
                    <div class="lancamento-meta">
                        ${categoria ? `<span>${categoria.nome}</span>` : ''}
                        ${parceiro ? `<span>• ${parceiro.nome.split(' ')[0]}</span>` : ''}
                        ${lancamento.parcelaAtual ? `<span>• ${lancamento.parcelaAtual}/${lancamento.numeroParcelas}x</span>` : ''}
                    </div>
                </div>
                
                <div class="lancamento-values">
                    <div class="lancamento-amount" style="color: ${valueColor}">
                        ${valueSignal} ${formatMoney(lancamento.valor).replace('R$', '').trim()}
                    </div>
                    ${!lancamento.pago ? '<span style="font-size:10px; color:var(--warning); font-weight:600;">Pendente</span>' : ''}
                </div>
                
                <div class="lancamento-actions">
                    <button class="btn small" onclick="alternarStatusLancamento('${lancamento.id}')" 
                        style="background:transparent; color:${lancamento.pago ? 'var(--muted)' : 'var(--success)'}; border:1px solid transparent;" 
                        title="${lancamento.pago ? 'Desfazer pagamento' : 'Pagar'}">
                        <i class="fas ${lancamento.pago ? 'fa-undo' : 'fa-check-circle'}" style="font-size:16px;"></i>
                    </button>
                    
                    <button class="btn small" onclick="editarLancamento('${lancamento.id}')" 
                        style="background:transparent; color:var(--muted); border:1px solid transparent;">
                        <i class="fas fa-pen"></i>
                    </button>
                    
                    <button class="btn small" onclick="excluirLancamento('${lancamento.id}')" 
                        style="background:transparent; color:var(--danger); border:1px solid transparent;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
              `;
              
              grupoDiv.appendChild(itemCard);
          });
          
          listaWrapper.appendChild(grupoDiv);
      });
      
      container.appendChild(listaWrapper);
    }
					    
	async function alternarStatusLancamento(lancamentoId) {
        const lancamento = dataLancamentos.find(l => l.id === lancamentoId);
        if (!lancamento) return;

        const novoStatus = !lancamento.pago; 
        const multiplicador = (lancamento.tipo === 'despesa') ? -1 : 1;
        // Se novoStatus é true (está pagando), direção = 1. Se false (estornando), direção = -1.
        const direcao = novoStatus ? 1 : -1; 

        try {
            await db.collection('lancamentos').doc(lancamentoId).update({
                pago: novoStatus,
                dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
            });

            if (lancamento.tipo !== 'transferencia') {
                // Cálculo: Valor * (1 ou -1 do tipo) * (1 ou -1 da ação)
                await ajustarSaldoConta(lancamento.contaId, lancamento.valor * multiplicador * direcao);
            }

            lancamento.pago = novoStatus; 
            renderAll(); 
            if (document.getElementById('lancamentos').style.display === 'block') filtrarLancamentos();
            showSuccess(`Lançamento ${novoStatus ? 'realizado' : 'estornado'}!`);
        } catch (error) {
            showError("Erro ao atualizar status.");
        }
    }
	
    // ---------- FORMULÁRIO DE LANÇAMENTOS (REFATORADO) ----------
    function abrirFormLancamento(lancamentoId = null) {
      if (!currentUser) {
        showError('Faça login para continuar');
        return;
      }
      
      lancamentoEditando = lancamentoId ? dataLancamentos.find(l => l.id === lancamentoId) : null;
      const body = document.getElementById('modal-lancamento-body');
      
      // LÓGICA DE BLOQUEIO: Se o lançamento já estiver pago/realizado, criamos uma "trava"
      const isRealizado = lancamentoEditando && lancamentoEditando.pago === true;
      const travaCampos = isRealizado ? 'disabled' : ''; // Se realizado, insere 'disabled' (desabilitado)

      // Filtrar dados ativos para os dropdowns
      const categoriasAtivas = dataCategorias.filter(c => c.ativo && c.userId === currentUser.uid);
      const parceirosAtivos = dataParceiros.filter(p => p.ativo && p.userId === currentUser.uid);
      const contasAtivas = dataSaldos.filter(c => c.ativo && c.userId === currentUser.uid);
      const formasPagamentoAtivas = dataFormasPagamento.filter(f => f.ativo && f.userId === currentUser.uid);
      
      body.innerHTML = `
        ${isRealizado ? `
            <div style="background: var(--hover-bg); border: 1px solid var(--border); padding: 12px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; color: var(--muted); font-size: 13px;">
                <div style="background: var(--warning); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <i class="fas fa-lock" style="font-size: 10px;"></i>
                </div>
                <span>Este lançamento está <strong>consolidado</strong>. Para editar valores ou contas, altere o status para "Não Realizado".</span>
            </div>
        ` : ''}

        <div class="form-row">
          <div>
            <label>Tipo *</label>
            <select id="l_tipo" onchange="atualizarCamposPorTipo()" ${travaCampos}>
              <option value="">Selecione o tipo...</option>
              <option value="receita" ${lancamentoEditando && lancamentoEditando.tipo === 'receita' ? 'selected' : ''}>Receita</option>
              <option value="despesa" ${lancamentoEditando && lancamentoEditando.tipo === 'despesa' ? 'selected' : ''}>Despesa</option>
              <option value="transferencia" ${lancamentoEditando && lancamentoEditando.tipo === 'transferencia' ? 'selected' : ''}>Transferência</option>
            </select>
          </div>
          <div id="container-descricao"> <label>Descrição *</label>
            <input id="l_descricao" value="${lancamentoEditando ? lancamentoEditando.descricao : ''}" 
                   placeholder="Descrição do lançamento" ${travaCampos}>
            <div class="error-message" id="error-descricao"></div>
          </div>
        </div>
        
        <div class="form-row">
          <div>
            <label>Valor (R$) *</label>
            <input id="l_valor" type="number" step="0.01" 
                   value="${lancamentoEditando ? lancamentoEditando.valor : ''}" 
                   placeholder="0,00" oninput="atualizarCorValor()" ${travaCampos}>
            <div class="error-message" id="error-valor"></div>
          </div>
          <div>
            <label>Data de Vencimento *</label>
            <input id="l_data" type="date" 
                   value="${lancamentoEditando ? lancamentoEditando.data : getTodayString()}" ${travaCampos}>
          </div>
        </div>
        
        <div class="form-row">
          <div id="container-categoria"> <label>Categoria <span id="categoria-obrigatoria">*</span></label>
            <select id="l_categoria" ${travaCampos}>
              <option value="">Selecione o tipo primeiro...</option>
            </select>
            <div class="error-message" id="error-categoria"></div>
          </div>
          <div id="container-status"> <label>Status</label>
            <select id="l_pago">
              <option value="">Selecione o status...</option>
              <option value="true" ${lancamentoEditando && lancamentoEditando.pago ? 'selected' : ''}>Realizado</option>
              <option value="false" ${lancamentoEditando && !lancamentoEditando.pago ? 'selected' : ''}>Não Realizado</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div id="conta-origem-container">
            <label id="label-conta-origem">Conta Financeira *</label> 
            <select id="l_conta" ${travaCampos}>
              <option value="">Selecione...</option>
              ${contasAtivas.map(conta => `
                <option value="${conta.id}" ${lancamentoEditando && lancamentoEditando.contaId === conta.id ? 'selected' : ''}>
                  ${conta.nome} (${formatMoney(conta.valor)})
                </option>
              `).join('')}
            </select>
            <div class="error-message" id="error-conta"></div>
          </div>
          <div id="conta-destino-container" class="conditional-field">
            <label id="label-conta-destino">Conta de Destino *</label>
            <select id="l_conta_destino" ${travaCampos}>
              <option value="">Selecione...</option>
              ${contasAtivas.map(conta => `
                <option value="${conta.id}" ${lancamentoEditando && lancamentoEditando.contaDestinoId === conta.id ? 'selected' : ''}>
                  ${conta.nome} (${formatMoney(conta.valor)})
                </option>
              `).join('')}
            </select>
            <div class="error-message" id="error-conta-destino"></div>
          </div>
        </div>
        
        <div class="form-row">
          <div id="container-forma-pagamento"> <label>Forma de Pagamento</label>
            <select id="l_forma_pagamento" onchange="atualizarCampoParcelas()" ${travaCampos}>
              <option value="">Selecione...</option>
              ${formasPagamentoAtivas.map(forma => `
                <option value="${forma.id}" ${lancamentoEditando && lancamentoEditando.formaPagamentoId === forma.id ? 'selected' : ''}>
                  ${forma.descricao}
                </option>
              `).join('')}
            </select>
          </div>
          <div id="parcelas-container" class="conditional-field">
            <label>Número de Parcelas</label>
            <select id="l_parcelas" ${travaCampos}>
              <option value="1">1x</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div id="container-parceiro"> <label>Parceiro</label>
            <select id="l_parceiro" ${travaCampos}>
              <option value="">Selecione...</option>
              ${parceirosAtivos.map(parceiro => `
                <option value="${parceiro.id}" ${lancamentoEditando && lancamentoEditando.parceiroId === parceiro.id ? 'selected' : ''}>
                  ${parceiro.nome}
                </option>
              `).join('')}
            </select>
          </div>
        </div>
        
        <div style="margin-top:12px">
          <label id="label-observacoes">Observações</label> <textarea id="l_observacoes" rows="3" placeholder="Observações adicionais...">${lancamentoEditando ? (lancamentoEditando.observacoes || '') : ''}</textarea>
        </div>
        
        <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px">
          <button class="btn" onclick="fecharModalLancamento()">Cancelar</button>
          <button class="btn primary" onclick="salvarLancamento()">
            ${lancamentoEditando ? 'Atualizar' : 'Salvar'} Lançamento
          </button>
        </div>
      `;
      
      atualizarCamposPorTipo();
      atualizarCorValor();
      atualizarCampoParcelas();
      
      setTimeout(() => {
        verificarCamposPreenchidos();
        adicionarListenersCampos();
      }, 100);
      
      document.getElementById('modal-lancamento-title').textContent = 
        lancamentoEditando ? 'Editar Lançamento' : 'Novo Lançamento';
      document.getElementById('modal-lancamento').style.display = 'flex';
	  filtrarCategoriasPorTipo();
    }

    // ---------- FUNÇÃO ATUALIZADA (UX DE TRANSFERÊNCIA) ----------
    function atualizarCamposPorTipo() {
      const tipo = document.getElementById('l_tipo').value;
      const contaDestinoContainer = document.getElementById('conta-destino-container');
      
      // Elementos a serem controlados
      const containerDescricao = document.getElementById('container-descricao');
      const containerCategoria = document.getElementById('container-categoria');
      const containerFormaPagamento = document.getElementById('container-forma-pagamento');
      const containerParceiro = document.getElementById('container-parceiro');
      const categoriaObrigatoriaSpan = document.getElementById('categoria-obrigatoria');
      const categoriaSelect = document.getElementById('l_categoria');
      const observacoesTextarea = document.getElementById('l_observacoes');
      const descricaoInput = document.getElementById('l_descricao');
      const statusSelect = document.getElementById('l_pago');

      const labelContaOrigem = document.getElementById('label-conta-origem');
      const labelContaDestino = document.getElementById('label-conta-destino');
      
      // Contêineres a serem ocultados na Transferência
      const camposOcultos = [containerCategoria, containerFormaPagamento, containerParceiro];
      
      if (tipo === 'transferencia') {
        // VISIBILIDADE: Transferência
        contaDestinoContainer.classList.add('visible');
        
        // OCULTAR CAMPOS IRRELEVANTES (INCLUINDO DESCRIÇÃO)
        if (containerDescricao) containerDescricao.style.display = 'none'; // NOVO: OCULTA DESCRIÇÃO
        camposOcultos.forEach(el => el ? el.style.display = 'none' : null);
        
        // ÍCONES INTUITIVOS (NOVO)
        if (labelContaOrigem) {
            labelContaOrigem.innerHTML = 'Conta de Origem <i class="fas fa-arrow-up" style="color: var(--danger); margin-left: 5px;"></i> *'; 
        }
        if (labelContaDestino) {
            labelContaDestino.innerHTML = 'Conta de Destino <i class="fas fa-arrow-down" style="color: var(--info); margin-left: 5px;"></i> *';
        }
        
        // AUTO-PREENCHER STATUS (Visualmente "Não Realizado")
        if (statusSelect) {
            statusSelect.value = 'false'; // Valor visual padrão
            statusSelect.disabled = true; // Impedir alteração pelo usuário
        }
        
        // Descrição e Categoria
        if (categoriaObrigatoriaSpan) {
            categoriaObrigatoriaSpan.textContent = '';
            categoriaObrigatoriaSpan.title = 'Opcional para transferências';
        }
        if (categoriaSelect) {
            categoriaSelect.removeAttribute('required');
        }
        if (descricaoInput) {
            descricaoInput.placeholder = 'Descrição (Opcional)';
        }

        // Limpar observação se for a padrão de transferência para evitar redundância (será preenchido na gravação)
        if (!lancamentoEditando && observacoesTextarea) {
            observacoesTextarea.value = '';
        }
        
      } else {
        // VISIBILIDADE: Receita/Despesa
        contaDestinoContainer.classList.remove('visible');
        
        // MOSTRAR CAMPOS RELEVANTES
        if (containerDescricao) containerDescricao.style.display = 'block'; // MOSTRAR
        camposOcultos.forEach(el => el ? el.style.display = 'block' : null);

        // Restaurar Labels
        if (labelContaOrigem) labelContaOrigem.innerHTML = 'Conta Financeira *';
        if (labelContaDestino) labelContaDestino.innerHTML = 'Conta de Destino *';
        
        // Restaurar Status
        if (statusSelect) statusSelect.disabled = false;
        
        // Categoria obrigatória
        if (categoriaObrigatoriaSpan) categoriaObrigatoriaSpan.textContent = '*';
        if (categoriaSelect) categoriaSelect.setAttribute('required', 'required');

        // Limpar placeholder de Descrição
        if (descricaoInput) descricaoInput.placeholder = 'Descrição do lançamento';
      }
      
      atualizarCorValor();
      atualizarCampoParcelas();
      verificarCamposPreenchidos();
	  filtrarCategoriasPorTipo();
    }

    function atualizarCorValor() {
      const tipo = document.getElementById('l_tipo').value;
      const valorInput = document.getElementById('l_valor');
      
      if (tipo === 'despesa') {
        valorInput.style.color = 'var(--danger)';
      } else if (tipo === 'receita') {
        valorInput.style.color = 'var(--success)';
      } else {
         valorInput.style.color = 'var(--info)'; // Para Transferência
      }
    }

    function atualizarCampoParcelas() {
      const formaPagamentoId = document.getElementById('l_forma_pagamento').value;
      const parcelasContainer = document.getElementById('parcelas-container');
      const parcelasSelect = document.getElementById('l_parcelas');
      
      if (!formaPagamentoId) {
        parcelasContainer.classList.remove('visible');
        return;
      }
      
      const formaPagamento = dataFormasPagamento.find(f => f.id === formaPagamentoId);
      
      if (formaPagamento && formaPagamento.permiteParcelamento) {
        parcelasContainer.classList.add('visible');
        
        // Atualizar opções de parcelas baseado no máximo permitido
        const maxParcelas = formaPagamento.maxParcelas || 12;
        parcelasSelect.innerHTML = '';
        
        for (let i = 1; i <= maxParcelas; i++) {
          parcelasSelect.innerHTML += `<option value="${i}">${i}x</option>`;
        }
        
        if (lancamentoEditando && lancamentoEditando.numeroParcelas) {
          parcelasSelect.value = lancamentoEditando.numeroParcelas;
        }
      } else {
        parcelasContainer.classList.remove('visible');
        parcelasSelect.value = '1';
      }
    }

    // ---------- VALIDAÇÕES DE FORMULÁRIO APRIMORADAS (COM EXCEÇÃO DE DESCRIÇÃO) ----------
    function validarFormularioLancamento() {
        let isValid = true;
        const tipo = document.getElementById('l_tipo').value;

        // Limpar erros anteriores
        document.querySelectorAll('.error-message').forEach(el => {
            el.classList.remove('visible');
        });
        
        // Validar campos obrigatórios
        const campos = [
            { id: 'l_tipo', mensagem: 'Tipo é obrigatório' },
            { id: 'l_descricao', mensagem: 'Descrição é obrigatória', ignoraTransferencia: true }, // NOVO: Ignora para Transferência
            { id: 'l_valor', mensagem: 'Valor deve ser maior que zero' },
            { id: 'l_data', mensagem: 'Data é obrigatória' },
            { id: 'l_pago', mensagem: 'Status é obrigatório' },
            { id: 'l_conta', mensagem: 'Conta financeira é obrigatória' }
        ];
        
        campos.forEach(campo => {
            // Se for Transferência, ignora a validação de Descrição.
            if (campo.ignoraTransferencia && tipo === 'transferencia') return; 

            const element = document.getElementById(campo.id);
            const errorElement = document.getElementById(`error-${campo.id.replace('l_', '')}`);
            
            if (!element || !element.value) {
                if (errorElement) {
                    errorElement.textContent = campo.mensagem;
                    errorElement.classList.add('visible');
                }
                isValid = false;
            }
        });
        
        // Validação específica para valor
        const valor = parseFloat(document.getElementById('l_valor').value);
        if (!valor || valor <= 0) {
            const errorElement = document.getElementById('error-valor');
            if (errorElement) {
                errorElement.textContent = 'Valor deve ser maior que zero';
                errorElement.classList.add('visible');
            }
            isValid = false;
        }
        
        // Validação condicional da categoria
        const categoriaId = document.getElementById('l_categoria').value;
        if (tipo !== 'transferencia' && !categoriaId) {
            const errorElement = document.getElementById('error-categoria');
            if (errorElement) {
                errorElement.textContent = 'Categoria é obrigatória para receitas e despesas';
                errorElement.classList.add('visible');
            }
            isValid = false;
        }
        
        // Validação para transferência
        if (tipo === 'transferencia') {
            const contaDestinoId = document.getElementById('l_conta_destino').value;
            const contaOrigemId = document.getElementById('l_conta').value;
            
            if (!contaDestinoId) {
                const errorElement = document.getElementById('error-conta-destino');
                if (errorElement) {
                    errorElement.textContent = 'Conta de destino é obrigatória para transferências';
                    errorElement.classList.add('visible');
                }
                isValid = false;
            }
            
            if (contaOrigemId === contaDestinoId) {
                const errorElement = document.getElementById('error-conta-destino');
                if (errorElement) {
                    errorElement.textContent = 'Conta de origem e destino não podem ser iguais';
                    errorElement.classList.add('visible');
                }
                isValid = false;
            }
        }
        
        return isValid;
    }

    function coletarDadosFormularioLancamento() {
        const tipo = document.getElementById('l_tipo').value;
        
        // NOVO: Coleta o status. Se for transferência, o valor lógico 'pago' será forçado a true 
        // na função criarLancamentoTransferencia, mas o valor que sai do formulário é 'false' (Não Realizado).
        let statusPago = document.getElementById('l_pago').value === 'true';

        return {
            descricao: document.getElementById('l_descricao').value.trim(),
            tipo: tipo,
            valor: parseFloat(document.getElementById('l_valor').value),
            data: document.getElementById('l_data').value,
            pago: statusPago, 
            categoriaId: tipo !== 'transferencia' ? document.getElementById('l_categoria').value : null,
            contaId: document.getElementById('l_conta').value,
            formaPagamentoId: document.getElementById('l_forma_pagamento').value || null,
            numeroParcelas: parseInt(document.getElementById('l_parcelas')?.value || '1'),
            parceiroId: document.getElementById('l_parceiro').value || null,
            observacoes: document.getElementById('l_observacoes').value.trim(),
            contaDestinoId: tipo === 'transferencia' ? document.getElementById('l_conta_destino').value : null
        };
    }

    async function atualizarLancamentoExistente(dados) {
        await db.collection('lancamentos').doc(lancamentoEditando.id).update({
            ...dados,
            dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Atualizar localmente
        const index = dataLancamentos.findIndex(l => l.id === lancamentoEditando.id);
        if (index !== -1) {
            dataLancamentos[index] = { ...dataLancamentos[index], ...dados };
        }
    }

	async function criarNovoLancamento(dados) {
		
		const lancamentoBaseComMeta = {
			...dados,
			userId: currentUser.uid, 
			dataCriacao: firebase.firestore.FieldValue.serverTimestamp(),
			dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
		};
		
		if (lancamentoBaseComMeta.tipo === 'transferencia') {
			// FLUXO PRINCIPAL DE TRANSFERÊNCIA: Cria dois registros em lote e move o saldo.
			await criarLancamentoTransferencia(lancamentoBaseComMeta);
			
		} else if (lancamentoBaseComMeta.numeroParcelas > 1) {
			// Lógica de parcelamento (para Receita/Despesa parcelada)
			await criarLancamentosParcelados(lancamentoBaseComMeta); 
			
		} else {
			// Lançamento Único (Receita/Despesa simples)
			const docRef = await db.collection('lancamentos').add(lancamentoBaseComMeta);
			lancamentoBaseComMeta.id = docRef.id;
			dataLancamentos.unshift(lancamentoBaseComMeta); 
			
			if (document.getElementById('lancamentos').style.display === 'block') {
				carregarLancamentosMes();
			}
		}
	}
	
//-------------⚠️ atenção Correção ⚠️ -------------------------------------------------------------//
	
// ---------- FUNÇÃO REFATORADA: CRIA DUPLO REGISTRO DE TRANSFERÊNCIA COM AJUSTE DE SALDO ----------
	async function criarLancamentoTransferencia(lancamentoBase) {
		const batch = db.batch();
		const novosLancamentos = [];
		
		// NOVO: Forçar o status pago como verdadeiro no momento de salvar (operação atômica)
		lancamentoBase.pago = true;
		
		const contaOrigem = getContaById(lancamentoBase.contaId)?.nome || 'Conta Origem';
		const contaDestino = getContaById(lancamentoBase.contaDestinoId)?.nome || 'Conta Destino';
		
		// Gerar um ID único para vincular os dois lançamentos
		const transferenciaGrupoId = db.collection('lancamentos').doc().id; 
		
		// --- 1. Lançamento de SAÍDA (Despesa na Conta de Origem) ---
		const saidaDocRef = db.collection('lancamentos').doc();
		const lancamentoSaida = {
			...lancamentoBase,
			id: saidaDocRef.id,
			tipo: 'despesa', // Tipo de movimentação é Despesa
			contaId: lancamentoBase.contaId, // Conta de Origem
			
			// GARANTINDO A DATA CORRETA
			data: lancamentoBase.data, 
			
			// Campos nulos/limpos
			contaDestinoId: null, 
			categoriaId: null,
			parceiroId: null,
			formaPagamentoId: null,
			
			// DESCRIÇÃO SIMPLIFICADA (Sem valor)
			descricao: `Transferência para ${contaDestino}`,
			
			// OBSERVAÇÃO LIMPA (Sem ID de referência no texto)
			observacoes: `SAÍDA por Transferência.`, 
			referenciaTransferenciaId: transferenciaGrupoId, // Mantém a referência apenas internamente
		};
		batch.set(saidaDocRef, lancamentoSaida);
		novosLancamentos.push(lancamentoSaida);
		
		// --- 2. Lançamento de ENTRADA (Receita na Conta de Destino) ---
		const entradaDocRef = db.collection('lancamentos').doc();
		const lancamentoEntrada = {
			...lancamentoBase,
			id: entradaDocRef.id,
			tipo: 'receita', // Tipo de movimentação é Receita
			contaId: lancamentoBase.contaDestinoId, // Conta de Destino
			
			// GARANTINDO A DATA CORRETA
			data: lancamentoBase.data,
			
			// Campos nulos/limpos
			contaDestinoId: null,
			categoriaId: null,
			parceiroId: null,
			formaPagamentoId: null,

			// DESCRIÇÃO SIMPLIFICADA (Sem valor)
			descricao: `Transferência de ${contaOrigem}`,
			
			// OBSERVAÇÃO LIMPA (Sem ID de referência no texto)
			observacoes: `ENTRADA por Transferência.`,
			referenciaTransferenciaId: transferenciaGrupoId,
		};
		batch.set(entradaDocRef, lancamentoEntrada);
		novosLancamentos.push(lancamentoEntrada);

		// Salvar os dois lançamentos no Firebase em lote (atomicamente)
		await batch.commit();
		showSuccess('Transferência realizada com sucesso!');

		// AJUSTE DE SALDO IMEDIATO
		const valorMovimento = lancamentoBase.valor;
		await ajustarSaldoConta(lancamentoBase.contaId, valorMovimento * -1); // Saída (Débito da Origem)
		await ajustarSaldoConta(lancamentoBase.contaDestinoId, valorMovimento); // Entrada (Crédito no Destino)
		
		// Atualizar localmente
		dataLancamentos.unshift(...novosLancamentos);
		
		// Se o modal estiver aberto na tela de lançamentos, recarrega
		if (document.getElementById('lancamentos').style.display === 'block') {
			carregarLancamentosMes();
		}
	}

	async function salvarLancamento() {
        if (!currentUser) {
            showError('Faça login para continuar');
            return;
        }
        
        if (!validarFormularioLancamento()) {
            showError('Por favor, corrija os campos obrigatórios.');
            return;
        }
        
        const novosDados = coletarDadosFormularioLancamento();
        
        try {
            if (lancamentoEditando) {
                // LOGICA DE AJUSTE AO EDITAR STATUS
                const antigoStatusPago = lancamentoEditando.pago;
                const novoStatusPago = novosDados.pago;
                const valor = lancamentoEditando.valor;
                const multiplicador = (lancamentoEditando.tipo === 'despesa') ? -1 : 1;

                // Caso 1: Estorno (Era pago e agora não é)
                if (antigoStatusPago && !novoStatusPago) {
                    await ajustarSaldoConta(lancamentoEditando.contaId, valor * multiplicador * -1);
                } 
                // Caso 2: Pagamento Tardio (Não era pago e agora é)
                else if (!antigoStatusPago && novoStatusPago) {
                    await ajustarSaldoConta(lancamentoEditando.contaId, valor * multiplicador);
                }
                // Nota: Se mudar valor ou conta enquanto está "Realizado", o bloqueio de UI 
                // que fizemos antes impede que o erro aconteça aqui.

                await atualizarLancamentoExistente(novosDados);
                showSuccess('Lançamento atualizado!');
            } else {
                // NOVO LANÇAMENTO
                await criarNovoLancamento(novosDados);
                
                // Se for novo, pago e NÃO for transferência, ajusta saldo
                if (novosDados.pago && novosDados.tipo !== 'transferencia') {
                    const valorFinal = novosDados.valor * (novosDados.tipo === 'despesa' ? -1 : 1);
                    await ajustarSaldoConta(novosDados.contaId, valorFinal);
                }
            }
            
            fecharModalLancamento();
            invalidateCache(); 
            
            // Atualização Visual unificada
            renderAll();
			if (document.getElementById('lancamentos').style.display === 'block') {
				// Em vez de carregarLancamentosMes (que limpa tudo), 
				// chamamos filtrarLancamentos que respeita os campos preenchidos
				filtrarLancamentos(); 
			}
            
        } catch (error) {
            console.error("❌ Erro ao salvar lançamento:", error);
            showError("Erro ao salvar: " + error.message);
        }
    }	
			
	async function criarLancamentosParcelados(lancamentoBase) {
		  const numeroParcelas = lancamentoBase.numeroParcelas;
		  const valorParcela = lancamentoBase.valor / numeroParcelas;
		  const dataBase = new Date(lancamentoBase.data);
		  
		  const batch = db.batch();
		  const novosLancamentos = [];
		  
		  for (let i = 0; i < numeroParcelas; i++) {
			const dataParcela = new Date(dataBase);
			dataParcela.setMonth(dataParcela.getMonth() + i);
			
			// Usamos o lancamentoBase (que agora tem o userId) e sobrescrevemos apenas o necessário
			const lancamentoParcela = {
			  ...lancamentoBase,
			  valor: valorParcela,
			  data: dataParcela.toISOString().slice(0, 10),
			  parcelaAtual: i + 1,
			  // Novo formato de observação para incluir a parcela
			  observacoes: `${lancamentoBase.observacoes || ''} (Parcela ${i + 1}/${numeroParcelas})`.trim(), 
			  dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
			};
			
			const docRef = db.collection('lancamentos').doc();
			batch.set(docRef, lancamentoParcela);
			
			novosLancamentos.push({ id: docRef.id, ...lancamentoParcela });
			}
		  
		 await batch.commit(); // ✅ O commit do lote agora deve passar na regra de segurança
		  
		 // Adicionar localmente
		 dataLancamentos.unshift(...novosLancamentos);
		  
		 // ✅ CORREÇÃO: Forçar atualização imediata da tela se estiver visível
		 if (document.getElementById('lancamentos').style.display === 'block') {
			  carregarLancamentosMes();
		 }
	}	

    function editarLancamento(lancamentoId) {
      abrirFormLancamento(lancamentoId);
    }


		async function excluirLancamento(lancamentoId) {
		if (!confirm('Tem certeza que deseja excluir este lançamento?')) {
			return;
		}

		const lancamento = dataLancamentos.find(l => l.id === lancamentoId);
		if (!lancamento) return;
		
		try {
			// ************************************************
			// NOVO: LÓGICA DE REVERSÃO ANTES DE EXCLUIR (SIMPLIFICADO)
			// ************************************************
			if (lancamento.pago) {
				// Se o lançamento estava pago, aplicamos a reversão.
				// O valor reverso de uma Despesa (tipo: 'despesa') é positivo.
				// O valor reverso de uma Receita (tipo: 'receita') é negativo.
				
				// 1. Calcular o valor reverso
				const valorReverso = lancamento.valor * (lancamento.tipo === 'despesa' ? 1 : -1); 
				
				// 2. Ajustamos o saldo da conta vinculada a este registro.
				await ajustarSaldoConta(lancamento.contaId, valorReverso);
			}
			// ************************************************
			
			await db.collection('lancamentos').doc(lancamentoId).delete();
			
			// Remover localmente
			dataLancamentos = dataLancamentos.filter(l => l.id !== lancamentoId);
			invalidateCache();
			carregarLancamentosMes();
			renderDashboard();
			renderSaldos();
			atualizarCardsContasPendentes();
			// Atualizar gráficos
			if (document.getElementById('dashboard').style.display === 'block') {
				if (chartObj) updateChart();
				if (chartDespesasObj) updateChartDespesas();
			}
			
			// Recarrega o dashboard para atualizar KPIs e gráficos
			if (document.getElementById('dashboard').style.display === 'block') {
				renderAll();
				destroyChart();
				destroyChartDespesas();
				initChart();
				initChartDespesas();
			}
			
			showSuccess('Lançamento excluído com sucesso!');
			
		} catch (error) {
			console.error("Erro ao excluir lançamento:", error);
			showError("Erro ao excluir o lançamento.");
		}
	}


    function fecharModalLancamento() {
      document.getElementById('modal-lancamento').style.display = 'none';
      lancamentoEditando = null;
    }
	
	// --- FUNÇÃO DE AUDITORIA E RECÁLCULO ---
    async function recalcularSaldosGerais() {
        if (!confirm("Isso irá recalcular o saldo de todas as suas contas com base nos lançamentos realizados. Deseja continuar?")) return;

        try {
            showInfo("Iniciando recálculo... por favor, aguarde.");
            
            // 1. Criar um mapa para zerar os saldos temporariamente na memória
            const novosSaldos = {};
            dataSaldos.forEach(conta => {
                novosSaldos[conta.id] = 0;
            });

            // 2. Somar todos os lançamentos REALIZADOS que não sejam transferências
            // (As transferências já estão refletidas nos lançamentos de receita/despesa gerados por elas)
            dataLancamentos.forEach(l => {
                if (l.pago && novosSaldos.hasOwnProperty(l.contaId)) {
                    const multiplicador = (l.tipo === 'despesa') ? -1 : 1;
                    novosSaldos[l.contaId] += (l.valor * multiplicador);
                }
            });

            // 3. Atualizar o Firebase em lote (Batch)
            const batch = db.batch();
            for (const contaId in novosSaldos) {
                const novoValor = novosSaldos[contaId];
                const docRef = db.collection('contas').doc(contaId);
                
                batch.update(docRef, { 
                    valor: novoValor,
                    dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Atualiza na memória local do navegador
                const contaLocal = dataSaldos.find(c => c.id === contaId);
                if (contaLocal) contaLocal.valor = novoValor;
            }

            await batch.commit();
            
            // 4. Atualizar a interface visual
            renderAll();
            showSuccess("Saldos sincronizados com sucesso!");
            
        } catch (error) {
            console.error("Erro ao recalcular:", error);
            showError("Erro técnico ao sincronizar saldos.");
        }
    }
	

    // ========== CONTAS FINANCEIRAS ==========

    function renderTabelaContas() {
        const container = document.getElementById('lista-contas-container');
        if (!container) return;
        
        // Pega os filtros
        const filtroTipo = document.getElementById('filtro-tipo-conta')?.value || '';
        const filtroStatus = document.getElementById('filtro-status-conta')?.value || '';
        const filtroTexto = (document.getElementById('filtro-text-conta')?.value || '').toLowerCase();
        
        container.innerHTML = '';
        
        const contasFiltradas = dataSaldos.filter(c => {
            const matchTipo = filtroTipo ? c.tipo === filtroTipo : true;
            const matchStatus = filtroStatus ? 
                (filtroStatus === 'ativo' ? c.ativo === true : c.ativo === false) : true;
            const matchTexto = filtroTexto ? c.nome.toLowerCase().includes(filtroTexto) : true;
            return matchTipo && matchStatus && matchTexto;
        });

        if (contasFiltradas.length === 0) {
            container.innerHTML = `
                <div style="grid-column: 1/-1; text-align:center; padding: 40px; color: var(--muted);">
                    <i class="fas fa-wallet" style="font-size: 32px; margin-bottom: 10px; opacity: 0.5;"></i>
                    <p>Nenhuma conta encontrada.</p>
                </div>
            `;
            return;
        }
        
        contasFiltradas.forEach(conta => {
            // 1. Definir Aparência baseada no Tipo
            let icone = 'fa-university'; 
            let cor = '#3B82F6';         
            let tipoTexto = 'Conta Corrente';

            switch(conta.tipo) {
                case 'carteira':
                    icone = 'fa-wallet';
                    cor = '#10B981'; 
                    tipoTexto = 'Dinheiro / Carteira';
                    break;
                case 'poupanca':
                    icone = 'fa-piggy-bank';
                    cor = '#F59E0B'; 
                    tipoTexto = 'Poupança';
                    break;
                case 'investimento':
                    icone = 'fa-chart-line';
                    cor = '#8B5CF6'; 
                    tipoTexto = 'Investimentos';
                    break;
                case 'outro':
                    icone = 'fa-box-open';
                    cor = '#64748B'; 
                    tipoTexto = 'Outros';
                    break;
            }

            // 2. Criar o Cartão HTML com o Nome em Destaque
            const card = document.createElement('div');
            card.className = 'conta-card';
            card.style.borderLeft = `5px solid ${cor}`;
            
            if (!conta.ativo) card.style.opacity = '0.6';

            card.innerHTML = `
                <div class="conta-header" style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0;">
                        <div class="conta-icon-box" style="background: ${cor}; width: 40px; height: 40px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; border-radius: 10px; color: white;">
                            <i class="fas ${icone}"></i>
                        </div>
                        <div style="min-width: 0;">
                            <div style="font-weight: 700; color: var(--primary); font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${conta.nome}">
                                ${conta.nome}
                            </div>
                            <div style="font-size: 0.7rem; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">${tipoTexto}</div>
                        </div>
                    </div>
                    
                    <div class="conta-actions" style="display: flex; gap: 4px; flex-shrink: 0;">
                        <button class="btn small ghost" onclick="editarConta('${conta.id}')" title="Editar" style="border:none; background:transparent; padding: 4px; color: var(--muted);">
                            <i class="fas fa-pen"></i>
                        </button>
                        <button class="btn small ghost" onclick="excluirConta('${conta.id}')" title="Excluir" style="border:none; background:transparent; padding: 4px; color: var(--danger);">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="conta-body" style="margin-top: 15px;">
                    <div class="conta-label" style="font-size: 0.75rem; color: var(--muted); text-transform: uppercase; font-weight: 600;">Saldo Atual</div>
                    <div class="conta-saldo" style="color: ${conta.valor >= 0 ? 'var(--primary)' : 'var(--danger)'}; font-size: 1.5rem; font-weight: 800; margin-top: 2px;">
                        ${formatMoney(conta.valor)}
                    </div>
                    
                    ${!conta.ativo ? '<span class="status-badge status-inactive" style="margin-top: 8px; display: inline-block;">Inativo</span>' : ''}
                    
                    ${conta.descricao ? `
                        <div style="font-size: 12px; color: var(--muted); margin-top: 12px; padding-top: 8px; border-top: 1px solid var(--border); font-style: italic;">
                            ${conta.descricao}
                        </div>
                    ` : ''}
                </div>
            `;
            
            container.appendChild(card);
        });
    }
		
    function getTipoContaLabel(tipo) {
        const tipos = {
            'corrente': 'Conta Corrente',
            'poupanca': 'Poupança',
            'carteira': 'Carteira',
            'investimento': 'Investimento',
            'outro': 'Outro'
        };
        return tipos[tipo] || tipo;
    }

    function abrirFormConta(contaId = null) {
        if (!currentUser) {
            showError('Faça login para continuar');
            return;
        }
        
        const conta = contaId ? dataSaldos.find(c => c.id === contaId) : null;
        const body = document.getElementById('modal-body');
        
        body.innerHTML = `
            <div class="form-row">
                <div>
                    <label>Nome da Conta *</label>
                    <input id="ct_nome" value="${conta ? conta.nome : ''}" 
                           placeholder="Ex: Banco X, Carteira, Poupança...">
                    <div class="error-message" id="error-nome-conta"></div>
                </div>
                <div>
                    <label>Tipo *</label>
                    <select id="ct_tipo">
                        <option value="corrente" ${conta && conta.tipo === 'corrente' ? 'selected' : ''}>Conta Corrente</option>
                        <option value="poupanca" ${conta && conta.tipo === 'poupanca' ? 'selected' : ''}>Poupança</option>
                        <option value="carteira" ${conta && conta.tipo === 'carteira' ? 'selected' : ''}>Carteira</option>
                        <option value="investimento" ${conta && conta.tipo === 'investimento' ? 'selected' : ''}>Investimento</option>
                        <option value="outro" ${conta && conta.tipo === 'outro' ? 'selected' : ''}>Outro</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label>Saldo Inicial (R$)</label>
                    <input id="ct_valor" type="number" step="0.01" value="${conta ? conta.valor : '0'}" placeholder="0,00" ${contaId ? 'disabled title="Para alterar o saldo, use Lançamentos de Ajuste"' : ''}>
                </div>
                <div>
                    <label>Status</label>
                    <select id="ct_ativo">
                        <option value="true" ${conta && conta.ativo !== false ? 'selected' : ''}>Ativo</option>
                        <option value="false" ${conta && !conta.ativo ? 'selected' : ''}>Inativo</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top:12px">
                <label>Descrição</label>
                <textarea id="ct_descricao" rows="3" placeholder="Descrição opcional da conta...">${conta ? (conta.descricao || '') : ''}</textarea>
            </div>
            
            <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
                <button class="btn" onclick="fecharModal()">Cancelar</button>
                <button class="btn primary" onclick="salvarConta('${contaId || ''}')">
                    ${contaId ? 'Atualizar' : 'Salvar'} Conta
                </button>
            </div>
        `;
        
        abrirModal(contaId ? 'Editar Conta' : 'Nova Conta');
    }

    async function salvarConta(contaId = null) {
        if (!currentUser) {
            showError('Faça login para continuar');
            return;
        }
        
        // Validações
        const nome = document.getElementById('ct_nome').value.trim();
        const tipo = document.getElementById('ct_tipo').value;
        const valor = contaId ? dataSaldos.find(c => c.id === contaId)?.valor : parseFloat(document.getElementById('ct_valor').value || 0); // Preserva o valor existente
        const descricao = document.getElementById('ct_descricao').value.trim();
        const ativo = document.getElementById('ct_ativo').value === 'true';
        
        // Validar campos obrigatórios
        if (!nome) {
            document.getElementById('error-nome-conta').textContent = 'Nome é obrigatório';
            document.getElementById('error-nome-conta').classList.add('visible');
            return;
        } else {
            document.getElementById('error-nome-conta').classList.remove('visible');
        }
        
        const contaData = {
            nome: nome,
            tipo: tipo,
            valor: valor, // Usar o valor preservado/inicial
            descricao: descricao,
            ativo: ativo,
            userId: currentUser.uid,
            dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        try {
            if (contaId) {
                // Editar conta existente
                await db.collection('contas').doc(contaId).update(contaData);
                
                // Atualizar localmente
                const index = dataSaldos.findIndex(c => c.id === contaId);
                if (index !== -1) {
                    dataSaldos[index] = { ...dataSaldos[index], ...contaData };
                }
                showSuccess('Conta atualizada com sucesso!');
            } else {
                // Nova conta
                contaData.dataCriacao = firebase.firestore.FieldValue.serverTimestamp();
                const docRef = await db.collection('contas').add(contaData);
                contaData.id = docRef.id;
                dataSaldos.unshift(contaData);
                showSuccess('Conta criada com sucesso!');
            }
            
            fecharModal();
            invalidateCache();
            renderTabelaContas();
            renderDashboard();
            renderSaldos();
            // ATUALIZADO: Atualizar contas pendentes
            atualizarCardsContasPendentes();
            
        } catch (error) {
            console.error("❌ Erro ao salvar conta:", error);
            showError("Erro ao salvar a conta: " + error.message);
        }
    }

    function editarConta(contaId) {
        abrirFormConta(contaId);
    }
	
    async function excluirConta(contaId) {
        const conta = dataSaldos.find(c => c.id === contaId);
        if (!conta) return;
        
        // 1. Verificação de Saldo: Se o saldo não for zero, bloqueia a exclusão
        if (Math.abs(conta.valor) > 0.01) {
            showError(`Não é possível excluir a conta "${conta.nome}" pois ela ainda possui saldo (R$ ${conta.valor.toFixed(2)}). Transfira o saldo para outra conta antes de excluir.`);
            return;
        }

        // 2. Verificação de Lançamentos: Busca se há qualquer registro vinculado
        const possuiLancamentos = dataLancamentos.some(l => l.contaId === contaId);
        
        if (possuiLancamentos) {
            const confirmarInativar = confirm(`Esta conta possui histórico de lançamentos e não pode ser apagada para não corromper seus relatórios.\n\nDeseja apenas INATIVAR esta conta? (Ela deixará de aparecer nas seleções de novos lançamentos).`);
            
            if (confirmarInativar) {
                // Chama a função de salvar passando o ID para apenas atualizar o status
                document.getElementById('ct_ativo').value = 'false'; // Simula a escolha no formulário interno
                await salvarConta(contaId); 
                showInfo('Conta inativada com sucesso.');
            }
            return;
        }
        
        // 3. Exclusão definitiva (Só ocorre se a conta for nova e vazia)
        if (!confirm('Tem certeza que deseja excluir permanentemente esta conta vazia?')) return;
        
        try {
            await db.collection('contas').doc(contaId).delete();
            dataSaldos = dataSaldos.filter(c => c.id !== contaId);
            invalidateCache();
            renderTabelaContas();
            renderDashboard();
            renderSaldos();
            showSuccess('Conta removida com sucesso!');
        } catch (error) {
            showError("Erro ao excluir a conta.");
        }
    }
	
    // ========== SETORES (CENTRO DE CUSTO) ==========
	
   function renderTabelaSetores() {
        const container = document.getElementById('lista-setores-container');
        if (!container) return;
        
        const filtroStatus = document.getElementById('filtro-status-setor')?.value || '';
        const filtroTexto = (document.getElementById('filtro-text-setor')?.value || '').toLowerCase();
        
        container.innerHTML = '';
        
        const setoresFiltrados = dataSetores.filter(s => {
            const matchStatus = filtroStatus ? 
                (filtroStatus === 'ativo' ? s.ativo === true : s.ativo === false) : true;
            const matchTexto = filtroTexto ? s.descricao.toLowerCase().includes(filtroTexto) : true;
            return matchStatus && matchTexto;
        });

        if (setoresFiltrados.length === 0) {
            container.innerHTML = `
                <div style="grid-column: 1/-1; text-align:center; padding: 40px; color: var(--muted);">
                    <i class="fas fa-sitemap" style="font-size: 32px; margin-bottom: 10px; opacity: 0.5;"></i>
                    <p>Nenhum setor encontrado.</p>
                </div>
            `;
            return;
        }
        
        // Ordenar alfabeticamente
        setoresFiltrados.sort((a, b) => a.descricao.localeCompare(b.descricao));

        setoresFiltrados.forEach(setor => {
            // 1. Inteligência de Ícone Simples
            const nome = setor.descricao.toLowerCase();
            let icone = 'fa-layer-group'; // Padrão
            
            if (nome.includes('comercial') || nome.includes('venda')) icone = 'fa-briefcase';
            else if (nome.includes('rh') || nome.includes('humano') || nome.includes('pessoal')) icone = 'fa-users';
            else if (nome.includes('ti') || nome.includes('tecnologia') || nome.includes('dev')) icone = 'fa-laptop-code';
            else if (nome.includes('financeiro') || nome.includes('contabil')) icone = 'fa-calculator';
            else if (nome.includes('marketing') || nome.includes('mkt')) icone = 'fa-bullhorn';
            else if (nome.includes('producao') || nome.includes('fabrica')) icone = 'fa-industry';
            else if (nome.includes('admin')) icone = 'fa-building';

            // 2. Cria o Cartão
            const card = document.createElement('div');
            card.className = 'setor-card';
            
            if (!setor.ativo) card.style.opacity = '0.6';

            card.innerHTML = `
                <div class="setor-actions">
                    <button class="btn small ghost" onclick="editarSetor('${setor.id}')" style="border:none; padding:4px;">
                        <i class="fas fa-pen"></i>
                    </button>
                    <button class="btn small ghost" onclick="excluirSetor('${setor.id}')" style="border:none; color:var(--danger); padding:4px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>

                <div class="setor-icon">
                    <i class="fas ${icone}"></i>
                </div>
                
                <div class="setor-name">${setor.descricao}</div>
                
                <div class="setor-status ${!setor.ativo ? 'status-inactive-text' : ''}">
                    ${setor.ativo ? 'Ativo' : 'Inativo'}
                </div>
            `;
            
            container.appendChild(card);
        });
    } 
	
    function abrirFormSetor(setorId = null) {
        if (!currentUser) {
            showError('Faça login para continuar');
            return;
        }
        
        const setor = setorId ? dataSetores.find(s => s.id === setorId) : null;
        const body = document.getElementById('modal-body');
        
        body.innerHTML = `
            <div class="form-row">
                <div>
                    <label>Descrição do Setor *</label>
                    <input id="s_descricao" value="${setor ? setor.descricao : ''}" 
                           placeholder="Ex: Administrativo, Comercial, Produção...">
                    <div class="error-message" id="error-descricao-setor"></div>
                </div>
                <div>
                    <label>Status</label>
                    <select id="s_ativo">
                        <option value="true" ${setor && setor.ativo !== false ? 'selected' : ''}>Ativo</option>
                        <option value="false" ${setor && !setor.ativo ? 'selected' : ''}>Inativo</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
                <button class="btn" onclick="fecharModal()">Cancelar</button>
                <button class="btn primary" onclick="salvarSetor('${setorId || ''}')">
                    ${setorId ? 'Atualizar' : 'Salvar'} Setor
                </button>
            </div>
        `;
        
        abrirModal(setorId ? 'Editar Setor' : 'Novo Setor');
    }

    async function salvarSetor(setorId = null) {
        if (!currentUser) {
            showError('Faça login para continuar');
            return;
        }
        
        // Validações
        const descricao = document.getElementById('s_descricao').value.trim();
        const ativo = document.getElementById('s_ativo').value === 'true';
        
        // Validar campos obrigatórios
        if (!descricao) {
            document.getElementById('error-descricao-setor').textContent = 'Descrição é obrigatória';
            document.getElementById('error-descricao-setor').classList.add('visible');
            return;
        } else {
            document.getElementById('error-descricao-setor').classList.remove('visible');
        }
        
        // Verificar se já existe setor com mesma descrição
        const setorExistente = dataSetores.find(s => 
            s.descricao.toLowerCase() === descricao.toLowerCase() && 
            s.id !== setorId
        );
        
        if (setorExistente) {
            document.getElementById('error-descricao-setor').textContent = 'Já existe um setor com esta descrição';
            document.getElementById('error-descricao-setor').classList.add('visible');
            return;
        }
        
        const setorData = {
            descricao: descricao,
            ativo: ativo,
            userId: currentUser.uid,
            dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        try {
            if (setorId) {
                // Editar setor existente
                await db.collection('setores').doc(setorId).update(setorData);
                
                // Atualizar localmente
                const index = dataSetores.findIndex(s => s.id === setorId);
                if (index !== -1) {
                    dataSetores[index] = { ...dataSetores[index], ...setorData };
                }
                showSuccess('Setor atualizado com sucesso!');
            } else {
                // Novo setor
                setorData.dataCriacao = firebase.firestore.FieldValue.serverTimestamp();
                const docRef = await db.collection('setores').add(setorData);
                setorData.id = docRef.id;
                dataSetores.unshift(setorData);
                showSuccess('Setor criado com sucesso!');
            }
            
            fecharModal();
            invalidateCache();
            renderTabelaSetores();
            
        } catch (error) {
            console.error("❌ Erro ao salvar setor:", error);
            showError("Erro ao salvar o setor: " + error.message);
        }
    }

    function editarSetor(setorId) {
        abrirFormSetor(setorId);
    }

    async function excluirSetor(setorId) {
        const setor = dataSetores.find(s => s.id === setorId);
        
        if (!setor) return;
        
        // Verificar se existem lançamentos vinculados a este setor
        const lancamentosComSetor = dataLancamentos.filter(l => l.setorId === setorId);
        if (lancamentosComSetor.length > 0) {
            const confirmar = confirm(`Este setor está sendo usado em ${lancamentosComSetor.length} lançamento(s). Deseja realmente excluir?`);
            if (!confirmar) return;
        }
        
        if (!confirm('Tem certeza que deseja excluir este setor?')) {
            return;
        }
        
        try {
            await db.collection('setores').doc(setorId).delete();
            
            // Remover localmente
            dataSetores = dataSetores.filter(s => s.id !== setorId);
            invalidateCache();
            renderTabelaSetores();
            showSuccess('Setor excluído com sucesso!');
            
        } catch (error) {
            console.error("Erro ao excluir setor:", error);
            showError("Erro ao excluir o setor.");
        }
    }

    // ========== CATEGORIAS ==========
	
    function renderTabelaCategorias() {
        const container = document.getElementById('lista-categorias-container');
        if (!container) return;
        
        // Pega os filtros
        const filtroTipo = document.getElementById('filtro-tipo-categoria')?.value || '';
        const filtroStatus = document.getElementById('filtro-status-categoria')?.value || '';
        const filtroTexto = (document.getElementById('filtro-text-categoria')?.value || '').toLowerCase();
        
        container.innerHTML = '';
        
        const categoriasFiltradas = dataCategorias.filter(c => {
            const matchTipo = filtroTipo ? c.tipo === filtroTipo : true;
            const matchStatus = filtroStatus ? 
                (filtroStatus === 'ativo' ? c.ativo === true : c.ativo === false) : true;
            const matchTexto = filtroTexto ? c.nome.toLowerCase().includes(filtroTexto) : true;
            return matchTipo && matchStatus && matchTexto;
        });

        if (categoriasFiltradas.length === 0) {
            container.innerHTML = `
                <div style="grid-column: 1/-1; text-align:center; padding: 40px; color: var(--muted);">
                    <i class="fas fa-tags" style="font-size: 32px; margin-bottom: 10px; opacity: 0.5;"></i>
                    <p>Nenhuma categoria encontrada.</p>
                </div>
            `;
            return;
        }
        
        // Ordenar: Ativos primeiro, depois por nome
        categoriasFiltradas.sort((a, b) => (b.ativo - a.ativo) || a.nome.localeCompare(b.nome));

        categoriasFiltradas.forEach(cat => {
            // 1. Busca o Setor
            const setorNome = cat.setorId ? 
                (dataSetores.find(s => s.id === cat.setorId)?.descricao || 'Geral') : 
                'Geral';
            
            // 2. Define Ícone Inteligente
            const icone = (typeof getIconeCategoria === 'function') 
                          ? getIconeCategoria(cat.nome) 
                          : (cat.nome.charAt(0).toUpperCase());

            // 3. Define Classe da Badge (Receita/Despesa)
            const badgeClass = cat.tipo === 'receita' ? 'badge-receita' : 'badge-despesa';
            const tipoLabel = cat.tipo === 'receita' ? 'Receita' : 'Despesa';
            
            // 4. Cria o Cartão
            const card = document.createElement('div');
            card.className = 'cat-card';
            
            // Se estiver inativa, deixa transparente
            if (!cat.ativo) card.style.opacity = '0.6';

            card.innerHTML = `
                <div class="cat-card-header">
                    <div class="cat-card-icon" style="background: ${cat.cor || '#94A3B8'};">
                        ${icone}
                    </div>
                    
                    <div style="display:flex; gap: 4px;">
                        <button class="btn small ghost" onclick="editarCategoria('${cat.id}')" style="padding:4px 8px; border:none;">
                            <i class="fas fa-pen"></i>
                        </button>
                        <button class="btn small ghost" onclick="excluirCategoria('${cat.id}')" 
                                style="padding:4px 8px; border:none; color:var(--danger);"
                                ${cat.padrao ? 'disabled title="Padrão do sistema"' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="cat-card-body">
                    <div class="cat-card-name">${cat.nome}</div>
                    <div class="cat-card-setor">
                        <i class="fas fa-layer-group" style="font-size:10px;"></i> ${setorNome}
                    </div>
                </div>
                
                <span class="cat-badge ${badgeClass}">
                    ${tipoLabel}
                </span>
            `;
            
            container.appendChild(card);
        });
    }
	
    function abrirFormCategoria(categoriaId = null) {
        if (!currentUser) {
            showError('Faça login para continuar');
            return;
        }
        
        const categoria = categoriaId ? dataCategorias.find(c => c.id === categoriaId) : null;
        const body = document.getElementById('modal-body');
        
        // Filtrar setores ativos para o dropdown
        const setoresAtivos = dataSetores.filter(s => s.ativo);
        
        body.innerHTML = `
            <div class="form-row">
                <div>
                    <label>Nome da Categoria *</label>
                    <input id="c_nome" value="${categoria ? categoria.nome : ''}" 
                           placeholder="Ex: Alimentação, Salário, Transporte...">
                    <div class="error-message" id="error-nome-categoria"></div>
                </div>
                <div>
                    <label>Tipo *</label>
                    <select id="c_tipo">
                        <option value="receita" ${categoria && categoria.tipo === 'receita' ? 'selected' : ''}>Receita</option>
                        <option value="despesa" ${categoria && categoria.tipo === 'despesa' ? 'selected' : ''}>Despesa</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label>Cor de Identificação</label>
                    <div style="display:flex;gap:8px;align-items:center">
                        <input type="color" id="c_cor" value="${categoria ? (categoria.cor || '#2ECC71') : '#2ECC71'}" 
                               style="width:60px;height:40px;padding:2px">
                        <input type="text" id="c_cor_text" value="${categoria ? (categoria.cor || '#2ECC71') : '#2ECC71'}" 
                               placeholder="#2ECC71" style="flex:1" oninput="document.getElementById('c_cor').value = this.value">
                    </div>
                </div>
                <div>
                    <label>Setor (Centro de Custo)</label>
                    <select id="c_setor">
                        <option value="">Nenhum setor</option>
                        ${setoresAtivos.map(setor => `
                            <option value="${setor.id}" ${categoria && categoria.setorId === setor.id ? 'selected' : ''}>
                                ${setor.descricao}
                            </option>
                        `).join('')}
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label>Status</label>
                    <select id="c_ativo">
                        <option value="true" ${categoria && categoria.ativo !== false ? 'selected' : ''}>Ativo</option>
                        <option value="false" ${categoria && !categoria.ativo ? 'selected' : ''}>Inativo</option>
                    </select>
                </div>
                <div>
                    <label>Meta de Gastos Mensal (R$)</label>
                    <input id="c_meta" type="number" step="0.01" value="${categoria ? (categoria.meta || 0) : 0}" placeholder="0,00">
                </div>
            </div>
            
            <div style="margin-top:12px">
                <label>Descrição</label>
                <textarea id="c_descricao" rows="3" placeholder="Descrição opcional da categoria...">${categoria ? (categoria.descricao || '') : ''}</textarea>
            </div>
            
            ${categoria && categoria.padrao ? `
                <div style="margin-top:12px;padding:10px;background:#FFF3CD;border-radius:8px;border:1px solid #FFEAA7">
                    <i class="fas fa-info-circle" style="color:#856404"></i>
                    <span style="color:#856404;font-size:13px"> Esta é uma categoria padrão do sistema.</span>
                </div>
            ` : ''}
            
            <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
                <button class="btn" onclick="fecharModal()">Cancelar</button>
                <button class="btn primary" onclick="salvarCategoria('${categoriaId || ''}')">
                    ${categoriaId ? 'Atualizar' : 'Salvar'} Categoria
                </button>
            </div>
        `;
        
        // Sincronizar campos de cor
        document.getElementById('c_cor').addEventListener('input', function(e) {
            document.getElementById('c_cor_text').value = e.target.value;
        });
        
        document.getElementById('c_cor_text').addEventListener('input', function(e) {
            document.getElementById('c_cor').value = e.target.value;
        });
        
        abrirModal(categoriaId ? 'Editar Categoria' : 'Nova Categoria');
    }

    async function salvarCategoria(categoriaId = null) {
        if (!currentUser) {
            showError('Faça login para continuar');
            return;
        }
        
        // Validações
        const nome = document.getElementById('c_nome').value.trim();
        const tipo = document.getElementById('c_tipo').value;
        const cor = document.getElementById('c_cor').value;
        const setorId = document.getElementById('c_setor').value || null;
        const descricao = document.getElementById('c_descricao').value.trim();
        const ativo = document.getElementById('c_ativo').value === 'true';
        
        // Validar campos obrigatórios
        if (!nome) {
            document.getElementById('error-nome-categoria').textContent = 'Nome é obrigatório';
            document.getElementById('error-nome-categoria').classList.add('visible');
            return;
        } else {
            document.getElementById('error-nome-categoria').classList.remove('visible');
        }
        
        // Verificar se já existe categoria com mesmo nome e tipo
        const categoriaExistente = dataCategorias.find(c => 
            c.nome.toLowerCase() === nome.toLowerCase() && 
            c.tipo === tipo && 
            c.id !== categoriaId
        );
        
        if (categoriaExistente) {
            document.getElementById('error-nome-categoria').textContent = 'Já existe uma categoria com este nome e tipo';
            document.getElementById('error-nome-categoria').classList.add('visible');
            return;
        }
        
        const categoriaData = {
            nome: nome,
            tipo: tipo,
            cor: cor,
            setorId: setorId,
            descricao: descricao,
			meta: parseFloat(document.getElementById('c_meta').value || 0),
            ativo: ativo,
            userId: currentUser.uid,
            dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        try {
            if (categoriaId) {
                // Editar categoria existente - preservar campo 'padrao' se existir
                const categoriaOriginal = dataCategorias.find(c => c.id === categoriaId);
                if (categoriaOriginal && categoriaOriginal.padrao) {
                    categoriaData.padrao = true;
                }
                
                await db.collection('categorias').doc(categoriaId).update(categoriaData);
                
                // Atualizar localmente
                const index = dataCategorias.findIndex(c => c.id === categoriaId);
                if (index !== -1) {
                    dataCategorias[index] = { ...dataCategorias[index], ...categoriaData };
                }
                showSuccess('Categoria atualizada com sucesso!');
            } else {
                // Nova categoria
                categoriaData.dataCriacao = firebase.firestore.FieldValue.serverTimestamp();
                const docRef = await db.collection('categorias').add(categoriaData);
                categoriaData.id = docRef.id;
                dataCategorias.unshift(categoriaData);
                showSuccess('Categoria criada com sucesso!');
            }
            
            fecharModal();
            invalidateCache();
            renderTabelaCategorias();
            
        } catch (error) {
            console.error("❌ Erro ao salvar categoria:", error);
            showError("Erro ao salvar a categoria: " + error.message);
        }
    }

    function editarCategoria(categoriaId) {
        abrirFormCategoria(categoriaId);
    }

    async function excluirCategoria(categoriaId) {
        const categoria = dataCategorias.find(c => c.id === categoriaId);
        
        if (!categoria) return;
        
        // Impedir exclusão de categorias padrão
        if (categoria.padrao) {
            showError('Categorias padrão do sistema não podem ser excluídas.');
            return;
        }
        
        // Verificar se existem lançamentos usando esta categoria
        const lancamentosComCategoria = dataLancamentos.filter(l => l.categoriaId === categoriaId);
        if (lancamentosComCategoria.length > 0) {
            const confirmar = confirm(`Esta categoria está sendo usada em ${lancamentosComCategoria.length} lançamento(s). Deseja realmente excluir?`);
            if (!confirmar) return;
        }
        
        if (!confirm('Tem certeza que deseja excluir esta categoria?')) {
            return;
        }
        
        try {
            await db.collection('categorias').doc(categoriaId).delete();
            
            // Remover localmente
            dataCategorias = dataCategorias.filter(c => c.id !== categoriaId);
            invalidateCache();
            renderTabelaCategorias();
            showSuccess('Categoria excluída com sucesso!');
            
        } catch (error) {
            console.error("Erro ao excluir categoria:", error);
            showError("Erro ao excluir a categoria.");
        }
    }

    // ---------- PARCEIROS ----------
    	
    function renderTabelaParceiros() {
        const container = document.getElementById('lista-parceiros-container');
        if (!container) return;
        
        // Filtros
        const filtroTipo = document.getElementById('filtro-tipo-parceiro')?.value || '';
        const filtroStatus = document.getElementById('filtro-status-parceiro')?.value || '';
        const filtroTexto = (document.getElementById('filtro-text-parceiro')?.value || '').toLowerCase();
        
        container.innerHTML = '';
        
        const parceirosFiltrados = dataParceiros.filter(p => {
            const matchTipo = filtroTipo ? p.tipo === filtroTipo : true;
            const matchStatus = filtroStatus ? 
                (filtroStatus === 'ativo' ? p.ativo === true : p.ativo === false) : true;
            const matchTexto = filtroTexto ? p.nome.toLowerCase().includes(filtroTexto) : true;
            return matchTipo && matchStatus && matchTexto;
        });

        if (parceirosFiltrados.length === 0) {
            container.innerHTML = `
                <div style="grid-column: 1/-1; text-align:center; padding: 40px; color: var(--muted);">
                    <i class="fas fa-address-book" style="font-size: 32px; margin-bottom: 10px; opacity: 0.5;"></i>
                    <p>Nenhum parceiro encontrado.</p>
                </div>
            `;
            return;
        }
        
        // Ordenar alfabeticamente
        parceirosFiltrados.sort((a, b) => a.nome.localeCompare(b.nome));

        parceirosFiltrados.forEach(parceiro => {
            // Define Ícone e Cor baseados no Tipo (Física ou Jurídica)
            const isEmpresa = parceiro.tipo === 'juridica';
            const icone = isEmpresa ? 'fa-building' : 'fa-user';
            const cor = isEmpresa ? '#8B5CF6' : '#3B82F6'; // Roxo para empresa, Azul para pessoa
            const tipoLabel = isEmpresa ? 'Pessoa Jurídica' : 'Pessoa Física';
            
            // Define o Status
            const statusClass = parceiro.ativo ? 'status-ativo' : 'status-inativo';
            const statusIcon = parceiro.ativo ? 'fa-check' : 'fa-times';
            
            const card = document.createElement('div');
            card.className = 'parceiro-card';
            
            // Opacidade se inativo
            if (!parceiro.ativo) card.style.opacity = '0.7';

            card.innerHTML = `
                <div class="parceiro-actions">
                    <button class="btn small ghost" onclick="editarParceiro('${parceiro.id}')" style="border:none; padding:4px 8px;">
                        <i class="fas fa-pen"></i>
                    </button>
                    <button class="btn small ghost" onclick="excluirParceiro('${parceiro.id}')" style="border:none; color:var(--danger); padding:4px 8px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>

                <div class="parceiro-header">
                    <div class="parceiro-avatar" style="background: ${cor};">
                        <i class="fas ${icone}"></i>
                    </div>
                    <div class="parceiro-info">
                        <div class="parceiro-name" title="${parceiro.nome}">${parceiro.nome}</div>
                        <div class="parceiro-type">${tipoLabel}</div>
                    </div>
                </div>
                
                <div class="parceiro-body">
                    ${parceiro.telefone ? `
                        <div class="contact-row">
                            <i class="fas fa-phone contact-icon"></i>
                            <span>${parceiro.telefone}</span>
                        </div>
                    ` : ''}
                    
                    ${parceiro.cpfCnpj ? `
                        <div class="contact-row">
                            <i class="fas fa-id-card contact-icon"></i>
                            <span>${parceiro.cpfCnpj}</span>
                        </div>
                    ` : ''}
                    
                    <div class="contact-row" style="margin-top: 4px;">
                        <span class="status-badge ${statusClass}">
                             <i class="fas ${statusIcon}"></i> ${parceiro.ativo ? 'Ativo' : 'Inativo'}
                        </span>
                    </div>
                </div>
            `;
            
            container.appendChild(card);
        });
    }
	
    function abrirFormParceiro(parceiroId = null) {
        if (!currentUser) {
            showError('Faça login para continuar');
            return;
        }
        
        const parceiro = parceiroId ? dataParceiros.find(p => p.id === parceiroId) : null;
        const body = document.getElementById('modal-body');
        
        body.innerHTML = `
            <div class="form-row">
                <div>
                    <label>Nome/Razão Social *</label>
                    <input id="p_nome" value="${parceiro ? parceiro.nome : ''}" placeholder="Nome completo ou razão social">
                    <div class="error-message" id="error-nome"></div>
                </div>
                <div>
                    <label>Tipo *</label>
                    <select id="p_tipo" onchange="toggleTipoDocumento()">
                        <option value="fisica" ${parceiro && parceiro.tipo === 'fisica' ? 'selected' : ''}>Pessoa Física</option>
                        <option value="juridica" ${parceiro && parceiro.tipo === 'juridica' ? 'selected' : ''}>Pessoa Jurídica</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div id="cpf_container" class="${parceiro && parceiro.tipo === 'fisica' ? '' : 'conditional-field'}">
                    <label>CPF *</label>
                    <input id="p_cpf" value="${parceiro && parceiro.tipo === 'fisica' ? (parceiro.cpfCnpj || '') : ''}" placeholder="000.000.000-00" oninput="formatarCPF(this)">
                    <div class="error-message" id="error-cpf"></div>
                </div>
                <div id="cnpj_container" class="conditional-field ${parceiro && parceiro.tipo === 'juridica' ? 'visible' : ''}">
                    <label>CNPJ *</label>
                    <input id="p_cnpj" value="${parceiro && parceiro.tipo === 'juridica' ? (parceiro.cpfCnpj || '') : ''}" placeholder="00.000.000/0000-00" oninput="formatarCNPJ(this)">
                    <div class="error-message" id="error-cnpj"></div>
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label>CEP</label>
                    <div style="display:flex;gap:8px">
                        <input id="p_cep" value="${parceiro ? (parceiro.cep || '') : ''}" placeholder="00000-000" style="flex:1" oninput="formatarCEP(this)" onblur="buscarCEP(this.value)">
                        <button type="button" class="btn ghost" onclick="buscarCEP(document.getElementById('p_cep').value)" style="white-space:nowrap">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div class="error-message" id="error-cep"></div>
                    <div id="cep-loading" style="display:none;font-size:12px;color:var(--muted);margin-top:4px">
                        <div class="cep-loading"></div> Buscando endereço...
                    </div>
                </div>
                <div>
                    <label>Telefone/WhatsApp</label>
                    <input id="p_telefone" value="${parceiro ? (parceiro.telefone || '') : ''}" placeholder="(11) 99999-9999" oninput="formatarTelefone(this)">
                    <div class="error-message" id="error-telefone"></div>
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label>Rua/Logradouro</label>
                    <input id="p_logradouro" value="${parceiro ? (parceiro.logradouro || '') : ''}" placeholder="Nome da rua, avenida, etc.">
                </div>
                <div>
                    <label>Número</label>
                    <input id="p_numero" value="${parceiro ? (parceiro.numero || '') : ''}" placeholder="Número">
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label>Bairro</label>
                    <input id="p_bairro" value="${parceiro ? (parceiro.bairro || '') : ''}" placeholder="Bairro">
                </div>
                <div>
                    <label>Cidade</label>
                    <input id="p_cidade" value="${parceiro ? (parceiro.cidade || '') : ''}" placeholder="Cidade">
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label>Estado</label>
                    <select id="p_estado">
                        <option value="">Selecione...</option>
                        <option value="AC" ${parceiro && parceiro.estado === 'AC' ? 'selected' : ''}>Acre</option>
                        <option value="AL" ${parceiro && parceiro.estado === 'AL' ? 'selected' : ''}>Alagoas</option>
                        <option value="AP" ${parceiro && parceiro.estado === 'AP' ? 'selected' : ''}>Amapá</option>
                        <option value="AM" ${parceiro && parceiro.estado === 'AM' ? 'selected' : ''}>Amazonas</option>
                        <option value="BA" ${parceiro && parceiro.estado === 'BA' ? 'selected' : ''}>Bahia</option>
                        <option value="CE" ${parceiro && parceiro.estado === 'CE' ? 'selected' : ''}>Ceará</option>
                        <option value="DF" ${parceiro && parceiro.estado === 'DF' ? 'selected' : ''}>Distrito Federal</option>
                        <option value="ES" ${parceiro && parceiro.estado === 'ES' ? 'selected' : ''}>Espírito Santo</option>
                        <option value="GO" ${parceiro && parceiro.estado === 'GO' ? 'selected' : ''}>Goiás</option>
                        <option value="MA" ${parceiro && parceiro.estado === 'MA' ? 'selected' : ''}>Maranhão</option>
                        <option value="MT" ${parceiro && parceiro.estado === 'MT' ? 'selected' : ''}>Mato Grosso</option>
                        <option value="MS" ${parceiro && parceiro.estado === 'MS' ? 'selected' : ''}>Mato Grosso do Sul</option>
                        <option value="MG" ${parceiro && parceiro.estado === 'MG' ? 'selected' : ''}>Minas Gerais</option>
                        <option value="PA" ${parceiro && parceiro.estado === 'PA' ? 'selected' : ''}>Pará</option>
                        <option value="PB" ${parceiro && parceiro.estado === 'PB' ? 'selected' : ''}>Paraíba</option>
                        <option value="PR" ${parceiro && parceiro.estado === 'PR' ? 'selected' : ''}>Paraná</option>
                        <option value="PE" ${parceiro && parceiro.estado === 'PE' ? 'selected' : ''}>Pernambuco</option>
                        <option value="PI" ${parceiro && parceiro.estado === 'PI' ? 'selected' : ''}>Piauí</option>
                        <option value="RJ" ${parceiro && parceiro.estado === 'RJ' ? 'selected' : ''}>Rio de Janeiro</option>
                        <option value="RN" ${parceiro && parceiro.estado === 'RN' ? 'selected' : ''}>Rio Grande do Norte</option>
                        <option value="RS" ${parceiro && parceiro.estado === 'RS' ? 'selected' : ''}>Rio Grande do Sul</option>
                        <option value="RO" ${parceiro && parceiro.estado === 'RO' ? 'selected' : ''}>Rondônia</option>
                        <option value="RR" ${parceiro && parceiro.estado === 'RR' ? 'selected' : ''}>Roraima</option>
                        <option value="SC" ${parceiro && parceiro.estado === 'SC' ? 'selected' : ''}>Santa Catarina</option>
                        <option value="SP" ${parceiro && parceiro.estado === 'SP' ? 'selected' : ''}>São Paulo</option>
                        <option value="SE" ${parceiro && parceiro.estado === 'SE' ? 'selected' : ''}>Sergipe</option>
                        <option value="TO" ${parceiro && parceiro.estado === 'TO' ? 'selected' : ''}>Tocantins</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top:12px">
                <label>Observações</label>
                <textarea id="p_observacoes" rows="3" placeholder="Observações adicionais...">${parceiro ? (parceiro.observacoes || '') : ''}</textarea>
            </div>
            
            <div class="form-row">
                <div>
                    <label>Status</label>
                    <select id="p_ativo">
                        <option value="true" ${parceiro && parceiro.ativo ? 'selected' : ''}>Ativo</option>
                        <option value="false" ${parceiro && !parceiro.ativo ? 'selected' : ''}>Inativo</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
                <button class="btn" onclick="fecharModal()">Cancelar</button>
                <button class="btn primary" onclick="salvarParceiro('${parceiroId || ''}')">
                    ${parceiroId ? 'Atualizar' : 'Salvar'} Parceiro
                </button>
            </div>
        `;
        
        // Inicializar campos baseados no tipo
        toggleTipoDocumento();
        
        abrirModal(parceiroId ? 'Editar Parceiro' : 'Novo Parceiro');
    }

    function toggleTipoDocumento() {
        const tipo = document.getElementById('p_tipo').value;
        const cpfContainer = document.getElementById('cpf_container');
        const cnpjContainer = document.getElementById('cnpj_container');
        
        if (tipo === 'fisica') {
            cpfContainer.classList.remove('conditional-field');
            cnpjContainer.classList.remove('visible');
        } else {
            cpfContainer.classList.add('conditional-field');
            cnpjContainer.classList.add('visible');
        }
    }

    // ---------- VALIDAÇÕES E FORMATAÇÕES ----------
    
    function formatarCPF(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 11) value = value.substring(0, 11);
        
        if (value.length <= 11) {
            value = value.replace(/(\d{3})(\d)/, '$1.$2')
                        .replace(/(\d{3})(\d)/, '$1.$2')
                        .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        }
        
        input.value = value;
        validarCPF(value);
    }

    function validarCPF(cpf) {
        const errorElement = document.getElementById('error-cpf');
        cpf = cpf.replace(/\D/g, '');
        
        if (cpf.length === 0) {
            errorElement.textContent = '';
            errorElement.classList.remove('visible');
            return true;
        }
        
        if (cpf.length !== 11) {
            errorElement.textContent = 'CPF deve ter 11 dígitos';
            errorElement.classList.add('visible');
            return false;
        }
        
        // Validação simples de CPF
        if (/^(\d)\1{10}$/.test(cpf)) {
            errorElement.textContent = 'CPF inválido';
            errorElement.classList.add('visible');
            return false;
        }
        
        errorElement.textContent = '';
        errorElement.classList.remove('visible');
        return true;
    }

    function formatarCNPJ(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 14) value = value.substring(0, 14);
        
        if (value.length <= 14) {
            value = value.replace(/^(\d{2})(\d)/, '$1.$2')
                        .replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3')
                        .replace(/\.(\d{3})(\d)/, '.$1/$2')
                        .replace(/(\d{4})(\d)/, '$1-$2');
        }
        
        input.value = value;
        validarCNPJ(value);
    }

    function validarCNPJ(cnpj) {
        const errorElement = document.getElementById('error-cnpj');
        cnpj = cnpj.replace(/\D/g, '');
        
        if (cnpj.length === 0) {
            errorElement.textContent = '';
            errorElement.classList.remove('visible');
            return true;
        }
        
        if (cnpj.length !== 14) {
            errorElement.textContent = 'CNPJ deve ter 14 dígitos';
            errorElement.classList.add('visible');
            return false;
        }
        
        errorElement.textContent = '';
        errorElement.classList.remove('visible');
        return true;
    }

    function formatarTelefone(input) {
        let value = input.value.replace(/\D/g, '');
        
        if (value.length > 11) value = value.substring(0, 11);
        
        if (value.length <= 11) {
            if (value.length === 11) {
                value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (value.length === 10) {
                value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            } else if (value.length > 6) {
                value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
            } else if (value.length > 0) {
                value = value.replace(/(\d{0,2})/, '($1');
            }
        }
        
        input.value = value;
        validarTelefone(value);
    }

    function validarTelefone(telefone) {
        const errorElement = document.getElementById('error-telefone');
        const digits = telefone.replace(/\D/g, '').length;
        
        if (telefone.length === 0) {
            errorElement.textContent = '';
            errorElement.classList.remove('visible');
            return true;
        }
        
        if (digits < 10 || digits > 11) {
            errorElement.textContent = 'Telefone deve ter 10 ou 11 dígitos';
            errorElement.classList.add('visible');
            return false;
        }
        
        errorElement.textContent = '';
        errorElement.classList.remove('visible');
        return true;
    }

    function formatarCEP(input) {
        let value = input.value.replace(/\D/g, '');
        
        if (value.length > 8) value = value.substring(0, 8);
        
        if (value.length === 8) {
            value = value.replace(/(\d{5})(\d{3})/, '$1-$2');
        }
        
        input.value = value;
    }

    async function buscarCEP(cep) {
        const cepDigits = cep.replace(/\D/g, '');
        const loadingElement = document.getElementById('cep-loading');
        
        if (cepDigits.length !== 8) {
            return;
        }
        
        loadingElement.style.display = 'block';
        
        try {
            const response = await fetch(`https://viacep.com.br/ws/${cepDigits}/json/`);
            const data = await response.json();
            
            if (!data.erro) {
                // Preencher automaticamente os campos de endereço
                document.getElementById('p_logradouro').value = data.logradouro || '';
                document.getElementById('p_bairro').value = data.bairro || '';
                document.getElementById('p_cidade').value = data.localidade || '';
                document.getElementById('p_estado').value = data.uf || '';
                showInfo('Endereço preenchido automaticamente!');
            } else {
                showInfo('CEP não encontrado');
            }
        } catch (error) {
            console.error('Erro ao buscar CEP:', error);
            showError('Erro ao buscar CEP');
        } finally {
            loadingElement.style.display = 'none';
        }
    }

    async function salvarParceiro(parceiroId = null) {
        if (!currentUser) {
            showError('Faça login para continuar');
            return;
        }
        
        // Validações
        const nome = document.getElementById('p_nome').value.trim();
        const tipo = document.getElementById('p_tipo').value;
        const cpf = tipo === 'fisica' ? document.getElementById('p_cpf').value : '';
        const cnpj = tipo === 'juridica' ? document.getElementById('p_cnpj').value : '';
        const telefone = document.getElementById('p_telefone').value;
        const cep = document.getElementById('p_cep').value;
        const logradouro = document.getElementById('p_logradouro').value;
        const numero = document.getElementById('p_numero').value;
        const bairro = document.getElementById('p_bairro').value;
        const cidade = document.getElementById('p_cidade').value;
        const estado = document.getElementById('p_estado').value;
        const observacoes = document.getElementById('p_observacoes').value;
        const ativo = document.getElementById('p_ativo').value === 'true';
        
        // Validar campos obrigatórios
        if (!nome) {
            document.getElementById('error-nome').textContent = 'Nome é obrigatório';
            document.getElementById('error-nome').classList.add('visible');
            return;
        } else {
            document.getElementById('error-nome').classList.remove('visible');
        }
        
        if (tipo === 'fisica' && !validarCPF(cpf)) return;
        if (tipo === 'juridica' && !validarCNPJ(cnpj)) return;
        if (telefone && !validarTelefone(telefone)) return;
        
        const parceiroData = {
            nome: nome,
            tipo: tipo,
            cpfCnpj: tipo === 'fisica' ? cpf : cnpj,
            telefone: telefone,
            cep: cep,
            logradouro: logradouro,
            numero: numero,
            bairro: bairro,
            cidade: cidade,
            estado: estado,
            observacoes: observacoes,
            ativo: ativo,
            userId: currentUser.uid,
            dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        try {
            if (parceiroId) {
                // Editar parceiro existente
                await db.collection('parceiros').doc(parceiroId).update(parceiroData);
                
                // Atualizar localmente
                const index = dataParceiros.findIndex(p => p.id === parceiroId);
                if (index !== -1) {
                    dataParceiros[index] = { ...dataParceiros[index], ...parceiroData };
                }
                showSuccess('Parceiro atualizado com sucesso!');
            } else {
                // Novo parceiro
                parceiroData.dataCriacao = firebase.firestore.FieldValue.serverTimestamp();
                const docRef = await db.collection('parceiros').add(parceiroData);
                parceiroData.id = docRef.id;
                dataParceiros.unshift(parceiroData);
                showSuccess('Parceiro criado com sucesso!');
            }
            
            fecharModal();
            invalidateCache();
            renderTabelaParceiros();
            
        } catch (error) {
            console.error("❌ Erro ao salvar parceiro:", error);
            showError("Erro ao salvar o parceiro: " + error.message);
        }
    }

    function editarParceiro(parceiroId) {
        abrirFormParceiro(parceiroId);
    }

    async function excluirParceiro(parceiroId) {
        if (!confirm('Tem certeza que deseja excluir este parceiro?')) {
            return;
        }
        
        try {
            await db.collection('parceiros').doc(parceiroId).delete();
            
            // Remover localmente
            dataParceiros = dataParceiros.filter(p => p.id !== parceiroId);
            invalidateCache();
            renderTabelaParceiros();
            showSuccess('Parceiro excluído com sucesso!');
            
        } catch (error) {
            console.error("Erro ao excluir parceiro:", error);
            showError("Erro ao excluir o parceiro.");
        }
    }

    // ---------- FORMAS DE PAGAMENTO ----------
    	
    function renderTabelaFormasPagamento() {
        const container = document.getElementById('lista-formas-pagamento-container');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (dataFormasPagamento.length === 0) {
            container.innerHTML = `
                <div style="grid-column: 1/-1; text-align:center; padding: 40px; color: var(--muted);">
                    <i class="fas fa-credit-card" style="font-size: 32px; margin-bottom: 10px; opacity: 0.5;"></i>
                    <p>Nenhuma forma de pagamento cadastrada.</p>
                </div>
            `;
            return;
        }
        
        // Ordenar: Ativos primeiro, depois alfabético
        dataFormasPagamento.sort((a, b) => (b.ativo - a.ativo) || a.descricao.localeCompare(b.descricao));

        dataFormasPagamento.forEach(forma => {
            // 1. Inteligência de Ícone
            const nome = forma.descricao.toLowerCase();
            let icone = 'fa-wallet'; // Padrão
            
            if (nome.includes('credito') || nome.includes('crédito') || nome.includes('card')) icone = 'fa-credit-card';
            else if (nome.includes('pix') || nome.includes('digital')) icone = 'fa-qrcode';
            else if (nome.includes('dinheiro') || nome.includes('especie') || nome.includes('espécie')) icone = 'fa-money-bill-wave';
            else if (nome.includes('boleto')) icone = 'fa-barcode';
            else if (nome.includes('debito') || nome.includes('débito')) icone = 'fa-id-card';

            // 2. Texto do Badge (Parcelado ou À Vista)
            const badgeClass = forma.permiteParcelamento ? 'badge-parcelado' : 'badge-avista';
            const badgeText = forma.permiteParcelamento 
                ? `Até ${forma.maxParcelas}x` 
                : 'À Vista';
            
            // 3. Cria o Cartão
            const card = document.createElement('div');
            card.className = 'forma-card';
            
            // Se inativo, opacidade reduzida
            if (!forma.ativo) card.style.opacity = '0.6';

            card.innerHTML = `
                <div class="forma-icon">
                    <i class="fas ${icone}"></i>
                </div>
                
                <div class="forma-info">
                    <div class="forma-name">${forma.descricao}</div>
                    <span class="forma-badge ${badgeClass}">
                        ${badgeText}
                    </span>
                    ${!forma.ativo ? '<span style="font-size:10px; color:var(--danger); margin-left:6px; font-weight:600;">Inativo</span>' : ''}
                </div>
                
                <div class="forma-actions">
                    <button class="btn small ghost" onclick="editarFormaPagamento('${forma.id}')" style="border:none; padding:4px;">
                        <i class="fas fa-pen"></i>
                    </button>
                    <button class="btn small ghost" onclick="excluirFormaPagamento('${forma.id}')" style="border:none; color:var(--danger); padding:4px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(card);
        });
    }
	
    function abrirFormFormaPagamento(formaId = null) {
        if (!currentUser) {
            showError('Faça login para continuar');
            return;
        }
        
        const forma = formaId ? dataFormasPagamento.find(f => f.id === formaId) : null;
        const body = document.getElementById('modal-body');
        
        body.innerHTML = `
            <div class="form-row">
                <div>
                    <label>Descrição *</label>
                    <input id="f_descricao" value="${forma ? forma.descricao : ''}" placeholder="Ex: Cartão de Crédito, PIX, etc.">
                </div>
                <div>
                    <label>Status</label>
                    <select id="f_ativo">
                        <option value="true" ${forma && forma.ativo ? 'selected' : ''}>Ativo</option>
                        <option value="false" ${forma && !forma.ativo ? 'selected' : ''}>Inativo</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label>Permite Parcelamento</label>
                    <select id="f_permite_parcelamento" onchange="toggleCampoParcelas()">
                        <option value="false" ${forma && !forma.permiteParcelamento ? 'selected' : ''}>Não</option>
                        <option value="true" ${forma && forma.permiteParcelamento ? 'selected' : ''}>Sim</option>
                    </select>
                </div>
                <div id="max_parcelas_container" class="conditional-field ${forma && forma.permiteParcelamento ? 'visible' : ''}">
                    <label>Máximo de Parcelas</label>
                    <input id="f_max_parcelas" type="number" min="1" max="36" value="${forma && forma.permiteParcelamento ? forma.maxParcelas : 1}">
                </div>
            </div>
            
            <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
                <button class="btn" onclick="fecharModal()">Cancelar</button>
                <button class="btn primary" onclick="salvarFormaPagamento('${formaId || ''}')">
                    ${formaId ? 'Atualizar' : 'Salvar'} Forma de Pagamento
                </button>
            </div>
        `;
        
        abrirModal(formaId ? 'Editar Forma de Pagamento' : 'Nova Forma de Pagamento');
    }

    function toggleCampoParcelas() {
        const permiteParcelamento = document.getElementById('f_permite_parcelamento').value === 'true';
        const container = document.getElementById('max_parcelas_container');
        
        if (permiteParcelamento) {
            container.classList.add('visible');
        } else {
            container.classList.remove('visible');
        }
    }

    async function salvarFormaPagamento(formaId = null) {
        if (!currentUser) {
            showError('Faça login para continuar');
            return;
        }
        
        const descricao = document.getElementById('f_descricao').value.trim();
        const ativo = document.getElementById('f_ativo').value === 'true';
        const permiteParcelamento = document.getElementById('f_permite_parcelamento').value === 'true';
        const maxParcelas = permiteParcelamento ? parseInt(document.getElementById('f_max_parcelas').value) || 1 : 1;
        
        if (!descricao) {
            showError('Preencha a descrição da forma de pagamento.');
            return;
        }
        
        if (permiteParcelamento && (maxParcelas < 1 || maxParcelas > 36)) {
            showError('O número máximo de parcelas deve estar entre 1 e 36.');
            return;
        }
        
        const formaData = {
            descricao: descricao,
            ativo: ativo,
            permiteParcelamento: permiteParcelamento,
            maxParcelas: maxParcelas,
            userId: currentUser.uid,
            dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        try {
            if (formaId) {
                // Editar forma existente
                await db.collection('formasPagamento').doc(formaId).update(formaData);
                
                // Atualizar localmente
                const index = dataFormasPagamento.findIndex(f => f.id === formaId);
                if (index !== -1) {
                    dataFormasPagamento[index] = { ...dataFormasPagamento[index], ...formaData };
                }
                showSuccess('Forma de pagamento atualizada com sucesso!');
            } else {
                // Nova forma
                formaData.dataCriacao = firebase.firestore.FieldValue.serverTimestamp();
                const docRef = await db.collection('formasPagamento').add(formaData);
                formaData.id = docRef.id;
                dataFormasPagamento.unshift(formaData);
                showSuccess('Forma de pagamento criada com sucesso!');
            }
            
            fecharModal();
            invalidateCache();
            renderTabelaFormasPagamento();
            
        } catch (error) {
            console.error("Erro ao salvar forma de pagamento:", error);
            showError("Erro ao salvar a forma de pagamento.");
        }
    }

    function editarFormaPagamento(formaId) {
        abrirFormFormaPagamento(formaId);
    }

    async function excluirFormaPagamento(formaId) {
        if (!confirm('Tem certeza que deseja excluir esta forma de pagamento?')) {
            return;
        }
        
        try {
            await db.collection('formasPagamento').doc(formaId).delete();
            
            // Remover localmente
            dataFormasPagamento = dataFormasPagamento.filter(f => f.id !== formaId);
            invalidateCache();
            renderTabelaFormasPagamento();
            showSuccess('Forma de pagamento excluída com sucesso!');
            
        } catch (error) {
            console.error("Erro ao excluir forma de pagamento:", error);
            showError("Erro ao excluir a forma de pagamento.");
        }
    }

// ---------- UTILITÁRIOS ----------
    
	// ---------- FUNÇÕES MOBILE ----------
    function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.querySelector('.sidebar-overlay');
        
        // Alterna a classe 'open' na sidebar
        sidebar.classList.toggle('open');
        
        // Alterna a classe 'active' no overlay (fundo escuro)
        overlay.classList.toggle('active');
    }

    // Fechar sidebar automaticamente ao clicar em um link do menu (Melhor UX)
    document.querySelectorAll('.nav a').forEach(link => {
        link.addEventListener('click', () => {
            // Só fecha se estiver no modo mobile (tela pequena)
            if (window.innerWidth <= 980) {
                toggleSidebar();
            }
        });
    });

    function formatMoney(v){ 
        return isNaN(v) ? 'R$ 0,00' : 
            (v < 0 ? `- R$ ${Math.abs(v).toFixed(2).replace('.',',')}` : `R$ ${v.toFixed(2).replace('.',',')}`);
    }
    
	function formatDate(d){ 
		if (!d) return '---'; 
		
		// Adicionar um pequeno offset para garantir que a data não retroceda no fuso horário local.
		// O ideal é criar a data sem a conversão automática de fuso horário.
		const parts = d.split('-'); // d é 'YYYY-MM-DD'
		
		// Cria a data localmente: (Ano, Mês - 1, Dia)
		const dt = new Date(parts[0], parts[1] - 1, parts[2]); 
		
		// Fallback de segurança para quem está lendo a data
		if (isNaN(dt)) {
			// Se a construção acima falhar (o que é raro), tenta a conversão padrão
			const fallbackDt = new Date(d); 
			return fallbackDt.toLocaleDateString('pt-BR'); 
		}
		
		return dt.toLocaleDateString('pt-BR'); 
	}
	
	function getTodayString() {
		const today = new Date();
		
		// Obter o ano, mês e dia da data LOCAL
		const year = today.getFullYear();
		// O mês começa em 0 (Janeiro), então somamos 1 e garantimos 2 dígitos
		const month = String(today.getMonth() + 1).padStart(2, '0'); 
		// Garantir 2 dígitos para o dia
		const day = String(today.getDate()).padStart(2, '0');

		// Retorna a data no formato YYYY-MM-DD (padrão do campo de data HTML)
		return `${year}-${month}-${day}`;
	}
   
	
		function calcularReceitasMes(mes = mesAtual, ano = anoAtual) {
		const primeiroDia = new Date(ano, mes, 1);
		const ultimoDia = new Date(ano, mes + 1, 0);
			
		return dataLancamentos
			.filter(l => 
					l.tipo === 'receita' && 
					l.pago === true && 
					!l.referenciaTransferenciaId
				)
				.filter(l => {
					const dataLancamento = new Date(l.data);
					return dataLancamento >= primeiroDia && dataLancamento <= ultimoDia;
				})
				.reduce((s, x) => s + (x.valor || 0), 0);
				}

		function calcularDespesasMes(mes = mesAtual, ano = anoAtual) {
		const primeiroDia = new Date(ano, mes, 1);
		const ultimoDia = new Date(ano, mes + 1, 0);
			
		return dataLancamentos
			.filter(l => 
				l.tipo === 'despesa' && 
				l.pago === true && 
				!l.referenciaTransferenciaId
				)
				.filter(l => {
					const dataLancamento = new Date(l.data);
					return dataLancamento >= primeiroDia && dataLancamento <= ultimoDia;
				})
				.reduce((s, x) => s + (x.valor || 0), 0);
		}

		function calcularSaldoMes(mes = mesAtual, ano = anoAtual) {
			return calcularReceitasMes(mes, ano) - calcularDespesasMes(mes, ano);
		}

		function calcularSaldoGeral() {
			return dataSaldos.reduce((s, x) => s + (x?.valor || 0), 0);
		}
	

// ---------- NOVO: FUNÇÃO PARA CALCULAR O FLUXO DE CAIXA MENSAL (ÚLTIMOS 6 MESES) ----------
	function calcularFluxoDeCaixaMensal() {
		const dataAtual = new Date();
		let meses = [];
		let receitasMensais = [];
		let despesasMensais = [];

		// Loop para os últimos 6 meses
		for (let i = 5; i >= 0; i--) {
			// Calcula o mês de referência (ex: Se i=0 é o mês atual, se i=5 é 5 meses atrás)
			const dataReferencia = new Date(dataAtual.getFullYear(), dataAtual.getMonth() - i, 1);
			const ano = dataReferencia.getFullYear();
			const mes = dataReferencia.getMonth();
			
			// Rótulo do mês (Ex: Nov/25)
			// toLocaleDateString é uma maneira simples de formatar a data
			meses.push(dataReferencia.toLocaleDateString('pt-BR', { month: 'short' }) + '/' + ano.toString().slice(-2));

			// Define o intervalo de datas para o cálculo
			const primeiroDia = new Date(ano, mes, 1);
			const ultimoDia = new Date(ano, mes + 1, 0); // O dia 0 do próximo mês é o último dia do mês atual
			
			// Filtrar lançamentos do mês de referência
			const lancamentosDoMes = dataLancamentos.filter(l => {
				const dataLancamento = new Date(l.data);
				return dataLancamento >= primeiroDia && dataLancamento <= ultimoDia;
			});

			// Filtrar Receitas (pagas e que não são Transferências)
			const totalReceita = lancamentosDoMes
				.filter(l => 
					l.tipo === 'receita' && 
					l.pago === true && 
					!l.referenciaTransferenciaId // Ignora entradas de transferência
				)
				// Soma os valores de todos os lançamentos filtrados
				.reduce((sum, l) => sum + (l.valor || 0), 0);

			// Filtrar Despesas (pagas e que não são Transferências)
			const totalDespesa = lancamentosDoMes
				.filter(l => 
					l.tipo === 'despesa' && 
					l.pago === true && 
					!l.referenciaTransferenciaId // Ignora saídas de transferência
				)
				// Soma os valores de todos os lançamentos filtrados
				.reduce((sum, l) => sum + (l.valor || 0), 0);

			receitasMensais.push(totalReceita);
			despesasMensais.push(totalDespesa);
		}

		return {
			meses: meses,
			receitas: receitasMensais,
			despesas: despesasMensais
		};
	}
	
	// NOVO: FUNÇÃO PARA CALCULAR DISTRIBUIÇÃO DE DESPESAS POR CATEGORIA (MÊS ATUAL)
	function calcularDistribuicaoDespesas() {
	    const primeiroDia = new Date(anoAtual, mesAtual, 1);
        const ultimoDia = new Date(anoAtual, mesAtual + 1, 0);
	    
	    const despesasMes = dataLancamentos.filter(l => {
	        const dataLancamento = new Date(l.data);
	        return l.tipo === 'despesa' && 
	               l.pago === true && 
	               !l.referenciaTransferenciaId &&
	               dataLancamento >= primeiroDia && dataLancamento <= ultimoDia;
	    });
	    
	    const resumo = despesasMes.reduce((acc, l) => {
	        const categoria = dataCategorias.find(c => c.id === l.categoriaId);
	        const nome = categoria ? categoria.nome : 'Sem Categoria';
	        const cor = categoria ? categoria.cor : '#95A5A6'; // Cor neutra para sem categoria
	        
	        if (!acc[nome]) {
	            acc[nome] = { nome, valor: 0, cor };
	        }
	        acc[nome].valor += l.valor;
	        return acc;
	    }, {});
	    
	    // Converter para array e ordenar por valor
	    const resultados = Object.values(resumo).sort((a, b) => b.valor - a.valor);
	    
	    return {
	        labels: resultados.map(r => r.nome),
	        data: resultados.map(r => r.valor),
	        colors: resultados.map(r => r.cor)
	    };
	}
    
    function calcSaldo(){ 
        return dataSaldos.reduce((s, x) => s + (x?.valor || 0), 0); 
    }

	// ---------- IMPLEMENTAÇÃO DOS GRÁFICOS (CHART.JS) ----------

	function destroyChart() {
		if (chartObj) {
			chartObj.destroy();
			chartObj = null;
		}
	}
	
	function destroyChartDespesas() {
    if (chartDespesasObj) {
        chartDespesasObj.destroy();
        chartDespesasObj = null;
    }
}
	
	function initChart() {
		destroyChart(); // Garante que o anterior foi apagado

		const dataFluxo = calcularFluxoDeCaixaMensal();
		const ctx = document.getElementById('chartFluxo');
		
		if (!ctx) return;

        // --- CORREÇÃO DO BUG: Detectar cores dinamicamente AGORA ---
        const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
        
        // Se for escuro, texto claro (#94A3B8). Se for claro, texto escuro (#64748B).
        const textColor = isDarkTheme ? '#94A3B8' : '#64748B'; 
        const gridColor = isDarkTheme ? '#334155' : '#E2E8F0'; 
		
		const receitaColor = '#10B981'; 
		const despesaColor = '#EF4444'; 
		
		chartObj = new Chart(ctx, {
			type: 'line',
			data: {
				labels: dataFluxo.meses,
				datasets: [
					{
						label: 'Receitas',
						data: dataFluxo.receitas,
						borderColor: receitaColor,
						backgroundColor: 'rgba(16, 185, 129, 0.15)',
						borderWidth: 3,
						tension: 0.4,
						fill: true,
						pointRadius: 4,
						pointHoverRadius: 6,
						pointBackgroundColor: receitaColor,
						pointBorderColor: isDarkTheme ? '#1E293B' : '#FFFFFF', // Borda do ponto adapta ao fundo
						pointBorderWidth: 2,
						borderCapStyle: 'round',
					},
					{
						label: 'Despesas',
						data: dataFluxo.despesas,
						borderColor: despesaColor,
						backgroundColor: 'rgba(239, 68, 68, 0.15)',
						borderWidth: 3,
						tension: 0.4,
						fill: false,
						pointRadius: 4,
						pointHoverRadius: 6,
						pointBackgroundColor: despesaColor,
						pointBorderColor: isDarkTheme ? '#1E293B' : '#FFFFFF', // Borda do ponto adapta ao fundo
						pointBorderWidth: 2,
						borderDash: [5, 5],
						borderCapStyle: 'butt',
					}
				]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				interaction: {
					intersect: false,
					mode: 'index',
				},
				plugins: {
					legend: {
						position: 'top',
						labels: {
							color: textColor, // <--- AQUI A MÁGICA ACONTECE (Legenda)
							font: {
								size: 13,
								weight: '600',
                                family: "'Inter', sans-serif"
							},
							padding: 20,
							usePointStyle: true,
							pointStyle: 'circle',
							boxWidth: 8,
							boxHeight: 8
						}
					},
					tooltip: {
						backgroundColor: isDarkTheme ? '#1E293B' : '#FFFFFF', // Fundo do tooltip
						titleColor: isDarkTheme ? '#F1F5F9' : '#1E293B',
						bodyColor: isDarkTheme ? '#F1F5F9' : '#1E293B',
						borderColor: gridColor,
						borderWidth: 1,
						padding: 12,
						cornerRadius: 8,
						displayColors: true,
						usePointStyle: true,
                        titleFont: { family: "'Inter', sans-serif", size: 13 },
                        bodyFont: { family: "'Inter', sans-serif", size: 13 },
						callbacks: {
							label: function(context) {
								let label = context.dataset.label || '';
								if (label) {
									label += ': ';
								}
								if (context.parsed.y !== null) {
									label += formatMoney(context.parsed.y);
								}
								return label;
							},
							labelColor: function(context) {
								return {
									borderColor: context.dataset.borderColor,
									backgroundColor: context.dataset.borderColor,
									borderWidth: 2,
									borderRadius: 2
								};
							}
						}
					}
				},
				scales: {
					y: {
						beginAtZero: true,
						grid: {
							color: gridColor, // <--- Linhas da grade adaptáveis
							drawBorder: false,
						},
						ticks: {
							callback: function(value) {
								if (value >= 1000000) return 'R$ ' + (value / 1000000).toFixed(1) + 'M';
								if (value >= 1000) return 'R$ ' + (value / 1000).toFixed(1) + 'k';
								return 'R$ ' + value;
							},
							color: textColor, // <--- Texto do eixo Y
							font: {
								size: 11,
                                family: "'Inter', sans-serif"
							},
							padding: 10
						},
						title: {
							display: false
						}
					},
					x: {
						grid: {
							display: false, // Oculta linhas verticais para visual mais limpo
						},
						ticks: {
							color: textColor, // <--- Texto do eixo X (Datas)
							font: {
								size: 11,
								weight: '500',
                                family: "'Inter', sans-serif"
							},
							maxRotation: 0
						}
					}
				},
				animation: {
					duration: 800,
					easing: 'easeOutQuart'
				}
			}
		});
	}

	function updateChart() {
		const dataFluxo = calcularFluxoDeCaixaMensal();
		
		if (!chartObj) {
			initChart();
			return;
		}
		
		// --- ATUALIZAÇÃO DE TEMA ---
		const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
		
		// Cores adaptativas
		const textColor = isDarkTheme ? '#94A3B8' : '#64748B';
		const mutedColor = isDarkTheme ? '#94A3B8' : '#64748B'; // Usando mesmo tom para consistência
		const gridColor = isDarkTheme ? '#334155' : '#E2E8F0';
		const pointBorderColor = isDarkTheme ? '#1E293B' : '#FFFFFF'; // Importante para os pontos!
		const tooltipBg = isDarkTheme ? '#1E293B' : '#FFFFFF';
		const tooltipText = isDarkTheme ? '#F1F5F9' : '#1E293B';

		// Cores fixas das linhas (Verde e Vermelho)
		const receitaColor = '#10B981'; 
		const despesaColor = '#EF4444'; 
		
		// 1. Atualizar Dados
		chartObj.data.labels = dataFluxo.meses;
		chartObj.data.datasets[0].data = dataFluxo.receitas;
		chartObj.data.datasets[1].data = dataFluxo.despesas;
		
		// 2. Atualizar Cores dos Datasets (Pontos e fundos)
		chartObj.data.datasets[0].pointBorderColor = pointBorderColor;
		chartObj.data.datasets[1].pointBorderColor = pointBorderColor;
		
		// 3. Atualizar Legendas e Tooltips
		chartObj.options.plugins.legend.labels.color = textColor;
		
		chartObj.options.plugins.tooltip.backgroundColor = tooltipBg;
		chartObj.options.plugins.tooltip.titleColor = tooltipText;
		chartObj.options.plugins.tooltip.bodyColor = tooltipText;
		chartObj.options.plugins.tooltip.borderColor = gridColor;
		
		// 4. Atualizar Eixos (Grades e Texto)
		chartObj.options.scales.y.ticks.color = mutedColor;
		chartObj.options.scales.y.grid.color = gridColor;
		chartObj.options.scales.x.ticks.color = mutedColor;
		
		// 5. Forçar atualização
		chartObj.update();
	}
	
	// SE PRECISAR, TAMBÉM ATUALIZE A FUNÇÃO destroyChart() PARA SER MAIS ROBUSTA:

	function destroyChart() {
		if (chartObj) {
			// Remover listeners para evitar memory leaks
			const canvas = document.getElementById('chartFluxo');
			if (canvas) {
				const newCanvas = canvas.cloneNode(true);
				canvas.parentNode.replaceChild(newCanvas, canvas);
			}
			
			chartObj.destroy();
			chartObj = null;
		}
	}
	
	function updateChartDespesas() {
		const dataDespesas = calcularDistribuicaoDespesas();
		const ctx = document.getElementById('chartDespesas');
		
		// Se não existe gráfico ou não tem dados, chama o init que lida com isso
		if (!chartDespesasObj || dataDespesas.data.length === 0) {
			initChartDespesas();
			return;
		}

		// --- ATUALIZAÇÃO DE TEMA (O Pulo do Gato) ---
		// 1. Descobrimos qual é o tema AGORA
		const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
		
		// 2. Definimos as cores baseadas nessa descoberta
		const textColor = isDarkTheme ? '#94A3B8' : '#64748B';
		const borderColor = isDarkTheme ? '#1E293B' : '#FFFFFF';
		const tooltipBg = isDarkTheme ? '#1E293B' : '#FFFFFF';
		const tooltipText = isDarkTheme ? '#F1F5F9' : '#1E293B';
		const tooltipBorder = isDarkTheme ? '#334155' : '#E2E8F0';

		// 3. Atualiza os Dados
		chartDespesasObj.data.labels = dataDespesas.labels;
		chartDespesasObj.data.datasets[0].data = dataDespesas.data;
		chartDespesasObj.data.datasets[0].backgroundColor = dataDespesas.colors;
		
		// 4. Aplica as Novas Cores
		chartDespesasObj.data.datasets[0].borderColor = borderColor; // Borda das fatias
		
		chartDespesasObj.options.plugins.legend.labels.color = textColor; // Texto da legenda
		
		chartDespesasObj.options.plugins.tooltip.backgroundColor = tooltipBg;
		chartDespesasObj.options.plugins.tooltip.titleColor = tooltipText;
		chartDespesasObj.options.plugins.tooltip.bodyColor = tooltipText;
		chartDespesasObj.options.plugins.tooltip.borderColor = tooltipBorder;
		
		// 5. Manda repintar
		chartDespesasObj.update();
	}
	
	function initChartDespesas() {
		// 1. Destruir gráfico anterior para evitar sobreposição
		destroyChartDespesas();
		
		const dataDespesas = calcularDistribuicaoDespesas();
		const ctx = document.getElementById('chartDespesas');
		
		if (!ctx) return;
		
		// Se não houver dados, mostra mensagem amigável e sai
		if (dataDespesas.data.length === 0) {
			const parent = ctx.parentElement;
			// Limpa e adiciona mensagem se ainda não tiver
			if (!parent.querySelector('.empty-msg')) {
				parent.innerHTML = `<p class="empty-msg" style="text-align:center;color:var(--muted);margin-top:50px">Sem despesas realizadas neste mês.</p>`;
				// Recria o elemento canvas para uso futuro (pois o innerHTML removeu ele)
				const newCanvas = document.createElement('canvas');
				newCanvas.id = 'chartDespesas';
				parent.appendChild(newCanvas);
			}
			return;
		} else {
			// Se tem dados, garante que o canvas está limpo de mensagens antigas
			const msg = ctx.parentElement.querySelector('.empty-msg');
			if (msg) msg.remove();
		}

		// --- CORREÇÃO DO BUG: Detectar cores dinamicamente ---
		const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
		
		// Cores adaptativas (consistentes com o Fluxo de Caixa)
		const textColor = isDarkTheme ? '#94A3B8' : '#64748B'; 
		const borderColor = isDarkTheme ? '#1E293B' : '#FFFFFF';
		const tooltipBg = isDarkTheme ? '#1E293B' : '#FFFFFF';
		const tooltipText = isDarkTheme ? '#F1F5F9' : '#1E293B';
		const tooltipBorder = isDarkTheme ? '#334155' : '#E2E8F0';
		
		chartDespesasObj = new Chart(ctx, {
			type: 'doughnut', // 'doughnut' é mais moderno que 'pie'
			data: {
				labels: dataDespesas.labels,
				datasets: [{
					data: dataDespesas.data,
					backgroundColor: dataDespesas.colors,
					borderWidth: 2,
					borderColor: borderColor, // Borda se adapta ao fundo (dark/light)
					hoverOffset: 4
				}]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				layout: {
					padding: 10
				},
				plugins: {
					legend: {
						position: 'right',
						labels: {
							color: textColor, // <--- AQUI A COR DA LEGENDA
							font: {
								size: 12,
								weight: '500',
								family: "'Inter', sans-serif"
							},
							padding: 15,
							usePointStyle: true,
							pointStyle: 'circle'
						}
					},
					tooltip: {
						backgroundColor: tooltipBg,
						titleColor: tooltipText,
						bodyColor: tooltipText,
						borderColor: tooltipBorder,
						borderWidth: 1,
						padding: 12,
						cornerRadius: 8,
						displayColors: true,
						usePointStyle: true,
						callbacks: {
							label: function(context) {
								const label = context.label || '';
								const value = context.raw || 0;
								const total = context.dataset.data.reduce((a, b) => a + b, 0);
								const percentage = Math.round((value / total) * 100);
								return `${label}: ${formatMoney(value)} (${percentage}%)`;
							},
							labelColor: function(context) {
								return {
									borderColor: context.dataset.backgroundColor[context.dataIndex],
									backgroundColor: context.dataset.backgroundColor[context.dataIndex],
									borderWidth: 2,
									borderRadius: 2
								};
							}
						}
					},
					datalabels: {
						display: true,
						color: '#FFFFFF', // Texto dentro da fatia sempre branco
						font: {
							weight: 'bold',
							size: 11,
							family: "'Inter', sans-serif"
						},
						formatter: (value, ctx) => {
							const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
							const percentage = Math.round((value / total) * 100);
							return percentage > 5 ? `${percentage}%` : ''; // Só mostra se > 5% para não poluir
						}
					}
				},
				animation: {
					animateScale: true,
					animateRotate: true
				}
			},
			plugins: [ChartDataLabels] // Plugin para mostrar % dentro da fatia
		});
	}
    
    // ---------- MODAL ----------
    
    function abrirModal(titulo){
        document.getElementById('modal-title').textContent = titulo;
        document.getElementById('modal-form').style.display = 'flex';
    }

    function fecharModal(){
        document.getElementById('modal-form').style.display = 'none';
    }
    
	async function recalcularSaldosGerais() {
        if (!confirm("Isso irá recalcular o saldo de todas as suas contas com base nos lançamentos realizados. Deseja continuar?")) return;

        try {
            showInfo("Iniciando recálculo... por favor, aguarde.");
            
            // 1. Criar um mapa para armazenar os novos saldos zerados
            const novosSaldos = {};
            dataSaldos.forEach(conta => {
                novosSaldos[conta.id] = 0;
            });

            // 2. Somar todos os lançamentos REALIZADOS
            dataLancamentos.forEach(l => {
                if (l.pago && novosSaldos.hasOwnProperty(l.contaId)) {
                    const multiplicador = (l.tipo === 'despesa') ? -1 : 1;
                    novosSaldos[l.contaId] += (l.valor * multiplicador);
                }
            });

            // 3. Atualizar o Firebase e a memória local
            const batch = db.batch();
            for (const contaId in novosSaldos) {
                const novoValor = novosSaldos[contaId];
                const docRef = db.collection('contas').doc(contaId);
                
                batch.update(docRef, { 
                    valor: novoValor,
                    dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Atualiza na memória local
                const contaLocal = dataSaldos.find(c => c.id === contaId);
                if (contaLocal) contaLocal.valor = novoValor;
            }

            await batch.commit();
            
            // 4. Atualizar a interface
            renderAll();
            showSuccess("Saldos recalculados com sucesso!");
            
        } catch (error) {
            console.error("Erro ao recalcular:", error);
            showError("Erro técnico ao recalcular saldos.");
        }
    }
 
    document.addEventListener('DOMContentLoaded', () => {
		// 1. Carregar Tema Salvo ao Iniciar
		const savedTheme = localStorage.getItem('finpess_theme');
		if (savedTheme) {
			document.documentElement.setAttribute('data-theme', savedTheme);
		}

		// Inicializa a autenticação
		initializeAuth();
		
		// Configuração de Navegação
		document.querySelectorAll('.nav a').forEach(link => {
			link.addEventListener('click', (e) => {
				e.preventDefault();
				document.querySelectorAll('.nav a').forEach(l => l.classList.remove('active'));
				link.classList.add('active');
				showScreen(link.dataset.screen);
			});
		});
		
		// 2. Botão de Tema com Refresh dos Gráficos
		const btnTheme = document.getElementById('btn-theme');
		if (btnTheme) {
			btnTheme.addEventListener('click', () => {
				const root = document.documentElement;
				const currentTheme = root.getAttribute('data-theme');
				const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
				
				root.setAttribute('data-theme', newTheme);
				localStorage.setItem('finpess_theme', newTheme);
				
				setTimeout(() => {
					if (document.getElementById('dashboard').style.display !== 'none') {
						if (chartObj) { destroyChart(); initChart(); }
						if (chartDespesasObj) { destroyChartDespesas(); initChartDespesas(); }
					}
				}, 50);
			});
		}
		
		// Ativar Busca Global
        const globalSearch = document.getElementById('global-search');
        if (globalSearch) {
            globalSearch.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const termoBusca = globalSearch.value.trim();
                    if (termoBusca !== "") {
                        // 1. Ir para a tela de lançamentos
                        showScreen('lancamentos');
                        
                        // 2. Atualizar o menu lateral visualmente
                        document.querySelectorAll('.nav a').forEach(l => l.classList.remove('active'));
                        const linkLancamentos = document.querySelector('a[data-screen="lancamentos"]');
                        if (linkLancamentos) linkLancamentos.classList.add('active');

                        // 3. Aplicar o termo no filtro da tela de lançamentos
                        const inputFiltro = document.getElementById('filtro-descricao-lancamento');
                        if (inputFiltro) {
                            inputFiltro.value = termoBusca;
                            // Dispara a função de filtragem que já existe no seu código
                            filtrarLancamentos();
                        }
                        
                        // 4. Limpar a busca global e dar feedback
                        globalSearch.value = "";
                        showNotification(`Exibindo resultados para: "${termoBusca}"`, 'info');
                    }
                }
            });
        }
		
	});
	
	// Funções para a Melhoria de Visibilidade
		function abrirConfigVisibilidade() {
			// Remove as preferências antigas para não "travar" a tela do usuário
			localStorage.removeItem('cfg_ocultar_novo');
			localStorage.removeItem('cfg_ocultar_busca');

			// Carrega apenas o que sobrou (KPIs)
			const checkKpis = document.getElementById('check-hide-kpis');
			if (checkKpis) {
				checkKpis.checked = localStorage.getItem('cfg_ocultar_kpis') === 'true';
			}

			document.getElementById('modal-config-visibilidade').style.display = 'flex';
		}

		function fecharModalConfig() {
			document.getElementById('modal-config-visibilidade').style.display = 'none';
		}

		function salvarPreferenciasVisibilidade() {
			const checkKpis = document.getElementById('check-hide-kpis');
			
			// 1. Salva apenas a preferência de KPIs que mantivemos no HTML
			if (checkKpis) {
				localStorage.setItem('cfg_ocultar_kpis', checkKpis.checked);
			}

			// 2. LIMPEZA DE SEGURANÇA: Garante que as opções removidas nunca fiquem ativas
			localStorage.removeItem('cfg_ocultar_novo');
			localStorage.removeItem('cfg_ocultar_busca');

			// 3. Aplica as mudanças visualmente
			aplicarRegrasVisibilidade();
			
			// 4. Fecha o modal e avisa o usuário
			fecharModalConfig();
			showSuccess("Preferências de exibição atualizadas!");
		}

		function aplicarRegrasVisibilidade() {
			const body = document.body;

			// Remove as classes antigas do body caso existam
			body.classList.remove('ocultar-novo-mobile');
			body.classList.remove('ocultar-busca-mobile');

			// Aplica apenas a regra dos KPIs
			const ocultarKPIs = localStorage.getItem('cfg_ocultar_kpis') === 'true';
			if (ocultarKPIs) {
				body.classList.add('ocultar-kpis-mobile');
			} else {
				body.classList.remove('ocultar-kpis-mobile');
			}
		}

	// Chamar a função ao carregar a página (adicione isso no final do seu script)
		aplicarRegrasVisibilidade();
		
	function abrirConfigVisibilidadeContas() {
		const container = document.getElementById('lista-checks-contas');
		container.innerHTML = '';

		// Cria a lista de checkboxes baseada nas contas que existem
		dataSaldos.forEach(conta => {
			const estaVisivel = (conta.exibirNoDashboard !== false);
			container.innerHTML += `
				<label style="display:flex; align-items:center; gap:12px; font-size:14px; cursor:pointer; padding: 10px; border-radius:8px; background:var(--input-bg); border: 1px solid var(--border)">
					<input type="checkbox" class="check-conta-visivel" data-id="${conta.id}" ${estaVisivel ? 'checked' : ''} style="width:18px; height:18px;">
					<span style="font-weight:600">${conta.nome}</span>
				</label>
			`;
		});
		
		document.getElementById('modal-config-contas-dashboard').style.display = 'flex';
	}

	function fecharModalConfigContas() {
		document.getElementById('modal-config-contas-dashboard').style.display = 'none';
	}

	async function salvarVisibilidadeContas() {
		const checkboxes = document.querySelectorAll('.check-conta-visivel');
		const batch = db.batch();

		checkboxes.forEach(cb => {
			const id = cb.getAttribute('data-id');
			const valor = cb.checked;
			
			// Atualiza na memória do navegador na hora
			const conta = dataSaldos.find(c => c.id === id);
			if (conta) conta.exibirNoDashboard = valor;

			// Prepara a gravação no banco de dados (Firebase)
			const ref = db.collection('contas').doc(id);
			batch.update(ref, { exibirNoDashboard: valor });
		});

		try {
			await batch.commit(); // Salva tudo de uma vez
			fecharModalConfigContas();
			renderSaldos(); // Atualiza a lista do Dashboard
			showSuccess("Configurações de exibição salvas!");
		} catch (error) {
			showError("Erro ao salvar preferências: " + error.message);
		}
	}
	
	function resetFiltrosLancamentosCompleto() {
		// 1. Capturar todos os elementos de filtro da tela de lançamentos
		const fConta = document.getElementById('filtro-conta-lancamento');
		const fTipo = document.getElementById('filtro-tipo-lancamento');
		const fStatus = document.getElementById('filtro-status-lancamento');
		const fParceiro = document.getElementById('filtro-parceiro-lancamento');
		const fDescricao = document.getElementById('filtro-descricao-lancamento');

		// 2. Resetar os valores para o padrão (vazio)
		if (fConta) fConta.value = "";
		if (fTipo) fTipo.value = "";
		if (fStatus) fStatus.value = "";
		if (fParceiro) fParceiro.value = "";
		if (fDescricao) fDescricao.value = "";

		// 3. Remover a classe visual 'filled' (aquela que deixa o campo em destaque)
		const todosFiltros = [fConta, fTipo, fStatus, fParceiro, fDescricao];
		todosFiltros.forEach(el => {
			if (el) el.classList.remove('filled');
		});

		// 4. Re-executar a filtragem para que a lista volte ao estado original (sem filtros)
		filtrarLancamentos();
		
		console.log('🧹 Filtros de lançamentos limpos ao trocar de tela.');
	}
	
	function filtrarCategoriasPorTipo() {
		const tipoSelecionado = document.getElementById('l_tipo').value;
		const selectCategoria = document.getElementById('l_categoria');
		
		// Se for transferência, o campo categoria geralmente fica oculto, mas limpamos por segurança
		if (tipoSelecionado === 'transferencia' || !tipoSelecionado) {
			selectCategoria.innerHTML = '<option value="">Selecione...</option>';
			return;
		}

		// Filtramos as categorias que correspondem ao tipo (receita ou despesa)
		const categoriasFiltradas = dataCategorias.filter(cat => 
			cat.tipo === tipoSelecionado && cat.ativo === true
		);

		// Limpamos o select e adicionamos as opções filtradas
		selectCategoria.innerHTML = `<option value="">Selecione uma categoria de ${tipoSelecionado}...</option>`;
		
		categoriasFiltradas.forEach(cat => {
			const selected = (lancamentoEditando && lancamentoEditando.categoriaId === cat.id) ? 'selected' : '';
			selectCategoria.innerHTML += `<option value="${cat.id}" ${selected}>${cat.nome}</option>`;
		});
	}
	
	function renderMetasDashboard() {
		const container = document.getElementById('container-metas');
		const displayEconomia = document.getElementById('valor-economia-prevista');
		if (!container) return;
		
		container.innerHTML = '';

		// 1. Calcular Receita Total Esperada para o mês (Paga ou Pendente)
		const primeiroDia = new Date(anoAtual, mesAtual, 1);
		const ultimoDia = new Date(anoAtual, mesAtual + 1, 0);
		
		const receitaPrevista = dataLancamentos.filter(l => {
			const d = new Date(l.data);
			return l.tipo === 'receita' && d >= primeiroDia && d <= ultimoDia && !l.referenciaTransferenciaId;
		}).reduce((sum, l) => sum + (l.valor || 0), 0);

		// 2. Calcular Soma de todas as Metas de Despesas definidas
		const totalMetas = dataCategorias
			.filter(c => c.tipo === 'despesa' && c.meta > 0 && c.ativo)
			.reduce((sum, c) => sum + (c.meta || 0), 0);

		// 3. Calcular e Atualizar o Indicador de Economia (Receita - Metas)
		const economia = receitaPrevista - totalMetas;
		if (displayEconomia) {
			displayEconomia.textContent = formatMoney(economia);
			// Se a economia for negativa (prejuízo previsto), fica vermelho. Se positiva, verde.
			displayEconomia.style.color = economia >= 0 ? 'var(--success)' : 'var(--danger)';
		}

		// 4. Renderizar as barras de progresso (Lógica que você já tinha)
		const categoriasComMeta = dataCategorias.filter(c => c.tipo === 'despesa' && c.meta > 0 && c.ativo);

		if (categoriasComMeta.length === 0) {
			container.innerHTML = '<p style="color:var(--muted); font-size:13px; grid-column: 1/-1;">Nenhuma meta definida. Configure metas no cadastro de categorias.</p>';
			return;
		}

		categoriasComMeta.forEach(cat => {
			const gastoAtual = dataLancamentos.filter(l => {
				const d = new Date(l.data);
				return l.categoriaId === cat.id && l.pago && d.getMonth() === mesAtual && d.getFullYear() === anoAtual;
			}).reduce((sum, l) => sum + (l.valor || 0), 0);

			const porcentagem = Math.min((gastoAtual / cat.meta) * 100, 100);
			const corBarra = porcentagem >= 90 ? '#EF4444' : (porcentagem >= 70 ? '#F59E0B' : '#10B981');

			container.innerHTML += `
				<div style="background: var(--bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border);">
					<div style="display:flex; justify-content:space-between; margin-bottom: 8px;">
						<span style="font-weight:700; font-size: 13px;">${cat.nome}</span>
						<span style="font-size: 11px; color: var(--muted);">${formatMoney(gastoAtual)} / ${formatMoney(cat.meta)}</span>
					</div>
					<div style="width: 100%; height: 8px; background: var(--input-bg); border-radius: 10px; overflow: hidden; border: 1px solid var(--border);">
						<div style="width: ${porcentagem}%; height: 100%; background: ${corBarra}; border-radius: 10px; transition: width 0.6s ease-in-out;"></div>
					</div>
					<div style="margin-top: 6px; font-size: 10px; text-align: right; color: ${corBarra}; font-weight: 800; text-transform: uppercase;">
						${porcentagem.toFixed(0)}% Utilizado
					</div>
				</div>
			`;
		});
	}
	
	function navegarMobile(elemento) {
		// 1. Identifica o ID da tela através do atributo data-screen que colocamos no HTML
		const screenId = elemento.getAttribute('data-screen');
		
		// 2. Remove o destaque (classe 'active') de todos os ícones da barra inferior
		document.querySelectorAll('.mobile-nav-item').forEach(item => {
			item.classList.remove('active');
		});
		
		// 3. Adiciona o destaque apenas no ícone que foi clicado agora
		elemento.classList.add('active');
		
		// 4. Executa o Scroll Automático: centraliza o ícone na tela se ele estiver escondido no canto
		elemento.scrollIntoView({ 
			behavior: 'smooth', 
			block: 'nearest', 
			inline: 'center' 
		});
		
		// 5. Chama a função principal do seu sistema para esconder a tela atual e mostrar a nova
		showScreen(screenId);
		
		// 6. Sincronização: Procura o link correspondente no menu lateral (sidebar) e o marca como ativo
		// Isso garante que se você girar o celular para o modo paisagem, o menu lateral estará correto.
		document.querySelectorAll('.nav a').forEach(link => {
			link.classList.remove('active');
			if (link.dataset.screen === screenId) {
				link.classList.add('active');
			}
		});
	}
		
  </script>
  
	<div id="modal-config-visibilidade" class="modal">
	  <div class="modal-content" style="max-width:350px; border-radius: 16px;">
		<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
		  <h3 style="margin:0; font-size: 1.1rem;">Ajustes de Tela</h3>
		  <button onclick="fecharModalConfig()" style="border:0; background:transparent; cursor:pointer; color:var(--muted)"><i class="fas fa-times"></i></button>
		</div>
		<p style="font-size:13px; color:var(--muted); margin-bottom:18px">Personalização da Tela de Lançamentos:</p>
		
		<div style="display:flex; flex-direction:column; gap:15px">
		  <label style="display:flex; align-items:center; gap:12px; font-size:14px; cursor:pointer">
			<input type="checkbox" id="check-hide-kpis" style="width:18px; height:18px; cursor:pointer"> 
			Não Exibir Resumos (KPIs) do Mês no Celular
		  </label>
		</div>

		<button class="btn primary" onclick="salvarPreferenciasVisibilidade()" style="width:100%; margin-top:25px; padding:12px">
		  Salvar Preferência
		</button>
	  </div>
	</div>
	
	<div id="modal-config-contas-dashboard" class="modal">
	  <div class="modal-content" style="max-width:400px; border-radius: 16px;">
		<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
		  <h3 style="margin:0; font-size: 1.1rem;">Exibir no Dashboard</h3>
		  <button onclick="fecharModalConfigContas()" style="border:0; background:transparent; cursor:pointer; color:var(--muted)"><i class="fas fa-times"></i></button>
		</div>
		<p style="font-size:13px; color:var(--muted); margin-bottom:15px">Marque as contas que devem aparecer no indicador "Saldos Detalhados por Conta" do Dashboard:</p>
		
		<div id="lista-checks-contas" style="display:flex; flex-direction:column; gap:12px; max-height: 300px; overflow-y: auto;">
		  </div>

		<button class="btn primary" onclick="salvarVisibilidadeContas()" style="width:100%; margin-top:20px; padding:12px">
		  Salvar Preferências
		</button>
	  </div>
	</div>
	
	<nav class="mobile-nav-bar">
	  <a href="#" class="mobile-nav-item active" data-screen="dashboard" onclick="navegarMobile(this)">
		<i class="fas fa-home"></i>
		<span>Home</span>
	  </a>
	  <a href="#" class="mobile-nav-item" data-screen="lancamentos" onclick="navegarMobile(this)">
		<i class="fas fa-money-bill-wave"></i>
		<span>Lançamentos</span>
	  </a>
	  <a href="#" class="mobile-nav-item" data-screen="contas" onclick="navegarMobile(this)">
		<i class="fas fa-university"></i>
		<span>Contas</span>
	  </a>
	  <a href="#" class="mobile-nav-item" data-screen="setores" onclick="navegarMobile(this)">
		<i class="fas fa-sitemap"></i>
		<span>Setores</span>
	  </a>
	  <a href="#" class="mobile-nav-item" data-screen="categorias" onclick="navegarMobile(this)">
		<i class="fas fa-tags"></i>
		<span>Categorias</span>
	  </a>
	  <a href="#" class="mobile-nav-item" data-screen="parceiros" onclick="navegarMobile(this)">
		<i class="fas fa-user-friends"></i>
		<span>Parceiros</span>
	  </a>
	  <a href="#" class="mobile-nav-item" data-screen="formas-pagamento" onclick="navegarMobile(this)">
		<i class="fas fa-credit-card"></i>
		<span>Pagamento</span>
	  </a>
	</nav>
  
</body>
</html>
